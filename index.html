<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChRi Health</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;0,9..144,700;0,9..144,800;1,9..144,400;1,9..144,600;1,9..144,700&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════
   DESIGN SYSTEM — CHRI HEALTH v3
   Dark · Editorial · High-retention
═══════════════════════════════════════════ */
:root {
  /* Base — warm white */
  --bg:        #f7f8fc;
  --bg1:       #ffffff;
  --bg2:       #f0f2f8;
  --bg3:       #e8eaf2;
  --bg4:       #dde0ec;
  --surf:      #ffffff;
  --surf2:     #f4f5fa;

  /* Borders */
  --bdr:       rgba(30,40,80,.08);
  --bdr2:      rgba(30,40,80,.14);
  --bdr3:      rgba(30,40,80,.22);

  /* Text */
  --tx:        #1a1d2e;
  --tx2:       #4a4f6a;
  --tx3:       #8087a8;
  --tx4:       #b0b6cc;

  /* Accents — same hues, adjusted for light */
  --blue:      #2563eb;
  --blue-dk:   #1a4db8;
  --blue-dim:  rgba(37,99,235,.08);
  --blue-glow: rgba(37,99,235,.18);

  --amber:     #d97706;
  --amber-dim: rgba(217,119,6,.09);
  --amber-glow:rgba(217,119,6,.2);

  --green:     #059669;
  --green-dim: rgba(5,150,105,.09);
  --green-glow:rgba(5,150,105,.2);

  --red:       #dc2626;
  --red-dim:   rgba(220,38,38,.08);

  --purp:      #7c3aed;
  --purp-dim:  rgba(124,58,237,.08);

  /* Layout */
  --sb:        220px;
  --hdr:       56px;
}


*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { height: 100%; overflow: hidden; background: var(--bg); color: var(--tx); }
body { height: 100%; overflow: hidden; background: var(--bg); color: var(--tx); }

/* ── iOS tap fix: all clickable divs register touch ── */
[onclick], .sb-item, .sb-sub, .sb-section-link, .rs-btn, .mt-btn,
.ans-opt, .mc-btn-primary, .mc-btn-secondary, .tb-btn, .dash-cta-btn,
.ex-diff-opt, .lec-row, .ex-back-btn, .prog-action-btn,
.t-conf-btn, .t-next-btn, .t-submit-btn {
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(37,99,235,.12);
  touch-action: manipulation;
}
body {
  font-family: 'IBM Plex Sans', sans-serif;
  font-weight: 400;
  color: var(--tx);
  background: var(--bg);
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ═══════════════ SCROLLBARS ═══════════════ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 99px; }

/* ═══════════════ APP SHELL ═══════════════ */
.app { display:flex; height:100vh; height:100dvh; overflow:hidden; }

/* ═══════════════ SIDEBAR ═══════════════ */
.sidebar {
  width: var(--sb);
  flex-shrink: 0;
  background: var(--bg1);
  border-right: 1px solid var(--bdr);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sb-logo {
  height: var(--hdr);
  display: flex;
  align-items: center;
  padding: 0 18px;
  border-bottom: 1px solid var(--bdr);
  gap: 10px;
  flex-shrink: 0;
}
.logo-gem {
  width: 26px; height: 26px;
  border-radius: 6px;
  background: linear-gradient(135deg, var(--blue) 0%, #1a4fff 100%);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Fraunces', serif;
  font-size: 11px; font-weight: 700; color: #fff;
  flex-shrink: 0;
  box-shadow: 0 1px 6px rgba(37,99,235,.16);
}
.logo-name {
  font-family: 'Fraunces', serif;
  font-size: 15px; font-weight: 600;
  letter-spacing: -.02em;
  color: var(--tx);
}
.logo-name span { color: var(--blue); }

/* Role switcher */
.role-switch {
  margin: 12px 14px;
  display: flex;
  background: var(--bg);
  border: 1px solid var(--bdr);
  border-radius: 6px;
  padding: 3px;
  gap: 2px;
  flex-shrink: 0;
}
.rs-btn {
  flex: 1;
  text-align: center;
  padding: 4px 0;
  border-radius: 4px;
  font-size: 10.5px;
  font-weight: 500;
  color: var(--tx3);
  cursor: pointer;
  transition: all .15s;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: .02em;
}
.rs-btn.active {
  background: var(--bg3);
  color: var(--blue);
}

/* Nav */
.sb-nav { flex:1; overflow-y:auto; padding: 6px 0 16px; }
.sb-section {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px;
  letter-spacing: .16em;
  text-transform: uppercase;
  color: var(--tx4);
  padding: 14px 18px 4px;
}
.sb-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 18px;
  font-size: 13px;
  color: var(--tx2);
  cursor: pointer;
  transition: all .12s;
  border-left: 2px solid transparent;
  margin: 1px 0;
}
.sb-item:hover { background: var(--bg2); color: var(--tx); }
.sb-item.active {
  background: rgba(37,99,235,.08);
  color: var(--blue);
  border-left-color: var(--blue);
}
.sb-item.locked { opacity: .6; cursor: pointer; }
.sb-item.locked:hover { background: var(--bg2); opacity: .8; }
.sb-sub {
  padding: 5px 18px 5px 42px;
  font-size: 12px;
  color: var(--tx3);
  cursor: pointer;
  transition: all .12s;
  display: flex;
  align-items: center;
  gap: 8px;
  border-left: 2px solid transparent;
}
.sb-sub:hover { background: var(--bg2); color: var(--tx2); }
.sb-sub.active { color: var(--blue); border-left-color: var(--blue); background: var(--blue-dim); }
.sb-sub.locked { opacity: .35; cursor: pointer; }
.sb-sub.locked:hover { opacity: .55; background: var(--bg2); }
.sb-sub-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--tx4); flex-shrink: 0; }
.sb-sub.active .sb-sub-dot { background: var(--blue); }
.sb-sub.locked .sb-sub-dot { background: var(--tx4); }
.sb-lock-icon { margin-left: auto; font-size: 9px; color: var(--tx4); }
.sb-coming { margin-left: auto; font-family:'IBM Plex Mono',monospace; font-size: 8px; color: var(--tx4); letter-spacing:.04em; }

/* ─── CURRICULUM SCREEN ─── */
.curr-screen {
  padding: 44px 52px 80px;
  max-width: 820px;
  margin: 0 auto;
}
.curr-header {
  margin-bottom: 36px;
  padding-bottom: 32px;
  border-bottom: 1px solid var(--bdr);
}
.curr-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  letter-spacing: .18em;
  text-transform: uppercase;
  color: var(--blue);
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.curr-eyebrow::before {
  content: '';
  width: 20px; height: 2px;
  background: var(--blue);
}
.curr-title {
  font-family: 'Fraunces', serif;
  font-size: 38px;
  font-weight: 800;
  letter-spacing: -.03em;
  color: var(--tx);
  margin-bottom: 10px;
  line-height: 1;
}
.curr-sub {
  font-size: 15px;
  color: var(--tx3);
  line-height: 1.7;
  max-width: 560px;
}

/* Progress bar */
.curr-progress-bar-wrap { margin-bottom: 40px; }
.curr-progress-lbl {
  display: flex;
  justify-content: space-between;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  letter-spacing: .1em;
  text-transform: uppercase;
  color: var(--tx4);
  font-weight: 600;
  margin-bottom: 8px;
}
.curr-progress-track {
  height: 6px;
  background: var(--bg3);
  border-radius: 99px;
  overflow: hidden;
}
.curr-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), #60a5fa);
  border-radius: 99px;
  transition: width 1.2s cubic-bezier(.4,0,.2,1);
}

/* Module cards */
.curr-modules {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.curr-mod {
  background: var(--bg1);
  border: 1.5px solid var(--bdr);
  border-radius: 16px;
  display: flex;
  gap: 0;
  overflow: hidden;
  box-shadow: 0 1px 4px rgba(30,40,80,.05);
  transition: all .18s;
  cursor: pointer;
}
.curr-mod.live {
  border-color: rgba(37,99,235,.25);
  box-shadow: 0 2px 12px rgba(37,99,235,.08);
}
.curr-mod.live:hover {
  border-color: rgba(37,99,235,.5);
  box-shadow: 0 4px 20px rgba(37,99,235,.12);
  transform: translateY(-2px);
}
.curr-mod.locked {
  opacity: .72;
}
.curr-mod.locked:hover {
  opacity: .9;
  border-color: var(--bdr2);
}

/* Left accent strip */
.curr-mod-left {
  width: 68px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 22px 0 22px;
  gap: 8px;
  background: var(--bg2);
  border-right: 1px solid var(--bdr);
}
.curr-mod.live .curr-mod-left {
  background: rgba(37,99,235,.04);
  border-right-color: rgba(37,99,235,.1);
}
.curr-mod-num {
  font-family: 'Fraunces', serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--bg4);
  line-height: 1;
  letter-spacing: -.04em;
}
.curr-mod.live .curr-mod-num { color: var(--blue); opacity: .4; }
.curr-mod-icon { font-size: 22px; line-height: 1; }

/* Body */
.curr-mod-body {
  padding: 20px 24px;
  flex: 1;
  min-width: 0;
}
.curr-mod-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 12px;
}
.curr-mod-name {
  font-family: 'Fraunces', serif;
  font-size: 19px;
  font-weight: 700;
  color: var(--tx);
  margin-bottom: 4px;
  letter-spacing: -.02em;
}
.curr-mod-sub {
  font-size: 13px;
  color: var(--tx3);
  line-height: 1.6;
  max-width: 480px;
}
.curr-mod-tag {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: .1em;
  text-transform: uppercase;
  padding: 5px 12px;
  border-radius: 99px;
  white-space: nowrap;
  flex-shrink: 0;
}
.tag-live {
  background: rgba(5,150,105,.1);
  color: var(--green);
  border: 1px solid rgba(5,150,105,.2);
}
.tag-soon {
  background: var(--bg3);
  color: var(--tx4);
  border: 1px solid var(--bdr2);
}

/* Condition pills */
.curr-mod-conditions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 14px;
}
.curr-cond-pill {
  font-size: 11.5px;
  color: var(--tx3);
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: 6px;
  padding: 3px 10px;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: .01em;
}
.curr-cond-pill.pill-live {
  color: var(--blue);
  background: var(--blue-dim);
  border-color: rgba(37,99,235,.18);
}

/* Footer row */
.curr-mod-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 12px;
  border-top: 1px solid var(--bdr);
}
.curr-mod-count {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--tx4);
  letter-spacing: .08em;
  text-transform: uppercase;
  font-weight: 600;
}
.curr-mod-cta {
  font-size: 13px;
  font-weight: 600;
  color: var(--blue);
  display: flex;
  align-items: center;
  gap: 4px;
}
.curr-cta-arr {
  transition: transform .15s;
}
.curr-mod.live:hover .curr-cta-arr { transform: translateX(4px); }
.curr-mod-notify {
  font-size: 12px;
  color: var(--tx3);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all .12s;
}
.curr-mod-notify:hover { background: var(--bg3); color: var(--tx); }

/* Sidebar section as link */
.sb-section-link {
  cursor: pointer;
  display: flex !important;
  align-items: center;
  transition: color .12s;
}
.sb-section-link:hover { color: var(--blue) !important; }
.sb-section-link.active { color: var(--blue) !important; }


/* ─── COMING SOON SCREEN ─── */
.cs-screen { padding: 48px 40px 64px; max-width: 720px; margin: 0 auto; }
.cs-hero { display:flex; align-items:center; gap:20px; margin-bottom:32px; padding-bottom:32px; border-bottom:1px solid var(--bdr); }
.cs-lock-icon { font-size: 44px; opacity: .55; flex-shrink:0; }
.cs-hero-text {}
.cs-module-tag { font-family:'IBM Plex Mono',monospace; font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:var(--blue); margin-bottom:8px; opacity:.7; }
.cs-title { font-family:'Fraunces',serif; font-size:32px; font-weight:800; letter-spacing:-.025em; margin-bottom:8px; line-height:1.15; }
.cs-sub { font-size:14px; color:var(--tx2); line-height:1.75; }
.cs-body { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:28px; }
@media(max-width:640px){.cs-body{grid-template-columns:1fr;}}
.cs-col-label { font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.16em; text-transform:uppercase; color:var(--tx4); margin-bottom:12px; }
.cs-conditions { display:flex; flex-direction:column; gap:6px; }
.cs-cond-pill { font-size:12.5px; color:var(--tx2); background:var(--bg2); border:1px solid var(--bdr2); border-radius:6px; padding:8px 14px; font-family:'IBM Plex Mono',monospace; display:flex; align-items:center; gap:8px; }
.cs-cond-pill::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--tx4); flex-shrink:0; }
.cs-notify { display:inline-flex; align-items:center; gap:10px; background:var(--blue-dim); border:1px solid rgba(74,158,255,.25); border-radius:8px; padding:14px 24px; cursor:pointer; font-size:13px; font-weight:500; color:var(--blue); transition:all .15s; margin-bottom:40px; }
.cs-notify:hover { background:rgba(74,158,255,.2); }
.cs-roadmap { background:var(--bg1); border:1px solid var(--bdr); border-radius:12px; overflow:hidden; }
.cs-roadmap-hdr { padding:14px 20px; border-bottom:1px solid var(--bdr); font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.14em; text-transform:uppercase; color:var(--tx3); }
.cs-roadmap-row { display:flex; align-items:center; gap:14px; padding:12px 20px; border-bottom:1px solid var(--bdr); transition:background .1s; }
.cs-roadmap-row:last-child { border-bottom:none; }
.cs-roadmap-row:hover { background:var(--bg2); }
.cs-roadmap-num { font-family:'Fraunces',serif; font-size:13px; font-style:italic; color:var(--tx4); width:20px; flex-shrink:0; }
.cs-roadmap-name { font-size:13px; color:var(--tx2); flex:1; }
.cs-roadmap-count { font-size:10.5px; font-family:'IBM Plex Mono',monospace; color:var(--tx4); margin-right:10px; }
.cs-roadmap-status { font-size:10.5px; font-family:'IBM Plex Mono',monospace; min-width:64px; text-align:right; }
.cs-roadmap-status.done { color:var(--green); }
.cs-roadmap-status.active { color:var(--blue); }
.cs-roadmap-status.soon { color:var(--tx4); }
.sb-icon { font-size: 14px; flex-shrink: 0; width: 18px; text-align: center; }
.sb-badge {
  margin-left: auto;
  background: var(--blue);
  color: #fff;
  font-size: 9px;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: 99px;
  font-family: 'IBM Plex Mono', monospace;
}
.sb-badge.amber { background: var(--amber); color: #000; }
.sb-badge.green { background: var(--green); color: #000; }

/* User strip */
.sb-user {
  padding: 12px 14px;
  border-top: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.sb-avatar {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--blue-dk), var(--purp));
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 600; color: #fff;
  flex-shrink: 0;
  font-family: 'Fraunces', serif;
}
.sb-user-name { font-size: 12.5px; font-weight: 500; color: var(--tx); }
.sb-user-role { font-size: 10.5px; color: var(--tx3); font-family: 'IBM Plex Mono', monospace; }

/* ═══════════════ MAIN ═══════════════ */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

/* Topbar */
.topbar {
  height: var(--hdr);
  background: var(--bg1);
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 14px;
  flex-shrink: 0;
}
.tb-title {
  font-family: 'Fraunces', serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--tx);
  letter-spacing: -.01em;
  flex: 1;
}
.tb-mono {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  color: var(--tx3);
  letter-spacing: .08em;
}
.tb-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px;
  border-radius: 6px;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 12px; font-weight: 500;
  cursor: pointer;
  transition: all .15s;
  border: 1px solid var(--bdr2);
  background: transparent;
  color: var(--tx2);
  -webkit-appearance: none;
  touch-action: manipulation;
  -webkit-tap-highlight-color: rgba(37,99,235,.12);
}
.tb-btn:hover { border-color: var(--bdr3); color: var(--tx); background: var(--bg2); }
.tb-btn.primary {
  background: var(--blue);
  color: #fff;
  border-color: var(--blue);
  box-shadow: 0 2px 8px rgba(37,99,235,.18);
}
.tb-btn.primary:hover { background: #6aaeff; }
.mode-toggle {
  display: flex;
  background: var(--bg);
  border: 1px solid var(--bdr);
  border-radius: 6px;
  padding: 3px;
  gap: 2px;
}
.mt-btn {
  padding: 5px 13px;
  border-radius: 4px;
  font-size: 11.5px;
  font-weight: 500;
  cursor: pointer;
  color: var(--tx3);
  transition: all .15s;
  white-space: nowrap;
}
.mt-btn:hover { color: var(--tx2); }
.mt-btn.active { background: var(--bg3); color: var(--blue); }
.notif-btn {
  width: 32px; height: 32px;
  border-radius: 6px;
  border: 1px solid var(--bdr2);
  background: transparent;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 14px;
  transition: all .15s;
  position: relative;
}
.notif-btn:hover { background: var(--bg2); }
.notif-dot {
  position: absolute;
  top: 5px; right: 5px;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--red);
  border: 1.5px solid var(--bg1);
}

/* ═══════════════ SCREENS ═══════════════ */
.screens { flex:1; overflow:hidden; position:relative; }
.screen {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  overflow-y: scroll;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  display: none;
  background: var(--bg);
}
.screen.active {
  display: block;
  animation: screenIn .22s cubic-bezier(.4,0,.2,1) both;
}
/* Exchange uses flex layout */
@keyframes screenIn {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}

/* ═══════════════════════════════════════
   SCREEN: DASHBOARD
═══════════════════════════════════════ */

.dash {
  padding: 28px 36px 64px;
  max-width: 1280px;
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 0 24px;
  align-items: start;
}
.dash-main-col {
  min-width: 0;
  display: flex;
  flex-direction: column;
}
.dash-pearl-col {
  position: sticky;
  top: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ─── HERO CARD ─────────────────────────────── */
/* Name + streak calendar + XP in one unified card */
.dash-hero {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 16px;
  margin-bottom: 20px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(30,40,80,.07);
  display: grid;
  grid-template-columns: 1fr 200px;
}
.dh-main {
  padding: 28px 32px 26px;
  border-right: 1px solid var(--bdr);
}
.dh-greeting {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx3);
  margin-bottom: 5px;
}
.dh-name {
  font-family: 'Fraunces', serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--tx);
  letter-spacing: -.03em;
  line-height: 1.1;
  margin-bottom: 18px;
}
.dh-name span { color: var(--blue); }

/* Streak calendar — 2 rows of 7 days */
.streak-cal-wrap {
  margin-bottom: 16px;
}
.streak-cal-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.streak-flame {
  font-size: 20px;
  line-height: 1;
}
.streak-count {
  font-family: 'Fraunces', serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--amber);
  line-height: 1;
}
.streak-count-lbl {
  font-size: 12px;
  color: var(--tx3);
  margin-left: 1px;
}
.streak-best {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--tx4);
  letter-spacing: .06em;
  margin-left: auto;
}
.streak-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}
.sg-cell {
  aspect-ratio: 1;
  border-radius: 6px;
  border: 1.5px solid transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px;
  font-weight: 600;
  letter-spacing: .02em;
  position: relative;
  transition: transform .1s;
}
.sg-cell:hover { transform: scale(1.1); }
.sg-cell.done {
  background: linear-gradient(135deg, rgba(217,119,6,.18), rgba(217,119,6,.1));
  border-color: rgba(217,119,6,.3);
  color: var(--amber);
}
.sg-cell.today {
  background: var(--amber);
  border-color: #b45309;
  color: #fff;
  box-shadow: 0 2px 8px rgba(217,119,6,.35);
  font-weight: 700;
}
.sg-cell.missed {
  background: var(--bg2);
  border-color: rgba(220,38,38,.15);
  color: rgba(220,38,38,.35);
}
.sg-cell.future {
  background: var(--bg2);
  border-color: var(--bdr);
  color: var(--tx4);
  opacity: .4;
}
.sg-row-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8px;
  letter-spacing: .08em;
  color: var(--tx4);
  text-transform: uppercase;
  margin-bottom: 4px;
  margin-top: 10px;
}

/* Accuracy pill row */
.dh-stats-row {
  display: flex;
  gap: 10px;
}
.dh-stat-pill {
  display: flex;
  align-items: center;
  gap: 7px;
  background: var(--bg2);
  border: 1px solid var(--bdr2);
  border-radius: 8px;
  padding: 7px 12px;
}
.dh-stat-val {
  font-family: 'Fraunces', serif;
  font-size: 16px;
  font-weight: 700;
  line-height: 1;
}
.dh-stat-val.green { color: var(--green); }
.dh-stat-val.blue { color: var(--blue); }
.dh-stat-lbl {
  font-size: 11.5px;
  color: var(--tx3);
}

/* XP panel — right side of hero */
.dh-xp {
  padding: 28px 24px 26px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  background: linear-gradient(160deg, rgba(37,99,235,.04), rgba(37,99,235,.01));
}
.dh-level-ring {
  width: 76px; height: 76px;
  border-radius: 50%;
  border: 2.5px solid rgba(37,99,235,.2);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(37,99,235,.05);
  position: relative;
}
.dh-level-ring::before {
  content: '';
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  border: 1px dashed rgba(37,99,235,.12);
}
.dh-lvl-num {
  font-family: 'Fraunces', serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--blue);
  line-height: 1;
}
.dh-lvl-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 7px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--blue);
  opacity: .55;
}
.dh-xp-info { width: 100%; text-align: center; }
.dh-xp-pts {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  color: var(--blue);
  font-weight: 600;
  margin-bottom: 7px;
}
.dh-xp-track {
  height: 6px;
  background: var(--bg3);
  border-radius: 99px;
  overflow: hidden;
  margin-bottom: 6px;
}
.dh-xp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue-dk), var(--blue));
  border-radius: 99px;
  transition: width 1.1s cubic-bezier(.4,0,.2,1);
}
.dh-xp-next {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--tx4);
  line-height: 1.6;
}
.dh-xp-today {
  font-size: 11px;
  color: var(--green);
  font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}

/* ─── MIDDLE GRID ──────────────────────────── */
.dash-mid {
  display: grid;
  grid-template-columns: 1fr 264px;
  gap: 16px;
  margin-bottom: 20px;
}

/* Mission card */
.mission-card {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 14px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 2px 8px rgba(30,40,80,.06);
}
.mission-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--blue), #818cf8);
}
.mc-header {
  padding: 15px 22px 13px;
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.mc-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx3);
  font-weight: 600;
}
.mc-xp-pill {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  font-weight: 700;
  color: var(--amber);
  background: var(--amber-dim);
  border: 1px solid rgba(217,119,6,.2);
  padding: 3px 10px;
  border-radius: 99px;
}
.mc-body { padding: 20px 22px 18px; }
.mc-condition {
  font-family: 'Fraunces', serif;
  font-size: 23px;
  font-weight: 800;
  letter-spacing: -.025em;
  color: var(--tx);
  line-height: 1.15;
  margin-bottom: 3px;
}
.mc-sub {
  font-size: 12.5px;
  color: var(--tx3);
  margin-bottom: 18px;
}
.mc-tasks {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 20px;
}
.mc-task {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--tx2);
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--bg2);
  border: 1px solid var(--bdr);
  line-height: 1.3;
}
.mc-task::before {
  content: '○';
  color: var(--tx4);
  font-size: 12px;
  flex-shrink: 0;
  width: 14px;
}
.mc-task.done {
  color: var(--green);
  background: var(--green-dim);
  border-color: rgba(5,150,105,.2);
  opacity: .8;
}
.mc-task.done::before { content: '✓'; color: var(--green); }
.mc-actions { display: flex; gap: 8px; }
.mc-btn-primary {
  flex: 1;
  text-align: center;
  background: var(--blue);
  color: #fff;
  padding: 10px 18px;
  border-radius: 9px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .14s;
  box-shadow: 0 2px 10px rgba(37,99,235,.22);
  letter-spacing: .01em;
}
.mc-btn-primary:hover { background: var(--blue-dk); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(37,99,235,.28); }
.mc-btn-secondary {
  padding: 10px 16px;
  border-radius: 9px;
  font-size: 13px;
  font-weight: 500;
  color: var(--tx2);
  background: var(--bg2);
  border: 1px solid var(--bdr2);
  cursor: pointer;
  transition: all .14s;
  white-space: nowrap;
}
.mc-btn-secondary:hover { background: var(--bg3); color: var(--tx); }

/* Stats sidebar */
.dash-stats {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.dash-stat-card {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 12px;
  padding: 18px 20px;
  box-shadow: 0 1px 4px rgba(30,40,80,.05);
  flex: 1;
}
.dsc-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9.5px;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--tx3);
  font-weight: 600;
  margin-bottom: 8px;
}
.dsc-value {
  font-family: 'Fraunces', serif;
  font-size: 34px;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 3px;
}
.dsc-sub {
  font-size: 11.5px;
  color: var(--tx3);
}
.dsc-value.green { color: var(--green); }
.dsc-value.blue { color: var(--blue); }
.dsc-value.amber { color: var(--amber); }

/* ─── MODULE SECTION ───────────────────────── */
.module-section {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 1px 4px rgba(30,40,80,.05);
}
.mod-sec-header {
  padding: 16px 22px 14px;
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.mod-sec-title {
  font-family: 'Fraunces', serif;
  font-size: 15px;
  font-weight: 700;
  color: var(--tx);
}
.mod-sec-badge {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--green);
  background: var(--green-dim);
  border: 1px solid rgba(5,150,105,.2);
  padding: 3px 10px;
  border-radius: 99px;
  font-weight: 600;
  letter-spacing: .06em;
}
.mod-progress-bar { height: 3px; background: var(--bg3); }
.mod-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #059669, #34d399);
  transition: width 1.2s cubic-bezier(.4,0,.2,1);
}
.cond-list { padding: 0; }
.cond-row {
  display: grid;
  grid-template-columns: 36px 1fr 220px;
  align-items: center;
  padding: 14px 22px;
  border-bottom: 1px solid var(--bdr);
  cursor: pointer;
  transition: background .12s;
  gap: 0;
}
.cond-row:last-child { border-bottom: none; }
.cond-row:hover { background: var(--bg2); }
.cond-row:hover .cond-row-name { color: var(--blue); }
.cond-row-num {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--tx4);
  font-weight: 600;
  letter-spacing: .08em;
  padding-top: 2px;
}
.cond-row-main { display: flex; flex-direction: column; gap: 5px; }
.cond-row-name-wrap { display: flex; align-items: baseline; gap: 8px; }
.cond-row-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx);
  transition: color .12s;
}
.cond-row-aka {
  font-size: 11.5px;
  color: var(--tx4);
  font-style: italic;
}
.cond-row-hallmark {
  font-size: 12px;
  color: var(--tx3);
  line-height: 1.5;
}
.cond-row-tags {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-top: 1px;
}
.cond-tag {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px;
  font-weight: 600;
  letter-spacing: .06em;
  padding: 2px 7px;
  border-radius: 4px;
  border: 1px solid transparent;
  text-transform: uppercase;
}
.cond-tag.t-amber  { color: var(--amber); background: var(--amber-dim);  border-color: rgba(217,119,6,.18); }
.cond-tag.t-blue   { color: var(--blue);  background: var(--blue-dim);   border-color: rgba(37,99,235,.18); }
.cond-tag.t-green  { color: var(--green); background: var(--green-dim);  border-color: rgba(5,150,105,.18); }
.cond-tag.t-red    { color: var(--red);   background: var(--red-dim);    border-color: rgba(220,38,38,.18); }
.cond-tag.t-neutral { color: var(--tx3);  background: var(--bg2);        border-color: var(--bdr2); }

/* Right column: boards bar + metadata */
.cond-row-right {
  display: flex;
  align-items: center;
  gap: 14px;
  justify-content: flex-end;
}
.cond-boards-wrap {
  display: flex;
  align-items: center;
  gap: 7px;
}
.cond-boards-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px;
  color: var(--tx4);
  letter-spacing: .08em;
  text-transform: uppercase;
  white-space: nowrap;
}
.cond-boards-track {
  width: 72px;
  height: 5px;
  background: var(--bg3);
  border-radius: 99px;
  overflow: hidden;
}
.cond-boards-fill {
  height: 100%;
  border-radius: 99px;
  transition: width 1.2s cubic-bezier(.4,0,.2,1);
}
.cond-boards-fill.t-amber { background: linear-gradient(90deg, #b45309, var(--amber)); }
.cond-boards-fill.t-blue  { background: linear-gradient(90deg, var(--blue-dk), var(--blue)); }
.cond-boards-fill.t-green { background: linear-gradient(90deg, #047857, var(--green)); }
.cond-boards-fill.t-red   { background: linear-gradient(90deg, #991b1b, var(--red)); }
.cond-boards-pct {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9.5px;
  font-weight: 700;
  color: var(--tx3);
  min-width: 28px;
  text-align: right;
}
.cond-row-cases {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  color: var(--tx4);
  white-space: nowrap;
}
.cond-row-check {
  font-size: 14px;
  color: var(--green);
  font-weight: 700;
  line-height: 1;
}

/* ─── BOTTOM ROW ──────────────────────────── */
.dash-bottom {
  display: grid;
  grid-template-columns: 1fr 264px;
  gap: 16px;
}
.pearl-card {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 1px 4px rgba(30,40,80,.05);
}
.pearl-hdr {
  padding: 15px 22px 13px;
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  gap: 9px;
}
.pearl-hdr-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx3);
  font-weight: 600;
}
.pearl-body { padding: 4px 0 8px; }
.pearl-item {
  padding: 15px 22px;
  border-bottom: 1px solid var(--bdr);
}
.pearl-item:last-child { border-bottom: none; }
.pearl-cond {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--blue);
  font-weight: 600;
  margin-bottom: 6px;
}
.pearl-text {
  font-size: 13px;
  color: var(--tx2);
  line-height: 1.8;
}
.pearl-text strong { color: var(--tx); font-weight: 600; }

/* Trainer card */
.trainer-card {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 14px;
  padding: 22px 22px 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 1px 4px rgba(30,40,80,.05);
}
.tc-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx3);
  font-weight: 600;
  margin-bottom: 16px;
}
.tc-stats {
  display: flex;
  margin-bottom: 16px;
  background: var(--bg2);
  border-radius: 10px;
  border: 1px solid var(--bdr);
  overflow: hidden;
}
.tc-stats > div {
  flex: 1;
  padding: 12px 8px;
  text-align: center;
  border-right: 1px solid var(--bdr);
}
.tc-stats > div:last-child { border-right: none; }
.tc-stat-val {
  font-family: 'Fraunces', serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--tx);
  line-height: 1;
  margin-bottom: 3px;
}
.tc-stat-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--tx4);
}
.tc-desc {
  font-size: 12.5px;
  color: var(--tx3);
  line-height: 1.75;
  margin-bottom: 18px;
  flex: 1;
}
.tc-btn {
  background: var(--blue);
  color: #fff;
  padding: 11px 16px;
  border-radius: 9px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: all .14s;
  box-shadow: 0 2px 10px rgba(37,99,235,.22);
  letter-spacing: .01em;
}
.tc-btn:hover { background: var(--blue-dk); transform: translateY(-1px); }

/* remove old classes */
.xp-bar-wrap, .streak-row, .dash-top, .stat-col, .cond-grid-section, .cond-grid,
.cg-item, .cg-num, .cg-name, .cg-meta, .cg-check, .xp-level-badge, .xp-main,
.xp-right, .xp-stat, .xp-fill, .xp-track, .xp-top-row, .xp-pts, .xp-sub-row,
.xp-sub, .xp-title, .streak-dot, .streak-label, .streak-fire, .stat-tile,
.stat-col { display: none !important; }

/* ═══════════════════════════════════════
   SCREEN: PATHOLOGY — Teaching Mode
═══════════════════════════════════════ */

.path-wrap { display:grid; grid-template-columns:1fr 256px; min-height:100%; }
.path-panel { padding:20px 14px; position:sticky; top:0; max-height:calc(100vh - var(--hdr)); overflow-y:auto; border-left:1px solid var(--bdr); background:var(--bg1); }

/* ── Teach layout ─────────────────────── */
.teach-wrap { padding:40px 48px 80px; max-width:720px; }

/* Header */
.teach-eyebrow {
  font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.18em;
  text-transform:uppercase; color:var(--blue); font-weight:600; margin-bottom:12px;
  display:flex; align-items:center; gap:10px;
}
.teach-eyebrow::before { content:''; width:20px; height:2px; background:var(--blue); flex-shrink:0; }
.teach-title {
  font-family:'Fraunces',serif; font-size:46px; font-weight:800;
  letter-spacing:-.035em; line-height:.95; color:var(--tx); margin-bottom:8px;
}
.teach-aka { font-family:'Fraunces',serif; font-size:17px; font-style:italic; color:var(--tx3); margin-bottom:14px; }
.teach-tagrow { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:32px; }

/* ctag reuse */
.ctag { font-size:10px; font-weight:600; padding:4px 11px; border-radius:99px; font-family:'IBM Plex Mono',monospace; letter-spacing:.04em; }
.ctag.blue  { background:var(--blue-dim);  color:var(--blue);  border:1px solid rgba(37,99,235,.2); }
.ctag.green { background:var(--green-dim); color:var(--green); border:1px solid rgba(5,150,105,.2); }
.ctag.red   { background:var(--red-dim);   color:var(--red);   border:1px solid rgba(220,38,38,.18); }
.ctag.amber { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(217,119,6,.2); }
.ctag.purp  { background:var(--purp-dim);  color:var(--purp);  border:1px solid rgba(124,58,237,.18); }
.ctag.slate { background:var(--bg3); color:var(--tx3); border:1px solid var(--bdr2); }

/* ── Section label ────────────────────── */
.teach-section-lbl {
  font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.16em;
  text-transform:uppercase; color:var(--tx3); font-weight:700;
  margin-bottom:14px; display:flex; align-items:center; gap:10px;
}
.teach-section-lbl::after { content:''; flex:1; height:1px; background:var(--bdr2); }

/* ── Why this is hard ─────────────────── */
.teach-why-hard {
  display:flex; gap:14px; align-items:flex-start;
  background:rgba(37,99,235,.04); border:1px solid rgba(37,99,235,.1);
  border-radius:12px; padding:18px 20px; margin-bottom:28px;
}
.teach-why-icon { font-size:20px; flex-shrink:0; margin-top:1px; line-height:1; }
.teach-why-text { font-size:14px; color:var(--tx2); line-height:1.8; font-style:italic; }

/* ── Core idea ────────────────────────── */
.teach-core { margin-bottom:28px; }
.teach-core-text {
  font-size:15.5px; line-height:1.9; color:var(--tx2); margin-bottom:14px;
  padding-bottom:14px; border-bottom:1px solid var(--bdr);
}
.teach-core-text strong { color:var(--tx); font-weight:600; }
.teach-the-number {
  font-size:14px; line-height:1.75; color:var(--tx2);
  padding:14px 18px; background:var(--amber-dim); border:1px solid rgba(217,119,6,.2);
  border-left:3px solid var(--amber); border-radius:0 10px 10px 0;
}
.teach-the-number strong { color:var(--amber); font-weight:700; }

/* ── Fingerprint bars ─────────────────── */
.teach-fp-row {
  display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
  background:var(--bg1); border:1px solid var(--bdr); border-radius:12px;
  padding:14px 16px; margin-bottom:32px; box-shadow:0 1px 4px rgba(30,40,80,.05);
}
.teach-fp-item { display:flex; flex-direction:column; gap:5px; }
.teach-fp-k { font-family:'IBM Plex Mono',monospace; font-size:8px; letter-spacing:.1em; text-transform:uppercase; color:var(--tx4); font-weight:600; }
.teach-fp-bar { height:5px; background:var(--bg3); border-radius:99px; overflow:hidden; }
.teach-fp-fill { height:100%; border-radius:99px; transition:width 1s cubic-bezier(.4,0,.2,1); }
.teach-fp-fill.fp-green { background:linear-gradient(90deg,#047857,var(--green)); }
.teach-fp-fill.fp-amber { background:linear-gradient(90deg,#b45309,var(--amber)); }
.teach-fp-fill.fp-red   { background:linear-gradient(90deg,#991b1b,var(--red)); }
.teach-fp-v { font-family:'IBM Plex Mono',monospace; font-size:8.5px; font-weight:700; }
.teach-fp-v.fp-green { color:var(--green); }
.teach-fp-v.fp-amber { color:var(--amber); }
.teach-fp-v.fp-red   { color:var(--red); }

/* ── Diagram ──────────────────────────── */
.teach-diagram-block { margin-bottom:36px; }
.teach-visual-note {
  font-size:13.5px; color:var(--tx2); line-height:1.8;
  padding:12px 16px; background:var(--bg2); border-radius:8px;
  margin-bottom:14px; border:1px solid var(--bdr);
}
.teach-svg-wrap {
  background:#f8f9fb; border:1px solid var(--bdr); border-radius:14px;
  padding:24px; overflow:hidden; box-shadow:0 1px 6px rgba(30,40,80,.07);
}

/* ── Logic chain ──────────────────────── */
.teach-chain-block { margin-bottom:36px; }
.teach-chain-step { display:flex; align-items:flex-start; gap:0; }
.teach-chain-left { display:flex; flex-direction:column; align-items:center; width:48px; flex-shrink:0; }
.teach-chain-num {
  width:32px; height:32px; border-radius:50%;
  background:var(--blue); color:#fff;
  font-family:'Fraunces',serif; font-size:15px; font-weight:800; line-height:1;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.teach-chain-line { width:2px; flex:1; min-height:20px; background:linear-gradient(to bottom,rgba(37,99,235,.3),rgba(37,99,235,.08)); margin:5px 0; }
.teach-chain-body { padding:0 0 28px 16px; flex:1; min-height:48px; }
.teach-chain-q {
  font-family:'Fraunces',serif; font-size:15px; font-weight:700;
  color:var(--tx); margin-bottom:7px; line-height:1.3;
}
.teach-chain-a { font-size:13.5px; color:var(--tx2); line-height:1.85; }
.teach-chain-a strong { color:var(--tx); font-weight:600; }

/* ── Traps ────────────────────────────── */
.teach-traps-block { margin-bottom:36px; }
.teach-trap-card {
  background:var(--bg1); border:1.5px solid rgba(220,38,38,.18);
  border-radius:14px; overflow:hidden; margin-bottom:14px;
  box-shadow:0 2px 8px rgba(220,38,38,.06);
}
.teach-trap-hdr {
  display:flex; align-items:center; gap:10px;
  padding:12px 18px; background:rgba(220,38,38,.05);
  border-bottom:1px solid rgba(220,38,38,.1);
  font-family:'IBM Plex Mono',monospace; font-size:9px;
  letter-spacing:.14em; text-transform:uppercase; color:var(--red); font-weight:700;
}
.teach-trap-body { padding:16px 18px 0; }
.teach-trap-scene {
  background:var(--bg2); border:1px solid var(--bdr); border-radius:8px;
  padding:12px 14px; margin-bottom:10px;
}
.teach-trap-scene-lbl {
  font-family:'IBM Plex Mono',monospace; font-size:8px; letter-spacing:.1em;
  text-transform:uppercase; color:var(--tx4); font-weight:600; margin-bottom:6px;
}
.teach-trap-scene > div:last-child { font-size:13.5px; color:var(--tx); line-height:1.7; font-weight:500; }
.teach-trap-arrow { font-size:18px; color:var(--red); opacity:.5; text-align:center; padding:6px 0; }
.teach-trap-outcome {
  font-size:13.5px; color:var(--red); line-height:1.75;
  background:var(--red-dim); border:1px solid rgba(220,38,38,.15);
  border-radius:8px; padding:12px 14px; margin-bottom:0;
}
.teach-trap-fix {
  font-size:13px; color:var(--tx2); line-height:1.7;
  padding:14px 18px; border-top:1px solid var(--bdr);
}
.teach-trap-fix strong { color:var(--tx); font-weight:600; }

/* ── Contrast table ───────────────────── */
.teach-contrast-block { margin-bottom:36px; }
.teach-contrast-intro {
  font-size:14px; color:var(--tx2); line-height:1.8;
  margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--bdr);
}
.teach-vs-table { border:1px solid var(--bdr); border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(30,40,80,.05); }
.teach-vs-hdr { display:grid; grid-template-columns:130px 1fr 1fr; background:var(--bg2); border-bottom:1px solid var(--bdr2); }
.teach-vs-row { display:grid; grid-template-columns:130px 1fr 1fr; border-bottom:1px solid var(--bdr); }
.teach-vs-row:last-child { border-bottom:none; }
.teach-vs-row:hover { background:var(--bg2); }
.teach-vs-cell { padding:11px 14px; font-size:13px; color:var(--tx2); line-height:1.5; border-right:1px solid var(--bdr); }
.teach-vs-cell:last-child { border-right:none; }
.teach-vs-cell.lbl-col { font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.08em; text-transform:uppercase; color:var(--tx4); font-weight:600; }
.teach-vs-cell.a-col { font-size:13px; color:var(--tx2); background:rgba(37,99,235,.025); }
.teach-vs-cell.b-col { font-size:13px; color:var(--tx2); background:rgba(217,119,6,.02); }
.teach-vs-hdr .a-col { font-family:'Fraunces',serif; font-size:13px; font-weight:700; color:var(--blue); background:rgba(37,99,235,.05); padding:12px 14px; }
.teach-vs-hdr .b-col { font-family:'Fraunces',serif; font-size:13px; font-weight:700; color:var(--amber); background:rgba(217,119,6,.04); padding:12px 14px; }

/* ── Clinical flow ────────────────────── */
.teach-flow-block { margin-bottom:36px; }
.teach-flow-steps { display:flex; flex-direction:column; }
.teach-flow-node { background:var(--bg1); border:1px solid var(--bdr); border-radius:12px; overflow:hidden; box-shadow:0 1px 3px rgba(30,40,80,.05); }
.teach-flow-q { display:flex; align-items:flex-start; gap:12px; padding:14px 16px; border-bottom:1px solid var(--bdr); }
.teach-flow-q-num {
  width:26px; height:26px; border-radius:50%; background:var(--blue); color:#fff;
  font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:700;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.teach-flow-q-text { font-size:13.5px; font-weight:600; color:var(--tx); line-height:1.5; padding-top:2px; }
.teach-flow-answers { display:flex; gap:0; }
.teach-flow-yes, .teach-flow-no {
  flex:1; display:flex; align-items:flex-start; gap:8px;
  padding:10px 14px; font-size:12.5px; color:var(--tx2); line-height:1.55;
}
.teach-flow-yes { border-right:1px solid var(--bdr); background:rgba(5,150,105,.02); }
.teach-flow-no  { background:rgba(220,38,38,.02); }
.teach-flow-badge {
  font-family:'IBM Plex Mono',monospace; font-size:8px; font-weight:700;
  letter-spacing:.06em; padding:2px 8px; border-radius:4px; white-space:nowrap; flex-shrink:0; margin-top:2px;
}
.teach-flow-badge.yes { background:var(--green-dim); color:var(--green); border:1px solid rgba(5,150,105,.2); }
.teach-flow-badge.no  { background:var(--red-dim);   color:var(--red);   border:1px solid rgba(220,38,38,.18); }
.teach-flow-connector { width:2px; height:16px; background:var(--bdr2); margin:0 auto; }

/* ── Pearls ───────────────────────────── */
.teach-pearls-block { margin-bottom:36px; }
.teach-pearl-item {
  display:flex; gap:18px; align-items:flex-start;
  padding:16px 0; border-bottom:1px solid var(--bdr);
}
.teach-pearl-item:last-child { border-bottom:none; }
.teach-pearl-num {
  font-family:'Fraunces',serif; font-size:28px; font-weight:800;
  color:var(--bg4); line-height:.9; flex-shrink:0; min-width:36px;
  letter-spacing:-.04em;
}
.teach-pearl-lbl {
  font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.12em;
  text-transform:uppercase; color:var(--blue); font-weight:600; margin-bottom:6px;
}
.teach-pearl-txt { font-size:13.5px; color:var(--tx2); line-height:1.8; }
.teach-pearl-txt strong { color:var(--tx); font-weight:600; }

/* ── Mnemonic ─────────────────────────── */
.teach-mnem-block { margin-bottom:36px; }
.teach-mnem-card {
  background:linear-gradient(135deg,rgba(124,58,237,.07),rgba(124,58,237,.03));
  border:1.5px solid rgba(124,58,237,.18); border-radius:14px; padding:24px 28px;
}
.teach-mnem-word {
  font-family:'Fraunces',serif; font-size:30px; font-weight:800;
  letter-spacing:.14em; color:var(--purp); margin-bottom:18px; line-height:1;
}
.teach-mnem-line {
  font-size:14px; color:var(--tx2); padding:8px 0; line-height:1.5;
  border-bottom:1px solid rgba(124,58,237,.1); display:flex; gap:6px;
}
.teach-mnem-line:last-child { border-bottom:none; }
.teach-mnem-line strong { color:var(--purp); font-weight:800; font-family:'IBM Plex Mono',monospace; font-size:14px; min-width:18px; }

/* ── Quiz CTA ─────────────────────────── */
.teach-quiz-cta {
  background:var(--blue-dim); border:1px solid rgba(37,99,235,.2);
  border-radius:14px; padding:24px 28px;
  display:flex; align-items:center; justify-content:space-between; gap:20px; margin-top:12px;
}
.teach-quiz-cta h4 { font-family:'Fraunces',serif; font-size:20px; font-weight:700; color:var(--tx); margin-bottom:4px; }
.teach-quiz-cta p { font-size:12.5px; color:var(--tx3); }
.quiz-start {
  background:var(--blue); color:#fff; border:none; border-radius:10px;
  padding:12px 26px; font-family:'IBM Plex Sans',sans-serif; font-size:13px;
  font-weight:600; cursor:pointer; white-space:nowrap;
  box-shadow:0 2px 12px rgba(37,99,235,.25); transition:all .15s; flex-shrink:0;
}
.quiz-start:hover { background:var(--blue-dk); transform:translateY(-1px); }

/* ── Right panel — redesigned ─────────────── */
.path-panel {
  padding: 18px 14px 32px;
  position: sticky;
  top: 0;
  max-height: calc(100vh - var(--hdr));
  overflow-y: auto;
  border-left: 1px solid var(--bdr);
  background: var(--bg1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
/* scrollbar on panel */
.path-panel::-webkit-scrollbar { width: 4px; }
.path-panel::-webkit-scrollbar-track { background: transparent; }
.path-panel::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 4px; }

.rp-card {
  background: var(--bg);
  border: 1px solid var(--bdr);
  border-radius: 12px;
  padding: 14px 14px 12px;
  box-shadow: 0 1px 3px rgba(30,40,80,.05);
}
.rp-card-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx4);
  font-weight: 700;
  margin-bottom: 9px;
}

/* ── The one thing card ─── */
.rp-key {
  border-color: rgba(37,99,235,.15);
  background: rgba(37,99,235,.02);
}
.rp-key-text {
  font-size: 13px;
  color: var(--tx2);
  line-height: 1.75;
}
.rp-key-text strong { color: var(--tx); font-weight: 600; }

/* ── Don't confuse with ─── */
.rp-ddx-item {
  padding: 9px 10px;
  border: 1px solid var(--bdr);
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all .12s;
  background: var(--bg1);
}
.rp-ddx-item:last-child { margin-bottom: 0; }
.rp-ddx-item:hover { border-color: rgba(37,99,235,.3); background: var(--blue-dim); }
.rp-ddx-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--blue);
  margin-bottom: 4px;
}
.rp-ddx-why {
  font-size: 11.5px;
  color: var(--tx3);
  line-height: 1.55;
}

/* ── Quick Rx ─── */
.rp-rx-row { margin-bottom: 2px; }
.rp-rx-val {
  font-size: 12.5px;
  font-weight: 500;
  color: var(--tx);
  line-height: 1.5;
  display: block;
}

/* ── Module map ─── */
.rp-modmap {
  display: flex;
  flex-direction: column;
  gap: 0;
}
.rp-modmap-item {
  display: flex;
  align-items: center;
  gap: 9px;
  padding: 6px 8px;
  border-radius: 7px;
  cursor: pointer;
  transition: all .1s;
}
.rp-modmap-item:hover { background: var(--bg2); }
.rp-modmap-item.active { background: var(--blue-dim); }
.rp-modmap-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--bdr2);
  border: 1.5px solid var(--bdr2);
  flex-shrink: 0;
  transition: all .1s;
}
.rp-modmap-dot.done { background: var(--green); border-color: var(--green); }
.rp-modmap-dot.now  { background: var(--blue); border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
.rp-modmap-name {
  font-size: 11.5px;
  color: var(--tx3);
  line-height: 1.3;
}
.rp-modmap-item.active .rp-modmap-name { color: var(--blue); font-weight: 500; }

/* ── Trainer CTA ─── */
.rp-quiz-cta {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 14px;
  background: var(--bg);
  border: 1px solid var(--bdr);
  border-radius: 12px;
  cursor: pointer;
  transition: all .14s;
  box-shadow: 0 1px 3px rgba(30,40,80,.05);
}
.rp-quiz-cta:hover {
  border-color: rgba(37,99,235,.3);
  background: var(--blue-dim);
  transform: translateY(-1px);
}
.rp-quiz-icon { font-size: 20px; flex-shrink: 0; line-height: 1; }
.rp-quiz-title { font-size: 13px; font-weight: 600; color: var(--tx); margin-bottom: 2px; }
.rp-quiz-sub   { font-size: 11px; color: var(--tx3); }
.rp-quiz-arrow { font-size: 16px; color: var(--blue); margin-left: auto; opacity: .6; transition: transform .14s; }
.rp-quiz-cta:hover .rp-quiz-arrow { opacity: 1; transform: translateX(3px); }



/* ═══════════════════════════════════════
   TRAINER — Complete Styling
═══════════════════════════════════════ */

/* ── Outer layout ─────────────────────── */
.trainer-screen {
  min-height: 100%;
  background: var(--bg);
  display: flex;
  flex-direction: column;
}
.trainer-inner {
  max-width: 900px;
  margin: 0 auto;
  padding: 36px 48px 80px;
  width: 100%;
}

/* ── Header block ─────────────────────── */
.t-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .18em; text-transform: uppercase;
  color: var(--blue); font-weight: 600; margin-bottom: 10px;
  display: flex; align-items: center; gap: 10px;
}
.t-eyebrow::before { content:''; width:20px; height:2px; background:var(--blue); flex-shrink:0; }
.t-title {
  font-family: 'Fraunces', serif; font-size: 32px; font-weight: 800;
  letter-spacing: -.03em; color: var(--tx); line-height: 1; margin-bottom: 6px;
}
.t-sub { font-size: 13.5px; color: var(--tx3); line-height: 1.7; margin-bottom: 28px; }

/* ── Progress bar + dots ──────────────── */
.t-prog-wrap {
  margin-bottom: 24px;
  padding: 16px 18px;
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.t-prog { display: flex; align-items: center; gap: 12px; }
.t-prog-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .12em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700; white-space: nowrap; min-width: 80px;
}
.t-prog-track {
  flex: 1; height: 5px; background: var(--bg3); border-radius: 99px; overflow: hidden;
}
.t-prog-fill {
  height: 100%; background: linear-gradient(90deg, var(--blue), #60a5fa);
  border-radius: 99px; transition: width .6s cubic-bezier(.4,0,.2,1);
}
.t-score {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .1em; text-transform: uppercase;
  color: var(--green); font-weight: 700; white-space: nowrap;
}
.t-dots { display: flex; gap: 5px; flex-wrap: wrap; }
.t-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--bg3); border: 1.5px solid var(--bdr2);
  transition: all .2s; cursor: default; flex-shrink: 0;
}
.t-dot.current {
  background: var(--blue); border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(37,99,235,.18);
  transform: scale(1.15);
}
.t-dot.done-correct { background: var(--green); border-color: var(--green); }
.t-dot.done-wrong   { background: var(--red);   border-color: var(--red); }

/* ── Case type strip ──────────────────── */
.case-type-strip {
  display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
}
.case-type-badge {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; font-weight: 700; letter-spacing: .12em; text-transform: uppercase;
  padding: 4px 12px; border-radius: 99px;
}
.case-type-badge.recognition { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(37,99,235,.2); }
.case-type-badge.trap        { background: var(--red-dim); color: var(--red); border: 1px solid rgba(220,38,38,.2); }
.case-type-badge.pediatric   { background: var(--green-dim); color: var(--green); border: 1px solid rgba(5,150,105,.2); }
.case-cond-tag {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9.5px; color: var(--tx4); letter-spacing: .06em;
}

/* ── Main case card ───────────────────── */
.case-card {
  background: var(--bg1);
  border: 1.5px solid var(--bdr);
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 2px 16px rgba(30,40,80,.08);
  display: flex;
  flex-direction: column;
}

/* ── Xray panel ───────────────────────── */
.xray-panel {
  background: #010306;
  position: relative;
  border-bottom: 1px solid #0d1420;
  overflow: hidden;
}
.xray-svg {
  width: 100%; height: auto; display: block;
  image-rendering: crisp-edges;
}
.xray-badge {
  position: absolute; top: 10px; left: 12px;
  background: rgba(255,255,255,.07); backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,.1);
  color: rgba(200,225,252,.75); font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .1em; text-transform: uppercase; font-weight: 600;
  padding: 4px 10px; border-radius: 6px;
}
.xray-badge2 {
  position: absolute; top: 10px; right: 12px;
  background: rgba(255,255,255,.06); backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,.08);
  color: rgba(160,200,245,.65); font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .08em; font-weight: 600;
  padding: 4px 10px; border-radius: 6px;
}

/* ── Case body ────────────────────────── */
.case-body { padding: 24px 26px 26px; }
.case-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700; margin-bottom: 10px;
}
.case-vig {
  font-size: 14.5px; color: var(--tx2); line-height: 1.85;
  margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--bdr);
}
.case-vig strong { color: var(--tx); font-weight: 600; }

/* ── Finding chips ────────────────────── */
.finds-row {
  display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 22px;
}
.find {
  display: flex; align-items: center; gap: 6px;
  font-size: 11.5px; font-family: 'IBM Plex Mono', monospace; font-weight: 600;
  padding: 5px 11px; border-radius: 8px; letter-spacing: .02em;
}
.fd {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.find.radio  { background: rgba(37,99,235,.08);  color: var(--blue);  border: 1px solid rgba(37,99,235,.16); }
.find.radio  .fd { background: var(--blue); }
.find.clinical { background: rgba(5,150,105,.08); color: var(--green); border: 1px solid rgba(5,150,105,.16); }
.find.clinical .fd { background: var(--green); }
.find.histo  { background: rgba(124,58,237,.08); color: var(--purp);  border: 1px solid rgba(124,58,237,.16); }
.find.histo  .fd { background: var(--purp); }

/* ── Confidence section ───────────────── */
.conf-section { margin-bottom: 20px; }
.conf-lbl-row { margin-bottom: 8px; }
.conf-label-txt {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .14em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700;
}
.conf-row { display: flex; gap: 8px; }
.conf-btn {
  flex: 1; text-align: center;
  padding: 9px 8px; border-radius: 9px;
  border: 1.5px solid var(--bdr2);
  background: var(--bg2); color: var(--tx3);
  font-size: 12px; font-weight: 500; cursor: pointer;
  transition: all .14s; line-height: 1;
}
.conf-btn:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-dim); }
.conf-btn.sel.lo { border-color: var(--amber); color: var(--amber); background: var(--amber-dim); }
.conf-btn.sel.md { border-color: var(--blue);  color: var(--blue);  background: var(--blue-dim); }
.conf-btn.sel.hi { border-color: var(--green); color: var(--green); background: var(--green-dim); }

/* ── Answer grid ──────────────────────── */
.ans-section-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .14em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700; margin-bottom: 10px;
}
.ans-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-bottom: 20px;
}
.ans-opt {
  padding: 13px 15px; border-radius: 11px;
  border: 1.5px solid var(--bdr2); background: var(--bg2);
  color: var(--tx2); font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all .15s; line-height: 1.3;
  position: relative; overflow: hidden;
}
.ans-opt::before {
  content: ''; position: absolute; inset: 0;
  background: var(--blue); opacity: 0; transition: opacity .12s;
  border-radius: 9px;
}
.ans-opt:hover { border-color: var(--blue); color: var(--blue); transform: translateY(-1px); box-shadow: 0 3px 12px rgba(37,99,235,.1); }
.ans-opt.correct {
  border-color: var(--green); background: var(--green-dim); color: var(--green);
  font-weight: 600;
  animation: ans-correct-pop .3s cubic-bezier(.34,1.56,.64,1) forwards;
}
.ans-opt.wrong {
  border-color: var(--red); background: var(--red-dim); color: var(--red);
  font-weight: 600;
  animation: ans-wrong-shake .35s ease forwards;
}
.ans-opt.reveal {
  border-color: var(--green); background: var(--green-dim); color: var(--green);
  opacity: .7;
}
@keyframes ans-correct-pop {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.03); }
  100% { transform: scale(1); }
}
@keyframes ans-wrong-shake {
  0%,100% { transform: translateX(0); }
  20%  { transform: translateX(-5px); }
  40%  { transform: translateX(5px); }
  60%  { transform: translateX(-3px); }
  80%  { transform: translateX(3px); }
}

/* ── Reveal section ───────────────────── */
.reveal-sec {
  display: none; opacity: 0;
  transition: opacity .3s ease;
  margin-top: 4px;
}
.reveal-sec.show { display: block; animation: fadeSlideUp .28s ease forwards; }
@keyframes fadeSlideUp {
  from { opacity:0; transform: translateY(8px); }
  to   { opacity:1; transform: translateY(0); }
}

/* ── Result banner ────────────────────── */
.result-banner {
  display: flex; align-items: flex-start; gap: 14px;
  padding: 16px 18px; border-radius: 12px; margin-bottom: 16px;
  border: 1.5px solid;
}
.result-banner.correct {
  background: var(--green-dim);
  border-color: rgba(5,150,105,.25);
}
.result-banner.wrong {
  background: var(--red-dim);
  border-color: rgba(220,38,38,.2);
}
.rb-ico { font-size: 22px; flex-shrink: 0; line-height: 1; margin-top: 1px; }
.rb-title {
  font-size: 15px; font-weight: 700; font-family: 'Fraunces', serif;
  color: var(--tx); margin-bottom: 4px; line-height: 1.2;
}
.result-banner.correct .rb-title { color: var(--green); }
.result-banner.wrong   .rb-title { color: var(--red); }
.rb-body { font-size: 13px; color: var(--tx2); line-height: 1.7; }

/* ── Reasoning breakdown ──────────────── */
.reasoning {
  background: var(--bg2); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 16px 18px; margin-bottom: 14px;
}
.reason-hdr {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.reason-hdr::after { content:''; flex:1; height:1px; background:var(--bdr2); }
.r-row {
  display: grid; grid-template-columns: 20px 1fr 1fr; gap: 8px;
  padding: 7px 0; border-bottom: 1px solid var(--bdr);
  align-items: start;
}
.r-row:last-child { border-bottom: none; padding-bottom: 0; }
.r-ico { font-size: 13px; font-weight: 700; line-height: 1.4; }
.r-key {
  font-size: 12px; color: var(--tx2); font-weight: 500; line-height: 1.5;
}
.r-val {
  font-size: 12px; font-weight: 600; line-height: 1.5; text-align: right;
}
.r-val.match { color: var(--green); }
.r-val.warn  { color: var(--amber); }
.r-val.err   { color: var(--red); }

/* ── Study nudge ──────────────────────── */
.study-nudge {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 16px; border-radius: 11px;
  background: var(--bg1); border: 1.5px solid var(--bdr);
  cursor: pointer; transition: all .14s; margin-bottom: 18px;
}
.study-nudge:hover { border-color: rgba(37,99,235,.3); background: var(--blue-dim); }
.study-nudge-ico { font-size: 18px; flex-shrink: 0; line-height: 1; }
.study-nudge-txt {
  flex: 1; font-size: 13px; color: var(--tx2); line-height: 1.5;
}
.study-nudge-txt strong { color: var(--tx); font-weight: 600; }
.study-nudge-arrow { font-size: 16px; color: var(--blue); opacity: .5; transition: all .14s; }
.study-nudge:hover .study-nudge-arrow { opacity: 1; transform: translateX(3px); }

/* ── Bottom buttons ───────────────────── */
.t-btns {
  display: flex; gap: 10px; flex-wrap: wrap;
}
.t-btn {
  padding: 12px 22px; border-radius: 10px;
  font-size: 13.5px; font-weight: 600; cursor: pointer;
  transition: all .14s; border: 1.5px solid; line-height: 1;
  font-family: inherit;
}
.t-btn.ghost {
  background: var(--bg1); border-color: var(--bdr2); color: var(--tx2);
}
.t-btn.ghost:hover { border-color: var(--tx3); color: var(--tx); }
.t-btn.primary {
  background: var(--blue); border-color: var(--blue); color: #fff;
  box-shadow: 0 2px 10px rgba(37,99,235,.22);
}
.t-btn.primary:hover { background: var(--blue-dk); transform: translateY(-1px); }

/* ── Results screen ───────────────────── */
.results-screen { max-width: 640px; }
.tc-score {
  font-family: 'Fraunces', serif; font-size: 72px; font-weight: 800;
  color: var(--tx); letter-spacing: -.05em; line-height: 1; margin-bottom: 4px;
}
.tc-pct {
  font-family: 'IBM Plex Mono', monospace; font-size: 14px;
  color: var(--blue); letter-spacing: .06em; font-weight: 700; margin-bottom: 6px;
}
.tc-lbl { font-size: 15px; color: var(--tx3); line-height: 1.6; margin-bottom: 28px; }
.score-bd {
  display: flex; gap: 12px; margin-bottom: 28px;
}
.sbi {
  flex: 1; padding: 16px 12px; text-align: center;
  background: var(--bg1); border: 1px solid var(--bdr); border-radius: 12px;
}
.sbi-num {
  font-family: 'Fraunces', serif; font-size: 30px; font-weight: 800;
  line-height: 1; margin-bottom: 4px;
}
.sbi-lbl {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  letter-spacing: .1em; text-transform: uppercase; color: var(--tx4); font-weight: 600;
}
.results-breakdown {
  background: var(--bg1); border: 1px solid var(--bdr);
  border-radius: 14px; padding: 18px 20px; margin-bottom: 18px;
}
.rb-section-hdr {
  font-family: 'IBM Plex Mono', monospace; font-size: 8.5px;
  letter-spacing: .16em; text-transform: uppercase; color: var(--tx4);
  font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
}
.rb-section-hdr::after { content:''; flex:1; height:1px; background:var(--bdr2); }
.rb-cond-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 0; border-bottom: 1px solid var(--bdr);
}
.rb-cond-row:last-child { border-bottom: none; padding-bottom: 0; }
.rb-cond-name { font-size: 13px; color: var(--tx2); font-weight: 500; }
.rb-cond-score {
  font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 700;
  padding: 3px 10px; border-radius: 6px;
}
.rb-cond-score.all-correct { color: var(--green); background: var(--green-dim); }
.rb-cond-score.all-wrong   { color: var(--red);   background: var(--red-dim); }
.rb-cond-score.some-wrong  { color: var(--amber);  background: var(--amber-dim); }
.insight-card {
  background: var(--bg1); border: 1.5px solid rgba(37,99,235,.15);
  border-left: 3px solid var(--blue);
  border-radius: 0 12px 12px 0; padding: 16px 18px; margin-bottom: 24px;
}
.insight-card-hdr {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  letter-spacing: .14em; text-transform: uppercase;
  color: var(--blue); font-weight: 700; margin-bottom: 8px;
}
.insight-card-txt {
  font-size: 13.5px; color: var(--tx2); line-height: 1.8;
}
.insight-card-txt strong { color: var(--tx); font-weight: 600; }
.results-btns { display: flex; gap: 10px; flex-wrap: wrap; }



/* ── Trainer polish additions ──────────── */
.finds-hdr {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .14em; text-transform: uppercase;
  color: var(--tx4); font-weight: 700; margin-bottom: 8px;
}
.xray-panel { min-height: 140px; }

/* Case card entrance */
.case-card {
  animation: card-enter .3s cubic-bezier(.2,.8,.4,1) forwards;
}
@keyframes card-enter {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

/* Trap case — red accent on card border */
.trainer-screen .case-type-strip:has(.trap) ~ .case-card,
.case-card.trap-case {
  border-color: rgba(220,38,38,.25);
}

/* ═══════════════════════════════════════════════
   COVER + LOGIN — Warm Light Theme
═══════════════════════════════════════════════ */

/* ── Shared base ─────────────────────────────── */
.cover-screen,
.login-screen {
  position: fixed;
  inset: 0;
  z-index: 999;
  overflow-y: scroll;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
}

/* ── Cover: warm split layout ────────────────── */
.cover-screen {
  display: grid;
  grid-template-columns: 1fr 420px;
  background: #faf8f4;
}

/* LEFT panel — editorial brand */
.cover-left {
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 48px 56px;
  background: #faf8f4;
  overflow: hidden;
}

/* Subtle warm texture */
.cover-left::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 30%, rgba(37,99,235,.05) 0%, transparent 70%),
    radial-gradient(ellipse 50% 60% at 80% 80%, rgba(5,150,105,.04) 0%, transparent 70%);
  pointer-events: none;
}

/* Decorative large number watermark */
.cover-left::after {
  content: '01';
  position: absolute;
  bottom: -40px;
  right: -20px;
  font-family: 'Fraunces', serif;
  font-size: 280px;
  font-weight: 800;
  color: rgba(37,99,235,.04);
  line-height: 1;
  letter-spacing: -.06em;
  pointer-events: none;
  user-select: none;
}

.cover-left-top { position: relative; z-index: 2; }
.cover-left-bottom { position: relative; z-index: 2; }

/* Logo */
.cover-logo {
  display: flex; align-items: center; gap: 12px; margin-bottom: 64px;
  opacity: 0; animation: cover-rise .5s .05s cubic-bezier(.2,.8,.4,1) forwards;
}
.cover-logo-gem {
  width: 38px; height: 38px; border-radius: 9px;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Fraunces', serif; font-size: 15px; font-weight: 800; color: #fff;
  box-shadow: 0 4px 16px rgba(37,99,235,.28);
}
.cover-logo-text {
  font-family: 'Fraunces', serif; font-size: 21px; font-weight: 700;
  color: #1a1d2e; letter-spacing: -.02em;
}
.cover-logo-text span { color: #2563eb; }

/* Headline */
.cover-headline {
  font-family: 'Fraunces', serif;
  font-size: clamp(34px, 4.2vw, 52px);
  font-weight: 800;
  line-height: 1.08;
  letter-spacing: -.04em;
  color: #1a1d2e;
  margin-bottom: 22px;
  opacity: 0; animation: cover-rise .6s .18s cubic-bezier(.2,.8,.4,1) forwards;
}
.cover-headline em {
  font-style: italic;
  color: #2563eb;
}

.cover-sub {
  font-size: 16px; color: #8087a8; line-height: 1.8;
  max-width: 460px; margin-bottom: 40px;
  opacity: 0; animation: cover-rise .6s .3s cubic-bezier(.2,.8,.4,1) forwards;
}

/* Proof points — horizontal list */
.cover-proof {
  display: flex; flex-direction: column; gap: 12px; margin-bottom: 0;
  opacity: 0; animation: cover-rise .6s .42s cubic-bezier(.2,.8,.4,1) forwards;
}
.cover-proof-item {
  display: flex; align-items: center; gap: 12px;
}
.cover-proof-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.cover-proof-dot.blue  { background: #2563eb; }
.cover-proof-dot.green { background: #059669; }
.cover-proof-dot.amber { background: #d97706; }
.cover-proof-text {
  font-size: 14px; color: #4a4f6a; line-height: 1.5;
}
.cover-proof-text strong { color: #1a1d2e; font-weight: 600; }

/* Bottom strip */
.cover-bottom-strip {
  opacity: 0; animation: cover-rise .5s .58s cubic-bezier(.2,.8,.4,1) forwards;
}
.cover-module-badge {
  display: inline-flex; align-items: center; gap: 8px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9.5px; font-weight: 700; letter-spacing: .14em; text-transform: uppercase;
  color: #059669;
  background: rgba(5,150,105,.07);
  border: 1px solid rgba(5,150,105,.18);
  padding: 6px 14px; border-radius: 99px;
}
.cover-module-badge::before {
  content: ''; width: 6px; height: 6px;
  background: #059669; border-radius: 50%; flex-shrink: 0;
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%,100% { opacity:1; transform:scale(1); }
  50%      { opacity:.5; transform:scale(.7); }
}

/* RIGHT panel — login form */
.cover-right {
  background: #ffffff;
  border-left: 1px solid rgba(30,40,80,.08);
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 48px 44px;
  position: relative;
}
.cover-right::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, #2563eb, #7c3aed);
}

/* Login form elements (reused in login screen) */
.login-form-wrap {
  opacity: 0; animation: cover-rise .5s .2s cubic-bezier(.2,.8,.4,1) forwards;
}
.login-welcome {
  font-family: 'Fraunces', serif;
  font-size: 24px; font-weight: 800; color: #1a1d2e;
  letter-spacing: -.025em; margin-bottom: 6px;
}
.login-welcome-sub {
  font-size: 13px; color: #8087a8; margin-bottom: 32px; line-height: 1.6;
}
.login-field {
  display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px;
}
.login-row { display: flex; gap: 12px; margin-bottom: 14px; }
.login-row .login-field { margin-bottom: 0; }
.login-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .14em; text-transform: uppercase;
  color: #8087a8; font-weight: 700;
}
.login-input {
  background: #f7f8fc; border: 1.5px solid rgba(30,40,80,.1);
  border-radius: 10px; color: #1a1d2e;
  font-size: 13.5px; font-family: inherit;
  padding: 11px 14px; outline: none;
  transition: all .14s; width: 100%; box-sizing: border-box;
}
.login-input::placeholder { color: #b0b6cc; }
.login-input:focus {
  border-color: rgba(37,99,235,.5);
  background: rgba(37,99,235,.03);
  box-shadow: 0 0 0 3px rgba(37,99,235,.1);
}
.login-select {
  cursor: pointer; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%238087a8' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px;
}
.login-btn {
  width: 100%; padding: 13px; border-radius: 11px;
  font-size: 14px; font-weight: 600; font-family: inherit;
  cursor: pointer; transition: all .16s;
  border: none; letter-spacing: .01em;
}
.login-btn:not(.login-btn-ghost) {
  background: #2563eb; color: #fff;
  box-shadow: 0 4px 16px rgba(37,99,235,.28);
  margin-bottom: 10px;
}
.login-btn:not(.login-btn-ghost):hover {
  background: #1d4ed8; transform: translateY(-1px);
  box-shadow: 0 6px 24px rgba(37,99,235,.38);
}
.login-btn-ghost {
  background: transparent;
  border: 1.5px solid rgba(30,40,80,.12) !important;
  color: #8087a8;
}
.login-btn-ghost:hover { border-color: rgba(30,40,80,.24) !important; color: #4a4f6a; background: #f7f8fc; }
.login-divider {
  display: flex; align-items: center; gap: 12px;
  margin: 12px 0; color: #b0b6cc; font-size: 11px;
}
.login-divider::before, .login-divider::after {
  content:''; flex:1; height:1px; background: rgba(30,40,80,.08);
}
.login-fine {
  text-align: center; font-size: 10.5px; color: #b0b6cc;
  line-height: 1.7; margin-top: 18px;
}
.login-fine strong { color: #8087a8; }

/* ── Standalone login screen (back from cover) ── */
.login-screen {
  background: #faf8f4;
  align-items: center;
  justify-content: center;
}
.login-back {
  position: absolute; top: 24px; left: 28px; z-index: 10;
  background: none; border: none; color: #8087a8;
  font-size: 13px; font-family: inherit;
  cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all .14s;
}
.login-back:hover { color: #1a1d2e; background: rgba(30,40,80,.06); }
.login-card {
  position: relative; z-index: 2;
  background: #ffffff;
  border: 1px solid rgba(30,40,80,.09);
  border-radius: 20px; padding: 40px 44px;
  width: 100%; max-width: 420px;
  box-shadow: 0 8px 48px rgba(30,40,80,.1), 0 2px 8px rgba(30,40,80,.06);
  animation: cover-rise .4s cubic-bezier(.2,.8,.4,1) forwards;
}
.login-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 3px; background: linear-gradient(90deg, #2563eb, #7c3aed);
  border-radius: 20px 20px 0 0;
}
.login-logo {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 28px; justify-content: center;
}
.login-title {
  font-family: 'Fraunces', serif;
  font-size: 24px; font-weight: 800; color: #1a1d2e;
  text-align: center; margin-bottom: 6px; letter-spacing: -.025em;
}
.login-sub {
  font-size: 13px; color: #8087a8; text-align: center;
  margin-bottom: 28px; line-height: 1.6;
}

/* ── Transition out ───────────────────────────── */
.cover-screen.exit,
.login-screen.exit {
  animation: screen-exit .45s cubic-bezier(.4,0,1,1) forwards;
}
@keyframes screen-exit {
  from { opacity:1; transform: scale(1); }
  to   { opacity:0; transform: scale(.98); pointer-events:none; }
}
@keyframes cover-rise {
  from { opacity:0; transform: translateY(14px); }
  to   { opacity:1; transform: translateY(0); }
}




/* ════════════════════════════════════════════════
   CLINICAL EXCHANGE — Complete
════════════════════════════════════════════════ */

/* Screen containers */
#screen-exchange { display:none; flex-direction:column; }
#screen-exchange.active { display:flex; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
#screen-lectures { display:none; }
#screen-lectures.active { display:block; }

/* Index */
.ex-index { height:100%; overflow-y:auto; }
.ex-index-wrap { max-width:740px; margin:0 auto; padding:40px 48px 80px; }

.ex-eyebrow {
  font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.18em;
  text-transform:uppercase; color:var(--blue); font-weight:600; margin-bottom:12px;
  display:flex; align-items:center; gap:10px;
}
.ex-eyebrow::before { content:''; width:20px; height:2px; background:var(--blue); flex-shrink:0; }

.ex-index-title {
  font-family:'Fraunces',serif; font-size:36px; font-weight:800;
  letter-spacing:-.03em; color:var(--tx); margin-bottom:8px;
}
.ex-index-sub { font-size:14px; color:var(--tx3); line-height:1.75; margin-bottom:28px; max-width:520px; }

.ex-filters { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:28px; }
.ex-filter {
  font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700;
  letter-spacing:.08em; padding:6px 14px; border-radius:99px; cursor:pointer;
  border:1.5px solid var(--bdr2); color:var(--tx3); background:var(--bg1); transition:all .12s;
}
.ex-filter:hover { border-color:var(--blue); color:var(--blue); }
.ex-filter.active { background:var(--blue); color:#fff; border-color:var(--blue); box-shadow:0 2px 8px rgba(37,99,235,.22); }

.ex-case-list { display:flex; flex-direction:column; gap:10px; }
.ex-case-row {
  background:var(--bg1); border:1.5px solid var(--bdr); border-radius:14px;
  padding:18px 20px; cursor:pointer; transition:all .14s;
  box-shadow:0 1px 4px rgba(30,40,80,.05);
}
.ex-case-row:hover { border-color:rgba(37,99,235,.3); transform:translateY(-1px); box-shadow:0 4px 16px rgba(37,99,235,.1); }
.ex-row-top { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.ex-row-type { font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--tx4); }
.ex-row-tag { font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; padding:3px 10px; border-radius:99px; }
.ex-row-tag.expert { background:rgba(5,150,105,.09); color:var(--green); border:1px solid rgba(5,150,105,.2); }
.ex-row-tag.verified { background:var(--blue-dim); color:var(--blue); border:1px solid rgba(37,99,235,.2); }
.ex-row-tag.new { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(217,119,6,.2); }
.ex-row-title { font-size:15px; font-weight:600; color:var(--tx); line-height:1.45; margin-bottom:14px; }
.ex-row-footer { display:flex; align-items:center; gap:14px; font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--tx4); }
.ex-row-poster { display:flex; align-items:center; gap:8px; flex:1; }
.ex-row-av { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:800; color:#fff; flex-shrink:0; }
.ex-row-av.resident { background:var(--blue); }
.ex-row-av.attending { background:var(--green); }
.ex-row-av.student { background:var(--amber); }

/* Thread: two-column layout */
.ex-thread { display:none; flex:1; overflow:hidden; }
.ex-thread.show { display:grid; grid-template-columns:380px 1fr; }

.ex-case-panel { border-right:1px solid var(--bdr); overflow-y:auto; background:var(--bg1); }
.ex-cp-inner { padding:24px 22px 60px; }

.ex-cp-tag { font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.14em; text-transform:uppercase; color:var(--tx4); font-weight:700; margin-bottom:10px; }
.ex-cp-title { font-family:'Fraunces',serif; font-size:17px; font-weight:700; color:var(--tx); line-height:1.35; letter-spacing:-.015em; margin-bottom:16px; }
.ex-cp-poster { display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:14px; border-bottom:1px solid var(--bdr); }
.ex-cp-av { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800; color:#fff; flex-shrink:0; }
.ex-cp-av.resident { background:var(--blue); }
.ex-cp-av.attending { background:var(--green); }
.ex-cp-name { font-size:13px; font-weight:600; color:var(--tx); margin-bottom:2px; }
.ex-cp-cred { font-size:11px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; }
.ex-cp-verified { margin-left:auto; font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--green); font-weight:700; background:var(--green-dim); border:1px solid rgba(5,150,105,.2); padding:3px 9px; border-radius:99px; }

.ex-imaging { background:#010306; border-radius:12px; overflow:hidden; margin-bottom:14px; }
.ex-img-bar { display:flex; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.07); padding:0 12px; }
.ex-img-tab { font-family:'IBM Plex Mono',monospace; font-size:9.5px; font-weight:700; color:rgba(200,220,255,.35); padding:8px 12px; cursor:pointer; border-bottom:2px solid transparent; transition:all .12s; }
.ex-img-tab.active { color:rgba(200,220,255,.8); border-bottom-color:var(--blue); }
.ex-img-view svg { width:100%; height:auto; display:block; }
.xray-svg { width:100%; height:auto; display:block; }

.ex-facts { background:var(--bg2); border:1px solid var(--bdr); border-radius:10px; overflow:hidden; margin-bottom:14px; }
.ex-fact { display:flex; padding:9px 14px; border-bottom:1px solid var(--bdr); gap:12px; }
.ex-fact:last-child { border-bottom:none; }
.ex-fact-key { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--tx4); font-weight:700; letter-spacing:.1em; text-transform:uppercase; white-space:nowrap; min-width:72px; }
.ex-fact-val { font-size:12.5px; color:var(--tx2); line-height:1.55; }
.ex-fact-val strong { color:var(--tx); font-weight:600; }
.ex-fact-val em { color:var(--tx3); font-style:normal; }

.ex-gate { background:var(--bg1); border:1.5px solid var(--bdr); border-radius:12px; padding:14px 16px; }
.ex-gate-lbl { font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.14em; text-transform:uppercase; color:var(--tx4); font-weight:700; margin-bottom:10px; }
.ex-diff-opts { display:flex; flex-direction:column; gap:7px; margin-bottom:10px; }
.ex-diff-opt { padding:10px 14px; border-radius:9px; border:1.5px solid var(--bdr2); background:var(--bg2); font-size:13px; color:var(--tx2); cursor:pointer; transition:all .13s; }
.ex-diff-opt:hover { border-color:var(--blue); color:var(--blue); background:var(--blue-dim); }
.ex-diff-opt.pending { border-color:var(--blue); color:var(--blue); background:var(--blue-dim); font-weight:600; }
.ex-diff-opt.correct { border-color:var(--green); background:var(--green-dim); color:var(--green); font-weight:600; pointer-events:none; }
.ex-diff-opt.wrong   { border-color:var(--red);   background:var(--red-dim);   color:var(--red);   font-weight:600; pointer-events:none; }
.ex-commit-btn { width:100%; padding:11px; background:var(--blue); color:#fff; border:none; border-radius:9px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .14s; }
.ex-commit-btn:hover:not(:disabled) { background:var(--blue-dk); }
.ex-commit-btn:disabled { opacity:.4; cursor:default; background:var(--tx3); }

/* Discussion panel */
.ex-disc-panel { overflow-y:auto; background:var(--bg); }
.ex-disc-inner { padding:24px 28px 60px; }

.ex-disc-locked { display:flex; flex-direction:column; align-items:center; justify-content:center; height:320px; gap:14px; text-align:center; }
.ex-disc-lock-icon { font-size:40px; opacity:.3; }
.ex-disc-lock-txt { font-size:14px; color:var(--tx4); line-height:1.7; max-width:220px; }

.ex-disc-result { display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:10px; margin-bottom:18px; font-size:13px; font-weight:600; }
.ex-disc-result.correct { background:var(--green-dim); color:var(--green); border:1px solid rgba(5,150,105,.2); }
.ex-disc-result.wrong   { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(217,119,6,.2); }

.ex-expert { background:var(--bg1); border:1.5px solid rgba(5,150,105,.22); border-radius:14px; padding:18px 20px; margin-bottom:18px; }
.ex-expert-badge { font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--green); margin-bottom:12px; }
.ex-expert-poster { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
.ex-expert-av { width:34px; height:34px; border-radius:50%; background:var(--green); color:#fff; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800; flex-shrink:0; }
.ex-expert-name { font-size:13px; font-weight:700; color:var(--tx); margin-bottom:2px; }
.ex-expert-cred { font-size:10.5px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; }
.ex-expert-body { font-size:13.5px; color:var(--tx2); line-height:1.85; }
.ex-expert-body strong { color:var(--tx); font-weight:600; }
.ex-expert-points { display:flex; flex-direction:column; gap:8px; margin:12px 0; }
.ex-expert-pt { display:flex; gap:10px; font-size:13px; color:var(--tx2); line-height:1.6; }
.ex-expert-pt-num { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--green); font-weight:700; flex-shrink:0; margin-top:2px; }
.ex-expert-footer { display:flex; align-items:center; gap:12px; margin-top:14px; padding-top:12px; border-top:1px solid var(--bdr); }
.ex-helpful-btn { background:var(--bg2); border:1.5px solid var(--bdr2); color:var(--tx3); font-size:12px; font-weight:600; padding:6px 14px; border-radius:8px; cursor:pointer; font-family:inherit; transition:all .13s; }
.ex-helpful-btn:hover, .ex-helpful-btn.voted { border-color:var(--green); color:var(--green); background:var(--green-dim); }
.ex-module-link { margin-left:auto; font-size:12px; color:var(--blue); font-weight:600; cursor:pointer; }
.ex-module-link:hover { text-decoration:underline; }

.ex-disc-section-lbl { font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.14em; text-transform:uppercase; color:var(--tx3); font-weight:700; margin:16px 0 12px; display:flex; align-items:center; gap:8px; }
.ex-disc-section-lbl::after { content:''; flex:1; height:1px; background:var(--bdr2); }

.ex-replies { display:flex; flex-direction:column; gap:10px; }
.ex-reply { background:var(--bg1); border:1px solid var(--bdr); border-radius:12px; padding:16px 18px; }
.ex-reply-hdr { display:flex; align-items:flex-start; gap:10px; margin-bottom:10px; }
.ex-reply-av { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:800; color:#fff; flex-shrink:0; }
.ex-reply-av.resident { background:var(--blue); }
.ex-reply-av.attending { background:var(--green); }
.ex-reply-av.student { background:var(--amber); }
.ex-reply-meta { flex:1; }
.ex-reply-name { font-size:12.5px; font-weight:700; color:var(--tx); margin-bottom:2px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.ex-reply-cred { font-size:10px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; }
.ex-reply-time { font-size:10px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; margin-top:2px; }
.ex-reply-rtag { font-family:'IBM Plex Mono',monospace; font-size:8.5px; font-weight:700; letter-spacing:.08em; text-transform:uppercase; padding:2px 8px; border-radius:99px; }
.ex-reply-rtag.dx    { background:var(--blue-dim); color:var(--blue); border:1px solid rgba(37,99,235,.18); }
.ex-reply-rtag.sx    { background:var(--red-dim); color:var(--red); border:1px solid rgba(220,38,38,.18); }
.ex-reply-rtag.path  { background:var(--purp-dim); color:var(--purp); border:1px solid rgba(124,58,237,.18); }
.ex-reply-rtag.boards { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(217,119,6,.18); }
.ex-reply-body { font-size:13px; color:var(--tx2); line-height:1.8; }
.ex-reply-body strong { color:var(--tx); font-weight:600; }
.ex-reply-actions { margin-top:10px; padding-top:8px; border-top:1px solid var(--bdr); }
.ex-vote-btn { font-size:11px; color:var(--tx3); font-weight:600; background:var(--bg2); border:1.5px solid var(--bdr2); padding:5px 12px; border-radius:7px; cursor:pointer; font-family:inherit; transition:all .13s; }
.ex-vote-btn:hover, .ex-vote-btn.voted { border-color:var(--green); color:var(--green); background:var(--green-dim); }

.ex-hind-section { margin-top:18px; background:var(--bg1); border:1.5px solid var(--bdr); border-radius:12px; padding:14px 16px; }
.ex-hind-lbl { font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.14em; text-transform:uppercase; color:var(--tx4); font-weight:700; margin-bottom:10px; }
.ex-hind-list { display:flex; flex-direction:column; gap:8px; margin-bottom:10px; }
.ex-hind-item { font-size:13px; color:var(--tx2); line-height:1.7; padding:8px 12px; background:var(--bg2); border-radius:8px; border:1px solid var(--bdr); }
.ex-hind-input-row { display:flex; gap:8px; }
#exHindInput { flex:1; padding:10px 14px; border-radius:9px; border:1.5px solid var(--bdr2); background:var(--bg2); font-size:13px; font-family:inherit; color:var(--tx); outline:none; transition:all .13s; }
#exHindInput:focus { border-color:rgba(37,99,235,.4); background:var(--blue-dim); }
.ex-hind-add { padding:10px 16px; background:var(--blue); color:#fff; border:none; border-radius:9px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .13s; white-space:nowrap; }
.ex-hind-add:hover { background:var(--blue-dk); }

/* ════════════════════════════════════════════════
   CE LECTURES — Complete
════════════════════════════════════════════════ */
.lec-wrap { max-width:740px; margin:0 auto; padding:40px 48px 80px; }
.lec-header { margin-bottom:28px; }
.lec-header-title { font-family:'Fraunces',serif; font-size:36px; font-weight:800; letter-spacing:-.03em; color:var(--tx); margin-bottom:8px; }
.lec-header-sub { font-size:14px; color:var(--tx3); line-height:1.75; max-width:520px; }

.lec-credit-bar { background:var(--bg1); border:1px solid var(--bdr); border-radius:12px; padding:16px 18px; margin-bottom:28px; display:flex; align-items:center; gap:16px; }
.lec-credit-nums { font-family:'Fraunces',serif; font-size:28px; font-weight:800; color:var(--tx); white-space:nowrap; line-height:1; }
.lec-credit-nums span { font-size:13px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; font-weight:600; }
.lec-credit-track-wrap { flex:1; }
.lec-credit-lbl { font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.12em; text-transform:uppercase; color:var(--tx4); font-weight:700; margin-bottom:7px; }
.lec-credit-track { height:6px; background:var(--bg3); border-radius:99px; overflow:hidden; }
.lec-credit-fill { height:100%; background:linear-gradient(90deg,var(--blue),#60a5fa); border-radius:99px; transition:width .8s cubic-bezier(.4,0,.2,1); }

.lec-filters { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:24px; }
.lec-filter { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; letter-spacing:.08em; padding:6px 14px; border-radius:99px; cursor:pointer; border:1.5px solid var(--bdr2); color:var(--tx3); background:var(--bg1); transition:all .12s; }
.lec-filter:hover { border-color:var(--blue); color:var(--blue); }
.lec-filter.active { background:var(--blue); color:#fff; border-color:var(--blue); }

.lec-section-lbl { font-family:'IBM Plex Mono',monospace; font-size:9px; letter-spacing:.16em; text-transform:uppercase; color:var(--tx3); font-weight:700; margin-bottom:14px; display:flex; align-items:center; gap:10px; }
.lec-section-lbl::after { content:''; flex:1; height:1px; background:var(--bdr2); }

.lec-list { display:flex; flex-direction:column; gap:10px; margin-bottom:32px; }
.lec-row { display:flex; align-items:center; gap:16px; background:var(--bg1); border:1.5px solid var(--bdr); border-radius:14px; padding:16px 18px; cursor:pointer; transition:all .14s; box-shadow:0 1px 4px rgba(30,40,80,.05); }
.lec-row:hover { border-color:rgba(37,99,235,.25); transform:translateY(-1px); box-shadow:0 4px 16px rgba(37,99,235,.09); }
.lec-row.locked { opacity:.55; cursor:default; }
.lec-row.locked:hover { transform:none; box-shadow:0 1px 4px rgba(30,40,80,.05); border-color:var(--bdr); }
.lec-row-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0; border:1px solid var(--bdr); }
.lec-row-body { flex:1; min-width:0; }
.lec-row-eyebrow { font-family:'IBM Plex Mono',monospace; font-size:8.5px; letter-spacing:.1em; text-transform:uppercase; color:var(--tx4); font-weight:600; margin-bottom:4px; }
.lec-row-title { font-size:14px; font-weight:600; color:var(--tx); line-height:1.4; margin-bottom:4px; }
.lec-row-meta { display:flex; gap:8px; font-size:11.5px; color:var(--tx3); font-family:'IBM Plex Mono',monospace; flex-wrap:wrap; }
.lec-row-progress { height:3px; background:var(--bg3); border-radius:99px; overflow:hidden; margin-top:7px; }
.lec-row-progress-fill { height:100%; background:var(--blue); border-radius:99px; }
.lec-row-right { display:flex; flex-direction:column; align-items:flex-end; gap:5px; flex-shrink:0; }
.lec-row-credits { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; color:var(--blue); letter-spacing:.06em; }
.lec-row-duration { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--tx4); }
.lec-row-done { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; color:var(--green); }
.lec-row-soon { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--tx4); font-weight:600; }



.ex-thread-layout {
  display: grid;
  grid-template-columns: 380px 1fr;
  height: 100%;
  overflow: hidden;
}

/* ── Lecture detail view ─────────────────────── */
.lec-detail-wrap { max-width:900px; margin:0 auto; padding:32px 48px 80px; }

.lec-detail-header {
  display:flex; gap:18px; align-items:flex-start; margin-bottom:28px;
}
.lec-detail-icon {
  width:56px; height:56px; border-radius:14px; display:flex;
  align-items:center; justify-content:center; font-size:26px;
  flex-shrink:0; border:1px solid var(--bdr);
}
.lec-detail-eyebrow {
  font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700;
  letter-spacing:.16em; text-transform:uppercase; color:var(--blue); margin-bottom:8px;
  display:flex; align-items:center; gap:8px;
}
.lec-detail-eyebrow::before { content:''; width:16px; height:2px; background:var(--blue); }
.lec-detail-title {
  font-family:'Fraunces',serif; font-size:26px; font-weight:800;
  color:var(--tx); line-height:1.2; letter-spacing:-.025em; margin-bottom:10px;
}
.lec-detail-stats {
  display:flex; align-items:center; gap:10px;
  font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--tx4);
  flex-wrap:wrap;
}
.lec-detail-tag {
  background:var(--blue-dim); color:var(--blue); border:1px solid rgba(37,99,235,.18);
  padding:2px 9px; border-radius:99px; font-size:9px; font-weight:700;
}

/* Player */
.lec-player {
  background:#010306; border-radius:14px; overflow:hidden; margin-bottom:28px;
}
.lec-player-inner {
  position:relative; padding:32px 24px 24px; cursor:pointer;
  min-height:120px; display:flex; flex-direction:column; justify-content:flex-end;
}
.lec-player-overlay {
  position:absolute; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:10px;
  background:rgba(1,3,6,.6); transition:opacity .2s;
}
.lec-player-inner:hover .lec-player-overlay { opacity:.85; }
.lec-play-btn {
  width:52px; height:52px; border-radius:50%;
  background:var(--blue); color:#fff; display:flex;
  align-items:center; justify-content:center;
  font-size:18px; padding-left:3px;
  box-shadow:0 4px 20px rgba(37,99,235,.5);
}
.lec-player-label {
  font-family:'IBM Plex Mono',monospace; font-size:9.5px; font-weight:700;
  color:rgba(200,220,255,.6); letter-spacing:.1em; text-transform:uppercase;
}
.lec-waveform {
  display:flex; align-items:flex-end; gap:3px; height:48px;
  position:relative; z-index:0;
}
.lec-wf-bar {
  width:6px; border-radius:3px; flex-shrink:0;
  background:rgba(255,255,255,.12); transition:background .2s;
}
.lec-wf-bar.played { background:rgba(37,99,235,.5); }
.lec-player-controls {
  padding:12px 20px 14px;
  border-top:1px solid rgba(255,255,255,.07);
}
.lec-player-prog-wrap {
  display:flex; align-items:center; gap:12px;
}
.lec-player-prog-track {
  flex:1; height:4px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden;
}
.lec-player-prog-fill { height:100%; background:var(--blue); border-radius:99px; }
.lec-player-time {
  font-family:'IBM Plex Mono',monospace; font-size:9.5px; color:rgba(200,220,255,.4);
  white-space:nowrap;
}

/* Two-column body */
.lec-detail-body { display:grid; grid-template-columns:1fr 280px; gap:28px; align-items:start; }
.lec-detail-section-lbl {
  font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700;
  letter-spacing:.14em; text-transform:uppercase; color:var(--tx3);
  margin-bottom:12px; margin-top:24px;
  display:flex; align-items:center; gap:8px;
}
.lec-detail-section-lbl::after { content:''; flex:1; height:1px; background:var(--bdr2); }

.lec-speaker-card {
  display:flex; gap:14px; align-items:flex-start;
  background:var(--bg1); border:1px solid var(--bdr);
  border-radius:12px; padding:16px 18px; margin-bottom:4px;
}
.lec-speaker-av {
  width:40px; height:40px; border-radius:50%; background:var(--blue);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:13px; font-weight:800; flex-shrink:0;
}
.lec-speaker-name { font-size:13.5px; font-weight:700; color:var(--tx); margin-bottom:4px; }
.lec-speaker-cred { font-size:12px; color:var(--tx3); line-height:1.6; }

.lec-detail-desc { font-size:14px; color:var(--tx2); line-height:1.85; }

.lec-objectives { display:flex; flex-direction:column; gap:10px; }
.lec-obj-row { display:flex; gap:12px; align-items:flex-start; }
.lec-obj-dot {
  width:7px; height:7px; border-radius:50%; background:var(--blue);
  flex-shrink:0; margin-top:6px;
}
.lec-obj-text { font-size:13.5px; color:var(--tx2); line-height:1.65; }

.lec-transcript {
  background:var(--bg1); border:1px solid var(--bdr); border-radius:12px;
  overflow:hidden; position:relative;
}
.lec-transcript-text {
  font-size:13.5px; color:var(--tx2); line-height:1.9; padding:18px 20px 80px;
  white-space:pre-line;
}
.lec-transcript-fade {
  position:absolute; bottom:0; left:0; right:0; height:100px;
  background:linear-gradient(transparent, var(--bg1));
  display:flex; align-items:flex-end; justify-content:center; padding-bottom:14px;
}

/* Right column cards */
.lec-cme-card {
  background:var(--bg1); border:1.5px solid var(--bdr);
  border-radius:14px; padding:20px; margin-bottom:16px;
}
.lec-cme-top { display:flex; gap:14px; align-items:center; margin-bottom:14px; }
.lec-cme-credits {
  font-family:'Fraunces',serif; font-size:36px; font-weight:800;
  color:var(--tx); line-height:1;
}
.lec-cme-lbl { font-size:13px; font-weight:700; color:var(--tx); margin-bottom:2px; }
.lec-cme-sub { font-size:11px; color:var(--tx4); font-family:'IBM Plex Mono',monospace; }
.lec-cme-prog-lbl {
  font-family:'IBM Plex Mono',monospace; font-size:8.5px; font-weight:700;
  letter-spacing:.12em; text-transform:uppercase; color:var(--tx4); margin-bottom:6px;
}
.lec-cme-prog-track {
  height:5px; background:var(--bg3); border-radius:99px; overflow:hidden; margin-bottom:16px;
}
.lec-cme-prog-fill { height:100%; background:var(--blue); border-radius:99px; }
.lec-start-btn {
  width:100%; padding:12px; border-radius:10px;
  background:transparent; border:1.5px solid var(--blue);
  font-size:14px; font-weight:700; cursor:pointer; font-family:inherit;
  transition:all .15s; letter-spacing:.01em;
}
.lec-start-btn:hover { background:var(--blue-dim); }

.lec-chapters-card {
  background:var(--bg1); border:1px solid var(--bdr);
  border-radius:14px; overflow:hidden;
}
.lec-chapters-hdr {
  display:flex; justify-content:space-between; align-items:center;
  padding:14px 16px; border-bottom:1px solid var(--bdr);
  font-size:13px; font-weight:700; color:var(--tx);
}
.lec-chapters-list { }
.lec-chapter {
  display:flex; align-items:center; gap:12px;
  padding:10px 16px; border-bottom:1px solid var(--bdr);
  transition:background .12s; cursor:default;
}
.lec-chapter:last-child { border-bottom:none; }
.lec-chapter.done .lec-chapter-title { color:var(--tx3); }
.lec-chapter-num {
  font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700;
  color:var(--tx4); width:16px; flex-shrink:0; text-align:center;
}
.lec-chapter-body { flex:1; min-width:0; }
.lec-chapter-title { font-size:12px; color:var(--tx); line-height:1.4; margin-bottom:2px; }
.lec-chapter-ts { font-family:'IBM Plex Mono',monospace; font-size:9.5px; color:var(--tx4); }
.lec-chapter-status { font-size:11px; color:var(--green); font-weight:700; flex-shrink:0; }

/* Back button for coming soon */
.lec-back-btn {
  background:var(--bg1); border:1.5px solid var(--bdr2); color:var(--tx3);
  padding:10px 20px; border-radius:10px; font-size:13px; font-weight:600;
  cursor:pointer; font-family:inherit; transition:all .13s;
}
.lec-back-btn:hover { border-color:var(--blue); color:var(--blue); background:var(--blue-dim); }


/* ═══════════════════════════════════════════════════════════════
   MOBILE NAV OVERLAY + HAMBURGER
   Sidebar slides in over content on mobile — never pushes layout
═══════════════════════════════════════════════════════════════ */
.mob-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(10,14,26,.55);
  backdrop-filter: blur(2px);
  z-index: 299;
  opacity: 0;
  transition: opacity .22s;
  pointer-events: none;
}
.mob-overlay.open { opacity: 1; pointer-events: all; display: block; }

.mob-hamburger {
  display: none;
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid var(--bdr2);
  background: var(--bg2);
  cursor: pointer;
  align-items: center; justify-content: center;
  flex-direction: column; gap: 4px;
  flex-shrink: 0;
}
.mob-hamburger span {
  display: block; width: 16px; height: 1.5px;
  background: var(--tx2); border-radius: 2px;
  transition: all .2s;
}

/* ── Wide-tablet: collapse XP panel before it clips ── */
/* ════════════════════════════════════════════════
   RESPONSIVE — CHRI HEALTH
   Three breakpoints: 1100 · 900 · 600
   Core fix: iOS Safari needs the SCREEN itself
   to scroll, not a hidden parent. We switch to
   100dvh app shell + scrollable .screen on mobile.
════════════════════════════════════════════════ */

/* ── 1100px: wide tablet / small laptop ── */
@media (max-width: 1100px) {
  .dash { grid-template-columns: 1fr !important; }
  .dash-pearl-col { position: static; }
  .dash-hero { grid-template-columns: 1fr; }
  .dh-xp {
    border-top: 1px solid var(--bdr); border-left: none;
    flex-direction: row; align-items: center;
    gap: 20px; padding: 18px 28px !important;
    justify-content: flex-start;
  }
  .dh-level-ring { width: 56px; height: 56px; flex-shrink: 0; }
  .dh-xp-info { text-align: left; }
  .dh-lvl-num { font-size: 20px !important; }
}

/* ── 900px: tablet + all phones ── */
@media (max-width: 900px) {

  /* ── ROOT SCROLL FIX ──────────────────────────
     iOS Safari ignores overflow-y:auto on children
     when any ancestor is overflow:hidden and has a
     fixed height. Solution: make the .screen the
     scroll root and let html/body be natural height.
  ─────────────────────────────────────────────── */
  html, body { height: 100%; overflow: hidden; }
  .app { height: 100dvh; overflow: hidden; display: flex; }
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
  .screens { flex: 1; overflow: hidden; position: relative; }
  .screen {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    overflow-y: scroll;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
    display: none;
  }
  .screen.active { display: block; }

  /* ── COVER PAGE ───────────────────────────── */
  .cover-screen {
    display: flex; flex-direction: column;
    min-height: 100%;
  }
  /* Cover: compact header bar on mobile — headline sits above form in one view */
  .cover-screen {
    display: flex; flex-direction: column;
    min-height: 100%;
  }
  .cover-left {
    display: flex; flex-direction: column;
    padding: 24px 24px 20px;
    background: #faf8f4;
    flex-shrink: 0;
  }
  .cover-left::after { display: none; }
  /* Hide the large decorative left content — show compact version */
  .cover-left-bottom { display: none; }
  .cover-logo { margin-bottom: 12px !important; }
  .cover-headline { font-size: 22px !important; line-height: 1.2 !important; margin-bottom: 0 !important; }
  .cover-sub { display: none; }
  .cover-proof { display: none; }
  .cover-bottom-strip { display: none; }
  .cover-right {
    border-left: none;
    border-top: 1px solid rgba(0,0,0,.08);
    padding: 24px 24px 40px !important;
    flex: 1;
    background: #fff;
  }
  .login-form-wrap { max-width: 100%; }

  /* ── SIDEBAR OVERLAY ─────────────────────── */
  .sidebar {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 300;
    width: min(280px, 85vw);
    transform: translateX(-110%);
    transition: transform .24s cubic-bezier(.4,0,.2,1);
    box-shadow: 4px 0 32px rgba(0,0,0,.2);
  }
  .sidebar.mob-open { transform: translateX(0); }
  .mob-overlay { display: block; }
  .mob-hamburger { display: flex; }
  .tb-mono { display: none; }

  /* ── TOPBAR ──────────────────────────────── */
  .topbar { padding: 0 12px; gap: 8px; }
  #topCta { font-size: 11px !important; padding: 6px 10px !important; }
  .mt-btn { font-size: 11px !important; padding: 5px 9px !important; }

  /* ── DASHBOARD ───────────────────────────── */
  .dash { padding: 16px 16px 80px; }
  .dash-hero { grid-template-columns: 1fr; }
  .dh-main { padding: 20px 20px 18px; }
  .dh-name { font-size: 26px !important; }
  .dh-xp {
    border-top: 1px solid var(--bdr); border-left: none;
    flex-direction: row; align-items: center;
    gap: 16px; padding: 16px 20px !important;
    justify-content: flex-start;
  }
  .dh-level-ring { width: 52px; height: 52px; flex-shrink: 0; }
  .dh-xp-info { text-align: left; }
  .dash-mid { grid-template-columns: 1fr; gap: 12px; }
  .dash-bottom { grid-template-columns: 1fr; gap: 12px; }
  .dash-stats { flex-direction: row; flex-wrap: wrap; }
  .dash-stat-card { flex: 1; min-width: 140px; }
  .sg-cell { width: 30px !important; height: 30px !important; font-size: 9px !important; }

  /* ── STUDY / PATHOLOGY ───────────────────── */
  .path-wrap { grid-template-columns: 1fr; }
  .path-right { display: none; }
  .teach-wrap { padding: 24px 20px 80px; }
  .teach-title { font-size: 32px !important; }
  .teach-tagrow { margin-bottom: 20px !important; }
  .teach-fp-row { gap: 8px !important; flex-wrap: wrap; }
  .teach-vs-hdr,
  .teach-vs-row { grid-template-columns: 100px 1fr 1fr !important; }

  /* ── TRAINER ─────────────────────────────── */
  .trainer-inner { padding: 20px 16px 80px; max-width: 100%; }
  .t-title { font-size: 24px !important; }
  .case-body { padding: 18px 16px 20px; }
  .case-vig { font-size: 14px !important; line-height: 1.7 !important; }
  .finds-row { flex-wrap: wrap; gap: 6px; }
  .ans-grid { gap: 8px !important; }
  .ans-opt { padding: 14px 14px; font-size: 13.5px; }
  .t-dots { gap: 4px !important; }
  .t-dot { width: 7px !important; height: 7px !important; }

  /* ── COMPARE TABLE ───────────────────────── */
  .cmp-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .cmp-table { min-width: 600px; }

  /* ── EXCHANGE / LECTURES ─────────────────── */
  .ex-thread-layout,
  .ex-thread.show { grid-template-columns: 1fr !important; }
  .ex-case-panel { border-right: none; border-bottom: 1px solid var(--bdr); max-height: 40vh; overflow-y: auto; }
  .lec-detail-body { grid-template-columns: 1fr !important; }
  .lec-detail-right { order: -1; }
  .ex-index-wrap,
  .lec-wrap,
  .lec-detail-wrap,
  .prog-wrap { padding: 20px 16px 80px !important; }

  /* ── RESULTS ─────────────────────────────── */
  .results-screen { padding: 20px 16px 80px !important; }
  .prog-score-row { flex-direction: column; gap: 12px; text-align: center; }
  .prog-conf-row { flex-direction: column; }
}

/* ── 600px: phones only ── */
@media (max-width: 600px) {
  .teach-title { font-size: 28px !important; }
  .teach-aka { font-size: 15px !important; }
  .lec-detail-title { font-size: 20px !important; }
  .ex-index-title, .lec-header-title { font-size: 24px !important; }
  .t-title { font-size: 22px !important; }
  .xray-panel { border-radius: 0 !important; }
  .ans-opt { padding: 15px 14px; font-size: 14px; min-height: 52px; }
  .finds-row { gap: 5px; }
  .rsn-row { flex-direction: column; gap: 3px; }
  .rsn-key { min-width: unset !important; font-size: 9px !important; }
  .prog-cond-name { min-width: 120px !important; font-size: 12px !important; }
}


/* ── Pearl Sidebar ──────────────────────────── */
.pearl-sidebar-card {
  background: var(--bg1);
  border: 1px solid var(--bdr);
  border-radius: 16px;
  padding: 20px 20px 18px;
  box-shadow: 0 2px 12px rgba(30,40,80,.07);
}
.psb-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; font-weight: 700; letter-spacing: .14em;
  text-transform: uppercase; color: var(--tx3);
  display: flex; align-items: center; gap: 7px;
  margin-bottom: 12px;
}
.psb-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.psb-cond {
  font-family: 'Fraunces', serif;
  font-size: 15px; font-weight: 700;
  letter-spacing: -.02em; margin-bottom: 8px;
}
.psb-tag {
  display: inline-block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; font-weight: 700; letter-spacing: .08em;
  padding: 3px 9px; border-radius: 99px; margin-bottom: 14px;
}
.psb-headline {
  font-size: 13.5px; font-weight: 700;
  color: var(--tx); line-height: 1.45; margin-bottom: 10px;
}
.psb-body {
  font-size: 12.5px; color: var(--tx2);
  line-height: 1.75; margin-bottom: 14px;
}
.psb-trap-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; font-weight: 700; letter-spacing: .1em;
  text-transform: uppercase; color: var(--amber); margin-bottom: 6px;
}
.psb-trap {
  font-size: 12px; color: var(--tx2); line-height: 1.7;
  background: var(--amber-dim); border-left: 2px solid var(--amber);
  padding: 8px 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;
}
.psb-btn {
  width: 100%; background: var(--blue); color: #fff;
  border: none; border-radius: 10px; padding: 11px 16px;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .15s; letter-spacing: -.01em;
}
.psb-btn:hover { background: #1a4fff; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(37,99,235,.28); }
.pearl-sidebar-next {
  background: var(--bg1); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 14px 16px;
}
.psn-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; font-weight: 700; letter-spacing: .12em;
  text-transform: uppercase; color: var(--tx4); margin-bottom: 6px;
}
.psn-cond { font-size: 13px; font-weight: 600; color: var(--tx2); margin-bottom: 4px; }
.psn-preview { font-size: 11.5px; color: var(--tx3); line-height: 1.5; }
.pearl-sidebar-streak {
  background: var(--bg1); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 14px 16px;
}
.pss-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
.pss-label { font-size: 11.5px; color: var(--tx3); font-weight: 500; min-width: 64px; flex-shrink: 0; }
.pss-track { flex: 1; height: 5px; background: var(--bg3); border-radius: 99px; overflow: hidden; }
.pss-fill { height: 100%; border-radius: 99px; transition: width .8s ease; }
.pss-pct { font-family: 'IBM Plex Mono', monospace; font-size: 10px; font-weight: 700; min-width: 28px; text-align: right; color: var(--tx3); }
.pss-pct.green { color: var(--green); }
.pss-pct.blue  { color: var(--blue); }

.ex-back-btn {
  font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700;
  letter-spacing:.08em; color:var(--tx3); background:transparent;
  border:1.5px solid var(--bdr2); padding:6px 14px; border-radius:8px;
  cursor:pointer; transition:all .13s; margin-bottom:16px; display:block;
}
.ex-back-btn:hover { color:var(--blue); border-color:var(--blue); background:var(--blue-dim); }


/* ── Role-aware framing banner ─────────────────── */
.teach-role-banner {
  display: flex; align-items: center; gap: 10px;
  background: var(--amber-dim); border: 1px solid rgba(217,119,6,.2);
  border-radius: 10px; padding: 10px 16px; margin-bottom: 20px;
  font-size: 12.5px; color: var(--tx2);
}
.teach-role-icon { font-size: 16px; flex-shrink: 0; }
.teach-role-lbl {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  font-weight: 700; letter-spacing: .1em; text-transform: uppercase;
  color: var(--amber); white-space: nowrap;
}
.teach-role-note { color: var(--tx3); font-size: 12px; }

/* ── Progress screen ──────────────────────────── */
.prog-wrap { max-width: 700px; margin: 0 auto; padding: 40px 48px 80px; }
.prog-empty { text-align: center; padding: 60px 0; }
.prog-score-row {
  display: flex; gap: 24px; align-items: center;
  background: var(--bg1); border: 1.5px solid var(--bdr);
  border-radius: 14px; padding: 24px 28px; margin-bottom: 28px;
}
.prog-big-score {
  font-family: 'Fraunces', serif; font-size: 56px; font-weight: 800;
  line-height: 1; flex-shrink: 0;
}
.prog-big-score span { font-size: 28px; }
.prog-score-detail { flex: 1; }
.prog-score-line { font-size: 13.5px; color: var(--tx2); line-height: 1.7; }
.prog-section-lbl {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px; font-weight: 700;
  letter-spacing: .16em; text-transform: uppercase; color: var(--tx3);
  margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
}
.prog-section-lbl::after { content: ''; flex: 1; height: 1px; background: var(--bdr2); }
.prog-cond-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 28px; }
.prog-cond-row {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px; background: var(--bg1);
  border: 1px solid var(--bdr); border-radius: 10px;
}
.prog-cond-name { font-size: 13px; font-weight: 600; color: var(--tx); min-width: 180px; }
.prog-cond-bar-wrap { flex: 1; }
.prog-cond-track { height: 6px; background: var(--bg3); border-radius: 99px; overflow: hidden; }
.prog-cond-fill { height: 100%; border-radius: 99px; transition: width .7s ease; }
.prog-cond-pct {
  font-family: 'IBM Plex Mono', monospace; font-size: 11px;
  font-weight: 700; min-width: 36px; text-align: right;
}
.prog-cond-conf {
  font-family: 'IBM Plex Mono', monospace; font-size: 9.5px;
  color: var(--tx4); white-space: nowrap;
}
.prog-conf-row { display: flex; gap: 12px; margin-bottom: 28px; }
.prog-conf-item {
  flex: 1; background: var(--bg1); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 14px 16px;
}
.prog-conf-num {
  font-family: 'Fraunces', serif; font-size: 28px; font-weight: 800;
  color: var(--tx); margin-bottom: 4px;
}
.prog-conf-lbl { font-size: 11px; color: var(--tx3); margin-bottom: 10px; }
.prog-conf-bar {
  height: 4px; background: var(--bg3); border-radius: 99px; overflow: hidden;
}
.prog-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }

</style>
</head>
<body>

<!-- ══════════════════════════════════════════
     COVER PAGE
══════════════════════════════════════════ -->
<div id="coverScreen" class="cover-screen">

  <!-- LEFT — editorial brand panel -->
  <div class="cover-left">
    <div class="cover-left-top">

      <!-- Logo -->
      <div class="cover-logo">
        <div class="cover-logo-gem">Ch</div>
        <div class="cover-logo-text">Ch<span>R</span>i Health</div>
      </div>

      <!-- Headline -->
      <h1 class="cover-headline">
        Learn medicine<br>
        the way <em>clinicians</em><br>
        actually think.
      </h1>

      <p class="cover-sub">
        Visual teaching, board-focused cases, and diagnostic reasoning — built for dental students, residents, and practitioners who want to learn deeply, not just memorize.
      </p>

      <!-- Proof points -->
      <div class="cover-proof">
        <div class="cover-proof-item">
          <div class="cover-proof-dot blue"></div>
          <div class="cover-proof-text"><strong>Visual-first teaching</strong> — diagrams and logic chains, not walls of text</div>
        </div>
        <div class="cover-proof-item">
          <div class="cover-proof-dot green"></div>
          <div class="cover-proof-text"><strong>Board-style trainer</strong> — commit to a diagnosis before the reveal</div>
        </div>
        <div class="cover-proof-item">
          <div class="cover-proof-dot amber"></div>
          <div class="cover-proof-text"><strong>Built for the struggle</strong> — written for the student studying at midnight</div>
        </div>
      </div>
    </div>

    <!-- Bottom badge -->
    <div class="cover-bottom-strip">
      <span class="cover-module-badge">Module 1 — Odontogenic Cysts · Live Now</span>
    </div>
  </div>

  <!-- RIGHT — login form -->
  <div class="cover-right">
    <div class="login-form-wrap">
      <div class="login-welcome">Welcome</div>
      <div class="login-welcome-sub">Sign in to track your progress, or continue as a guest to explore.</div>

      <div class="login-field">
        <label class="login-lbl">Email</label>
        <input class="login-input" id="loginEmail" type="email" placeholder="you@med.edu" autocomplete="email"/>
      </div>
      <div class="login-field">
        <label class="login-lbl">Password</label>
        <input class="login-input" id="loginPassword" type="password" placeholder="••••••••"/>
      </div>

      <div class="login-row">
        <div class="login-field" style="flex:1">
          <label class="login-lbl">Role</label>
          <select class="login-input login-select" id="loginRole">
            <option value="student">Dental Student</option>
            <option value="resident">Resident / Fellow</option>
            <option value="attending">Attending / Faculty</option>
          </select>
        </div>
        <div class="login-field" style="flex:1">
          <label class="login-lbl">Year</label>
          <select class="login-input login-select" id="loginYear">
            <option>MS-I</option>
            <option selected>MS-II</option>
            <option>MS-III</option>
            <option>MS-IV</option>
            <option>PGY-1</option>
            <option>PGY-2</option>
            <option>PGY-3</option>
            <option>Faculty</option>
          </select>
        </div>
      </div>

      <button class="login-btn" onclick="doLogin()">Sign in →</button>

      <div class="login-divider"><span>or</span></div>

      <button class="login-btn login-btn-ghost" onclick="enterAsGuest()">Continue as guest</button>

      <div class="login-fine">
        Demo mode — no real authentication required.<br>
        <strong>Your progress is saved locally.</strong>
      </div>
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════════
     LOGIN SCREEN
══════════════════════════════════════════ -->
<div id="loginScreen" class="login-screen" style="display:none">

  <button class="login-back" onclick="showCover()">← Back</button>

  <div class="login-card">
    <div class="login-logo">
      <div class="cover-logo-gem" style="width:34px;height:34px;font-size:13px;border-radius:8px">Ch</div>
      <div class="cover-logo-text" style="font-size:18px">Ch<span>R</span>i Health</div>
    </div>
    <div class="login-title">Welcome back</div>
    <div class="login-sub">Sign in to continue your progress</div>

    <div class="login-field">
      <label class="login-lbl">Email</label>
      <input class="login-input" id="loginEmailAlt" type="email" placeholder="you@med.edu"/>
    </div>
    <div class="login-field">
      <label class="login-lbl">Password</label>
      <input class="login-input" id="loginPasswordAlt" type="password" placeholder="••••••••"/>
    </div>
    <div class="login-row">
      <div class="login-field" style="flex:1">
        <label class="login-lbl">Role</label>
        <select class="login-input login-select" id="loginRoleAlt">
          <option value="student">Dental Student</option>
          <option value="resident">Resident</option>
          <option value="attending">Attending</option>
        </select>
      </div>
      <div class="login-field" style="flex:1">
        <label class="login-lbl">Year</label>
        <select class="login-input login-select" id="loginYearAlt">
          <option>MS-I</option><option selected>MS-II</option>
          <option>MS-III</option><option>MS-IV</option>
          <option>PGY-1</option><option>PGY-2</option>
          <option>PGY-3</option><option>Faculty</option>
        </select>
      </div>
    </div>
    <button class="login-btn" onclick="doLoginAlt()">Sign in →</button>
    <div class="login-divider"><span>or</span></div>
    <button class="login-btn login-btn-ghost" onclick="enterAsGuest()">Continue as guest</button>
    <div class="login-fine">Demo mode — no real authentication.<br><strong>Progress saved locally.</strong></div>
  </div>

</div>

<!-- Mobile nav overlay -->
<div class="mob-overlay" id="mobOverlay" onclick="closeMobNav()"></div>

<!-- ════════ SIDEBAR ════════ -->
<div class="app">
<aside class="sidebar">
  <div class="sb-logo">
    <div class="logo-gem">Ch</div>
    <div class="logo-name">Ch<span>R</span>i Health</div>
  </div>
  <div class="role-switch" id="roleSwitch">
    <div class="rs-btn active" onclick="setRole('student',this)">Student</div>
    <div class="rs-btn" onclick="setRole('resident',this)">Resident</div>
    <div class="rs-btn" onclick="setRole('attending',this)">Attending</div>
  </div>
  <nav class="sb-nav" id="sbNav">
    <div class="sb-section">Overview</div>
    <div class="sb-item active" id="sbDash" onclick="goScreen('dashboard',this)"><span class="sb-icon">⬡</span> Dashboard</div>

    <div class="sb-section sb-section-link" id="sbCurriculum" onclick="goScreen('curriculum',this)">Curriculum <span style="font-size:9px;opacity:.5;margin-left:auto;">view all →</span></div>

    <!-- Module 1: Odontogenic Cysts — LIVE -->
    <div class="sb-item" id="sbPath" onclick="goScreen('pathology',this);setSbModule('m1')"><span class="sb-icon">🔬</span> Odontogenic Cysts <span class="sb-badge green">✓</span></div>
    <div id="sbM1" style="display:none">
      <div class="sb-sub active" id="sbDC" onclick="showCond('dc','study')"><div class="sb-sub-dot"></div>Dentigerous Cyst</div>
      <div class="sb-sub" id="sbOKC" onclick="showCond('okc','study')"><div class="sb-sub-dot"></div>OKC / KCOT</div>
      <div class="sb-sub" id="sbUA" onclick="showCond('ua','study')"><div class="sb-sub-dot"></div>Unicystic Ameloblastoma</div>
      <div class="sb-sub" id="sbLPC" onclick="showCond('lpc','study')"><div class="sb-sub-dot"></div>Lateral Periodontal Cyst</div>
      <div class="sb-sub" id="sbCOC" onclick="showCond('coc','study')"><div class="sb-sub-dot"></div>Calcifying OC</div>
      <div class="sb-sub" id="sbRC" onclick="showCond('rc','study')"><div class="sb-sub-dot"></div>Radicular Cyst</div>
      <div class="sb-sub" id="sbRES" onclick="showCond('res','study')"><div class="sb-sub-dot"></div>Residual Cyst</div>
      <div class="sb-sub" id="sbPARA" onclick="showCond('para','study')"><div class="sb-sub-dot"></div>Paradental / BBC</div>
    </div>

    <!-- Module 2–6: LOCKED -->
    <div class="sb-item" id="sbM2" onclick="goScreen('m2',this)"><span class="sb-icon">🫙</span> Non-OG Cysts</div>
    <div id="sbM2Nav" style="display:none"></div>
    <div class="sb-item locked" onclick="goComingSoon('Odontogenic Tumors','m3')"><span class="sb-icon">🧬</span> OG Tumors <span class="sb-coming">Q3 2026</span></div>
    <div class="sb-item locked" onclick="goComingSoon('Bone Pathology','m4')"><span class="sb-icon">🦴</span> Bone Pathology <span class="sb-coming">Q3 2026</span></div>
    <div class="sb-item locked" onclick="goComingSoon('Soft Tissue Lesions','m5')"><span class="sb-icon">🫀</span> Soft Tissue <span class="sb-coming">Q4 2026</span></div>
    <div class="sb-item locked" onclick="goComingSoon('Salivary Gland Pathology','m6')"><span class="sb-icon">💧</span> Salivary Gland <span class="sb-coming">2027</span></div>

    <div class="sb-section">Community</div>
    <div class="sb-item" id="sbExchange" onclick="goScreen('exchange',this)"><span class="sb-icon">💬</span> Clinical Exchange <span class="sb-badge">4</span></div>
    <div class="sb-item" id="sbLectures" onclick="goLectures()"><span class="sb-icon">🎓</span> CE Lectures <span class="sb-badge" style="font-size:8px;padding:1px 5px;">NEW</span></div>

    <div class="sb-section">Personal</div>
    <div class="sb-item" id="sbProgress" onclick="goScreen('progress',this)"><span class="sb-icon">📈</span> My Progress</div>
    <div class="sb-item locked" onclick="goComingSoon('Saved Notes','notes')"><span class="sb-icon">🔖</span> Saved Notes <span class="sb-coming">Soon</span></div>
    <div class="sb-item locked" onclick="goComingSoon('Settings','settings')"><span class="sb-icon">⚙️</span> Settings <span class="sb-coming">Soon</span></div>
  </nav>
  <div class="sb-user">
    <div class="sb-avatar">JR</div>
    <div>
      <div class="sb-user-name" id="sbUserName">Jordan R.</div>
      <div class="sb-user-role" id="sbUserRole">MS-II · Student</div>
    </div>
  </div>
</aside>

<!-- ════════ MAIN ════════ -->
<div class="main">
  <header class="topbar">
    <button class="mob-hamburger" id="mobHamburger" aria-label="Open menu" onclick="toggleMobNav()">
      <span></span><span></span><span></span>
    </button>
    <div class="tb-title" id="topTitle">Dashboard</div>
    <div class="tb-mono" id="topMono"></div>
    <div class="mode-toggle" id="modeToggle" style="display:none">
      <div class="mt-btn active" id="mStudy" onclick="setMode('study')">📖 Study</div>
      <div class="mt-btn" id="mCompare" onclick="setMode('compare')">⇄ Compare</div>
      <div class="mt-btn" id="mTrainer" onclick="setMode('trainer')">🎯 Trainer</div>
    </div>
    <div class="notif-btn"><span>🔔</span><div class="notif-dot"></div></div>
    <button class="tb-btn primary" id="topCta" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">Start Quiz →</button>
  </header>

  <div class="screens">

    <!-- ══════════════ DASHBOARD ══════════════ -->
    <div id="screen-dashboard" class="screen active">
      <div class="dash" id="dashContent"></div>
    </div>

    <!-- ══════════════ PATHOLOGY ══════════════ -->
    <div id="screen-pathology" class="screen">
      <div id="pathScreen"></div>
    </div>

    <!-- ══════════════ MODULE 2 — NON-OG CYSTS ══════════════ -->
    <div id="screen-m2" class="screen">
      <div id="m2Screen"></div>
    </div>

    <!-- ══════════════ EXCHANGE ══════════════ -->
    <div id="screen-exchange" class="screen">
  <div id="exchangeContent" style="height:100%;overflow:hidden;display:flex;flex-direction:column;"></div>
</div>
    <!-- ══════════════ PROGRESS ══════════════ -->
    <div id="screen-progress" class="screen">
      <div class="progress-wrap" id="progressContent"></div>
    </div>

    <!-- ══════════════ CURRICULUM ══════════════ -->
    <div id="screen-curriculum" class="screen">
      <div id="curriculumContent"></div>
    </div>

    <!-- COMING SOON -->
    <div id="screen-comingsoon" class="screen">
      <div id="comingSoonContent"></div>
    </div>

    <div id="screen-lectures" class="screen">
      <div id="lecturesContent"></div>
    </div>

  </div>
</div>
</div>

<script>
/* ════════════════════════════════════════════════
   CHRI HEALTH v3 — COMPLETE JAVASCRIPT
════════════════════════════════════════════════ */

// ── STATE ──
let curScreen = 'dashboard';
let curRole   = 'student';
let curCond   = 'dc';
let curCondM2 = 'npc';
let curModuleId = 'm1';
let curMode   = 'study';
let tr = { case:0, correct:0, answered:false, done:false };


// ── ROLE DATA ──
const ROLES = {
  student: {
    name:'Jordan R.', role:'MS-II · Student',
    greeting:'Good evening,', name2:'Jordan.',
    tagline:'14-day streak. Keep the momentum.',
    stats:[
      {l:'Modules Done',v:'12',s:'of 36 total',c:'blue'},
      {l:'Quiz Accuracy',v:'87%',s:'last 30 days',c:'green'},
      {l:'Study Streak',v:'14',s:'days in a row',c:'amber'},
      {l:'Last Quiz',v:'3/3',s:'Dentigerous Cyst',c:'green'},
    ],
    cta:'Continue Studying →',
    exchangeRole:'view'
  },
  resident: {
    name:'Dr. Malik S.', role:'OMFS-2 · Resident',
    greeting:'Good evening,', name2:'Dr. Malik.',
    tagline:'2 cases posted this week. 5 replies waiting.',
    stats:[
      {l:'Modules Done',v:'28',s:'of 36 total',c:'blue'},
      {l:'Exchange Posts',v:'12',s:'this month',c:'green'},
      {l:'CE Credits',v:'8.5',s:'of 20 required',c:'amber'},
      {l:'Study Streak',v:'21',s:'days in a row',c:'green'},
    ],
    cta:'View New Cases →',
    exchangeRole:'post'
  },
  attending: {
    name:'Dr. Chen, M.D.', role:'OMFS · Attending',
    greeting:'Welcome back,', name2:'Dr. Chen.',
    tagline:'3 mentorship requests. 134 students in your modules.',
    stats:[
      {l:'CE Credits',v:'18.5',s:'of 20 required',c:'green'},
      {l:'Mentee Requests',v:'3',s:'awaiting response',c:'amber'},
      {l:'Module Views',v:'134',s:'this month',c:'blue'},
      {l:'Expert Rating',v:'4.9',s:'from 47 reviews',c:'green'},
    ],
    cta:'Review Mentee Cases →',
    exchangeRole:'expert'
  }
};

// ── CONDITION DATA ──
const CONDITIONS = {
  dc:{
    id:'dc', ey:'Pathology · Odontogenic Cysts · 1 of 8',
    title:'Dentigerous Cyst', aka:'Follicular Cyst',
    tags:[{l:'Developmental',c:'blue'},{l:'Low Recurrence',c:'green'},{l:'Boards High-Yield',c:'amber'}],
    summary:'The <strong>most common developmental odontogenic cyst</strong>, arising from fluid accumulation between the reduced enamel epithelium and the crown of an <strong>unerupted or impacted tooth</strong>. The diagnostic threshold is a pericoronal radiolucency <strong>&gt;3–4 mm</strong>. Excellent prognosis with enucleation. Cannot be distinguished from OKC or Unicystic Ameloblastoma radiographically — histology is always required.',
    fp:[{k:'Aggressiveness',v:20,t:'lo',l:'Low'},{k:'Recurrence',v:12,t:'lo',l:'Rare'},{k:'Commonality',v:90,t:'hi',l:'Very High'},{k:'Boards Freq.',v:95,t:'hi',l:'Extreme'},{k:'Tx Complexity',v:22,t:'lo',l:'Low'}],
    sections:[
      {n:'01', title:'Clinical Presentation', sub:'Demographics · Location · Symptoms', cards:[
        {lbl:'👤 Demographics', items:['Peak: <em>2nd–4th decade</em>','<strong>Male > Female</strong> — slight predilection','Most common <em>developmental</em> OG cyst','2nd most common OG cyst overall (after radicular)']},
        {lbl:'📍 Location', items:['<em>Mandibular 3rd molar</em> — most common','Maxillary canines if impacted','Any unerupted / impacted tooth','Follows unerupted tooth distribution']},
        {lbl:'🔍 Symptoms', items:['<strong>Usually asymptomatic</strong> — incidental finding','Painless swelling if large','Pain only if secondarily infected','Tooth displacement in adjacent teeth']},
        {lbl:'⚠️ Clinical Signs', items:['Missing tooth without extraction history','Root resorption of adjacent teeth','Cortical expansion in large lesions','Facial asymmetry — rare, advanced cases']},
      ]},
      {n:'02', title:'Radiographic Presentation', sub:'Panoramic · CBCT · Diagnostic Threshold', cards:[
        {lbl:'🔲 Features', items:['<strong>Well-defined unilocular radiolucency</strong>','Pericoronal space <em>&gt;3–4 mm</em> — pathologic threshold','Scalloped, corticated margins','Crown of unerupted tooth within the lumen','Attachment at <em>cemento-enamel junction</em>']},
        {lbl:'🔬 CBCT', items:['3D cortical expansion detail','Proximity to IAN or sinus','Root resorption quantification','Surgical planning for large lesions','Thin but intact cortical borders']},
      ], hls:[
        {cls:'amber', lbl:'⚡ Critical Threshold', txt:'Pericoronal space <strong>&gt;3–4 mm</strong> = Dentigerous Cyst until proven otherwise. Below this threshold = hyperplastic follicle (normal variant). This single radiographic measurement drives the biopsy decision.'},
        {cls:'red', lbl:'⚠️ Cannot Exclude Radiographically', txt:'OKC and Unicystic Ameloblastoma are <strong>radiographically indistinguishable</strong> from DC. Histology is always required before definitive treatment in any uncertain pericoronal radiolucency.'},
      ], rels:[{ico:'🦷',title:'Central',sub:'Crown surrounded\nMost common',p:true},{ico:'↔️',title:'Lateral',sub:'Along root\nPartial eruption',p:false},{ico:'⭕',title:'Circumferential',sub:'Entire tooth',p:false},{ico:'⚠️',title:'vs. Radicular',sub:'Apex ≠ Crown',p:false}]},
      {n:'03', title:'Histopathology', sub:'Epithelium · Wall · Pitfalls', grid:'g3', cards:[
        {lbl:'🧫 Epithelial Lining', items:['<em>Non-keratinized</em> stratified squamous','<strong>2–3 cell layers</strong> — thin','Flat interface — no rete ridges (uninflamed)','Attached at CEJ']},
        {lbl:'🧱 Cyst Wall', items:['Loose fibrous connective tissue','Odontogenic rests may be present','Inflammatory infiltrate if infected','Rushton bodies — occasional']},
        {lbl:'⚗️ Variants', items:['Mucous cells — occasional','Sebaceous cells — rare','Ciliated cells — rare','Hyaline (Rushton) bodies']},
      ], hls:[{cls:'red',lbl:'⚠️ Histologic Pitfall',txt:'Inflammation <strong>thickens the lining</strong> and produces rete ridges — mimicking OKC or Unicystic Ameloblastoma histologically. Never diagnose on histology alone. Always integrate clinical and radiographic findings.',full:true}]},
      {n:'04', title:'Differential Diagnosis', sub:'Interactive — click to exclude', ddx:[
        {name:'Hyperplastic Follicle', key:'Pericoronal <3mm = normal variant. No treatment. Below the threshold.'},
        {name:'Odontogenic Keratocyst', key:'Parakeratinized epithelium, daughter cysts, 30% recurrence. Can be pericoronal. Gorlin link.'},
        {name:'Unicystic Ameloblastoma', key:'Radiographically identical. Palisading columnar cells on histo. Cannot exclude without biopsy.'},
        {name:'Radicular Cyst', key:'Root APEX of non-vital tooth. Inflammatory origin. Never pericoronal.'},
        {name:'Ameloblastic Fibroma', key:'Younger patients (<20). OG epithelium cords in primitive mesenchyme. Jaw expansion in child.'},
        {name:'Central Giant Cell Granuloma', key:'Not pericoronal. Anterior mandible. Giant cells on histo. F > M.'},
      ]},
      {n:'05', title:'Management & Prognosis', sub:'Surgery · Follow-Up · Escalation', cards:[
        {lbl:'🔪 Surgical', items:['<strong>Small–medium:</strong> Enucleation + curettage','<strong>Large:</strong> Marsupialize → decompress → enucleate','Associated tooth usually extracted','Peripheral ostectomy not routinely needed']},
        {lbl:'📋 Prognosis', items:['<strong>Recurrence: very rare</strong> with complete removal','Annual radiograph × 2–3 years','Malignant transformation: very rare (SCC)','Mucoepidermoid carcinoma from mucous lining — documented']},
      ], hls:[
        {cls:'green',lbl:'✅ When to Marsupialize',txt:'Large cysts near vital structures (IAN, sinus). Decompression shrinks the lesion over 6–12 months — definitive enucleation is then safer and more conservative.'},
        {cls:'red',lbl:'🚨 Escalate If',txt:'Aggressive expansion, cortical perforation, multilocular pattern, or thick/irregular lining → <strong>biopsy urgently</strong> to exclude Unicystic Ameloblastoma before treatment.'},
      ]},
    ],
    pearls:[
      {s:'dark', lbl:'Pearl #1 — The diagnostic threshold', txt:'Pericoronal radiolucency <strong>&gt;3–4 mm</strong> = Dentigerous Cyst until proven otherwise. Below that = hyperplastic follicle. This one measurement is the most board-tested concept in odontogenic cyst pathology.'},
      {s:'blue', lbl:'Pearl #2 — The histologic trap', txt:'Inflammation thickens the lining. An inflamed DC develops rete ridges and can mimic OKC or UA. <strong>Never diagnose on histology alone</strong> — integrate the complete clinical and radiographic picture.'},
      {s:'amber', lbl:'Pearl #3 — The syndrome link', txt:'<strong>Multiple pericoronal cysts</strong> = screen for Gorlin Syndrome (PTCH1). Multiple OKCs look identical to Dentigerous Cysts radiographically. One missed case = missed systemic diagnosis with multi-organ consequences.'},
    ],
    mnem:{ word:'D · E · N · T', lines:[
      {l:'D',r:'evelopmental — not inflammatory in origin'},
      {l:'E',r:'namel epithelium (reduced) forms the lining'},
      {l:'N',r:'on-keratinized — thin 2–3 cell layers, flat interface'},
      {l:'T',r:'hreshold — >3–4mm pericoronal lucency = pathologic'},
    ]},
    syns:[
      {cls:'amber', ico:'⚠️', title:'Gorlin Syndrome (NBCCS) — PTCH1', txt:'<strong>Chr 9q, autosomal dominant.</strong> Multiple jaw cysts (OKCs), multiple BCCs (early onset), calcified falx cerebri, bifid ribs, palmar pits, desmoplastic medulloblastoma. Trigger: multiple pericoronal cysts in young patient.'},
    ],
    next:[{id:'okc',ico:'🦴',title:'Odontogenic Keratocyst',sub:'30% recurrence · Gorlin · Parakeratinization'},{id:'ua',ico:'🔴',title:'Unicystic Ameloblastoma',sub:'Critical DDx · Cannot exclude radiographically'}],
  },
  okc:{
    id:'okc', ey:'Pathology · Odontogenic Cysts · 2 of 8',
    title:'Odontogenic Keratocyst', aka:'OKC / KCOT',
    tags:[{l:'30% Recurrence',c:'red'},{l:'Gorlin Syndrome',c:'amber'},{l:'Boards Critical',c:'amber'}],
    summary:'An <strong>aggressive cystic lesion</strong> from dental lamina remnants. Defined by <strong>parakeratinized epithelium</strong>, 30% recurrence rate, and Gorlin Syndrome association (PTCH1). Grows silently along medullary bone — often far larger than clinical presentation suggests. The size-to-expansion discrepancy is its radiographic signature.',
    fp:[{k:'Aggressiveness',v:74,t:'hi',l:'High'},{k:'Recurrence',v:80,t:'hi',l:'30%'},{k:'Commonality',v:55,t:'md',l:'Moderate'},{k:'Boards Freq.',v:98,t:'hi',l:'Extreme'},{k:'Tx Complexity',v:70,t:'hi',l:'High'}],
    sections:[
      {n:'01', title:'Clinical Presentation', sub:'Demographics · Behavior · Gorlin Trigger', cards:[
        {lbl:'👤 Demographics', items:['Peak: <em>20–40 years</em>','<strong>Male > Female</strong>','Mandible 70–80% — posterior body/ramus','Bilateral in <em>Gorlin Syndrome</em>']},
        {lbl:'⚠️ Clinical Behavior', items:['Grows <strong>along medullary bone</strong> — silent','Minimal expansion vs. lesion size — key tell','Thin, fragile lining — collapses on removal','High recurrence if any remnant left behind']},
      ]},
      {n:'02', title:'Radiographic Presentation', sub:'Medullary Growth · Scalloped Border · Gorlin Flags', cards:[
        {lbl:'🔲 Features', items:['Unilocular <em>OR</em> <strong>multilocular</strong>','<em>Scalloped borders</em> — follows trabeculae','<strong>Grows along medullary space</strong>','Less expansion than size suggests','Satellite cysts on CBCT — pathognomonic']},
        {lbl:'🔬 Gorlin Indicators', items:['<strong>Bilateral or multiple OKCs</strong>','Young patient with large silent lesion','Family history of BCCs or jaw cysts','Calcified falx cerebri on imaging','→ PTCH1 genetic testing indicated']},
      ], hls:[
        {cls:'red', lbl:'⚡ Silent Medullary Growth', txt:'OKC follows the medullary bone silently. A <strong>surprisingly large lesion with minimal cortical expansion</strong> = OKC until proven otherwise. Clinical swelling underestimates radiographic extent.'},
        {cls:'amber', lbl:'🧬 Gorlin Red Flag', txt:'Bilateral or multiple OKCs in a young patient = <strong>Gorlin Syndrome until proven otherwise.</strong> Check for BCCs, calcified falx cerebri, bifid ribs, palmar pits. Life-altering consequences if missed.'},
      ]},
      {n:'03', title:'Histopathology', sub:'Parakeratinization · Daughter Cysts · Why It Recurs', grid:'g3', cards:[
        {lbl:'🧫 Lining — DEFINING', items:['<em><strong>Parakeratinized</strong></em> stratified squamous','<strong>Corrugated/wavy surface</strong>','Palisaded basal layer — columnar','Uniform 6–8 cell layers']},
        {lbl:'🧱 Wall', items:['Fibrous — thin and friable','<em>Satellite/daughter cysts</em> in wall','Odontogenic rests common','Inflammation strips parakeratinization']},
        {lbl:'🔴 Recurrence Mechanism', items:['Satellite cysts left behind','Thin wall tears — remnants remain','Odontogenic rests → new lesions','Incomplete enucleation → regrowth']},
      ], hls:[{cls:'red', lbl:'🔑 Pathognomonic', txt:'<strong>Parakeratinized + corrugated surface + palisaded basal layer</strong> = OKC. If inflammation removes parakeratinization, can look like DC. Request deeper sections — examine basal layer.',full:true}]},
      {n:'04', title:'Differential Diagnosis', sub:'Click to exclude', ddx:[
        {name:'Dentigerous Cyst', key:'Non-keratinized 2–3 layers. No daughter cysts. No corrugation. Low recurrence.'},
        {name:'Unicystic Ameloblastoma', key:'Palisading columnar cells, reverse nuclear polarity, stellate reticulum. No parakeratinization.'},
        {name:'Simple Bone Cyst', key:'Empty cavity. No epithelial lining. Scallops between roots. Self-resolves.'},
        {name:'Conventional Ameloblastoma', key:'More cortical expansion. Soap-bubble multilocular. Older patients.'},
        {name:'CGCG', key:'No epithelial lining. Giant cells. Anterior mandible. Responds to corticosteroids.'},
        {name:'Lateral Periodontal Cyst', key:'Lateral root surface, vital tooth. Glycogen-rich plaques. No parakeratinization.'},
      ]},
      {n:'05', title:'Management', sub:'Peripheral Ostectomy · Carnoy\'s · Surveillance', cards:[
        {lbl:'🔪 Surgical', items:['<strong>Enucleation + peripheral ostectomy</strong>','<strong>Carnoy\'s solution</strong> — chemical cauterization','Marsupialization for large/recurrent lesions','Resection with margins — recurrent/aggressive']},
        {lbl:'📋 Follow-Up', items:['<strong>30% recurrence</strong> — long surveillance mandatory','Annual CBCT × 5 years minimum','Gorlin patients: 6-month panoramic','Malignant transformation (SCC) — rare but documented']},
      ], hls:[
        {cls:'amber', lbl:'🔬 Why Peripheral Ostectomy?', txt:'Removes the outer bone layer — eliminates satellite cysts and odontogenic rests that cause recurrence after simple enucleation. Essential for OKC.'},
        {cls:'red', lbl:'🚨 Carnoy\'s Solution', txt:'Applied to bone cavity post-enucleation. <strong>Denatures proteins</strong> in remaining lining fragments. Reduces recurrence significantly. Contraindicated near IAN without nerve protection.'},
      ]},
    ],
    pearls:[
      {s:'dark', lbl:'Pearl #1 — The recurrence driver', txt:'OKC recurs because of <strong>daughter cysts and odontogenic rests</strong> left in the bone. Peripheral ostectomy and Carnoy\'s solution directly address this. Simple enucleation alone = unacceptably high recurrence.'},
      {s:'blue', lbl:'Pearl #2 — Silent radiographic growth', txt:'OKC grows along medullary bone and expands less than size suggests. <strong>Large lesion, minimal swelling</strong> = OKC until proven otherwise. Never underestimate based on clinical presentation alone.'},
      {s:'amber', lbl:'Pearl #3 — Multiple OKCs = Gorlin', txt:'Any patient with multiple jaw cysts must be evaluated for <strong>Gorlin Syndrome.</strong> The syndrome carries medulloblastoma, BCC, and cardiac fibroma risk. Missing the diagnosis has life-altering consequences.'},
    ],
    mnem:{ word:'O · K · C', lines:[
      {l:'O',r:'rigin: dental lamina remnants'},
      {l:'K',r:'eratinized: parakeratinized corrugated lining'},
      {l:'C',r:'arnoy\'s + peripheral ostectomy = recurrence prevention'},
    ]},
    syns:[
      {cls:'amber', ico:'⚠️', title:'Gorlin Syndrome (NBCCS) — PTCH1 Mutation', txt:'<strong>Chr 9q, autosomal dominant.</strong> Multiple OKCs (bilateral), multiple BCCs (early onset), calcified falx cerebri, bifid ribs, palmar pits, desmoplastic medulloblastoma. Co-manage with derm + neuro.'},
      {cls:'red', ico:'🔴', title:'Malignant Transformation', txt:'Rare: <strong>SCC arising within OKC wall.</strong> More likely in longstanding, recurrent, or irradiated lesions. Rapid expansion or cortical perforation in known OKC = re-biopsy urgently.'},
    ],
    next:[{id:'ua',ico:'🔴',title:'Unicystic Ameloblastoma',sub:'Most dangerous DDx · Palisading columnar cells'},{id:'dc',ico:'🦷',title:'Dentigerous Cyst',sub:'Review the contrast — non-keratinized, low risk'}],
  },
  ua:{
    id:'ua', ey:'Pathology · Odontogenic Cysts · 3 of 8',
    title:'Unicystic Ameloblastoma', aka:'UA / Mural Ameloblastoma',
    tags:[{l:'Malignant Potential',c:'red'},{l:'Histology Required',c:'amber'},{l:'Critical DDx',c:'purp'}],
    summary:'A <strong>cystic ameloblastoma</strong> that appears radiographically identical to a Dentigerous Cyst. The danger: it mimics a benign cyst until histology reveals <strong>palisading columnar basal cells with reverse nuclear polarity</strong>. Higher recurrence and malignant potential than the entities it mimics. <strong>Histology is mandatory before any treatment decision.</strong> Subtype (luminal/mural) determines everything.',
    fp:[{k:'Aggressiveness',v:84,t:'hi',l:'High'},{k:'Recurrence',v:72,t:'hi',l:'15–25%'},{k:'Commonality',v:28,t:'lo',l:'Uncommon'},{k:'Boards Freq.',v:92,t:'hi',l:'Very High'},{k:'Tx Complexity',v:84,t:'hi',l:'Very High'}],
    sections:[
      {n:'01', title:'Clinical Presentation', sub:'Subtypes · Demographics · Red Flags', cards:[
        {lbl:'🔴 Three Histologic Subtypes', items:['<strong>Luminal:</strong> tumor in cyst lining only — best prognosis','<strong>Intraluminal:</strong> nodule projects into lumen — intermediate','<strong>Mural:</strong> invades fibrous wall — highest risk, requires resection','<em>You cannot plan treatment without knowing the subtype</em>']},
        {lbl:'⚠️ Red Flags', items:['Pericoronal cyst recurring after enucleation','Rapid growth in a "dentigerous cyst"','Cortical perforation in what looked benign','Any pericoronal cyst in patient under 25']},
      ]},
      {n:'02', title:'Radiographic Presentation', sub:'Why It Cannot Be Detected Without Biopsy', cards:[
        {lbl:'🔲 Features', items:['<strong>Unilocular radiolucency — usually</strong>','Pericoronal — associated with unerupted tooth','Well-defined, corticated borders','<strong>Radiographically identical to Dentigerous Cyst</strong>','Root resorption may be present']},
        {lbl:'🚨 The Core Problem', items:['No reliable radiographic distinguishing feature','Cannot distinguish from DC on panoramic','Cannot distinguish from DC on CBCT','Mural type: minor irregularity possible','<strong>Only histology provides the answer</strong>']},
      ], hls:[
        {cls:'red', lbl:'🚨 The Critical Clinical Point', txt:'There is <strong>no reliable radiographic feature</strong> that distinguishes Unicystic Ameloblastoma from a Dentigerous Cyst. Every pericoronal radiolucency must be biopsied before definitive treatment. No exceptions.',full:true},
      ], rels:[{ico:'🔵',title:'Luminal',sub:'Best prognosis\nEnucleation ok',p:true},{ico:'🔴',title:'Intraluminal',sub:'Intermediate\nClose surveillance',p:false},{ico:'🟥',title:'Mural',sub:'Highest risk\nResection required',p:false},{ico:'📊',title:'Subtype = Tx',sub:'Biopsy first\nAlways',p:false}]},
      {n:'03', title:'Histopathology', sub:'The Defining Features — Memorize These', cards:[
        {lbl:'🧫 Epithelial Lining — Diagnostic', items:['<em><strong>Palisading columnar basal cells</strong></em>','<strong>Reverse nuclear polarity</strong> (nuclei away from BM)','Loose <em>stellate reticulum</em> in suprbasal layer','Hyperchromatism of basal nuclei']},
        {lbl:'🧱 Architecture by Subtype', items:['Luminal: tumor only in lining','Intraluminal: nodular projections inward','<strong>Mural: tumor invades fibrous wall</strong>','Mural = resection, not enucleation']},
      ], hls:[
        {cls:'purp', lbl:'🔑 Histologic Signature', txt:'<strong>Palisading columnar basal cells + reverse nuclear polarity + stellate reticulum</strong> = Ameloblastoma in a cyst lining = Unicystic Ameloblastoma. Distinguishes from OKC (parakeratinization) and DC (flat interface).'},
        {cls:'red', lbl:'⚠️ Mural Type', txt:'When ameloblastoma invades the fibrous wall, enucleation has unacceptably high recurrence rates and malignant potential. <strong>Mural type = resection with tumor-free margins. No exceptions.</strong>'},
      ]},
      {n:'04', title:'Differential Diagnosis', sub:'Click to exclude', ddx:[
        {name:'Dentigerous Cyst', key:'Non-keratinized thin 2–3 layers. No palisading columns. Flat interface. Most common DDx.'},
        {name:'Odontogenic Keratocyst', key:'Parakeratinized, corrugated, daughter cysts, 30% recurrence. No stellate reticulum.'},
        {name:'Conventional Ameloblastoma', key:'Solid or multicystic. Older. More cortical expansion. Soap-bubble multilocular.'},
        {name:'Calcifying Odontogenic Cyst', key:'Ghost cells. Calcifications on X-ray. Dentinoid material.'},
        {name:'Adenomatoid OT', key:'Young female, anterior maxilla, duct-like structures. Well-encapsulated. With canine.'},
        {name:'Glandular Odontogenic Cyst', key:'Mucous cells, cilia, duct-like structures. Mandibular anterior. Rare.'},
      ]},
      {n:'05', title:'Management', sub:'Subtype-Dependent — Cannot Plan Without Biopsy', cards:[
        {lbl:'🔪 Luminal / Intraluminal', items:['<strong>Enucleation + curettage</strong> — acceptable','Peripheral ostectomy for added margin','Annual CBCT × 5–10 years mandatory','Close long-term surveillance']},
        {lbl:'🔪 Mural Type', items:['<strong>Resection with clear margins required</strong>','Continuity resection if large','Reconstruction planning at surgery','Recurrence approaches conventional ameloblastoma']},
      ], hls:[
        {cls:'amber', lbl:'🎯 The Biopsy Rule', txt:'The biopsy isn\'t just for diagnosis — it\'s for treatment planning. <strong>Luminal → enucleation. Mural → resection.</strong> You cannot make this call without histology.'},
        {cls:'red', lbl:'🚨 The Consequence of Missing It', txt:'Treating UA as a Dentigerous Cyst causes inevitable recurrence, potential malignant transformation, and more aggressive re-resection. The cost of skipping the biopsy is always higher than doing it.'},
      ]},
    ],
    pearls:[
      {s:'dark', lbl:'Pearl #1 — The invisible danger', txt:'UA is dangerous because it looks benign. <strong>Radiographically identical to Dentigerous Cyst.</strong> Asymptomatic. Clean borders. And then histology reveals palisading columnar cells. This is the case that changes how you approach every future pericoronal cyst.'},
      {s:'blue', lbl:'Pearl #2 — The subtype rule', txt:'Luminal → conservative surgery + long surveillance. Mural → <strong>resection, period.</strong> Cannot make this call without the biopsy. Every pericoronal cyst in a young patient at the molar site deserves histologic confirmation.'},
      {s:'amber', lbl:'Pearl #3 — The recurrence clue', txt:'A "Dentigerous Cyst" that <strong>recurs after enucleation = UA until proven otherwise.</strong> Recurrence of a supposed benign cyst demands re-biopsy and complete reassessment. Do not repeat enucleation without new histology.'},
    ],
    mnem:{ word:'U · A · P · R', lines:[
      {l:'U',r:'nicystic — single cystic cavity'},
      {l:'A',r:'meloblastoma — palisading columnar, reverse polarity, stellate reticulum'},
      {l:'P',r:'ericoronal — looks like Dentigerous Cyst or OKC radiographically'},
      {l:'R',r:'equires biopsy — never treat without histologic confirmation'},
    ]},
    syns:[
      {cls:'red', ico:'🔴', title:'Malignant Transformation Risk', txt:'Mural type can progress to <strong>conventional ameloblastoma</strong> and rarely ameloblastic carcinoma. Incomplete resection and chronic recurrence increase this risk. Long-term CBCT surveillance is non-negotiable.'},
    ],
    next:[{id:'dc',ico:'🦷',title:'Dentigerous Cyst',sub:'The benign baseline — understand the contrast'},{id:'okc',ico:'🦴',title:'Odontogenic Keratocyst',sub:'The middle ground — moderate aggressiveness, high recurrence'}],
  },
};
// ── LATERAL PERIODONTAL CYST ────────────────────────────────────────────────
CONDITIONS['lpc'] = {
  id:'lpc', ey:'Pathology · Odontogenic Cysts · 4 of 8',
  title:'Lateral Periodontal Cyst', aka:'Botryoid OC (polycystic variant)',
  tags:[{l:'Developmental',c:'blue'},{l:'Vital Tooth',c:'green'},{l:'Lateral Root',c:'slate'}],
  summary:'Rare developmental cyst arising alongside the <strong>lateral root surface of a vital tooth</strong>. Mandibular premolar–canine–lateral incisor region. Pathognomonic: <strong>glycogen-rich clear cells (PAS+) with focal epithelial plaques</strong>. Polycystic variant = Botryoid OC, higher recurrence. Excellent prognosis.',
  fp:[{k:'Aggressiveness',v:18,t:'lo',l:'Low'},{k:'Recurrence',v:20,t:'lo',l:'Low (Botryoid: higher)'},{k:'Commonality',v:22,t:'lo',l:'Rare'},{k:'Boards Freq.',v:58,t:'md',l:'Moderate'},{k:'Tx Complexity',v:20,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Overview',sub:'Demographics · Location · Character',cards:[
      {lbl:'👤 Who Gets It',items:['Adults ages 40–80 (mean ~50)','Mandible >> maxilla','Premolar–canine–lateral incisor zone','No strong sex predilection']},
      {lbl:'📋 Character',items:['Rare — <1% of odontogenic cysts','Asymptomatic in nearly all cases','Small (<1 cm) at diagnosis','Adjacent teeth are vital — critical DDx point']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Signs · Symptoms · Exam',cards:[
      {lbl:'🏥 Clinical Findings',items:['Asymptomatic — incidental finding on routine X-ray','No swelling, no drainage, no pain','Adjacent teeth test vital (EPT positive)','Rare: mild cortical expansion if large']},
      {lbl:'⚠️ Red Flags',items:['Non-vital adjacent tooth → reconsider RC not LPC','Size >1 cm or multilocularity → consider Botryoid variant','Recurrence after excision → evaluate for Botryoid OC']},
    ]},
    {n:'03',title:'Radiographic',sub:'Imaging · Morphology · Location',cards:[
      {lbl:'📡 Radiographic Features',items:['Well-defined, small unilocular radiolucency','Smooth, corticated margins','Located lateral to root — NOT pericoronal','Root divergence possible but uncommon','Teardrop or oval shape classic']},
      {lbl:'🔍 Botryoid Variant',items:['Botryoid ("berry-like") = polycystic variant','Multiple fused cystic spaces on imaging','Well-defined but more complex outline','Higher recurrence rate than unicystic LPC','Longer follow-up required']},
    ]},
    {n:'04',title:'Histopathology',sub:'Epithelium · Stroma · Hallmark',cards:[
      {lbl:'🔬 Microscopic Findings',items:['Thin (1–5 cell layers) non-keratinized stratified squamous epithelium','<strong>Focal epithelial plaques</strong> — pathognomonic','Glycogen-rich clear cells within plaques (PAS-positive)','Fibrous connective tissue wall, minimal inflammation','No corrugated surface (vs. OKC), no parakeratinization']},
      {lbl:'🧪 Key Stain',items:['PAS stain highlights glycogen-rich clear cells','Plaques = nodular thickenings of the epithelial lining','Absence of keratinization excludes OKC','No satellite cysts, no hyperchromatism of basal layer']},
    ]},
    {n:'05',title:'DDx',sub:'What it mimics · How to separate',ddx:[
      {name:'Odontogenic Keratocyst',key:'OKC: parakeratinized, corrugated surface, satellite cysts, basal hyperchromatism — LPC: thin, non-keratinized, glycogen plaques'},
      {name:'Ameloblastoma (Unicystic)',key:'UA: pericoronal, palisading columnar cells at interface — LPC: lateral to erupted tooth, small, no palisading'},
      {name:'Gingival Cyst of Adult',key:'Soft tissue variant of LPC — no intraosseous component; presents as bluish gingival dome, may show superficial bone cupping'},
      {name:'Lateral Radicular Cyst',key:'Same position — but NON-vital tooth. Vitality testing is the single decisive DDx step: LPC = vital, RC = non-vital'},
    ]},
    {n:'06',title:'Management',sub:'Treatment · Prognosis · Follow-up',cards:[
      {lbl:'🔪 Treatment',items:['Complete enucleation and curettage','Preserve adjacent vital teeth — meticulous dissection','Botryoid variant: same approach, closer follow-up','No adjunct therapy required for unicystic LPC']},
      {lbl:'📈 Prognosis',items:['Unicystic LPC: recurrence rare — excellent prognosis','Botryoid OC: higher recurrence, longer surveillance required','No malignant transformation reported','Annual follow-up × 2 years standard']},
    ]},
  ],
  pearls:[
    {s:'blue',lbl:'Pearl #1 — The vital tooth rule',txt:'<strong>Vital adjacent tooth is the LPC tell.</strong> If the tooth next to a lateral radiolucency is non-vital, think radicular cyst first. LPC requires a vital pulp — always EPT before committing to diagnosis.'},
    {s:'amber',lbl:'Pearl #2 — Glycogen plaques are pathognomonic',txt:'Focal epithelial thickenings with <strong>PAS-positive glycogen-rich clear cells</strong> = LPC on histology. No other common odontogenic cyst has this finding. If your pathology report mentions glycogen plaques, it is LPC.'},
    {s:'dark',lbl:'Pearl #3 — Botryoid = higher stakes',txt:'Botryoid OC is the polycystic variant. Same histology, but multilocular on imaging and <strong>significantly higher recurrence rate</strong>. If LPC comes back after excision — reassess. It is probably Botryoid OC.'},
  ],
  mnem:{word:'L · P · C',lines:[
    {l:'L',r:'ateral root surface — NOT pericoronal, NOT apical'},
    {l:'P',r:'AS-positive glycogen plaques — pathognomonic histology'},
    {l:'C',r:'urettage only — vital teeth preserved, excellent prognosis'},
  ]},
  syns:[
    {cls:'blue',ico:'🔵',title:'Botryoid Variant (Higher Recurrence)',txt:'The <strong>Botryoid Odontogenic Cyst</strong> is a polycystic LPC variant formed by fused epithelial rests. Larger, multilocular, same histology — but recurrence rate is significantly higher than the unicystic LPC. Treat more aggressively and follow longer.'},
  ],
  next:[
    {id:'coc',ico:'💀',title:'Calcifying Odontogenic Cyst',sub:'Ghost cells, calcifications, and the Gorlin Cyst name to know'},
    {id:'rc',ico:'🦷',title:'Radicular Cyst',sub:'Most common OG cyst — apex, non-vital, inflammatory origin'},
  ],
};

// ── CALCIFYING ODONTOGENIC CYST ─────────────────────────────────────────────
CONDITIONS['coc'] = {
  id:'coc', ey:'Pathology · Odontogenic Cysts · 5 of 8',
  title:'Calcifying Odontogenic Cyst', aka:'Gorlin Cyst · CCOT',
  tags:[{l:'Ghost Cells',c:'purp'},{l:'Mixed Density',c:'amber'},{l:'Odontoma Association',c:'blue'}],
  summary:'Rare odontogenic cyst named the <strong>Gorlin Cyst</strong> — characterized by <strong>ghost cells</strong> (eosinophilic, anucleate epithelial cells) that progressively calcify. Mixed RL/RO pattern on imaging. Can be cystic or solid (Dentinogenic Ghost Cell Tumor). Associated with odontoma and ameloblastoma. Boards key: ghost cells + toothlike calcifications.',
  fp:[{k:'Aggressiveness',v:35,t:'md',l:'Low–Moderate'},{k:'Recurrence',v:28,t:'lo',l:'Low'},{k:'Commonality',v:20,t:'lo',l:'Rare'},{k:'Boards Freq.',v:75,t:'hi',l:'High'},{k:'Tx Complexity',v:35,t:'md',l:'Moderate'}],
  sections:[
    {n:'01',title:'Overview',sub:'Demographics · Location · Character',cards:[
      {lbl:'👤 Who Gets It',items:['Wide age range — bimodal peaks 10–30 and 60–70 yrs','Anterior jaw — mandible slightly > maxilla','Anterior maxilla common when associated with odontoma','No strong sex predilection']},
      {lbl:'📋 Character',items:['Rare — <2% of odontogenic lesions','Mostly asymptomatic or painless swelling','Intraosseous (most common) or extraosseous forms','Cystic (COC) or solid (Dentinogenic Ghost Cell Tumor) spectrum']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Signs · Symptoms · Exam',cards:[
      {lbl:'🏥 Clinical Findings',items:['Asymptomatic or painless jaw swelling','Anterior region: incisors and canines in over 50% of cases','Extraosseous: sessile or pediculated gingival mass — may be painful','Tooth displacement and root resorption possible']},
      {lbl:'⚠️ Associated Lesions',items:['Odontoma: most common association — esp. anterior maxilla','Adenomatoid Odontogenic Tumor (AOT)','Ameloblastoma component: raises management complexity','Association with another OG tumor may require more aggressive treatment']},
    ]},
    {n:'03',title:'Radiographic',sub:'Imaging · Morphology · Mixed Pattern',cards:[
      {lbl:'📡 Radiographic Features',items:['Well-defined unilocular radiolucency (most common)','<strong>Irregular or toothlike radiopaque calcifications</strong> within — a later finding','Root resorption or divergence common','Mixed RL/RO pattern = classic but only after calcification','Early lesions are purely radiolucent — do not exclude COC']},
      {lbl:'🔍 Imaging Clue',items:['Toothlike calcifications = enamel/dentin in aberrant form','May see odontoma as dense radiopacity within or adjacent','Extraosseous: superficial bone cupping or no bony change','Sclerotic rim present in well-established lesions']},
    ]},
    {n:'04',title:'Histopathology',sub:'Ghost Cells · Calcification · Stroma',cards:[
      {lbl:'🔬 Microscopic Findings',items:['<strong>Ghost cells: eosinophilic, anucleate epithelial cells — pathognomonic</strong>','Ghost cells fuse into sheets of amorphous calcified material','Ameloblastoma-like basal layer (palisading columnar cells)','Dentinoid (dysplastic dentin) deposits adjacent to ghost cells','Fibrous connective tissue stroma']},
      {lbl:'💀 Ghost Cell Definition',items:['Altered keratinocytes that lose their nucleus but retain cell outline','Appear as pale "ghosts" of a cell on H&E staining','PAS-positive, eosinophilic','Can calcify progressively — visible radiographically once dense enough','Large sheets of fused ghost cells = dystrophic calcification']},
    ]},
    {n:'05',title:'DDx',sub:'What it mimics · How to separate',ddx:[
      {name:'Adenomatoid Odontogenic Tumor',key:'AOT: anterior maxilla, pericoronal, duct-like structures, no ghost cells — COC: ghost cells, calcifications, broader age range'},
      {name:'Odontoma',key:'Pure calcified mass with no cystic component or lining — COC has epithelial cyst lining + ghost cells'},
      {name:'Dentigerous Cyst',key:'DC: pericoronal, non-keratinized, no ghost cells, no calcifications — COC has ghost cells regardless of pericoronal association'},
      {name:'Ameloblastoma',key:'Ameloblastoma lacks ghost cells — if you see palisading columnar cells AND ghost cells together, think COC with ameloblastomatous component'},
      {name:'OKC',key:'OKC: parakeratinized, corrugated, satellite cysts — no ghost cells, no calcifications. Completely different histology'},
    ]},
    {n:'06',title:'Management',sub:'Treatment · Prognosis · Follow-up',cards:[
      {lbl:'🔪 Treatment',items:['Complete enucleation and curettage: standard for intraosseous COC','Extraosseous subtype: simple surgical excision','If associated with ameloblastoma: may require resection','Dentinogenic Ghost Cell Tumor (solid): more aggressive resection often needed','Low recurrence rate — conservative management usually sufficient']},
      {lbl:'📈 Prognosis',items:['Recurrence rate low for standard COC','Malignant transformation possible but rare (Ghost Cell Odontogenic Carcinoma)','Annual follow-up × 2–3 years post-surgery','Associated tumors (ameloblastoma) drive prognosis more than COC itself']},
    ]},
  ],
  pearls:[
    {s:'purp',lbl:'Pearl #1 — Ghost cells are the answer',txt:'<strong>Ghost cells = COC until proven otherwise.</strong> On any board question featuring eosinophilic anucleate epithelial cells or toothlike calcifications within a jaw cyst, COC is the diagnosis. No other common odontogenic cyst has this finding.'},
    {s:'amber',lbl:'Pearl #2 — Mixed RL/RO is a late finding',txt:'The characteristic <strong>mixed radiolucent–radiopaque pattern</strong> only appears once ghost cells have calcified sufficiently. Early COC is purely radiolucent. Do not exclude COC because the X-ray shows no calcifications.'},
    {s:'dark',lbl:'Pearl #3 — Gorlin Cyst ≠ Gorlin Syndrome',txt:'The <strong>Gorlin Cyst</strong> (COC) and <strong>Gorlin Syndrome</strong> (Nevoid BCC → multiple OKCs) are named after the same person — Jerome Gorlin — but are completely different entities. This is a classic boards trap. Gorlin Cyst = ghost cells. Gorlin Syndrome = PTCH1 mutation + OKCs.'},
  ],
  mnem:{word:'G · H · O · S · T',lines:[
    {l:'G',r:'host cells — pathognomonic eosinophilic anucleate epithelial cells'},
    {l:'H',r:'as calcifications — radiopaque flecks from ghost cell calcification'},
    {l:'O',r:'dontoma association — especially anterior maxilla cases'},
    {l:'S',r:'pectrum — from cystic (COC) to solid (Dentinogenic Ghost Cell Tumor)'},
    {l:'T',r:'reat with enucleation — low recurrence, excellent prognosis'},
  ]},
  syns:[
    {cls:'purp',ico:'💜',title:'Dentinogenic Ghost Cell Tumor (Solid Variant)',txt:'When the COC loses its cystic architecture and becomes a solid mass, it is called the <strong>Dentinogenic Ghost Cell Tumor</strong>. More locally aggressive, higher recurrence rate, may require resection. Part of the ghost cell neoplasm spectrum.'},
    {cls:'red',ico:'🔴',title:'Ghost Cell Odontogenic Carcinoma',txt:'The malignant end of the ghost cell spectrum. Rare. Frankly malignant ghost cell epithelium, bone invasion, perineural spread. High recurrence and metastatic potential. Requires radical resection.'},
  ],
  next:[
    {id:'rc',ico:'🦷',title:'Radicular Cyst',sub:'Most common OG cyst — apex, non-vital, inflammatory origin'},
    {id:'lpc',ico:'🦴',title:'Lateral Periodontal Cyst',sub:'Vital tooth, lateral root, glycogen plaques'},
  ],
};

// ── RADICULAR CYST ───────────────────────────────────────────────────────────
CONDITIONS['rc'] = {
  id:'rc', ey:'Pathology · Odontogenic Cysts · 6 of 8',
  title:'Radicular Cyst', aka:'Periapical Cyst · Apical Periodontal Cyst',
  tags:[{l:'Most Common OG Cyst',c:'blue'},{l:'Inflammatory',c:'red'},{l:'Non-Vital Tooth',c:'slate'}],
  summary:'The <strong>most common odontogenic cyst (~60% of all jaw cysts)</strong>. Arises from <strong>Rests of Malassez</strong> in response to pulpal necrosis from caries or trauma. Always at the <strong>apex of a non-vital tooth</strong>. Inflammatory epithelial lining. First-line treatment is RCT — not surgical enucleation. Boards: apex + non-vital = radicular.',
  fp:[{k:'Aggressiveness',v:15,t:'lo',l:'Low'},{k:'Recurrence',v:12,t:'lo',l:'Rare'},{k:'Commonality',v:98,t:'hi',l:'Most Common OG Cyst'},{k:'Boards Freq.',v:90,t:'hi',l:'Very High'},{k:'Tx Complexity',v:22,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Overview',sub:'Demographics · Pathogenesis · Epidemiology',cards:[
      {lbl:'📋 Pathogenesis',items:['Pulpal necrosis (caries, trauma, crack) → periapical inflammation','Chronic inflammation stimulates Rests of Malassez to proliferate','Epithelial rests form true cyst lining at the root apex','Cyst expands via osmotic pressure + inflammatory mediators','If tooth extracted without cyst removal → Residual Cyst']},
      {lbl:'👤 Who Gets It',items:['Most common in adults ages 30–60','Any tooth can be affected — maxillary anterior most frequent','Equal sex distribution','Direct consequence of untreated dental caries or trauma','Most common cyst in the entire body']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Signs · Symptoms · Exam',cards:[
      {lbl:'🏥 Clinical Findings',items:['Usually asymptomatic unless secondarily infected','Non-vital tooth — cold EPT = no response','History of trauma, extensive restoration, or caries','Percussion sensitivity if acutely inflamed','Parulis or sinus tract if chronically draining','Large cysts: cortical expansion, adjacent tooth displacement']},
      {lbl:'⚠️ Secondary Infection',items:['Mimics periapical abscess when infected','Acute: pain, swelling, purulent drainage, systemic signs','Chronic: sinus tract (parulis) draining chronically','Primary teeth: may damage underlying permanent tooth bud']},
    ]},
    {n:'03',title:'Radiographic',sub:'Imaging · Morphology · Location',cards:[
      {lbl:'📡 Radiographic Features',items:['Well-defined unilocular radiolucency at the <strong>apex</strong>','Continuous with the periodontal ligament space — no gap','Smooth, corticated margins in chronic lesions','Root resorption common in chronic large lesions','No calcifications — purely radiolucent','Cortical expansion if >1.5–2 cm']},
      {lbl:'📏 Size Guide',items:['<1.5 cm: may be periapical granuloma — cannot distinguish radiographically','> 1.5 cm: more likely true cyst than granuloma','Only histology definitively separates granuloma from cyst','CBCT better for cortical involvement and true 3D extent']},
    ]},
    {n:'04',title:'Histopathology',sub:'Epithelium · Inflammation · Origin',cards:[
      {lbl:'🔬 Microscopic Findings',items:['Non-keratinized stratified squamous epithelium','Variable thickness — arcading (net-like) pattern when inflamed','<strong>Mixed inflammatory infiltrate</strong>: neutrophils (acute), plasma cells and lymphocytes (chronic)','Cholesterol clefts with surrounding giant cell reaction','Rushton bodies: eosinophilic, curved hyaline structures in epithelium']},
      {lbl:'🧪 Pathognomonic Clues',items:['Cholesterol clefts + giant cells = inflammatory cyst signature','Rushton bodies (hyaline ring bodies) are essentially unique to RC','Hemosiderin deposits from old hemorrhage','Fibrous stroma with chronic inflammatory infiltrate','Confirms inflammatory origin — NOT developmental']},
    ]},
    {n:'05',title:'DDx',sub:'What it mimics · How to separate',ddx:[
      {name:'Periapical Granuloma',key:'Cannot distinguish radiographically — both at apex of non-vital tooth. Histology: granuloma has no epithelial lining. Treat identically (RCT ± apicoectomy)'},
      {name:'Periapical Abscess',key:'Acute: diffuse, poorly defined borders, systemic signs — RC is chronic, corticated, asymptomatic. Abscess = no defined cyst wall'},
      {name:'Dentigerous Cyst',key:'DC is pericoronal (over the crown) + vital tooth + developmental. RC is apical + non-vital + inflammatory — opposite in every way'},
      {name:'OKC at the Apex',key:'OKC can occur at apex — non-vital tooth makes RC default. Histology resolves: OKC has parakeratinization, corrugated surface, satellite cysts'},
      {name:'Residual Cyst',key:'Identical histology — located in an edentulous site. History of prior tooth extraction at the site is the clinical DDx'},
    ]},
    {n:'06',title:'Management',sub:'Treatment · Prognosis · Follow-up',cards:[
      {lbl:'🔪 Treatment',items:['<strong>Root canal therapy (RCT)</strong> — first-line if tooth restorable','Apicoectomy + retrograde fill if RCT fails or is inaccessible','Surgical extraction if tooth non-restorable','Large cysts (>2 cm): may need surgical enucleation + curettage after RCT','Residual cyst: always enucleate — no tooth source to treat endodontically']},
      {lbl:'📈 Prognosis',items:['Excellent if source of inflammation is fully removed','Recurrence rare after complete RCT ± apicoectomy','Annual periapical radiograph until confirmed healing','No malignant transformation potential','Residual cysts after extraction: excellent prognosis after enucleation']},
    ]},
  ],
  pearls:[
    {s:'blue',lbl:'Pearl #1 — Most common cyst, most tested',txt:'<strong>Radicular cyst = most common odontogenic cyst (~60% of all jaw cysts).</strong> This appears on every board exam. Setup is always: caries or trauma history → non-vital tooth → apical radiolucency. Treat the tooth source first — not just the cyst.'},
    {s:'amber',lbl:'Pearl #2 — Granuloma vs cyst: does it matter clinically?',txt:'<strong>Periapical granuloma and radicular cyst cannot be distinguished radiographically</strong> — both sit at the apex of a non-vital tooth. Both are treated identically with RCT ± apicoectomy. Only histology separates them. Do not overthink this distinction until you have the surgical specimen in hand.'},
    {s:'red',lbl:'Pearl #3 — The residual trap',txt:'<strong>If you extract the tooth without enucleating the cyst lining, the radicular cyst becomes a residual cyst.</strong> It will continue growing asymptomatically in the edentulous site for years, found incidentally on a future panoramic. Always curettage the socket after extracting an infected or endodontically involved tooth.'},
  ],
  mnem:{word:'R · A · D · I · C · S',lines:[
    {l:'R',r:'ests of Malassez — origin of the cystic epithelium'},
    {l:'A',r:'pex — always at the root apex, not the crown'},
    {l:'D',r:'ead tooth — non-vital pulp is required for diagnosis'},
    {l:'I',r:'nflammatory lining — mixed acute and chronic infiltrate'},
    {l:'C',r:'holesterol clefts + Rushton bodies — hallmark histologic findings'},
    {l:'S',r:'tays as residual cyst if cyst left behind after extraction'},
  ]},
  syns:[
    {cls:'slate',ico:'⚫',title:'Residual Cyst — The Post-Extraction Variant',txt:'The <strong>Residual Cyst</strong> is a radicular cyst that persisted after the offending tooth was extracted without full cyst enucleation. Histologically identical. Found incidentally in an edentulous site on panoramic radiograph. Treated with surgical enucleation and curettage.'},
  ],
  next:[
    {id:'res',ico:'🔵',title:'Residual Cyst',sub:'What happens when you extract the tooth but forget the cyst'},
    {id:'para',ico:'🔴',title:'Paradental Cyst',sub:'Inflammatory, lateral to partially erupted tooth — different mechanism'},
  ],
};

// ── RESIDUAL CYST ────────────────────────────────────────────────────────────
CONDITIONS['res'] = {
  id:'res', ey:'Pathology · Odontogenic Cysts · 7 of 8',
  title:'Residual Cyst', aka:'Post-Extraction Radicular Cyst',
  tags:[{l:'Post-Extraction',c:'slate'},{l:'Radicular Origin',c:'red'},{l:'Incidental Panoramic',c:'blue'}],
  summary:'A <strong>radicular cyst that remained after the offending tooth was extracted</strong> without full enucleation of the cyst lining. Histologically identical to a radicular cyst. Grows silently in an edentulous site for years. Found incidentally on routine panoramic. Boards trap: edentulous radiolucency in an older adult = residual cyst first. <strong>"Residual" ≠ "Recurrent."</strong>',
  fp:[{k:'Aggressiveness',v:10,t:'lo',l:'None'},{k:'Recurrence',v:8,t:'lo',l:'Rare'},{k:'Commonality',v:40,t:'md',l:'Uncommon'},{k:'Boards Freq.',v:48,t:'md',l:'Moderate'},{k:'Tx Complexity',v:15,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Overview',sub:'How It Forms · Who Gets It · Where',cards:[
      {lbl:'📋 Pathogenesis',items:['Tooth extracted WITHOUT full curettage of the cyst lining','Residual epithelium continues to proliferate asymptomatically','No longer driven by pulpal inflammation — becomes self-sustaining','Expands via osmotic pressure like all jaw cysts','Silent growth for months to years post-extraction']},
      {lbl:'👤 Demographics',items:['Common in adults ages 50–70 with history of dental neglect','Often found incidentally on routine panoramic X-ray','Any edentulous site — posterior mandible most common','History of prior extraction with known or suspected periapical disease']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Signs · Symptoms · Exam',cards:[
      {lbl:'🏥 Clinical Findings',items:['Asymptomatic in vast majority of cases','No associated tooth — edentulous site is the key finding','No drainage, no swelling unless very large','Incidental finding on routine panoramic radiograph','Large lesions: cortical expansion, facial asymmetry']},
      {lbl:'⚠️ Key History Questions',items:['Tooth extracted in this area in the past?','Was prior extraction complicated by infection or abscesses?','When was the last full-mouth panoramic taken?','History of chronic dental caries or trauma in that region?','Prior failed root canal in adjacent teeth?']},
    ]},
    {n:'03',title:'Radiographic',sub:'Imaging · Morphology · Location',cards:[
      {lbl:'📡 Radiographic Features',items:['Well-defined unilocular radiolucency in an <strong>edentulous site</strong>','Smooth, corticated margins (well-established chronic lesion)','No associated tooth — the distinguishing feature','Round or oval shape','May show cortical expansion in large chronic lesions']},
      {lbl:'📏 DDx by Location',items:['Edentulous posterior mandible → residual cyst is #1 DDx','Edentulous anterior maxilla → also consider nasopalatine duct cyst','Large lesion in edentulous area → must rule out OKC and ameloblastoma','Always correlate with extraction history at the specific site']},
    ]},
    {n:'04',title:'Histopathology',sub:'Epithelium · Stroma · Identical to RC',cards:[
      {lbl:'🔬 Microscopic Findings',items:['Non-keratinized stratified squamous epithelium','Variable thickness — may be thinner than active RC','<strong>Inflammatory infiltrate may be minimal or absent</strong> — the source has been removed','Fibrous stroma with variable chronicity','Cholesterol clefts possible but less prominent','Histologically cannot be distinguished from radicular cyst']},
      {lbl:'🧪 The Diagnostic Distinction',items:['Clinical: no tooth present — edentulous site','Radiographic: no associated root or apex','Histologic: identical to radicular cyst — diagnosis is clinico-radiographic','Reduced inflammation vs. active radicular cyst (source is gone)','Rushton bodies possible but less common than in active RC']},
    ]},
    {n:'05',title:'DDx',sub:'What it mimics · How to separate',ddx:[
      {name:'Radicular Cyst',key:'Identical histology — differs by location: RC has an associated non-vital tooth, residual cyst is in a toothless site. Extraction history resolves this'},
      {name:'OKC (edentulous area)',key:'OKC: parakeratinized, satellite cysts, aggressive growth, scalloped margins — residual cyst is non-keratinized, well-behaved. Always biopsy large edentulous radiolucencies'},
      {name:'Nasopalatine Duct Cyst',key:'Nasopalatine: midline anterior maxilla, heart-shaped on PA, incisive canal location — residual cyst follows prior extraction site, not midline anatomy'},
      {name:'Traumatic Bone Cyst',key:'TBC is empty (no epithelial lining) — found in young patients, scallops around tooth roots. Residual cyst has true lining, older adult, edentulous area'},
      {name:'Stafne Bone Defect',key:'Stafne: posterior mandible BELOW the inferior alveolar canal, static on serial imaging — residual cyst is above IAN, enlarges over time'},
    ]},
    {n:'06',title:'Management',sub:'Treatment · Prognosis · Follow-up',cards:[
      {lbl:'🔪 Treatment',items:['Complete enucleation and curettage of the cyst lining','No tooth to treat — purely surgical approach','Histopathologic submission required to confirm diagnosis','Defect fills with bone over 6–12 months','No adjunct therapy needed for standard residual cyst']},
      {lbl:'📈 Prognosis',items:['Excellent — recurrence after complete removal is rare','No malignant transformation potential','1-year post-op panoramic to confirm bone fill','Prevent future residual cysts: always curettage the socket after extracting infected or endodontically involved teeth']},
    ]},
  ],
  pearls:[
    {s:'blue',lbl:'Pearl #1 — Edentulous + radiolucency = residual cyst first',txt:'When you see a <strong>well-defined unilocular radiolucency in an edentulous site in an older adult</strong>, residual cyst is your default diagnosis. Get the extraction history. Confirm with biopsy. It is almost always a residual cyst — but you must biopsy to exclude OKC or ameloblastoma.'},
    {s:'amber',lbl:'Pearl #2 — Residual ≠ Recurrent',txt:'These are different and the boards will test this distinction. <strong>Residual = never fully removed</strong> (the cyst persisted after extraction). <strong>Recurrent = came back after complete removal.</strong> Residual cysts are histologically identical to radicular cysts. Recurrent cysts should make you think OKC or UA.'},
    {s:'red',lbl:'Pearl #3 — Prevention is the real lesson',txt:'<strong>The residual cyst is a preventable complication.</strong> Every time you extract a tooth with known periapical pathology, curettage the socket and send the specimen. This is how residual cysts are stopped before they start — and why pathology awareness during routine extractions matters clinically.'},
  ],
  mnem:{word:'R · E · S · I · D · E',lines:[
    {l:'R',r:'adicular origin — same lining, same cells, same pathogenesis'},
    {l:'E',r:'dentulous site — no tooth present is the critical clinical tell'},
    {l:'S',r:'ilent growth — asymptomatic for months to years post-extraction'},
    {l:'I',r:'ncidental finding — discovered on routine panoramic X-ray'},
    {l:'D',r:'oes not recur — complete enucleation is curative'},
    {l:'E',r:'nucleation + curettage — surgical only, no source to treat endodontically'},
  ]},
  syns:[
    {cls:'slate',ico:'⚫',title:'Radicular Cyst — The Active Parent Lesion',txt:'The Residual Cyst is histologically identical to the <strong>Radicular Cyst</strong> — the only difference is that the tooth is gone. Understand radicular cysts completely and you understand residual cysts. The pathogenesis, epithelium, and inflammatory picture are the same. Just no tooth to point to.'},
  ],
  next:[
    {id:'para',ico:'🔴',title:'Paradental Cyst',sub:'Inflammatory, lateral to partially erupted tooth — the final condition'},
    {id:'rc',ico:'🦷',title:'Radicular Cyst',sub:'Review the active parent lesion — critical boards distinction'},
  ],
};

// ── PARADENTAL CYST ──────────────────────────────────────────────────────────
CONDITIONS['para'] = {
  id:'para', ey:'Pathology · Odontogenic Cysts · 8 of 8',
  title:'Paradental Cyst', aka:'Inflammatory Collateral Cyst · Buccal Bifurcation Cyst (children)',
  tags:[{l:'Inflammatory',c:'red'},{l:'Pericoronitis Origin',c:'amber'},{l:'3rd Molar Region',c:'slate'}],
  summary:'Inflammatory cyst arising at the <strong>buccal or lateral surface of a partially erupted tooth</strong> — most commonly mandibular 3rd molar — driven by pericoronitis. Key DDx from DC: location is <strong>lateral to the crown, NOT pericoronal over it</strong>. Pediatric variant (mandibular 1st molar) = Buccal Bifurcation Cyst. Vital tooth throughout. Enucleation ± extraction.',
  fp:[{k:'Aggressiveness',v:18,t:'lo',l:'Low'},{k:'Recurrence',v:15,t:'lo',l:'Low'},{k:'Commonality',v:30,t:'lo',l:'Uncommon'},{k:'Boards Freq.',v:42,t:'md',l:'Moderate'},{k:'Tx Complexity',v:22,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Overview',sub:'Pathogenesis · Variants · Demographics',cards:[
      {lbl:'📋 Pathogenesis',items:['Pericoronitis → chronic inflammation around partially erupted crown','Rests of Serres or reduced enamel epithelium stimulated to proliferate','Cyst forms on the lateral or buccal surface — NOT over the crown','Tooth remains vital — inflammatory mechanism not developmental','BBC (children): same process, mandibular 1st molar, ages 5–15']},
      {lbl:'👤 Demographics',items:['Adults: 3rd molar region — ages 20–40','Children (BBC): 5–15 years — mandibular 1st molar','Mandible only — maxillary paradental cysts exceedingly rare','History of recurrent pericoronitis in the area is classic']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Signs · Symptoms · Exam',cards:[
      {lbl:'🏥 Clinical Findings',items:['History of recurrent pericoronitis episodes','Buccal or lateral swelling adjacent to partially erupted tooth','Tooth is vital — EPT positive throughout','Pocketing on the buccal or lateral aspect of the crown','May have pain, drainage, or foul taste if acutely inflamed','BBC: buccal swelling + lingually tipped tooth roots']},
      {lbl:'⚠️ BBC vs. Adult Paradental',items:['BBC: children, mandibular 1st molar, roots tipped lingually','Adult: 3rd molar, posterior mandible, pericoronitis history','Both: buccal location, vital tooth, inflammatory origin','BBC: extraction often unnecessary — enucleation alone curative','Key feature: buccal pericoronitis + buccal cortex displacement']},
    ]},
    {n:'03',title:'Radiographic',sub:'Imaging · Morphology · Location',cards:[
      {lbl:'📡 Radiographic Features',items:['Well-defined unilocular radiolucency on the <strong>buccal or lateral</strong> aspect','NOT pericoronal — the radiolucency does NOT surround the crown','Roots may appear tipped lingually (BBC hallmark)','Well-corticated margins in chronic cases','Partially erupted 3rd molar with lateral buccal lucency = classic adult presentation']},
      {lbl:'🔍 Distinguish from DC',items:['DC: radiolucency is OVER the crown (pericoronal)','Paradental: radiolucency is BESIDE the crown (lateral/buccal)','Both involve impacted or partially erupted teeth','Both in the 3rd molar region in adults','Location relative to the crown is the single decisive DDx point']},
    ]},
    {n:'04',title:'Histopathology',sub:'Epithelium · Inflammation · Stroma',cards:[
      {lbl:'🔬 Microscopic Findings',items:['Non-keratinized stratified squamous epithelium','<strong>Prominent inflammatory infiltrate</strong> — key distinguishing feature','Mixed acute (neutrophils) and chronic (plasma cells, lymphocytes) cells','Fibrous connective tissue wall','Cholesterol clefts possible','No ghost cells, no parakeratinization, no satellite cysts']},
      {lbl:'🧪 Differentiation from LPC',items:['LPC: thin epithelium + glycogen plaques + minimal inflammation','Paradental: thick inflamed epithelium + pericoronitis history + buccal location','Both: vital adjacent tooth, lateral to root','Pericoronitis history + location is the clinical separator','Histology alone insufficient — need clinical correlation']},
    ]},
    {n:'05',title:'DDx',sub:'What it mimics · How to separate',ddx:[
      {name:'Dentigerous Cyst',key:'DC is pericoronal (crown surrounded) + developmental + no pericoronitis required. Paradental: lateral to crown + inflammatory + pericoronitis history is always present'},
      {name:'Lateral Periodontal Cyst',key:'LPC: fully erupted vital tooth, no pericoronitis, glycogen plaques on histo, premolar region — paradental: partially erupted, inflamed, 3rd molar'},
      {name:'Buccal Bifurcation Cyst',key:'BBC IS the pediatric paradental cyst — same entity, different tooth (1st molar), different age (children 5–15), same buccal location and vital tooth'},
      {name:'Lateral Radicular Cyst',key:'Lateral RC: non-vital tooth from lateral accessory canal — paradental: vital tooth + pericoronitis history + buccal location distinguishes clearly'},
      {name:'Pericoronal Abscess',key:'Acute infection around crown — similar history but no defined cyst wall on imaging. Paradental cyst is chronic with corticated defined architecture'},
    ]},
    {n:'06',title:'Management',sub:'Treatment · Prognosis · Follow-up',cards:[
      {lbl:'🔪 Treatment',items:['Enucleation and curettage: standard approach','Extraction of involved tooth: often performed but not always required','BBC (children): <strong>extraction often NOT necessary</strong> — enucleation alone curative and tooth erupts normally','Address pericoronitis: operculectomy or extraction of opposing tooth also considered','Irrigate and debride if acutely infected before definitive surgery']},
      {lbl:'📈 Prognosis',items:['Low recurrence rate after complete enucleation','Excellent overall prognosis','BBC: affected tooth usually continues to erupt normally after enucleation','Annual follow-up × 1–2 years sufficient','Recurrence should prompt evaluation for completeness of removal']},
    ]},
  ],
  pearls:[
    {s:'red',lbl:'Pearl #1 — Lateral, not pericoronal',txt:'<strong>The paradental cyst is lateral to the crown — not over it.</strong> This one anatomical distinction separates it from a dentigerous cyst on imaging. Both are near the 3rd molar. Trace the outline of the crown on the X-ray and ask where the radiolucency begins. If it is beside the crown rather than encircling it, think paradental.'},
    {s:'amber',lbl:'Pearl #2 — Pericoronitis is the mechanism',txt:'<strong>Every paradental cyst starts with pericoronitis.</strong> The chronic inflammation around the operculum of a partially erupted tooth drives epithelial proliferation. Patients with years of recurrent pericoronitis are your highest risk group. Treat pericoronitis aggressively early — or you may be treating a paradental cyst later.'},
    {s:'blue',lbl:'Pearl #3 — Buccal Bifurcation Cyst saves the tooth',txt:'The <strong>Buccal Bifurcation Cyst</strong> is the paradental cyst in children — mandibular 1st molar, buccal location, roots tipped lingually. What makes it memorable clinically: <strong>extraction is usually NOT required.</strong> Enucleation alone resolves it and the affected tooth erupts normally. This is the condition where surgeons routinely save the tooth.'},
  ],
  mnem:{word:'P · A · R · A · D · E',lines:[
    {l:'P',r:'ericoronitis — the inflammatory source that drives cyst formation'},
    {l:'A',r:'djacent to crown, not over it — lateral/buccal location'},
    {l:'R',r:'oots tipped lingually (Buccal Bifurcation Cyst, children)'},
    {l:'A',r:'dults: 3rd molar. Kids: 1st molar (BBC)'},
    {l:'D',r:'evelopmentally vital tooth — EPT positive throughout'},
    {l:'E',r:'nucleation ± extraction — BBC extraction often avoidable'},
  ]},
  syns:[
    {cls:'amber',ico:'🟡',title:'Buccal Bifurcation Cyst — Pediatric Variant',txt:'Same pathogenesis, different age group and tooth. In children ages 5–15, pericoronitis around the erupting mandibular <strong>1st molar</strong> drives cyst formation on its buccal surface. Roots are displaced lingually — a classic radiographic hallmark. Enucleation alone is usually curative and the tooth preserves normal eruption.'},
  ],
  next:[
    {id:'dc',ico:'🦷',title:'Dentigerous Cyst',sub:'Revisit the pericoronal cyst — the contrast with Paradental is instructive'},
    {id:'okc',ico:'🦴',title:'OKC / KCOT',sub:'The aggressive benchmark — see how these inflammatory cysts compare'},
  ],
};



// ── TRAINER CASES ──
const CASES=[
  {n:1,badge:'Panoramic · Posterior Mandible',badge2:'28M · Asymptomatic',svg:'dc',
   vig:'A <strong>28-year-old male</strong> presents for routine dental exam. He is asymptomatic. Panoramic radiograph reveals a <strong>well-defined, unilocular radiolucency</strong> in the posterior left mandible associated with an <strong>impacted mandibular third molar</strong>. The pericoronal radiolucency measures approximately <strong>6 mm</strong>. Borders are corticated. Adjacent second molar shows mild root displacement. No cortical expansion.',
   finds:[{t:'Unilocular radiolucency',c:'radio'},{t:'Pericoronal >3–4mm',c:'radio'},{t:'Corticated borders',c:'radio'},{t:'Asymptomatic',c:'clinical'},{t:'Impacted #17',c:'clinical'},{t:'Root displacement',c:'clinical'}],
   ans:'Dentigerous Cyst',opts:['Odontogenic Keratocyst','Dentigerous Cyst','Unicystic Ameloblastoma','Hyperplastic Follicle'],
   correct:'The pericoronal location >3–4mm around an impacted tooth with unilocular corticated borders and no expansion = classic DC. Asymptomatic + incidental = consistent with benign slow-growing cyst.',
   wrong:'OKC and Unicystic Ameloblastoma can appear radiographically identical. Histology confirms the diagnosis. The presentation most favors DC by the threshold rule and clinical picture.',
   reasoning:[{k:'Pericoronal >3–4mm',v:'match',t:'✓ Pathologic threshold — Dentigerous Cyst'},{k:'Unilocular + corticated',v:'match',t:'✓ Favors benign cyst'},{k:'Asymptomatic + incidental',v:'match',t:'✓ Classic DC presentation'},{k:'No cortical expansion',v:'match',t:'✓ Argues against OKC'},{k:'Why not OKC?',v:'warn',t:'OKC can look identical — histology needed'},{k:'Why not UA?',v:'warn',t:'Cannot exclude radiographically — always biopsy'},{k:'Why not Hyperplastic Follicle?',v:'err',t:'HF is <3mm — this is 6mm, clearly pathologic'}]},
  {n:2,badge:'Panoramic · Left Mandible + Ramus',badge2:'22M · Referred · Family Hx',svg:'okc',
   vig:'A <strong>22-year-old male</strong> is referred for an asymptomatic jaw lesion. Panoramic shows a <strong>large, multilocular radiolucency</strong> in the <strong>left posterior mandible and ramus</strong>. Borders are well-defined but scalloped. Clinical exam reveals <strong>surprisingly minimal buccal expansion</strong> for the lesion size. No pain. Family history reveals <strong>history of skin lesions</strong> in his father.',
   finds:[{t:'Multilocular radiolucency',c:'radio'},{t:'Scalloped borders',c:'radio'},{t:'Grows along medullary',c:'radio'},{t:'Minimal expansion vs. size',c:'clinical'},{t:'Asymptomatic',c:'clinical'},{t:'Family hx: skin lesions',c:'clinical'}],
   ans:'Odontogenic Keratocyst',opts:['Dentigerous Cyst','Ameloblastoma','Odontogenic Keratocyst','Central Giant Cell Granuloma'],
   correct:'Large multilocular radiolucency with scalloped borders, silent growth along medullary bone with disproportionately minimal expansion, young patient, and family history of skin lesions = classic OKC with Gorlin Syndrome red flag.',
   wrong:'Ameloblastoma is possible but typically causes more cortical expansion with soap-bubble pattern. The silent medullary extension with minimal expansion is the OKC signature.',
   reasoning:[{k:'Multilocular + scalloped',v:'match',t:'✓ Classic OKC radiographic pattern'},{k:'Silent medullary growth',v:'match',t:'✓ Pathognomonic OKC behavior'},{k:'Minimal expansion vs. size',v:'match',t:'✓ OKC grows along bone, not through it'},{k:'Young patient (22M)',v:'match',t:'✓ Peak OKC incidence 20–40 years'},{k:'Family skin lesion history',v:'warn',t:'⚠️ Gorlin Syndrome red flag — PTCH1 evaluation'},{k:'Why not Ameloblastoma?',v:'warn',t:'Ameloblastoma shows more cortical expansion'},{k:'Next step',v:'match',t:'Biopsy + Gorlin Syndrome workup'}]},
  {n:3,badge:'CBCT · Right Posterior Mandible',badge2:'18F · Post-Enucleation 8 Months',svg:'ua',
   vig:'An <strong>18-year-old female</strong> underwent enucleation of a "Dentigerous Cyst" 8 months ago. She returns with a <strong>recurrent radiolucency</strong> at the same site, appearing identical to the original on CBCT — unilocular, well-defined, pericoronal. Asymptomatic. Review of the original slides reveals <strong>palisading columnar cells at the epithelial–connective tissue interface</strong> in deeper sections.',
   finds:[{t:'Pericoronal recurrence',c:'radio'},{t:'Identical to original',c:'radio'},{t:'8mo post-enucleation',c:'clinical'},{t:'Treated as DC',c:'clinical'},{t:'Palisading columnar cells',c:'histo'}],
   ans:'Unicystic Ameloblastoma',opts:['Recurrent Dentigerous Cyst','Odontogenic Keratocyst','Unicystic Ameloblastoma','Residual Cyst'],
   correct:'Recurrence at 8 months after enucleation + radiographically identical appearance + palisading columnar cells on re-review of the original specimen = Unicystic Ameloblastoma. This is exactly how UA is missed and misclassified as DC.',
   wrong:'OKC is defined by parakeratinization + daughter cysts, not palisading columnar cells. The histologic finding of palisading columnar cells with reverse nuclear polarity = Ameloblastoma.',
   reasoning:[{k:'Recurrence at 8 months',v:'err',t:'Dentigerous Cysts virtually never recur'},{k:'Radiographically identical',v:'warn',t:'UA mirrors DC radiographically — the danger'},{k:'Palisading columnar cells',v:'match',t:'✓ Pathognomonic for Ameloblastoma'},{k:'Young patient, impacted tooth',v:'warn',t:'Classic UA presentation — missed initially'},{k:'Treatment implication',v:'err',t:'Now requires resection — not repeat enucleation'},{k:'The lesson',v:'match',t:'Every pericoronal cyst: biopsy before Tx'}]},

  // ── CASE 4: DC TRAP — Large DC mimicking OKC ─────────────────────────────
  {n:4,badge:'Panoramic · Anterior Mandible',badge2:'34F · Painless Swelling 4 Months',svg:'dc_ant',
   vig:'A <strong>34-year-old female</strong> presents with a 4-month history of painless lower jaw swelling. Panoramic shows a <strong>large, well-defined radiolucency</strong> spanning the anterior mandible from canine to canine, associated with an <strong>impacted supernumerary tooth</strong>. The lesion measures 3.8 cm. Borders are corticated and smooth. No scalloping. Buccal plate is expanded and thinned. Adjacent teeth are vital. No paresthesia.',
   finds:[{t:'Large unilocular RL (3.8cm)',c:'radio'},{t:'Pericoronal — supernumerary',c:'radio'},{t:'Corticated, smooth borders',c:'radio'},{t:'Buccal plate expansion',c:'clinical'},{t:'No scalloping',c:'radio'},{t:'Adjacent teeth vital',c:'clinical'}],
   ans:'Dentigerous Cyst',opts:['Odontogenic Keratocyst','Dentigerous Cyst','Ameloblastoma (Multicystic)','Calcifying Odontogenic Cyst'],
   correct:'Large size alone does not make this OKC. The key: unilocular (not multilocular), smooth corticated borders (not scalloped), cortical expansion present (OKC expands minimally for its size), pericoronal location around an impacted tooth. DC can grow large — size is not the DDx.',
   wrong:'OKC is the knee-jerk for large jaw lesions, but OKC characteristically grows ALONG bone with minimal expansion, has scalloped/irregular borders, and tends toward multilocularity when large. This lesion expands cortex and has smooth borders — DC behavior.',
   reasoning:[{k:'Unilocular, smooth borders',v:'match',t:'✓ Favors DC — OKC scallops when large'},{k:'Cortical expansion',v:'match',t:'✓ DC expands cortex; OKC grows along medullary'},{k:'Pericoronal (supernumerary)',v:'match',t:'✓ Classic DC mechanism'},{k:'Large size (3.8cm)',v:'warn',t:'Size alone does not change diagnosis'},{k:'No multilocularity',v:'match',t:'✓ Large OKC tends to multiloculate'},{k:'No scalloping',v:'match',t:'✓ OKC borders are typically scalloped'},{k:'Why not Ameloblastoma?',v:'warn',t:'Multicystic amelo: soap-bubble pattern, more destruction'}]},

  // ── CASE 5: OKC RECOGNITION — Unilocular OKC missed as DC ────────────────
  {n:5,badge:'Periapical · Right Mandible',badge2:'28M · Referred After Routine Panoramic',svg:'okc_uni',
   vig:'A <strong>28-year-old male</strong> is referred after a routine panoramic reveals a <strong>well-defined unilocular radiolucency</strong> in the right posterior mandible associated with an impacted mandibular second premolar. The pericoronal space measures <strong>9 mm</strong>. Borders are smooth and corticated. No expansion. The referring dentist diagnosed "likely Dentigerous Cyst." CBCT reveals <strong>scalloped posterior border and subtle cortical perforation</strong> at the distal ramus.',
   finds:[{t:'Unilocular radiolucency',c:'radio'},{t:'Pericoronal 9mm',c:'radio'},{t:'Smooth corticated borders (2D)',c:'radio'},{t:'Scalloped posterior wall (CBCT)',c:'radio'},{t:'Cortical perforation distal',c:'radio'},{t:'No expansion',c:'clinical'}],
   ans:'Odontogenic Keratocyst',opts:['Dentigerous Cyst','Odontogenic Keratocyst','Unicystic Ameloblastoma','Hyperplastic Follicle'],
   correct:'CBCT reveals the tell: scalloped posterior border and cortical perforation. OKC can appear identical to DC on 2D panoramic — unilocular, pericoronal, corticated. CBCT or histology separates them. The absence of expansion for the lesion size, the cortical perforation, and subtle scalloping on CBCT all point to OKC.',
   wrong:'DC cannot be excluded on panoramic alone when pericoronal radiolucency is this large. The critical findings are on CBCT — scalloped border and cortical perforation are OKC behavior. DC does not typically perforate cortex at this size.',
   reasoning:[{k:'Unilocular + pericoronal',v:'warn',t:'Can be DC or OKC — panoramic alone insufficient'},{k:'No expansion for 9mm',v:'match',t:'✓ OKC grows along bone — minimal expansion'},{k:'Scalloped posterior wall (CBCT)',v:'match',t:'✓ OKC scallops — DC is smooth'},{k:'Cortical perforation (CBCT)',v:'match',t:'✓ OKC perforates cortex more readily'},{k:'Young patient (28M)',v:'match',t:'✓ Peak OKC decade'},{k:'Why not DC?',v:'warn',t:'DC: smooth borders throughout, no perforation'},{k:'Lesson',v:'match',t:'Every pericoronal cyst >5mm needs CBCT + biopsy'}]},

  // ── CASE 6: OKC TRAP — Post-treatment recurrence ─────────────────────────
  {n:6,badge:'CBCT · Left Ramus',badge2:'31M · 18 Months Post-Enucleation',svg:'okc',
   vig:'A <strong>31-year-old male</strong> returns 18 months after enucleation and Carnoy\'s solution treatment of a confirmed OKC in the left ramus. CBCT shows a <strong>new 1.2 cm radiolucency</strong> at the inferior margin of the surgical site. The patient is asymptomatic. His surgeon considers whether to re-enucleate or escalate. Review of the original path report notes "satellite cyst present in fibrous wall."',
   finds:[{t:'New lucency at surgical margin',c:'radio'},{t:'1.2cm — small',c:'radio'},{t:'18mo post-enucleation',c:'clinical'},{t:'Original had satellite cyst',c:'histo'},{t:'Carnoy\'s used originally',c:'clinical'},{t:'Asymptomatic',c:'clinical'}],
   ans:'Odontogenic Keratocyst',opts:['Surgical Defect (Normal Healing)','Odontogenic Keratocyst','Dentigerous Cyst','Ameloblastoma'],
   correct:'OKC recurrence at the surgical margin 18 months post-enucleation, with documented satellite cyst in the original specimen. Satellite (daughter) cysts left in the surgical margin are the primary driver of OKC recurrence — they were not addressed by enucleation + Carnoy\'s alone. This is a recurrent OKC, not normal healing.',
   wrong:'Normal healing defects do not present as new discrete radiolucencies with defined borders — they are ill-defined and fill progressively. A new corticated radiolucency at 18 months = recurrence until proven otherwise. Satellite cysts in the original specimen should have raised recurrence risk at the time.',
   reasoning:[{k:'New defined radiolucency',v:'err',t:'Not normal healing — healing is progressive fill'},{k:'18mo timeframe',v:'match',t:'✓ OKC recurrence peaks within 2 years'},{k:'Satellite cyst documented',v:'err',t:'Satellite cysts = high recurrence risk — flagged at surgery'},{k:'Carnoy\'s not sufficient alone',v:'warn',t:'Adjunct therapy reduces but does not eliminate recurrence'},{k:'Management consideration',v:'match',t:'Peripheral ostectomy or segmental resection now indicated'},{k:'30–50% recurrence rate',v:'match',t:'✓ OKC: highest recurrence of all OG cysts'}]},

  // ── CASE 7: UA RECOGNITION — Classic young patient ───────────────────────
  {n:7,badge:'Panoramic · Right Posterior Mandible',badge2:'16F · Referred · Asymptomatic',svg:'ua',
   vig:'A <strong>16-year-old female</strong> is referred with a 6-month-old panoramic showing a <strong>well-defined unilocular radiolucency</strong> associated with an impacted mandibular right third molar. The pericoronal space is <strong>enlarged to 11mm</strong>. The lesion is asymptomatic. She has no swelling, no paresthesia, and adjacent teeth test vital. The oral surgery program schedules enucleation under the working diagnosis of "Dentigerous Cyst."',
   finds:[{t:'Unilocular pericoronal RL',c:'radio'},{t:'Enlarged to 11mm',c:'radio'},{t:'Corticated borders',c:'radio'},{t:'16yo female',c:'clinical'},{t:'Asymptomatic',c:'clinical'},{t:'No expansion',c:'clinical'}],
   ans:'Unicystic Ameloblastoma',opts:['Dentigerous Cyst','Odontogenic Keratocyst','Unicystic Ameloblastoma','Hyperplastic Follicle'],
   correct:'Radiographically identical to DC — but this is the classic UA setup: young patient, pericoronal unilocular cyst, third molar, asymptomatic. The correct answer is not "UA confirmed" — the correct answer is that UA cannot be excluded without histology. Never enucleate a pericoronal cyst without sending the specimen. The answer here is: biopsy first.',
   wrong:'DC is the most likely diagnosis statistically. But UA is the catastrophic miss — radiographically identical, treated differently (resection vs. enucleation), and confirmed only by histology showing palisading columnar cells with reverse nuclear polarity at the epithelial–connective tissue interface.',
   reasoning:[{k:'Unilocular pericoronal',v:'warn',t:'DC most likely — but UA looks identical on imaging'},{k:'Young patient (16F)',v:'match',t:'✓ Classic UA age group (10–30 years)'},{k:'Impacted 3rd molar',c:'match',t:'✓ UA most common here'},{k:'Asymptomatic, no expansion',v:'warn',t:'Cannot exclude UA on clinical grounds'},{k:'No histology yet',v:'err',t:'Treatment decision requires biopsy FIRST'},{k:'If UA confirmed',v:'match',t:'Resection required — not repeat enucleation'},{k:'The rule',v:'match',t:'Every pericoronal cyst: histology before definitive Tx'}]},

  // ── CASE 8: LPC RECOGNITION — Classic lateral radiolucency ───────────────
  {n:8,badge:'Periapical · Left Mandible',badge2:'52F · Incidental Finding',svg:'lpc',
   vig:'A <strong>52-year-old female</strong> presents for a routine periodontal check. Periapical radiograph reveals a <strong>small, well-defined, teardrop-shaped radiolucency</strong> along the lateral aspect of the root of the mandibular left first premolar. The lesion measures approximately <strong>7mm</strong>. Borders are smooth and corticated. The premolar and adjacent canine both respond normally to cold EPT. No swelling, no pocketing beyond 3mm, no history of trauma.',
   finds:[{t:'Lateral root radiolucency',c:'radio'},{t:'Well-defined, 7mm',c:'radio'},{t:'Teardrop/oval shape',c:'radio'},{t:'Premolar–canine region',c:'radio'},{t:'Vital adjacent teeth (EPT+)',c:'clinical'},{t:'Asymptomatic',c:'clinical'}],
   ans:'Lateral Periodontal Cyst',opts:['Lateral Radicular Cyst','Lateral Periodontal Cyst','Odontogenic Keratocyst','Periapical Granuloma'],
   correct:'Small, well-defined teardrop radiolucency lateral to the root of a vital premolar in a 50-year-old adult = classic Lateral Periodontal Cyst. Vital teeth (EPT positive) exclude radicular cyst. Mandibular premolar–canine region is the pathognomonic location. Biopsy will show glycogen-rich focal epithelial plaques on histology.',
   wrong:'Lateral Radicular Cyst is the main DDx — same position, but requires a NON-vital tooth. Always EPT adjacent teeth first. Vitality is the single most important clinical test in this scenario. Positive EPT = developmental cyst (LPC). Negative EPT = inflammatory cyst (radicular).',
   reasoning:[{k:'Lateral root position',v:'match',t:'✓ LPC: alongside root, not apical'},{k:'Teardrop shape',c:'match',t:'✓ Classic LPC morphology'},{k:'Premolar–canine region',v:'match',t:'✓ Most common LPC location'},{k:'Vital EPT — both teeth',v:'match',t:'✓ Excludes radicular cyst (needs non-vital tooth)'},{k:'Adult patient (52F)',v:'match',t:'✓ LPC peaks 40–80 years'},{k:'Why not OKC?',v:'warn',t:'OKC: rarely this small, parakeratinized histo, more aggressive'},{k:'Next step',v:'match',t:'Enucleation + histology — expect glycogen plaques'}]},

  // ── CASE 9: LPC TRAP — LPC vs. Lateral Radicular Cyst ───────────────────
  {n:9,badge:'Periapical · Anterior Maxilla',badge2:'44M · Post-Trauma',svg:'rclat',
   vig:'A <strong>44-year-old male</strong> who sustained facial trauma 2 years ago presents with no current complaints. Periapical X-ray of the maxillary anterior region shows a <strong>well-defined, 8mm radiolucency along the lateral surface</strong> of the left lateral incisor root. Borders are corticated. The patient reports the lateral incisor had a previous root canal performed elsewhere 18 months ago. No swelling. Probing depths normal.',
   finds:[{t:'Lateral root radiolucency',c:'radio'},{t:'Well-defined, 8mm',c:'radio'},{t:'Left lateral incisor',c:'radio'},{t:'Prior trauma history',c:'clinical'},{t:'Root canal treated tooth',c:'clinical'},{t:'No swelling',c:'clinical'}],
   ans:'Lateral Radicular Cyst',opts:['Lateral Periodontal Cyst','Lateral Radicular Cyst','Dentigerous Cyst','Nasopalatine Duct Cyst'],
   correct:'RCT-treated tooth following trauma = non-vital pulp origin. A lateral radiolucency on a root-canal-treated tooth is a lateral radicular cyst — either from an accessory lateral canal or inadequate RCT. Vitality is irrelevant (tooth already treated). The history of trauma + RCT is the pivot point, not the radiographic appearance.',
   wrong:'LPC looks radiographically identical — same position, same size, same shape. But LPC requires a vital tooth with no history of pulpal pathology. An RCT-treated tooth after trauma = non-vital origin = radicular cyst. The history is the DDx, not the image.',
   reasoning:[{k:'Lateral root position',v:'warn',t:'Same as LPC — cannot distinguish on image alone'},{k:'Root canal treated tooth',v:'match',t:'✓ Non-vital origin — radicular, not developmental'},{k:'Trauma history (2yr ago)',v:'match',t:'✓ Pulpal necrosis → cyst at lateral accessory canal'},{k:'No EPT possible (RCT tooth)',v:'warn',t:'Cannot confirm vitality — use clinical history instead'},{k:'Why not LPC?',v:'err',t:'LPC requires vital tooth, no prior pulpal pathology'},{k:'Treatment',v:'match',t:'Apicoectomy + retrograde fill or re-RCT first'}]},

  // ── CASE 10: COC RECOGNITION — Ghost cell path report ────────────────────
  {n:10,badge:'Panoramic · Anterior Mandible',badge2:'19M · Painless Swelling',svg:'coc_ant',
   vig:'A <strong>19-year-old male</strong> presents with a 3-month history of a painless anterior mandibular swelling. Panoramic shows a <strong>well-defined unilocular radiolucency</strong> with <strong>scattered irregular radiopaque flecks</strong> in the central incisor–canine region. Lesion measures 2.1cm. Borders corticated. Adjacent incisors show mild root divergence. Enucleation is performed. Pathology report returns: <em>"Cystic epithelial lining with focal areas of <strong>eosinophilic anucleate cells</strong> forming sheets of calcified material. Ameloblastoma-like basal cell layer."</em>',
   finds:[{t:'Unilocular RL with RO flecks',c:'radio'},{t:'Anterior mandible',c:'radio'},{t:'Root divergence',c:'radio'},{t:'Ghost cells (path report)',c:'histo'},{t:'Calcified sheets (histo)',c:'histo'},{t:'Amelo-like basal layer',c:'histo'}],
   ans:'Calcifying Odontogenic Cyst',opts:['Calcifying Epithelial Odontogenic Tumor','Calcifying Odontogenic Cyst','Adenomatoid Odontogenic Tumor','Ameloblastoma (Unicystic)'],
   correct:'Mixed RL/RO pattern + eosinophilic anucleate cells (ghost cells) forming sheets of calcified material + ameloblastoma-like basal layer = Calcifying Odontogenic Cyst (Gorlin Cyst). Ghost cells are pathognomonic. No other common odontogenic cyst produces them.',
   wrong:'Calcifying Epithelial Odontogenic Tumor (Pindborg) also has calcifications — but its calcifications are Liesegang rings (concentric) and it lacks the cystic architecture and true ghost cells. AOT has duct-like structures, not ghost cells. UA has palisading columnar cells but never ghost cells.',
   reasoning:[{k:'Mixed RL/RO on imaging',v:'match',t:'✓ Classic COC — ghost cell calcification'},{k:'Anterior mandible (19M)',v:'match',t:'✓ COC bimodal peak includes young adults'},{k:'Ghost cells (eosinophilic anucleate)',v:'match',t:'✓ Pathognomonic for COC'},{k:'Ameloblastoma-like basal layer',v:'match',t:'✓ COC feature — not actual ameloblastoma'},{k:'Why not Pindborg (CEOT)?',v:'warn',t:'CEOT: Liesegang calcifications, no cyst, no ghost cells'},{k:'Why not AOT?',v:'warn',t:'AOT: duct-like structures, no ghost cells, pericoronal'}]},

  // ── CASE 11: COC TRAP — Gorlin Cyst vs. Gorlin Syndrome ─────────────────
  {n:11,badge:'Panoramic · Multiple Lesions',badge2:'17M · Referred From Dermatology',svg:'okc',
   vig:'A <strong>17-year-old male</strong> is referred from dermatology after being diagnosed with multiple basal cell carcinomas. Panoramic shows <strong>three separate, well-defined radiolucencies</strong> in the mandible — two in the ramus bilaterally, one in the anterior body. All are unilocular with corticated borders. Slight scalloping of the posterior borders on CBCT. No calcifications noted within any lesion. Dermatology also reports <strong>palmar pits and calcification of the falx cerebri</strong> on head CT.',
   finds:[{t:'Multiple jaw radiolucencies (3)',c:'radio'},{t:'Bilateral ramus + anterior body',c:'radio'},{t:'Scalloped borders on CBCT',c:'radio'},{t:'Multiple BCCs (17yo)',c:'clinical'},{t:'Palmar pits',c:'clinical'},{t:'Calcified falx cerebri',c:'clinical'}],
   ans:'Odontogenic Keratocyst',opts:['Calcifying Odontogenic Cyst','Odontogenic Keratocyst','Dentigerous Cyst (Multiple)','Ameloblastoma (Multicystic)'],
   correct:'Multiple jaw cysts + multiple BCCs at age 17 + palmar pits + calcified falx cerebri = Gorlin Syndrome (Nevoid Basal Cell Carcinoma Syndrome). The jaw lesions in Gorlin Syndrome are OKCs — NOT Gorlin Cysts (COC). This is the most tested naming trap in oral pathology boards.',
   wrong:'Gorlin Cyst = Calcifying Odontogenic Cyst (ghost cells, mixed RL/RO, single lesion). Gorlin Syndrome = PTCH1 mutation → multiple OKCs + BCCs + palmar pits + skeletal anomalies. Same eponym, completely different entities. These lesions have no calcifications and show OKC radiographic behavior — scalloped borders, minimal expansion, ramus involvement.',
   reasoning:[{k:'Multiple jaw lesions',v:'match',t:'✓ Gorlin Syndrome: multiple OKCs pathognomonic'},{k:'Multiple BCCs at 17',v:'err',t:'BCCs this young = Gorlin Syndrome until proven otherwise'},{k:'Palmar pits',v:'match',t:'✓ Classic Gorlin Syndrome feature'},{k:'Calcified falx cerebri',v:'match',t:'✓ Gorlin Syndrome: falx calcification is diagnostic'},{k:'No calcifications in lesions',v:'err',t:'Gorlin CYST has calcifications — Gorlin SYNDROME does not'},{k:'Scalloped borders',v:'match',t:'✓ OKC radiographic behavior — not COC'},{k:'The trap',v:'warn',t:'Gorlin Cyst ≠ Gorlin Syndrome. Same name, different disease.'}]},

  // ── CASE 12: RC RECOGNITION — Classic apex, caries, non-vital ────────────
  {n:12,badge:'Periapical · Maxillary Anterior',badge2:'38F · Dull Ache, Prior Trauma',svg:'rc_max',
   vig:'A <strong>38-year-old female</strong> presents with a dull ache in the upper front teeth. She reports a history of trauma to the maxillary incisors approximately 8 years ago with no treatment. Periapical radiograph shows a <strong>well-defined, round radiolucency at the apex of the maxillary left central incisor</strong>, measuring 9mm. Borders are corticated. The tooth does not respond to cold EPT. The adjacent lateral incisor and right central respond normally.',
   finds:[{t:'Apical radiolucency 9mm',c:'radio'},{t:'Well-defined, corticated',c:'radio'},{t:'Maxillary central incisor',c:'radio'},{t:'No response to EPT',c:'clinical'},{t:'8yr trauma history',c:'clinical'},{t:'Dull ache',c:'clinical'}],
   ans:'Radicular Cyst',opts:['Periapical Granuloma','Radicular Cyst','Nasopalatine Duct Cyst','Dentigerous Cyst'],
   correct:'Well-defined, corticated apical radiolucency >8mm on a non-vital tooth following trauma = Radicular Cyst (most likely). Size >8–10mm favors true cyst over granuloma. However, only histology definitively confirms it — periapical granuloma is radiographically identical. Both are treated with RCT first.',
   wrong:'Periapical granuloma cannot be excluded radiographically. The 9mm size makes true cyst more likely than granuloma (granulomas tend to be <10mm), but this is probabilistic, not definitive. Nasopalatine Duct Cyst is midline, heart-shaped on PA view, and not associated with a specific non-vital tooth.',
   reasoning:[{k:'Apical location',v:'match',t:'✓ Radicular cyst is always at the root apex'},{k:'Non-vital tooth (no EPT)',v:'match',t:'✓ Pulpal necrosis is the required precondition'},{k:'Trauma history × 8 years',v:'match',t:'✓ Classic mechanism — untreated pulpal death'},{k:'9mm size',v:'match',t:'✓ >8mm favors cyst over granuloma (probabilistic)'},{k:'Corticated borders',v:'match',t:'✓ Chronic, slow-growing lesion'},{k:'Why not granuloma?',v:'warn',t:'Cannot exclude — only histology confirms. Treat same way'},{k:'Treatment',v:'match',t:'Root canal therapy first; apicoectomy if RCT fails'}]},

  // ── CASE 13: RC TRAP — The residual cyst left behind ─────────────────────
  {n:13,badge:'Panoramic · Posterior Mandible',badge2:'61M · Routine Panoramic · Edentulous Right Side',svg:'res',
   vig:'A <strong>61-year-old male</strong> presents for denture evaluation. He is edentulous in the right posterior mandible following multiple extractions performed approximately 12 years ago. Routine panoramic shows a <strong>well-defined, unilocular radiolucency</strong> in the edentulous right mandibular premolar region, measuring 1.4cm. Borders are smooth and corticated. He is asymptomatic. He does not recall whether any jaw pathology was noted at the time of extractions.',
   finds:[{t:'Unilocular RL (1.4cm)',c:'radio'},{t:'Edentulous site — right premolar',c:'radio'},{t:'Well-defined, corticated',c:'radio'},{t:'61yo male',c:'clinical'},{t:'Extracted 12 years ago',c:'clinical'},{t:'Asymptomatic',c:'clinical'}],
   ans:'Residual Cyst',opts:['Traumatic Bone Cyst','Residual Cyst','Stafne Bone Defect','Odontogenic Keratocyst'],
   correct:'Well-defined unilocular radiolucency in an edentulous site in a 61-year-old male, 12 years after extraction = Residual Cyst until proven otherwise. The cyst lining was not enucleated at the time of extraction and continued to grow silently. Histology will confirm non-keratinized squamous epithelium identical to a radicular cyst.',
   wrong:'Traumatic Bone Cyst is empty (no lining), found in young patients, and scallops around tooth roots. Stafne Bone Defect is located below the inferior alveolar canal in the posterior mandible — static, incidental, not truly a cyst. OKC cannot be excluded without histology — always biopsy edentulous radiolucencies.',
   reasoning:[{k:'Edentulous site',v:'match',t:'✓ No tooth present — residual cyst signature'},{k:'Extraction history at site',v:'match',t:'✓ Radicular cyst left behind after tooth removed'},{k:'12 years of silent growth',v:'match',t:'✓ Residual cysts grow asymptomatically for years'},{k:'Older patient (61M)',v:'match',t:'✓ Matches residual cyst demographics'},{k:'Why not TBC?',v:'warn',t:'TBC: young patient, empty cavity, scallops roots — wrong demographics'},{k:'Why not Stafne?',v:'warn',t:'Stafne is BELOW IAN canal — this is above it'},{k:'Must biopsy',v:'err',t:'Always biopsy — cannot exclude OKC without histology'}]},

  // ── CASE 14: PARA RECOGNITION — 3rd molar, buccal lucency ────────────────
  {n:14,badge:'Panoramic + CBCT · Right Mandible',badge2:'24M · Recurrent Pericoronitis',svg:'para',
   vig:'A <strong>24-year-old male</strong> presents with a 2-year history of recurrent right lower jaw pain and swelling around his partially erupted mandibular right third molar. CBCT reveals a <strong>well-defined radiolucency on the buccal and distal aspect</strong> of the partially erupted third molar crown. The radiolucency does NOT encircle the crown — it arises from its lateral surface. The third molar is vital. No root resorption.',
   finds:[{t:'Buccal/distal radiolucency',c:'radio'},{t:'Partially erupted 3rd molar',c:'radio'},{t:'Does NOT encircle crown',c:'radio'},{t:'2yr pericoronitis history',c:'clinical'},{t:'Vital third molar',c:'clinical'},{t:'Buccal swelling episodes',c:'clinical'}],
   ans:'Paradental Cyst',opts:['Dentigerous Cyst','Paradental Cyst','Lateral Periodontal Cyst','Periapical Abscess'],
   correct:'Radiolucency lateral to the crown (not pericoronal/encircling) of a partially erupted tooth with 2 years of pericoronitis history = Paradental Cyst. The mechanism is pericoronitis-driven epithelial proliferation. DC encircles the crown — paradental does not. Location relative to the crown is the decisive finding.',
   wrong:'Dentigerous Cyst is the default assumption for any radiolucency near an impacted tooth — but DC encircles the crown. Paradental Cyst arises BESIDE the crown, driven by pericoronitis. CBCT is essential: panoramic may make them look similar, but CBCT shows the cyst does not encircle the crown.',
   reasoning:[{k:'Buccal/distal — lateral to crown',v:'match',t:'✓ Paradental: beside crown, not over it'},{k:'Does NOT encircle crown',v:'match',t:'✓ Definitively separates from DC'},{k:'Pericoronitis × 2 years',v:'match',t:'✓ Inflammatory mechanism — required for diagnosis'},{k:'Partially erupted 3rd molar',v:'match',t:'✓ Classic paradental cyst substrate'},{k:'Vital tooth',v:'match',t:'✓ Inflammatory, not apical — tooth is alive'},{k:'Why not DC?',v:'err',t:'DC encircles the crown — this is lateral/buccal only'},{k:'Treatment',v:'match',t:'Enucleation ± extraction; address pericoronitis source'}]},

  // ── CASE 15: PARA TRAP — DC vs. Paradental, same tooth ──────────────────
  {n:15,badge:'Panoramic · Left Mandible',badge2:'26F · Asymptomatic · Impacted #17',svg:'dc',
   vig:'A <strong>26-year-old female</strong> is referred for evaluation of an impacted mandibular left third molar. Panoramic shows a radiolucency associated with the impacted tooth. Oral surgery consult notes a pericoronal lucency measuring <strong>5mm between the crown and the anterior border</strong>, but also a <strong>separate, more distal and buccal lucency</strong> extending beyond the crown outline. The patient has never had symptoms. The third molar is partially impacted at 45°.',
   finds:[{t:'Pericoronal lucency 5mm (anterior)',c:'radio'},{t:'Separate buccal/distal lucency',c:'radio'},{t:'Partially impacted 45°',c:'radio'},{t:'Asymptomatic',c:'clinical'},{t:'No pericoronitis history',c:'clinical'},{t:'26yo female',c:'clinical'}],
   ans:'Dentigerous Cyst',opts:['Dentigerous Cyst','Paradental Cyst','Both (concurrent lesions)','Hyperplastic Follicle'],
   correct:'The anterior pericoronal component at 5mm is at the pathologic threshold but the SEPARATE buccal/distal component is more suspicious. However, without pericoronitis history and given the asymptomatic nature, the most likely diagnosis for the primary lesion is DC — the buccal extension may represent the lateral or circumferential DC variant. Biopsy is required to separate DC from paradental or concurrent lesions.',
   wrong:'The circumferential DC variant can extend around and beyond the crown — mimicking a separate buccal lucency. Without pericoronitis history, paradental cyst is less likely (it requires an inflammatory mechanism). The key lesson: when two lucencies are present around an impacted tooth, think DC variants first, then biopsy.',
   reasoning:[{k:'5mm pericoronal — pathologic threshold',v:'match',t:'✓ >3–4mm is pathologic — DC confirmed component'},{k:'Separate buccal lucency',v:'warn',t:'Could be DC lateral/circumferential variant'},{k:'No pericoronitis history',v:'match',t:'✓ Paradental cyst requires inflammatory mechanism'},{k:'Asymptomatic, no history',v:'match',t:'✓ Favors developmental DC over inflammatory paradental'},{k:'45° impaction',v:'warn',t:'Partial eruption allows paradental — but no evidence here'},{k:'Lesson',v:'match',t:'DC can extend buccally — biopsy all components separately'}]},

  // ── CASE 16: BBC — Pediatric, save the tooth ─────────────────────────────
  {n:16,badge:'Panoramic · Right Mandible',badge2:'8M · Buccal Swelling, Drainage',svg:'bbc',
   vig:'An <strong>8-year-old male</strong> presents with a 3-week history of right buccal swelling near the first permanent molar. There is a small draining sinus on the buccal gingiva. Panoramic shows a <strong>well-defined radiolucency on the buccal aspect of the mandibular right first molar roots</strong>. The molar is partially erupted. CBCT confirms the roots are <strong>tipped lingually</strong>. Cold EPT elicits a normal response from the molar. The referring dentist considers extraction.',
   finds:[{t:'Buccal root radiolucency',c:'radio'},{t:'Mandibular 1st molar',c:'radio'},{t:'Roots tipped lingually (CBCT)',c:'radio'},{t:'8yo male',c:'clinical'},{t:'Buccal swelling + sinus',c:'clinical'},{t:'Vital molar (EPT+)',c:'clinical'}],
   ans:'Paradental Cyst',opts:['Periapical Abscess','Paradental Cyst','Dentigerous Cyst','Traumatic Bone Cyst'],
   correct:'Buccal radiolucency at the roots of a partially erupted mandibular 1st molar in an 8-year-old with lingually tipped roots = Buccal Bifurcation Cyst — the pediatric paradental cyst variant. Vital tooth confirms inflammatory, not apical, origin. Critical clinical point: extraction is NOT necessary. Enucleation alone is curative and the tooth erupts normally.',
   wrong:'Periapical abscess: non-vital tooth (EPT negative), acute presentation, diffuse borders — this tooth is vital and the lesion is well-defined. Dentigerous cyst: pericoronal, not buccal at the roots. Traumatic bone cyst: empty cavity, no drainage, scallops around roots — no lining to drain from.',
   reasoning:[{k:'Buccal root location',v:'match',t:'✓ BBC: circumscribes roots on buccal aspect'},{k:'Mandibular 1st molar (8yo)',v:'match',t:'✓ Classic BBC presentation — right age, right tooth'},{k:'Roots tipped lingually',v:'match',t:'✓ Pathognomonic BBC radiographic hallmark'},{k:'Vital tooth (EPT+)',v:'match',t:'✓ Not apical origin — inflammatory/developmental'},{k:'Why not extraction?',v:'warn',t:'Enucleation alone is curative — tooth can erupt normally'},{k:'Why not periapical abscess?',v:'err',t:'Abscess = non-vital, diffuse, no defined corticated wall'},{k:'Key lesson',v:'match',t:'BBC: preserve the tooth — this is a manageable, curative condition'}]},
];

/* ════════════ RENDER HELPERS ════════════ */
function tag(t){return`<span class="ctag ${t.c}">${t.l}</span>`;}

function rightPanelH(id){
  const c = CONDITIONS[id];
  if(!c) return '<div class="path-panel"></div>';

  // ── Per-condition data ──────────────────────────────────────
  const panelData = {
    dc:  {
      key: '<strong>&gt;4mm pericoronal space</strong> = DC until histology proves otherwise. Under 4mm = normal follicle.',
      ddx: [
        { id:'okc',  why:'Looks identical on xray — only histology distinguishes. OKC: parakeratinized, daughter cysts.' },
        { id:'ua',   why:'Pericoronal in young patients. Mural subtype requires resection, not enucleation.' },
      ],
      tx: 'Enucleate + curettage',
      recur: 'Rare'
    },
    okc: {
      key: 'Simple enucleation <strong>is not enough</strong>. Daughter cysts in the wall cause 25–60% recurrence. Carnoy\'s or peripheral ostectomy required.',
      ddx: [
        { id:'dc',  why:'Xray is identical. DC: non-keratinized, no daughter cysts, rare recurrence.' },
        { id:'ua',  why:'Both can be pericoronal in young adults. UA: ameloblastomatous lining, subtype changes treatment.' },
      ],
      tx: 'Enucleate + Carnoy\'s / ostectomy',
      recur: '25–60% without adjuncts'
    },
    ua: {
      key: 'Cannot be excluded from DC or OKC on imaging. <strong>Subtype is everything</strong> — mural (III) requires resection.',
      ddx: [
        { id:'dc',  why:'Same xray. DC: non-keratinized. UA: ameloblastomatous. Biopsy always required.' },
        { id:'okc', why:'Both aggressive. OKC: parakeratinized. UA: columnar palisading cells.' },
      ],
      tx: 'I/II: Enucleate · III: Resect',
      recur: 'Subtype-dependent'
    },
    lpc: {
      key: 'Vital pulp test the adjacent tooth. <strong>Non-vital = radicular cyst</strong>, not LPC. One test splits the entire differential.',
      ddx: [
        { id:'rc',   why:'Non-vital tooth → radicular. Same location, opposite cause.' },
        { id:'okc',  why:'Scalloped multilocular lateral lucency → consider OKC, especially if growing.' },
      ],
      tx: 'Enucleate, preserve tooth',
      recur: 'Low (botryoid: higher)'
    },
    coc: {
      key: '<strong>Ghost cells = COC</strong>. Eosinophilic anucleate cells in a jaw cyst = stop reading the question.',
      ddx: [
        { id:'dc',  why:'COC can be pericoronal. Ghost cells on histology differentiate immediately.' },
        { id:'okc', why:'Mixed RL/RO pattern with cystic component. Ghost cells absent in OKC.' },
      ],
      tx: 'Enucleate (solid DGCT: wider excision)',
      recur: 'Low'
    },
    rc: {
      key: 'RC vs periapical granuloma: <strong>treatment is identical</strong>. RCT first. Biopsy if it doesn\'t resolve at 6 months.',
      ddx: [
        { id:'lpc',  why:'Vital tooth + lateral lucency = LPC. Non-vital + apex = RC.' },
        { id:'res',  why:'RC with tooth present. Residual = same cyst after extraction.' },
      ],
      tx: 'RCT → if persists: enucleate',
      recur: 'Rare if pulp treated'
    },
    res: {
      key: '<strong>Edentulous site + radiolucency in older adult</strong> = residual cyst first. Histology identical to radicular.',
      ddx: [
        { id:'rc',  why:'Same cyst, different context. RC has a tooth; residual does not.' },
        { id:'dc',  why:'Edentulous lucency could be a retained DC if prior impacted tooth.' },
      ],
      tx: 'Enucleate',
      recur: 'Rare'
    },
    para: {
      key: 'Treat the tooth <strong>and</strong> the cyst — pericoronitis treatment alone leaves the cyst. Both must be addressed at the same appointment.',
      ddx: [
        { id:'dc',  why:'DC is pericoronal, fully unerupted tooth. Para is buccal-lateral, partially erupted.' },
        { id:'rc',  why:'Para is vital tooth, buccal. RC is non-vital, periapical.' },
      ],
      tx: 'Extract/expose tooth + enucleate',
      recur: 'Low'
    }
  };

  const pd = panelData[id] || { key: c.summary, ddx: [], tx: '—', recur: '—' };
  const condNames = {
    dc:'Dentigerous', okc:'OKC', ua:'Unicystic Amelo.', lpc:'Lateral Perio.',
    coc:'Calcifying OC', rc:'Radicular', res:'Residual', para:'Paradental'
  };
  const moduleOrder = ['dc','okc','ua','lpc','coc','rc','res','para','npc','nla','derm','lymp','thyro','staf'];
  let progress = {};
  try { progress = JSON.parse(localStorage.getItem('chri_progress') || '{}'); } catch(e){}

  let html = '<div class="path-panel">';

  // ── 1. The one thing ─────────────────────────────────────────
  html += '<div class="rp-card rp-key">'
    + '<div class="rp-card-lbl">🔑 The one thing</div>'
    + '<div class="rp-key-text">' + pd.key + '</div>'
  + '</div>';

  // ── 2. Don't confuse it with ─────────────────────────────────
  if(pd.ddx && pd.ddx.length){
    html += '<div class="rp-card">'
      + '<div class="rp-card-lbl">⚡ Don\'t confuse with</div>';
    pd.ddx.forEach(function(d){
      html += '<div class="rp-ddx-item" onclick="showCond(\'' + d.id + '\',\'study\')">'
        + '<div class="rp-ddx-name">' + (condNames[d.id] || d.id) + ' →</div>'
        + '<div class="rp-ddx-why">' + d.why + '</div>'
      + '</div>';
    });
    html += '</div>';
  }

  // ── 3. Quick Rx ──────────────────────────────────────────────
  html += '<div class="rp-card rp-rx">'
    + '<div class="rp-card-lbl">🔪 Treatment</div>'
    + '<div class="rp-rx-row"><span class="rp-rx-val">' + pd.tx + '</span></div>'
    + '<div class="rp-card-lbl" style="margin-top:10px">🔁 Recurrence</div>'
    + '<div class="rp-rx-row"><span class="rp-rx-val">' + pd.recur + '</span></div>'
  + '</div>';

  // ── 4. Module map ────────────────────────────────────────────
  html += '<div class="rp-card">'
    + '<div class="rp-card-lbl">Module 1 — 8 conditions</div>'
    + '<div class="rp-modmap">';
  moduleOrder.forEach(function(oid){
    const isActive = oid === id;
    const isDoneOid = progress[oid] === true;
    html += '<div class="rp-modmap-item' + (isActive ? ' active' : '') + '" onclick="showCond(\'' + oid + '\',\'study\')" title="' + (condNames[oid]||oid) + '">'
      + '<div class="rp-modmap-dot' + (isDoneOid ? ' done' : '') + (isActive ? ' now' : '') + '"></div>'
      + '<div class="rp-modmap-name">' + (condNames[oid]||oid) + '</div>'
    + '</div>';
  });
  html += '</div></div>';

  // ── 5. Trainer CTA ───────────────────────────────────────────
  html += '<div class="rp-quiz-cta" onclick="setMode(\'trainer\')">'
    + '<div class="rp-quiz-icon">🎯</div>'
    + '<div>'
      + '<div class="rp-quiz-title">Test yourself</div>'
      + '<div class="rp-quiz-sub">Board-style cases · ~6 min</div>'
    + '</div>'
    + '<div class="rp-quiz-arrow">→</div>'
  + '</div>';

  html += '</div>';
  return html;
}

function cardsH(arr,grid='g2'){return`<div class="${grid}">${arr.map(c=>`<div class="ic"><div class="ic-lbl">${c.lbl}</div><ul class="ic-list">${c.items.map(i=>`<li>${i}</li>`).join('')}</ul></div>`).join('')}</div>`;}
function hlsH(arr){if(!arr||!arr.length)return'';return`<div class="hl2">${arr.map(h=>`<div class="hl ${h.cls}${h.full?' full':''}"><div class="hl-lbl">${h.lbl}</div><div class="hl-txt">${h.txt}</div></div>`).join('')}</div>`;}
function relsH(arr){if(!arr||!arr.length)return'';return`<div class="rel-grid">${arr.map(r=>`<div class="rel-card ${r.p?'p':''}"><div class="rel-ico">${r.ico}</div><div class="rel-title">${r.title}</div><div class="rel-sub">${r.sub}</div></div>`).join('')}</div>`;}
function ddxH(arr){return`<div class="ddx-grid">${arr.map(d=>`<div class="ddx-card" onclick="this.classList.toggle('excluded')"><div class="ddx-hint">tap to exclude</div><div class="ddx-name">${d.name}</div><div class="ddx-key">${d.key}</div></div>`).join('')}</div><p style="font-size:11px;color:var(--tx4);margin-top:6px;font-family:'IBM Plex Mono',monospace;">tap any condition to exclude from your differential</p><div style="margin-top:10px;"><span class="tb-btn" style="display:inline-flex;font-size:12px;" onclick="setMode('compare')">⇄ Open Compare Mode →</span></div>`;}
function pearlsH(arr){return arr.map(p=>`<div class="pearl ${p.s}"><span class="pearl-ico">🔑</span><div><div class="pearl-lbl">${p.lbl}</div><div class="pearl-txt">${p.txt}</div></div></div>`).join('');}
function mnemH(m){if(!m.lines.length)return`<div class="mnemonic"><div class="mnem-label">🧠 Mnemonic</div><div style="color:var(--tx3);font-size:13px;">Full mnemonic coming in next content release.</div></div>`;return`<div class="mnemonic"><div class="mnem-label">🧠 Mnemonic</div><div class="mnem-word">${m.word}</div>${m.lines.map(l=>`<div class="mnem-line"><strong>${l.l}</strong>${l.r}</div>`).join('')}</div>`;}
function synsH(arr){return arr.map(s=>`<div class="syndrome ${s.cls}"><div class="syn-ico">${s.ico}</div><div><div class="syn-title">${s.title}</div><div class="syn-txt">${s.txt}</div></div></div>`).join('');}
function nextH(arr){return arr.map(n=>`<div class="next-strip" onclick="showCond('${n.id}',null)"><div class="next-ico">${n.ico}</div><div><div class="next-title">${n.title}</div><div class="next-sub">${n.sub||''}</div></div><span style="margin-left:auto;color:var(--blue);font-size:18px;">→</span></div>`).join('');}

/* ════════════ RENDER STUDY ════════════ */

const lessons = {
    dc: {
      whyHard: "Most students get this wrong because they treat it like a fact to memorize instead of a story that makes sense. Once you understand *why* this cyst forms, every other fact falls into place.",
      
      coreIdea: "A tooth that can't erupt gets surrounded by fluid. That's it. The reduced enamel epithelium — the tissue that made the crown — doesn't detach properly. Fluid accumulates. The space grows. Once that space exceeds 4mm, it's no longer normal.",
      
      theNumber: "The entire boards question on DC comes down to one number: **4mm**. Under 4mm = normal follicle, walk away. Over 4mm = Dentigerous Cyst until histology proves otherwise. That's the whole clinical decision.",
      
      bigTrap: "Here's what trips everyone up: **you cannot diagnose this from an xray.** OKC looks identical. Unicystic ameloblastoma looks identical. Students see 'pericoronal lucency' and write DC. That's wrong — the xray just tells you where to look. The pathologist tells you what it is.",
      
      visualNote: "Picture a tooth sitting inside a balloon of fluid. The balloon attaches exactly at the cemento-enamel junction — the neck of the tooth. That attachment point is the diagnostic landmark. Radicular cyst attaches at the apex (root tip). Dentigerous attaches at the CEJ. If you can orient yourself to that junction on a panoramic, you know where you are.",
      
      svgLabel: "Dentigerous Cyst — cross-section through mandible",
      svg: `<svg viewBox="0 0 480 240" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:580px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="g_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="g_cyst" cx="50%" cy="40%" r="55%"><stop offset="0%" stop-color="#bfdbfe" stop-opacity="0.95"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0.25"/></radialGradient>
    <radialGradient id="g_dentin" cx="50%" cy="30%" r="60%"><stop offset="0%" stop-color="#fdf6e3"/><stop offset="100%" stop-color="#e8d5a0"/></radialGradient>
  </defs>
  <!-- Bone body -->
  <path d="M20,230 L20,80 Q20,30 240,22 Q460,30 460,80 L460,230 Z" fill="url(#g_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Trabecular lines (bone texture) -->
  <line x1="60" y1="180" x2="80" y2="160" stroke="#b8a070" stroke-width="1" opacity="0.45"/>
  <line x1="90" y1="190" x2="115" y2="172" stroke="#b8a070" stroke-width="1" opacity="0.45"/>
  <line x1="130" y1="185" x2="150" y2="168" stroke="#b8a070" stroke-width="1" opacity="0.35"/>
  <line x1="330" y1="182" x2="350" y2="165" stroke="#b8a070" stroke-width="1" opacity="0.45"/>
  <line x1="370" y1="190" x2="392" y2="175" stroke="#b8a070" stroke-width="1" opacity="0.45"/>
  <!-- Alveolar bone crest -->
  <path d="M40,118 Q240,96 440,118" fill="none" stroke="#9a7e50" stroke-width="2.5"/>
  <!-- Cyst sac (pericoronal, around crown) -->
  <ellipse cx="240" cy="104" rx="82" ry="52" fill="url(#g_cyst)" stroke="#2563eb" stroke-width="2.2"/>
  <!-- Tooth crown -->
  <path d="M202,122 Q202,110 212,105 L228,100 L240,98 L252,100 L268,105 Q278,110 278,122 Z" fill="url(#g_dentin)" stroke="#c8b888" stroke-width="1.2"/>
  <!-- Cusps -->
  <path d="M212,105 Q218,94 228,100" fill="url(#g_dentin)" stroke="#c8b888" stroke-width="1.2"/>
  <path d="M228,100 Q240,90 252,100" fill="url(#g_dentin)" stroke="#c8b888" stroke-width="1.2"/>
  <path d="M252,100 Q262,94 268,105" fill="url(#g_dentin)" stroke="#c8b888" stroke-width="1.2"/>
  <!-- Roots -->
  <path d="M218,122 Q214,155 216,178" fill="none" stroke="#d8c898" stroke-width="10" stroke-linecap="round"/>
  <path d="M262,122 Q266,158 264,180" fill="none" stroke="#d8c898" stroke-width="10" stroke-linecap="round"/>
  <!-- CEJ line (attachment point — KEY LABEL) -->
  <line x1="200" y1="122" x2="280" y2="122" stroke="#dc2626" stroke-width="1.8" stroke-dasharray="5,3"/>
  <!-- CEJ arrow + label -->
  <line x1="198" y1="122" x2="155" y2="145" stroke="#dc2626" stroke-width="1.5"/>
  <circle cx="198" cy="122" r="3" fill="#dc2626"/>
  <rect x="62" y="140" width="90" height="22" rx="5" fill="white" opacity="0.9"/>
  <text x="107" y="154" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9.5" fill="#dc2626" font-weight="700">CEJ — attaches here</text>
  <!-- >4mm measurement bracket -->
  <line x1="330" y1="55" x2="330" y2="103" stroke="#d97706" stroke-width="1.8"/>
  <line x1="324" y1="55" x2="336" y2="55" stroke="#d97706" stroke-width="1.8"/>
  <line x1="324" y1="103" x2="336" y2="103" stroke="#d97706" stroke-width="1.8"/>
  <line x1="330" y1="55" x2="330" y2="103" stroke="#d97706" stroke-width="1.8"/>
  <rect x="338" y="68" width="58" height="22" rx="5" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
  <text x="367" y="82" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="10" fill="#92400e" font-weight="800">&gt; 4 mm</text>
  <text x="367" y="94" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#92400e">= pathologic</text>
  <!-- Cyst label -->
  <rect x="195" y="58" width="90" height="18" rx="5" fill="white" opacity="0.85"/>
  <text x="240" y="71" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#1d4ed8" font-weight="700">Cyst lumen (fluid)</text>
  <!-- Crown label -->
  <text x="240" y="115" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#78716c">Crown inside lumen</text>
  <!-- Bone label -->
  <text x="80" y="215" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#92835a" opacity="0.8">Mandibular bone (cross-section)</text>
</svg>`,

      chain: [
        { step: "Why does this cyst form?", answer: "A tooth that can't erupt stays trapped in the jaw. The tissue that made its crown — the reduced enamel epithelium — starts accumulating fluid between itself and the crown. The space inflates. That balloon of fluid is the dentigerous cyst.", visual: null },
        { step: "What does it look like on imaging?", answer: "A dark (radiolucent) bubble surrounding the crown of an unerupted tooth on panoramic. The key is *where* it attaches — exactly at the cemento-enamel junction (the neck of the tooth). That's how you know it's pericoronal and not periapical.", visual: null },
        { step: "The 4mm rule — memorize this", answer: "Any pericoronal space under 4mm is a normal follicle. Don't touch it. Once it hits 4mm or more, it's abnormal — treat it as a Dentigerous Cyst and biopsy. This number is the entire clinical decision and appears on virtually every boards question about this condition.", visual: "4mm" },
        { step: "What does biopsy show?", answer: "Non-keratinized squamous epithelium, just 2–3 cells thick. Flat at the base — no rete ridges poking down (unless it's inflamed, in which case it thickens and you can mistake it for OKC). The wall is loose and fibrous.", visual: null },
        { step: "Treatment and prognosis", answer: "Enucleation and curettage. Recurrence is rare. For giant cysts near the nerve, marsupialization first to shrink it, then enucleation. The prognosis is excellent — this is not the scary one. But you still need histology to prove that.", visual: null },
      ],
      
      traps: [
        { label: "The imaging trap", icon: "🎯", scenario: "You see a pericoronal lucency, it looks like a balloon around an impacted molar. You call it a Dentigerous Cyst on the spot.", consequence: "It could be OKC. It could be unicystic ameloblastoma. Both look radiographically identical. OKC recurs 30–60%. Mural UA requires resection — not enucleation. You've just undertaken the wrong surgery.", fix: "Never commit to DC from imaging. The xray tells you WHERE; the pathologist tells you WHAT." },
        { label: "The histology trap", icon: "🔬", scenario: "The biopsy shows stratified squamous epithelium with rete ridges. You say it's not DC, must be OKC.", consequence: "Inflammation thickens the DC lining and produces rete ridges that mimic OKC. You've falsely escalated the diagnosis.", fix: "Always integrate clinical + radiographic + histologic findings together. Inflamed DC ≠ OKC." },
      ],
      
      contrast: {
        versus: "OKC",
        vsId: "okc",
        intro: "These two conditions share a syllabus entry and that's about it. The xray is the problem — they look the same. The distinction lives entirely in histology and behavior.",
        rows: [
          { feature: "Epithelial lining", dc: "Non-keratinized, 2–3 cells, FLAT base", okc: "Parakeratinized, corrugated surface, palisading basal cells" },
          { feature: "Daughter cysts", dc: "None", okc: "YES — in the fibrous wall → this is why it recurs" },
          { feature: "Recurrence", dc: "Rare with full removal", okc: "25–60% with enucleation alone" },
          { feature: "How it grows", dc: "Expands outward — you see cortical expansion", okc: "Along medullary bone — minimal expansion, gets HUGE silently" },
          { feature: "Treatment", dc: "Enucleate + curettage", okc: "Carnoy's solution OR peripheral ostectomy — NOT optional" },
          { feature: "Gorlin syndrome?", dc: "No (multiple DC → screen for Gorlin as differential)", okc: "YES — multiple OKCs = PTCH1 mutation until proven otherwise" },
        ]
      },
      
      clinicalFlow: {
        title: "What to do when you see a pericoronal lucency",
        steps: [
          { q: "Is the lucency pericoronal (around a crown)?", y: "Continue", n: "Think radicular cyst, other periapical lesion" },
          { q: "Is the space > 4mm at the CEJ?", y: "Biopsy indicated — it's pathologic", n: "Normal follicle — observe, recheck in 1 year" },
          { q: "Biopsy: non-keratinized, thin lining, no daughter cysts?", y: "Dentigerous Cyst — enucleate + curettage", n: "OKC (parakeratinized) or UA (ameloblastomatous) — escalate plan" },
          { q: "Large cyst near IAN or sinus?", y: "Marsupialization → decompress → then enucleate", n: "Proceed directly to enucleation" },
        ]
      }
    },

    okc: {
      whyHard: "Students memorize 'parakeratinized epithelium' and '30% recurrence' and think they know OKC. They fail boards questions because they don't understand *why* it recurs and why the treatment is fundamentally different from every other cyst.",
      coreIdea: "OKC is a biologically aggressive cyst derived from dental lamina remnants. It doesn't behave like a cyst that just got big — it behaves like something that *wants* to come back. The daughter cysts in its wall are literally pre-loaded recurrences waiting to happen.",
      theNumber: "**25–60% recurrence** with enucleation alone. That number only drops dramatically with adjunctive treatment (Carnoy's, peripheral ostectomy). This isn't trivia — it's the entire reason OKC gets its own treatment category.",
      bigTrap: "Everyone knows OKC recurs. What they miss: **OKC grows along medullary bone with minimal cortical expansion**. A patient can have a massive OKC with barely any facial swelling. By the time you find it, it's enormous. This is why you can't rely on symptoms.",
      visualNote: "Picture a cyst that's eaten along the spongy bone of the mandible like a snake — thin walls, scalloped edges, minimal puffing outward. Then look inside the wall and you see tiny bubble-like daughter cysts. Those daughters are why it comes back.",
      svgLabel: "OKC — mandibular cross-section showing growth pattern",
      svg: `<svg viewBox="0 0 480 240" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:580px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="okc_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c4a87c"/></linearGradient>
    <radialGradient id="okc_cyst" cx="45%" cy="45%" r="55%"><stop offset="0%" stop-color="#fef9c3" stop-opacity="0.95"/><stop offset="100%" stop-color="#ca8a04" stop-opacity="0.2"/></radialGradient>
  </defs>
  <!-- Bone -->
  <path d="M18,232 L18,78 Q18,28 240,20 Q462,28 462,78 L462,232 Z" fill="url(#okc_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Trabeculae -->
  <line x1="50" y1="190" x2="72" y2="172" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <line x1="400" y1="185" x2="420" y2="168" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <!-- Large cyst — scalloped border, low-profile (minimal expansion) -->
  <path d="M88,168 Q82,128 92,98 Q110,62 158,52 Q208,44 258,50 Q310,58 340,82 Q368,106 368,140 Q368,172 348,186 Q318,200 268,202 Q208,204 160,196 Q110,188 88,168 Z" fill="url(#okc_cyst)" stroke="#ca8a04" stroke-width="2.2"/>
  <!-- Scalloped top edge (diagnostic feature) -->
  <path d="M92,98 Q104,86 118,96 Q132,84 148,95 Q164,83 180,93 Q196,81 212,91 Q228,80 244,90 Q260,79 278,89 Q296,78 314,88 Q330,78 340,82" fill="none" stroke="#ca8a04" stroke-width="1.8" opacity="0.85"/>
  <!-- Daughter cysts in wall (KEY FEATURE) -->
  <ellipse cx="118" cy="90" rx="14" ry="9" fill="rgba(253,224,71,0.75)" stroke="#b45309" stroke-width="1.4"/>
  <ellipse cx="178" cy="84" rx="11" ry="7" fill="rgba(253,224,71,0.75)" stroke="#b45309" stroke-width="1.4"/>
  <ellipse cx="300" cy="82" rx="12" ry="8" fill="rgba(253,224,71,0.75)" stroke="#b45309" stroke-width="1.4"/>
  <ellipse cx="350" cy="100" rx="10" ry="7" fill="rgba(253,224,71,0.75)" stroke="#b45309" stroke-width="1.4"/>
  <!-- Thin wall indicator -->
  <path d="M88,168 Q84,140 88,120" fill="none" stroke="#dc2626" stroke-width="3" stroke-dasharray="5,3"/>
  <!-- Horizontal growth arrows (grows along bone, not outward) -->
  <line x1="110" y1="135" x2="80" y2="135" stroke="#2563eb" stroke-width="2" marker-end="url(#okc_arr_l)"/>
  <line x1="345" y1="135" x2="375" y2="135" stroke="#2563eb" stroke-width="2" marker-end="url(#okc_arr_r)"/>
  <defs>
    <marker id="okc_arr_l" markerWidth="7" markerHeight="7" refX="0" refY="3.5" orient="auto"><path d="M7,0 L0,3.5 L7,7 Z" fill="#2563eb"/></marker>
    <marker id="okc_arr_r" markerWidth="7" markerHeight="7" refX="7" refY="3.5" orient="auto"><path d="M0,0 L7,3.5 L0,7 Z" fill="#2563eb"/></marker>
  </defs>
  <!-- Labels -->
  <rect x="30" y="124" width="48" height="22" rx="4" fill="white" opacity="0.9"/>
  <text x="54" y="136" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#1d4ed8" font-weight="700">Grows</text>
  <text x="54" y="146" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#1d4ed8" font-weight="700">this way</text>
  <rect x="384" y="124" width="68" height="22" rx="4" fill="white" opacity="0.9"/>
  <text x="418" y="136" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#1d4ed8" font-weight="700">Not outward</text>
  <text x="418" y="146" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#1d4ed8" font-weight="700">→ missed!</text>
  <!-- Daughter cyst label -->
  <rect x="80" y="62" width="90" height="20" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
  <text x="125" y="76" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#92400e" font-weight="700">Daughter cysts</text>
  <line x1="118" y1="82" x2="118" y2="81" stroke="#d97706" stroke-width="1.2"/>
  <line x1="125" y1="82" x2="120" y2="82" stroke="#d97706" stroke-width="1"/>
  <!-- Scalloping label -->
  <rect x="195" y="36" width="90" height="20" rx="4" fill="white" opacity="0.9"/>
  <text x="240" y="50" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#92400e" font-weight="700">Scalloped margin</text>
  <!-- Thin wall label -->
  <rect x="18" y="170" width="66" height="20" rx="4" fill="white" opacity="0.9"/>
  <text x="51" y="184" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#dc2626" font-weight="700">Thin wall</text>
</svg>`,
      chain: [
        { step: "Where does it come from?", answer: "Remnants of the dental lamina — the ribbon of tissue that generates teeth in development. These remnants persist in the jaw and can activate. This is why OKC isn't an inflammatory cyst — it has intrinsic growth potential. That's what makes it different." },
        { step: "Why does it look the way it does?", answer: "Scalloped borders, thin walls, minimal cortical expansion. It grows *along* the medullary bone rather than pushing outward. This is clinically dangerous because there's no swelling alarm — patients present late with enormous lesions." },
        { step: "The histologic definition", answer: "Parakeratinized stratified squamous epithelium. The surface is corrugated (wavy). The basal layer shows palisaded columnar cells with hyperchromatic nuclei — they look like a neat row of soldiers. In the fibrous wall: satellite (daughter) cysts and odontogenic rests." },
        { step: "Why it recurs — the actual mechanism", answer: "Those daughter cysts in the wall aren't removed during enucleation. They're left behind in the surrounding bone and mucosa. Each one is a seed. Carnoy's solution (fixative) or peripheral ostectomy kills them. Skip that step and you've scheduled a second surgery." },
        { step: "The Gorlin syndrome connection", answer: "Multiple OKCs in a patient under 30 = PTCH1 mutation screening until proven otherwise. Gorlin syndrome brings basal cell carcinomas (early onset), calcified falx cerebri, bifid ribs, palmar pits. One missed case means a missed systemic cancer syndrome." },
      ],
      traps: [
        { label: "The 'just enucleate it' trap", icon: "⚡", scenario: "You confirm OKC histologically. It's your first one. You enucleate cleanly. Looks complete. You close up.", consequence: "18 months later it's back — now extending into the ramus. The second surgery is substantially harder. You didn't use Carnoy's or peripheral ostectomy. The daughter cysts were always there.", fix: "OKC treatment requires adjunctive therapy. Enucleation alone is inadequate. This is not optional." },
        { label: "The silent growth trap", icon: "📏", scenario: "Young patient, no swelling, vague discomfort. Panoramic ordered for ortho. You see a cyst, think it's small, plan to watch.", consequence: "OKC grows along the medullary bone. What looks 'small' on panoramic may have already destroyed the lingual cortex on CBCT. You needed a 3D image.", fix: "Any confirmed or suspected OKC gets CBCT before treatment planning. Never trust the 2D panoramic for extent." },
      ],
      contrast: {
        versus: "DC",
        vsId: "dc",
        intro: "Same radiographic presentation. Completely different biology, prognosis, and treatment. This is the contrast question on every oral path exam.",
        rows: [
          { feature: "Epithelium surface", dc: "Non-keratinized, smooth base, flat", okc: "Parakeratinized, CORRUGATED surface, palisading base" },
          { feature: "Daughter cysts?", dc: "Absent", okc: "Present in wall — the recurrence engine" },
          { feature: "Growth pattern", dc: "Outward expansion (visible)", okc: "Along medullary bone — minimal expansion, sneaky" },
          { feature: "Recurrence", dc: "Rare", okc: "25–60% without Carnoy's / ostectomy" },
          { feature: "Boards treatment", dc: "Enucleation + curettage", okc: "Carnoy's solution OR peripheral ostectomy" },
        ]
      },
      clinicalFlow: {
        title: "OKC management decision flow",
        steps: [
          { q: "Unilocular or multilocular lucency — scalloped margins?", y: "Consider OKC — biopsy", n: "Other cyst differential" },
          { q: "Histology: parakeratinized, palisading basal cells, daughter cysts?", y: "Confirmed OKC", n: "Re-evaluate — maybe DC or UA" },
          { q: "CBCT: cortical perforation or involvement of critical structures?", y: "May need resection — multidisciplinary planning", n: "Conservative: enucleation + Carnoy's or peripheral ostectomy" },
          { q: "Multiple OKCs? Patient under 30?", y: "PTCH1 genetic screening — Gorlin syndrome workup", n: "Follow up at 6 months, then annually × 5 years" },
        ]
      }
    },

    ua: {
      whyHard: "Unicystic Ameloblastoma is the hardest condition in this module because it looks completely benign on imaging and the diagnosis that changes everything is histologic. Students underestimate it because it looks like a simple cyst.",
      coreIdea: "UA is an ameloblastoma that presents as a single cyst. The word 'unicystic' sounds reassuring — it isn't. A mural subtype UA has ameloblastomatous cells growing into the cyst wall. That turns a simple cyst into a locally invasive neoplasm. Treatment is completely different depending on subtype.",
      theNumber: "**3 subtypes, and only subtype matters for treatment.** Luminal (I) and Intraluminal (II) = enucleation is acceptable. Mural (III, cells invade the wall) = resection required, same as solid ameloblastoma. Getting this wrong means under-treating a locally invasive tumor.",
      bigTrap: "UA is radiographically indistinguishable from Dentigerous Cyst, especially in a young patient with a pericoronal lucency. Students miss it because they don't consider it. The trap is complacency — 'it's probably just a DC in a 22-year-old.'",
      visualNote: "Picture a simple unilocular cyst around a mandibular molar — looks completely benign. Now imagine that the inner lining of that cyst isn't just flat epithelium — it has islands of ameloblastoma cells growing inward (intraluminal) or into the fibrous wall (mural). That's the mural type. You can't see those islands on imaging.",
      svgLabel: "Unicystic Ameloblastoma — luminal vs. mural subtype",
      svg: `<svg viewBox="0 0 480 240" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:580px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="ua_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c4a87c"/></linearGradient>
    <radialGradient id="ua_cyst" cx="50%" cy="50%" r="55%"><stop offset="0%" stop-color="#fce7f3" stop-opacity="0.9"/><stop offset="100%" stop-color="#ec4899" stop-opacity="0.15"/></radialGradient>
  </defs>
  <!-- Bone -->
  <path d="M18,232 L18,78 Q18,28 240,20 Q462,28 462,78 L462,232 Z" fill="url(#ua_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Cyst lumen -->
  <ellipse cx="240" cy="128" rx="148" ry="82" fill="url(#ua_cyst)" stroke="#9d174d" stroke-width="2.2"/>
  <!-- Cyst wall (thickened) -->
  <ellipse cx="240" cy="128" rx="148" ry="82" fill="none" stroke="#db2777" stroke-width="7" opacity="0.25"/>
  <!-- LEFT SIDE: Luminal type I — flat lining (label "OK to enucleate") -->
  <text x="105" y="98" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#059669" font-weight="700">TYPE I / II</text>
  <text x="105" y="110" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#059669">Flat lining</text>
  <!-- RIGHT SIDE: Mural type III — nodules growing INTO wall -->
  <ellipse cx="355" cy="108" rx="18" ry="13" fill="rgba(220,38,38,0.35)" stroke="#dc2626" stroke-width="1.5"/>
  <ellipse cx="342" cy="132" rx="14" ry="10" fill="rgba(220,38,38,0.35)" stroke="#dc2626" stroke-width="1.5"/>
  <ellipse cx="370" cy="142" rx="12" ry="9" fill="rgba(220,38,38,0.35)" stroke="#dc2626" stroke-width="1.5"/>
  <!-- Mural label -->
  <rect x="365" y="88" width="88" height="36" rx="5" fill="#fef2f2" stroke="#dc2626" stroke-width="1.2"/>
  <text x="409" y="101" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#dc2626" font-weight="800">TYPE III</text>
  <text x="409" y="113" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#dc2626">Mural invasion</text>
  <text x="409" y="124" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#dc2626">→ RESECT</text>
  <!-- Arrow from label to nodules -->
  <line x1="365" y1="116" x2="358" y2="114" stroke="#dc2626" stroke-width="1.2"/>
  <!-- Crown of tooth -->
  <path d="M204,146 Q204,134 216,129 L232,124 L240,122 L248,124 L264,129 Q276,134 276,146 Z" fill="#fdf6e3" stroke="#c8b888" stroke-width="1.2"/>
  <!-- Identical xray reminder -->
  <rect x="50" y="196" width="380" height="24" rx="6" fill="#fffbeb" stroke="#d97706" stroke-width="1.2"/>
  <text x="240" y="212" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9.5" fill="#92400e" font-weight="700">⚠  Imaging is IDENTICAL for all subtypes — subtype is histologic only</text>
</svg>`,
      chain: [
        { step: "What makes it 'ameloblastoma'?", answer: "The lining contains cells that look like the enamel organ — tall columnar cells with palisaded nuclei, reverse polarity, star-reticulum-like areas. These are the histologic hallmarks that distinguish it from a simple benign cyst lining." },
        { step: "Why does subtype matter so much?", answer: "Luminal (I) and intraluminal (II) types stay inside the cyst. Enucleation can work. Mural type (III) has those ameloblastomatous cells growing INTO the fibrous wall — like a solid ameloblastoma hiding inside a cyst. It needs resection. Miss this and you've left tumor behind." },
        { step: "The imaging problem", answer: "UA looks exactly like a Dentigerous Cyst on panoramic — a pericoronal unilocular lucency. You cannot see subtype on imaging. You cannot see whether cells are invading the wall. Diagnosis requires histology. Treatment planning requires adequate tissue sampling from the wall, not just the fluid." },
        { step: "Who gets it?", answer: "Younger patients — peak in 2nd–3rd decade. Mandibular 3rd molar region is the most common site. Any pericoronal lucency in a patient under 25 should prompt UA as a primary differential alongside DC." },
        { step: "What happens if you miss it?", answer: "If you enucleate a mural UA thinking it's DC, recurrence is near-certain. Worse — repeated inadequate surgery allows the lesion to transform and expand. The window for conservative management closes." },
      ],
      traps: [
        { label: "The age trap", icon: "👤", scenario: "22-year-old. Pericoronal lucency around impacted lower right 8. You confidently say Dentigerous Cyst, plan enucleation with the wisdom tooth.", consequence: "It was mural UA. You enucleated it. The pathology report comes back 2 weeks later. Now you need to go back in for resection — a harder surgery with a more complicated recovery.", fix: "Any pericoronal lucency under age 25 requires biopsy before surgery. Biopsy first. Plan after." },
      ],
      contrast: {
        versus: "DC",
        vsId: "dc",
        intro: "These look identical on imaging. The treatment diverges completely based on histologic subtype. This is the boards trap.",
        rows: [
          { feature: "Xray appearance", dc: "Pericoronal unilocular lucency", okc: "Pericoronal unilocular lucency — IDENTICAL" },
          { feature: "Epithelium", dc: "Non-keratinized squamous, thin, flat", okc: "Ameloblastomatous — columnar, palisaded, reverse polarity" },
          { feature: "Treatment", dc: "Enucleation + curettage", okc: "Subtype-dependent: I/II = enucleate, III = resect" },
          { feature: "Recurrence", dc: "Rare", okc: "Up to 30% luminal, higher in mural if under-treated" },
          { feature: "Can you know from xray?", dc: "No — biopsy required", okc: "No — histology is the only answer" },
        ]
      },
      clinicalFlow: {
        title: "When you see a pericoronal lucency in a young patient",
        steps: [
          { q: "Patient under 25 with pericoronal lucency?", y: "Biopsy BEFORE surgery — UA must be excluded", n: "Still biopsy — cannot exclude UA on imaging at any age" },
          { q: "Histology: ameloblastomatous epithelium (columnar, palisaded)?", y: "Confirmed UA — now determine subtype", n: "Likely DC — plan enucleation" },
          { q: "Subtype I or II (luminal / intraluminal)?", y: "Enucleation + close follow-up acceptable", n: "" },
          { q: "Subtype III (mural — cells in wall)?", y: "Resection required — treat like solid ameloblastoma", n: "" },
        ]
      }
    }
  ,
// ── LPC, COC, RC, RES, PARA full lesson data ──────────────────

    lpc: {
      whyHard: "LPC is low-yield enough that people skip it — and then get the boards question wrong because they couldn't distinguish it from a radicular cyst or early OKC. The distinguishing feature is embarrassingly simple once you know it.",
      coreIdea: "A developmental cyst that forms next to the lateral root surface of a completely vital tooth. The tooth didn't cause it — it's just in the neighborhood. That single fact separates it from almost every other jaw cyst you'll encounter.",
      theNumber: "**The vital pulp test is the whole differential.** If the tooth next to a lateral root lucency responds normally to cold — think LPC. If it's non-vital — think radicular cyst. That one test splits the differential completely.",
      visualNote: "Picture a small teardrop-shaped dark bubble sitting alongside the root of a lower premolar — not at the tip, not around the crown, just beside the middle of the root. The tooth is alive. That location and vitality together are almost pathognomonic.",
      svgLabel: "Lateral Periodontal Cyst — position relative to vital tooth",
      svg: `<svg viewBox="0 0 420 220" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:520px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="lpc_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="lpc_cyst" cx="50%" cy="50%" r="55%"><stop offset="0%" stop-color="#d1fae5" stop-opacity="0.9"/><stop offset="100%" stop-color="#059669" stop-opacity="0.2"/></radialGradient>
    <radialGradient id="lpc_tooth" cx="50%" cy="30%" r="60%"><stop offset="0%" stop-color="#fffbeb"/><stop offset="100%" stop-color="#e8d5a0"/></radialGradient>
  </defs>
  <!-- Bone -->
  <path d="M20,210 L20,50 Q20,20 210,14 Q400,20 400,50 L400,210 Z" fill="url(#lpc_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Trabeculae -->
  <line x1="50" y1="160" x2="70" y2="142" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <line x1="320" y1="155" x2="340" y2="138" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <!-- Alveolar crest -->
  <path d="M38,92 Q210,74 382,92" fill="none" stroke="#9a7e50" stroke-width="2"/>
  <!-- Premolar tooth (vital) — center -->
  <rect x="192" y="84" width="36" height="20" rx="4" fill="url(#lpc_tooth)" stroke="#c8b888" stroke-width="1.2"/>
  <!-- Single root -->
  <path d="M202,104 Q198,148 200,172" fill="none" stroke="#d8c898" stroke-width="12" stroke-linecap="round"/>
  <!-- Pulp canal (alive = vital) -->
  <path d="M210,96 Q208,130 209,160" fill="none" stroke="#fbbf24" stroke-width="3" stroke-linecap="round" opacity="0.6"/>
  <!-- LPC cyst — LATERAL to root, NOT apex -->
  <ellipse cx="170" cy="138" rx="28" ry="22" fill="url(#lpc_cyst)" stroke="#059669" stroke-width="2"/>
  <!-- Connecting line shows lateral position -->
  <line x1="198" y1="138" x2="196" y2="138" stroke="#059669" stroke-width="1.5" stroke-dasharray="3,2"/>
  <!-- NOT at apex arrow (rule out radicular) -->
  <line x1="200" y1="175" x2="200" y2="195" stroke="#dc2626" stroke-width="1.5"/>
  <circle cx="200" cy="196" r="3" fill="none" stroke="#dc2626" stroke-width="1.5"/>
  <rect x="210" y="188" width="120" height="16" rx="4" fill="white" opacity="0.9"/>
  <text x="270" y="200" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#dc2626" font-weight="700">NOT here = not radicular</text>
  <!-- LPC label -->
  <rect x="100" y="108" width="58" height="16" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="129" y="120" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#065f46" font-weight="700">LPC cyst</text>
  <line x1="158" y1="130" x2="145" y2="124" stroke="#059669" stroke-width="1.2"/>
  <!-- Vital pulp label -->
  <rect x="238" y="122" width="96" height="28" rx="4" fill="#fffbeb" stroke="#d97706" stroke-width="1"/>
  <text x="286" y="135" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#92400e" font-weight="700">Vital pulp ✓</text>
  <text x="286" y="146" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#92400e">Responds to cold</text>
  <line x1="238" y1="136" x2="216" y2="136" stroke="#d97706" stroke-width="1.2"/>
  <!-- Lateral position label -->
  <rect x="58" y="130" width="40" height="16" rx="4" fill="white" opacity="0.9"/>
  <text x="78" y="142" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#059669">LATERAL</text>
  <text x="210" y="68" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#78716c">Premolar — mandible</text>
</svg>`,
      chain: [
        { step: "What exactly is it and why does it form?", answer: "A developmental cyst from entrapped rests of Serres — cell remnants left over from tooth formation. Unlike the radicular cyst, there's no infection or pulp necrosis involved. It just grows slowly, silently, alongside a root it has nothing to do with clinically." },
        { step: "Where does it live?", answer: "Almost always in the mandibular premolar-canine-lateral incisor zone, between the roots of teeth. It sits beside the lateral root surface — not at the apex (that's radicular), not around the crown (that's dentigerous). Location alone narrows it down significantly." },
        { step: "The one test that matters", answer: "Pulp vitality test the adjacent tooth. LPC sits next to a living tooth — the pulp responds normally. A radicular cyst sits at the apex of a dead tooth — no pulp response. That cold spray tells you more than any radiograph in this differential." },
        { step: "What does it look like on xray?", answer: "Well-defined unilocular radiolucency with a sclerotic (white) border, teardrop or oval shape, along the lateral root surface. Usually small — under 1cm. The sclerotic border is important: it signals slow, non-aggressive growth." },
        { step: "The botryoid variant — when it gets complicated", answer: "Botryoid OC is the polycystic variant — multiple cystic compartments fused together like a bunch of grapes. Looks more aggressive on imaging. Higher recurrence after enucleation. When you see a multicystic lateral lesion, think botryoid." },
      ],
      traps: [
        { label: "The non-vital tooth trap", icon: "🦷", scenario: "You see a small oval radiolucency beside the root of a lower premolar. You don't test vitality. You assume LPC.", consequence: "The tooth is non-vital. It's a radicular cyst driven by pulp infection. You enucleate the cyst but don't treat the tooth — the cyst regrows from the persistent periapical infection.", fix: "Always test vitality before calling LPC. Non-vital tooth beside a lateral lucency = radicular cyst first." },
      ],
      contrast: {
        versus: "Radicular Cyst",
        vsId: "rc",
        intro: "Same general location in the jaw, completely different cause. One has a dead tooth; one has a live one. That difference is the entire diagnosis.",
        rows: [
          { feature: "Adjacent tooth", dc: "VITAL — responds to pulp test", okc: "NON-VITAL — no pulp response" },
          { feature: "Location", dc: "Lateral root surface (mid-root)", okc: "Root APEX" },
          { feature: "Origin", dc: "Developmental — rests of Serres", okc: "Inflammatory — Rests of Malassez" },
          { feature: "Treatment", dc: "Enucleation — tooth often preserved", okc: "RCT + apicoectomy or extraction" },
          { feature: "Recurrence", dc: "Low (botryoid variant: higher)", okc: "Rare if pulp treated properly" },
        ]
      },
      clinicalFlow: {
        title: "Lateral root lucency — decision flow",
        steps: [
          { q: "Lucency alongside lateral root surface (not apex, not pericoronal)?", y: "Consider LPC, radicular cyst", n: "Different localization — rethink DDx" },
          { q: "Pulp vitality test: tooth responds normally to cold?", y: "LPC — enucleation, preserve tooth", n: "Non-vital → radicular cyst → RCT + surgical enucleation" },
          { q: "Multilocular / polycystic appearance on imaging?", y: "Botryoid variant — more aggressive excision, close follow-up", n: "Simple LPC — standard enucleation" },
        ]
      }
    },

    coc: {
      whyHard: "COC is a boards favorite precisely because it looks distinctive histologically and students either know it cold or blank on it entirely. The question always gives you ghost cells — the answer is always COC until you can rule it out.",
      coreIdea: "A cyst defined by one thing: ghost cells. These are eosinophilic, anucleate epithelial cells — cells that died but kept their outline, like a cell-shaped shadow. When those ghosts calcify over time, you get a mixed radiolucent-radiopaque pattern on imaging. That combination — cyst + ghost cells + calcification — is COC.",
      theNumber: "**Ghost cells = COC** on any board question. See eosinophilic anucleate epithelial cells in a jaw cyst? Stop there. That's your answer. No other odontogenic cyst has them as a defining feature.",
      visualNote: "Imagine a cyst lining where some cells look hollowed out — like empty cell-shaped rooms with no nucleus. Those are ghost cells. Over time they accumulate calcium and the lining becomes partially radiopaque. On imaging: a cystic lucency with little white flecks inside or along the wall.",
      svgLabel: "COC — ghost cell histology and imaging correlate",
      svg: `<svg viewBox="0 0 480 200" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:560px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="coc_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="coc_cyst" cx="50%" cy="50%" r="55%"><stop offset="0%" stop-color="#fdf4ff" stop-opacity="0.9"/><stop offset="100%" stop-color="#a855f7" stop-opacity="0.15"/></radialGradient>
  </defs>
  <!-- LEFT: Imaging panel -->
  <rect x="10" y="10" width="220" height="180" rx="10" fill="#f9fafb" stroke="#e2e8f0" stroke-width="1.5"/>
  <text x="120" y="28" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#64748b" font-weight="600">IMAGING — Mixed RL/RO</text>
  <!-- Bone -->
  <path d="M30,170 L30,60 Q30,40 120,36 Q210,40 210,60 L210,170 Z" fill="url(#coc_bone)" stroke="#a08858" stroke-width="1.2"/>
  <!-- Cyst lumen -->
  <ellipse cx="120" cy="108" rx="68" ry="50" fill="url(#coc_cyst)" stroke="#9333ea" stroke-width="2"/>
  <!-- Calcification flecks inside cyst -->
  <ellipse cx="98" cy="92" rx="7" ry="5" fill="rgba(255,255,255,0.9)" stroke="#7c3aed" stroke-width="1.2"/>
  <ellipse cx="128" cy="88" rx="5" ry="4" fill="rgba(255,255,255,0.9)" stroke="#7c3aed" stroke-width="1.2"/>
  <ellipse cx="148" cy="100" rx="6" ry="4" fill="rgba(255,255,255,0.9)" stroke="#7c3aed" stroke-width="1.2"/>
  <ellipse cx="106" cy="118" rx="4" ry="3" fill="rgba(255,255,255,0.9)" stroke="#7c3aed" stroke-width="1"/>
  <ellipse cx="140" cy="116" rx="5" ry="4" fill="rgba(255,255,255,0.9)" stroke="#7c3aed" stroke-width="1"/>
  <!-- Calcification labels -->
  <line x1="145" y1="75" x2="148" y2="96" stroke="#7c3aed" stroke-width="1.2"/>
  <rect x="130" y="62" width="86" height="14" rx="3" fill="white" opacity="0.9"/>
  <text x="173" y="73" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#7c3aed" font-weight="700">Ghost cell calcifications</text>
  <!-- Cyst label -->
  <rect x="58" y="152" width="62" height="14" rx="3" fill="white" opacity="0.9"/>
  <text x="89" y="163" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#7c3aed">Cyst lumen</text>

  <!-- RIGHT: Histology schematic -->
  <rect x="250" y="10" width="220" height="180" rx="10" fill="#fdf4ff" stroke="#e9d5ff" stroke-width="1.5"/>
  <text x="360" y="28" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#7c3aed" font-weight="600">HISTOLOGY — Ghost cells</text>
  <!-- Normal epithelial cells with nuclei -->
  <rect x="270" y="40" width="80" height="18" rx="2" fill="#f0fdf4" stroke="#bbf7d0" stroke-width="1"/>
  <text x="310" y="52" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#166534">Normal cells (nucleated)</text>
  <circle cx="284" cy="68" r="5" fill="white" stroke="#86efac" stroke-width="1.2"/>
  <circle cx="284" cy="68" r="2" fill="#16a34a" opacity="0.7"/>
  <circle cx="296" cy="68" r="5" fill="white" stroke="#86efac" stroke-width="1.2"/>
  <circle cx="296" cy="68" r="2" fill="#16a34a" opacity="0.7"/>
  <circle cx="308" cy="68" r="5" fill="white" stroke="#86efac" stroke-width="1.2"/>
  <circle cx="308" cy="68" r="2" fill="#16a34a" opacity="0.7"/>
  <!-- Ghost cells — anucleate, pale eosinophilic -->
  <rect x="270" y="95" width="80" height="18" rx="2" fill="#fef3c7" stroke="#fde68a" stroke-width="1"/>
  <text x="310" y="107" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#92400e" font-weight="700">GHOST cells — no nucleus</text>
  <ellipse cx="284" cy="124" rx="7" ry="5" fill="#fef9c3" stroke="#d97706" stroke-width="1.5"/>
  <ellipse cx="300" cy="124" rx="7" ry="5" fill="#fef9c3" stroke="#d97706" stroke-width="1.5"/>
  <ellipse cx="316" cy="124" rx="7" ry="5" fill="#fef9c3" stroke="#d97706" stroke-width="1.5"/>
  <!-- X marks = no nucleus -->
  <text x="284" y="127" text-anchor="middle" font-family="monospace" font-size="9" fill="#d97706" font-weight="700">×</text>
  <text x="300" y="127" text-anchor="middle" font-family="monospace" font-size="9" fill="#d97706" font-weight="700">×</text>
  <text x="316" y="127" text-anchor="middle" font-family="monospace" font-size="9" fill="#d97706" font-weight="700">×</text>
  <text x="360" y="152" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#92400e" font-weight="800">See this → answer is COC</text>
  <rect x="270" y="158" width="160" height="24" rx="5" fill="#fef3c7" stroke="#d97706" stroke-width="1.2"/>
  <text x="350" y="174" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#92400e" font-weight="700">Eosinophilic + anucleate = ghost</text>
</svg>`,
      chain: [
        { step: "What is a ghost cell?", answer: "An epithelial cell that died but kept its cell membrane shape — eosinophilic cytoplasm, no nucleus. Think of it as a cell-shaped empty room. These cells progressively calcify, which is why COC has mixed radiolucent-radiopaque (RL/RO) imaging on panoramic." },
        { step: "Why does this matter on boards?", answer: "Ghost cells are pathognomonic in the context of an odontogenic jaw lesion. No other cyst in the odontogenic category has them as its defining feature. When a boards question gives you 'eosinophilic anucleate epithelial cells' — stop reading the options and circle COC." },
        { step: "What does it look like on imaging?", answer: "Usually unilocular, well-defined. The defining feature is the mixed radiolucency — dark (fluid) with white flecks (calcified ghost cells) inside. Sometimes associated with an unerupted tooth. The calcifications vary from subtle to obvious depending on lesion age." },
        { step: "The Gorlin Cyst name — and why it's confusing", answer: "COC was originally called Gorlin Cyst (Gorlin described it in 1962). Gorlin Syndrome (NBCCS) is a completely separate entity involving PTCH1 mutations and multiple OKCs. The name overlap trips students constantly — COC is Gorlin's Cyst, not Gorlin Syndrome." },
        { step: "Solid variant and treatment escalation", answer: "Most COCs are treated by enucleation. But the solid variant — DGCT (Dentinogenic Ghost Cell Tumor) — behaves like a locally aggressive neoplasm and needs wider excision. When histology shows solid sheets of ghost cell material rather than a cyst, the treatment plan changes." },
      ],
      traps: [
        { label: "The Gorlin name trap", icon: "🧬", scenario: "You read 'Gorlin Cyst' in a question. You think Gorlin Syndrome — PTCH1, multiple OKCs, basal cell carcinomas.", consequence: "Wrong. Gorlin Cyst = COC (ghost cells). Gorlin Syndrome = PTCH1 = multiple OKCs. One is an eponym for a cyst. The other is a genetic syndrome. These are not related.", fix: "Gorlin Cyst = COC. Gorlin Syndrome = PTCH1 + multiple OKCs. Keep these completely separate in your head." },
      ],
      contrast: null,
      clinicalFlow: {
        title: "COC — clinical decision flow",
        steps: [
          { q: "Mixed RL/RO jaw lesion with cystic component?", y: "Consider COC — get biopsy", n: "Pure RL → other cyst DDx" },
          { q: "Histology: ghost cells present (eosinophilic, anucleate)?", y: "Confirmed COC", n: "Rule out COC — consider DC, OKC" },
          { q: "Solid or locally aggressive features on histology?", y: "DGCT — wider excision required", n: "Cystic COC — enucleation + curettage" },
        ]
      }
    },

    rc: {
      whyHard: "Everyone knows 'radicular cyst = non-vital tooth at the apex' and moves on. What trips people up is the treatment logic — and the fact that RC vs periapical granuloma is radiographically indistinguishable, yet treatment is identical. That distinction trips students repeatedly.",
      coreIdea: "The most common jaw cyst overall — about 60% of all odontogenic cysts. It forms when chronic periapical inflammation stimulates Rests of Malassez (epithelial remnants at the root apex) to proliferate and form a cyst. The cause is always the same: a dead tooth.",
      theNumber: "**RC vs granuloma: treatment is identical, always.** You cannot distinguish them on imaging. You don't need to. Root canal therapy first — if the lesion persists or grows at 6 months, surgical enucleation. Never let the imaging diagnosis change your initial treatment plan.",
      visualNote: "Picture a dark halo at the tip of a root where the pulp is dead. Infection leaks out of the apex, stimulates the Rests of Malassez, they proliferate, a cyst forms. The halo grows from millimeters to centimeters over years — patient often has no symptoms until it's large.",
      svgLabel: "Radicular Cyst — periapical location, non-vital tooth",
      svg: `<svg viewBox="0 0 420 220" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:520px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="rc_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="rc_cyst" cx="50%" cy="60%" r="55%"><stop offset="0%" stop-color="#fee2e2" stop-opacity="0.9"/><stop offset="100%" stop-color="#dc2626" stop-opacity="0.15"/></radialGradient>
  </defs>
  <!-- Bone -->
  <path d="M20,210 L20,48 Q20,20 210,14 Q400,20 400,48 L400,210 Z" fill="url(#rc_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Alveolar crest -->
  <path d="M38,88 Q210,70 382,88" fill="none" stroke="#9a7e50" stroke-width="2"/>
  <!-- Trabeculae -->
  <line x1="50" y1="165" x2="70" y2="148" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <line x1="330" y1="160" x2="350" y2="143" stroke="#b8a070" stroke-width="1" opacity="0.4"/>
  <!-- Incisor tooth (non-vital — darker) -->
  <rect x="190" y="80" width="40" height="22" rx="3" fill="#e8dcc8" stroke="#b8a888" stroke-width="1.5"/>
  <!-- Dead pulp (dark) -->
  <path d="M210,94 Q208,130 209,162" fill="none" stroke="#78716c" stroke-width="4" stroke-linecap="round" opacity="0.5"/>
  <!-- Root -->
  <path d="M200,102 Q196,148 198,165" fill="none" stroke="#c8b888" stroke-width="12" stroke-linecap="round"/>
  <path d="M218,102 Q222,150 220,167" fill="none" stroke="#c8b888" stroke-width="12" stroke-linecap="round"/>
  <!-- Periapical cyst at ROOT TIP -->
  <ellipse cx="210" cy="182" rx="40" ry="28" fill="url(#rc_cyst)" stroke="#dc2626" stroke-width="2.2"/>
  <!-- Necrotic apex indicator -->
  <circle cx="210" cy="166" r="5" fill="#dc2626" opacity="0.6"/>
  <!-- Arrow to apex -->
  <line x1="260" y1="158" x2="218" y2="166" stroke="#dc2626" stroke-width="1.5"/>
  <rect x="260" y="148" width="110" height="22" rx="4" fill="white" opacity="0.92"/>
  <text x="315" y="160" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#dc2626" font-weight="700">Necrotic apex</text>
  <text x="315" y="171" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#dc2626">Source of infection</text>
  <!-- Cyst label -->
  <rect x="260" y="183" width="100" height="22" rx="4" fill="white" opacity="0.92"/>
  <text x="310" y="195" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#b91c1c" font-weight="700">RC at apex</text>
  <text x="310" y="205" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#b91c1c">non-vital tooth</text>
  <line x1="260" y1="190" x2="248" y2="187" stroke="#b91c1c" stroke-width="1.2"/>
  <!-- Dead tooth label -->
  <rect x="60" y="70" width="120" height="20" rx="4" fill="#fee2e2" stroke="#fca5a5" stroke-width="1"/>
  <text x="120" y="83" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#991b1b" font-weight="700">Non-vital tooth (dead pulp)</text>
  <line x1="180" y1="83" x2="190" y2="90" stroke="#991b1b" stroke-width="1.2"/>
  <!-- Rests of Malassez label -->
  <text x="210" y="210" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#78716c">Rests of Malassez → stimulated → cyst</text>
</svg>`,
      chain: [
        { step: "The mechanism — why does RC form?", answer: "Pulp necrosis → bacterial byproducts leak through the root apex → chronic periapical inflammation → stimulates epithelial Rests of Malassez (normal remnants at the root tip) to proliferate → cystic cavity forms. Remove the stimulus (dead tooth) and the cyst stops growing." },
        { step: "How common is it really?", answer: "About 60% of all odontogenic cysts are radicular. It's by far the most common jaw cyst clinically. Any time a patient presents with a periapical lucency and a non-vital tooth, RC is the presumed diagnosis until proven otherwise." },
        { step: "RC vs periapical granuloma — the question you'll see", answer: "Radiographically indistinguishable. Both are periapical, both are dark on imaging. The granuloma is smaller (under 1cm typically) and has no epithelial lining — it's just inflamed tissue. RC has a true epithelial lining. You CANNOT tell them apart from an xray." },
        { step: "Why the distinction doesn't matter for treatment", answer: "Root canal therapy is the first-line treatment for both. You're removing the necrotic pulp — the stimulus. Most granulomas and small RCs resolve with RCT alone. If it doesn't shrink at 6 months on follow-up imaging, surgical enucleation." },
        { step: "When to biopsy regardless", answer: "Any periapical lesion that fails to resolve after adequate RCT, grows on follow-up, or looks atypical (multilocular, large, asymmetric) must be biopsied. Rare but real: central malignancy can mimic RC. Missing it by assuming RC and doing RCT costs the patient dearly." },
      ],
      traps: [
        { label: "The 'treat without biopsy' trap", icon: "🔬", scenario: "RC is so common you assume the diagnosis. Do the RCT. Follow up in a year. It's still there, maybe slightly bigger. You continue observing.", consequence: "Rare periapical lesions — CGCG, ameloblastoma, primary jaw malignancy — can masquerade as RC. A year of observation is a year of delay in a potentially aggressive diagnosis.", fix: "RCT first. Reassess at 6 months. Any lesion that fails to regress or grows after adequate RCT gets biopsied — no exceptions." },
      ],
      contrast: {
        versus: "Periapical Granuloma",
        vsId: "rc",
        intro: "The granuloma and the radicular cyst sit at the apex of the same dead tooth. They look identical on imaging. Treatment is the same. The only difference is what you find under the microscope.",
        rows: [
          { feature: "Epithelial lining?", dc: "YES — true epithelial-lined cavity", okc: "NO — inflamed fibrous/granulation tissue" },
          { feature: "Size typically", dc: "Often > 1cm; can get large", okc: "Usually < 1cm; self-limited" },
          { feature: "Xray appearance", dc: "Periapical radiolucency", okc: "Periapical radiolucency — IDENTICAL" },
          { feature: "Initial treatment", dc: "RCT first — same as granuloma", okc: "RCT first" },
          { feature: "Surgery needed?", dc: "If RCT fails — apicoectomy + enucleation", okc: "Usually resolves with RCT alone" },
        ]
      },
      clinicalFlow: {
        title: "Periapical lucency decision flow",
        steps: [
          { q: "Periapical radiolucency present?", y: "Test pulp vitality", n: "Not periapical — different DDx" },
          { q: "Tooth non-vital (no response to cold/EPT)?", y: "RC or granuloma — start RCT", n: "Vital tooth + periapical lucency = unusual, consider other lesions" },
          { q: "Lesion resolves or shrinks at 6-month follow-up?", y: "Successful — continue to monitor", n: "Persistent or growing → surgical enucleation + biopsy" },
          { q: "Biopsy: epithelial lining present?", y: "Radicular cyst confirmed", n: "Periapical granuloma — management was correct" },
        ]
      }
    },

    res: {
      whyHard: "Residual cyst is the condition students forget exists until they see an edentulous jaw with a radiolucency and draw a blank. It's essentially a radicular cyst with its tooth removed — histologically identical, clinically invisible.",
      coreIdea: "A radicular cyst that wasn't fully enucleated when its tooth was extracted. The tooth is gone. The cyst lining was left behind. It continues growing slowly in the now-edentulous site — sometimes for years before anyone notices on a panoramic.",
      theNumber: "**Edentulous site + well-defined radiolucency in an older adult = residual cyst first.** The age and edentulous context are the whole clinical story. Histology confirms — it looks exactly like a radicular cyst because it is one.",
      visualNote: "Picture a panoramic of a 65-year-old who had their lower molar extracted 10 years ago. There's a round, well-defined dark lesion where that root used to be. No tooth is there. But the cyst lining from the periapical infection was never removed — it kept growing after the tooth came out.",
      svgLabel: "Residual Cyst — post-extraction site, edentulous jaw",
      svg: `<svg viewBox="0 0 420 180" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:520px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="res_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="res_cyst" cx="50%" cy="50%" r="55%"><stop offset="0%" stop-color="#fef3c7" stop-opacity="0.9"/><stop offset="100%" stop-color="#d97706" stop-opacity="0.2"/></radialGradient>
  </defs>
  <!-- Bone (resorbed — edentulous) -->
  <path d="M20,165 L20,55 Q20,28 210,22 Q400,28 400,55 L400,165 Z" fill="url(#res_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Resorbed alveolar crest (lower, edentulous) -->
  <path d="M38,72 Q210,62 382,72" fill="none" stroke="#9a7e50" stroke-width="2" stroke-dasharray="6,3"/>
  <!-- Missing tooth ghost outlines (neighboring teeth extracted) -->
  <rect x="100" y="62" width="28" height="14" rx="2" fill="none" stroke="#c0a878" stroke-width="1" stroke-dasharray="3,2" opacity="0.4"/>
  <rect x="290" y="62" width="28" height="14" rx="2" fill="none" stroke="#c0a878" stroke-width="1" stroke-dasharray="3,2" opacity="0.4"/>
  <!-- Residual cyst at extraction site (no tooth above) -->
  <ellipse cx="210" cy="118" rx="52" ry="36" fill="url(#res_cyst)" stroke="#d97706" stroke-width="2.2"/>
  <!-- Arrow from empty alveolus to cyst -->
  <line x1="210" y1="70" x2="210" y2="84" stroke="#d97706" stroke-width="1.5" stroke-dasharray="3,2"/>
  <text x="210" y="60" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#92400e" font-weight="700">Extraction site — tooth gone</text>
  <!-- Cyst label -->
  <rect x="270" y="106" width="108" height="28" rx="4" fill="white" opacity="0.92"/>
  <text x="324" y="119" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#d97706" font-weight="700">Residual cyst</text>
  <text x="324" y="131" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#92400e">lining left at extraction</text>
  <line x1="270" y1="118" x2="260" y2="118" stroke="#d97706" stroke-width="1.2"/>
  <!-- Histology = RC label -->
  <rect x="32" y="106" width="130" height="22" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
  <text x="97" y="118" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#92400e" font-weight="700">Histology = Radicular Cyst</text>
  <text x="97" y="130" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="7.5" fill="#92400e">Identical lining</text>
  <text x="210" y="160" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#78716c">Patient: older adult, edentulous, often asymptomatic discovery on panoramic</text>
</svg>`,
      chain: [
        { step: "How does it form?", answer: "Simple: a tooth with a periapical (radicular) cyst is extracted, but the surgeon doesn't remove the cyst lining. The tooth is gone. The cyst lining stays behind, often microscopically. It continues to grow slowly — fueled by its own osmotic pressure — with no tooth to remind anyone it exists." },
        { step: "Who gets it and how is it found?", answer: "Older adults, often edentulous patients getting panoramics for denture fitting or implant planning. The patient has no idea it's there. It's an incidental finding on imaging — a well-defined, often sclerotic-bordered radiolucency in an area where a tooth used to be." },
        { step: "What does histology show?", answer: "Exactly what you'd expect from a radicular cyst: non-keratinized stratified squamous epithelium with inflamed fibrous wall. You can't distinguish residual from radicular on histology alone — the clinical context (edentulous site, prior extraction) makes the diagnosis." },
        { step: "Treatment", answer: "Enucleation. Straightforward, low recurrence. The challenge is just finding it — and recognizing that a post-extraction radiolucency that persists or grows after 6 months warrants surgical evaluation, not indefinite observation." },
      ],
      traps: [
        { label: "The 'just observe it' trap", icon: "📅", scenario: "Post-extraction radiolucency in an older patient. You tell yourself it's healing. You watch it for 18 months.", consequence: "It wasn't healing — it was growing. A residual cyst was present from the start. It's now larger and the surgical window is less ideal. Occasionally, these can undergo malignant transformation (rare but documented).", fix: "Post-extraction radiolucencies that don't resolve within 6 months need investigation. A panoramic at 6 months is reasonable surveillance." },
      ],
      contrast: null,
      clinicalFlow: {
        title: "Edentulous jaw radiolucency — decision flow",
        steps: [
          { q: "Well-defined radiolucency at an edentulous site?", y: "Consider residual cyst — biopsy", n: "Teeth present → different DDx" },
          { q: "History of tooth extraction at this site?", y: "Residual cyst most likely — enucleate + send to path", n: "Consider central lesion, hemangioma, other" },
          { q: "Histology: non-keratinized epithelial lining?", y: "Residual cyst confirmed — follow-up in 1 year", n: "Re-evaluate diagnosis if different histology" },
        ]
      }
    },

    para: {
      whyHard: "Paradental cyst hides in plain sight. The pericoronitis is obvious — the buccal cyst component isn't. Students treat the pericoronitis, leave the cyst, and wonder why the patient keeps coming back.",
      coreIdea: "An inflammatory cyst that forms at the buccal or lateral surface of a partially erupted mandibular third molar — driven by the same pericoronitis you're already treating. It's not a coincidence that it occurs with wisdom tooth inflammation — the inflammation is the cause.",
      theNumber: "**Lower third molar + buccal swelling + pericoronitis = suspect paradental cyst.** The cyst is in the same space as the pericoronitis. You need to treat both — extracting or exposing the tooth without enucleating the cyst leaves the cyst behind.",
      visualNote: "Picture a wisdom tooth that's partially erupted. The gum flap (operculum) over it is constantly inflamed — food traps, bacteria accumulate, the buccal mucosa swells. In the buccal bone next to that tooth, inflammation has stimulated a cyst to form. On imaging: a small radiolucency on the buccal side of the distal root, not pericoronal, not periapical — lateral buccal.",
      svgLabel: "Paradental Cyst — buccal to partially erupted lower molar",
      svg: `<svg viewBox="0 0 440 220" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:540px;height:auto;display:block;margin:0 auto;">
  <defs>
    <linearGradient id="pc_bone" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#c8b090"/></linearGradient>
    <radialGradient id="pc_cyst" cx="50%" cy="50%" r="55%"><stop offset="0%" stop-color="#fce7f3" stop-opacity="0.9"/><stop offset="100%" stop-color="#db2777" stop-opacity="0.2"/></radialGradient>
  </defs>
  <!-- Bone -->
  <path d="M20,210 L20,55 Q20,25 260,18 Q420,22 420,55 L420,210 Z" fill="url(#pc_bone)" stroke="#a08858" stroke-width="1.5"/>
  <!-- Alveolar crest -->
  <path d="M38,94 Q260,76 402,94" fill="none" stroke="#9a7e50" stroke-width="2"/>
  <!-- Partial eruption — tooth crown peeking through -->
  <rect x="222" y="84" width="60" height="22" rx="4" fill="#fdf6e3" stroke="#c8b888" stroke-width="1.5"/>
  <line x1="244" y1="84" x2="244" y2="106" stroke="#ddd" stroke-width="1"/>
  <line x1="258" y1="84" x2="258" y2="106" stroke="#ddd" stroke-width="1"/>
  <line x1="272" y1="84" x2="272" y2="106" stroke="#ddd" stroke-width="1"/>
  <!-- Operculum (gum flap) — inflamed -->
  <path d="M280,84 Q295,72 310,82 Q300,88 282,92 Z" fill="#fca5a5" stroke="#dc2626" stroke-width="1.5" opacity="0.8"/>
  <text x="314" y="74" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#dc2626" font-weight="700">Inflamed operculum</text>
  <!-- Roots -->
  <path d="M232,106 Q228,148 230,168" fill="none" stroke="#d8c898" stroke-width="11" stroke-linecap="round"/>
  <path d="M270,106 Q274,150 272,170" fill="none" stroke="#d8c898" stroke-width="11" stroke-linecap="round"/>
  <!-- Paradental cyst — BUCCAL side, lateral to distal root -->
  <ellipse cx="300" cy="148" rx="34" ry="26" fill="url(#pc_cyst)" stroke="#db2777" stroke-width="2.2"/>
  <!-- Buccal arrow -->
  <line x1="340" y1="148" x2="380" y2="148" stroke="#db2777" stroke-width="1.5"/>
  <rect x="340" y="136" width="72" height="26" rx="4" fill="white" opacity="0.9"/>
  <text x="376" y="149" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="9" fill="#9d174d" font-weight="700">Paradental</text>
  <text x="376" y="161" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#9d174d">cyst — BUCCAL</text>
  <!-- NOT pericoronal label -->
  <rect x="38" y="76" width="130" height="22" rx="4" fill="white" opacity="0.9"/>
  <text x="103" y="88" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#78716c">Not pericoronal —</text>
  <text x="103" y="99" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8" fill="#78716c">buccal-lateral position</text>
  <!-- Vital tooth label -->
  <rect x="38" y="174" width="120" height="20" rx="4" fill="#fdf4ff" stroke="#e9d5ff" stroke-width="1"/>
  <text x="98" y="187" text-anchor="middle" font-family="'IBM Plex Mono',monospace" font-size="8.5" fill="#7c3aed">Vital tooth — partial eruption</text>
</svg>`,
      chain: [
        { step: "What causes it?", answer: "Pericoronitis — the recurrent inflammation around a partially erupted wisdom tooth — drives epithelial proliferation in the buccal tissue. The inflamed environment stimulates the formation of a true cyst in the lateral/buccal bone adjacent to the distal root. Inflammation is both the trigger and the fuel." },
        { step: "How is it different from dentigerous cyst?", answer: "Location. DC is pericoronal — it wraps around the crown at the CEJ. Paradental cyst is buccal-lateral — it forms alongside the distal or buccal root surface, often below the CEJ. The tooth in a paradental cyst is partially erupted; in DC the tooth is completely unerupted." },
        { step: "What does imaging show?", answer: "A small, well-defined radiolucency on the buccal or distal-buccal surface of a partially erupted mandibular third molar. It's easy to miss because it overlaps with the tooth shadow on panoramic — CBCT shows it clearly as a buccal lesion." },
        { step: "The treatment mistake", answer: "Treating the pericoronitis (operculum removal, antibiotics, irrigation) without addressing the cyst. The cyst has its own epithelial lining — it won't resolve with pericoronitis treatment. You must extract or properly expose the tooth AND surgically enucleate the cyst." },
      ],
      traps: [
        { label: "The pericoronitis-only trap", icon: "🦷", scenario: "Partially erupted lower right third molar, classic pericoronitis presentation. You operculize, prescribe antibiotics, the patient improves. You see it as resolved.", consequence: "The paradental cyst was never addressed. The tooth comes back inflamed in 6 months. The cyst has grown. Eventually requires a more complex extraction and enucleation.", fix: "Any wisdom tooth with recurrent pericoronitis needs CBCT to rule out paradental cyst. Treat both the tooth and the cyst at the same surgical appointment." },
      ],
      contrast: null,
      clinicalFlow: {
        title: "Recurrent pericoronitis with third molar — decision flow",
        steps: [
          { q: "Partially erupted lower molar + recurrent pericoronitis?", y: "CBCT to evaluate for paradental cyst", n: "Single episode — standard pericoronitis management" },
          { q: "CBCT: buccal-lateral radiolucency adjacent to distal root?", y: "Paradental cyst — plan surgical enucleation with tooth removal", n: "No cyst — standard extraction or operculization" },
          { q: "Histology: non-keratinized lining with inflammatory wall?", y: "Paradental cyst confirmed — follow up in 6 months", n: "Unexpected histology → re-evaluate DDx" },
        ]
      }
    }

};

function renderStudy(id, targetEl){
  const c = CONDITIONS[id];
  if(!c) return;

  // ── Per-condition teaching content ──────────────────────────
  // Written for someone who is STRUGGLING — not for someone reviewing

  // Fallback — all 8 conditions now have full lessons, this is safety net only
  const defaultLesson = {
    whyHard: null,
    coreIdea: c.summary,
    theNumber: null,
    visualNote: null,
    svgLabel: c.title,
    svg: null,
    chain: [],
    traps: [],
    contrast: null,
    clinicalFlow: null
  };

  const L = lessons[id] || defaultLesson;

  // ── CSS classes for color bands ──────────────────────────────
  const tags = (c.tags||[]).map(function(t){ return '<span class="ctag ' + t.c + '">' + t.l + '</span>'; }).join('');

  // ── Build HTML ───────────────────────────────────────────────
  let html = '<div class="teach-wrap">';

  // Header
  html += '<div class="teach-header">'
    + '<div class="teach-eyebrow">' + c.ey + '</div>'
    + '<h1 class="teach-title">' + c.title + '</h1>'
    + (c.aka ? '<div class="teach-aka">also called <em>' + c.aka + '</em></div>' : '')
    + '<div class="teach-tagrow">' + tags + '</div>'
  + '</div>';

  // Role-aware framing banner (resident/attending only)
  const roleFrames = {
    resident:  { icon:'🔬', lbl:'Resident View',  note:'Emphasis on clinical presentation, surgical planning, and recurrence management.' },
    attending: { icon:'⚕', lbl:'Attending View', note:'Pathology review with focus on atypical presentations, documentation, and teaching.' }
  };
  const rf = roleFrames[curRole];
  if(rf){
    html += '<div class="teach-role-banner">'
      + '<span class="teach-role-icon">' + rf.icon + '</span>'
      + '<span class="teach-role-lbl">' + rf.lbl + '</span>'
      + '<span class="teach-role-note">' + rf.note + '</span>'
      + '</div>';
  }

  // Why this is hard — sets the tone
  if(L.whyHard){
    html += '<div class="teach-why-hard">'
      + '<div class="teach-why-icon">💬</div>'
      + '<div class="teach-why-text">' + L.whyHard + '</div>'
    + '</div>';
  }

  // The core idea in plain language
  html += '<div class="teach-core">'
    + '<div class="teach-section-lbl">The core idea</div>'
    + '<div class="teach-core-text">' + L.coreIdea + '</div>'
    + (L.theNumber ? '<div class="teach-the-number">' + L.theNumber.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') + '</div>' : '')
  + '</div>';

  // Condition fingerprint bars
  html += '<div class="teach-fp-row">';
  (c.fp||[]).forEach(function(f){
    const col = f.t==='hi' ? 'fp-red' : f.t==='md' ? 'fp-amber' : 'fp-green';
    html += '<div class="teach-fp-item">'
      + '<div class="teach-fp-k">' + f.k + '</div>'
      + '<div class="teach-fp-bar"><div class="teach-fp-fill ' + col + '" style="width:0" data-w="' + f.v + '%"></div></div>'
      + '<div class="teach-fp-v ' + col + '">' + f.l + '</div>'
    + '</div>';
  });
  html += '</div>';

  // Diagram
  if(L.svg){
    html += '<div class="teach-diagram-block">'
      + '<div class="teach-section-lbl">' + L.svgLabel + '</div>'
      + (L.visualNote ? '<div class="teach-visual-note">' + L.visualNote + '</div>' : '')
      + '<div class="teach-svg-wrap">' + L.svg + '</div>'
    + '</div>';
  }

  // Logic chain
  if(L.chain && L.chain.length){
    html += '<div class="teach-chain-block">'
      + '<div class="teach-section-lbl">Build the mental model — step by step</div>';
    L.chain.forEach(function(s, i){
      html += '<div class="teach-chain-step">'
        + '<div class="teach-chain-left">'
          + '<div class="teach-chain-num">' + (i+1) + '</div>'
          + (i < L.chain.length-1 ? '<div class="teach-chain-line"></div>' : '')
        + '</div>'
        + '<div class="teach-chain-body">'
          + '<div class="teach-chain-q">' + s.step + '</div>'
          + '<div class="teach-chain-a">' + s.answer + '</div>'
        + '</div>'
      + '</div>';
    });
    html += '</div>';
  }

  // Traps
  if(L.traps && L.traps.length){
    html += '<div class="teach-traps-block">'
      + '<div class="teach-section-lbl">The clinical traps — where people get it wrong</div>';
    L.traps.forEach(function(t){
      html += '<div class="teach-trap-card">'
        + '<div class="teach-trap-hdr"><span>' + t.icon + '</span><strong>' + t.label + '</strong></div>'
        + '<div class="teach-trap-body">'
          + '<div class="teach-trap-scene">'
            + '<div class="teach-trap-scene-lbl">The scenario</div>'
            + '<div>' + t.scenario + '</div>'
          + '</div>'
          + '<div class="teach-trap-arrow">↓ what happens</div>'
          + '<div class="teach-trap-outcome">' + t.consequence + '</div>'
        + '</div>'
        + '<div class="teach-trap-fix"><strong>The rule: </strong>' + t.fix + '</div>'
      + '</div>';
    });
    html += '</div>';
  }

  // Contrast table
  if(L.contrast){
    const vs = CONDITIONS[L.contrast.vsId];
    const vsName = vs ? vs.title : L.contrast.versus;
    html += '<div class="teach-contrast-block">'
      + '<div class="teach-section-lbl">' + c.title + ' vs. ' + vsName + '</div>'
      + '<div class="teach-contrast-intro">' + L.contrast.intro + '</div>'
      + '<div class="teach-vs-table">'
        + '<div class="teach-vs-hdr">'
          + '<div class="teach-vs-cell lbl-col"></div>'
          + '<div class="teach-vs-cell a-col">' + c.title + '</div>'
          + '<div class="teach-vs-cell b-col">' + vsName + '</div>'
        + '</div>'
        + L.contrast.rows.map(function(row){
          return '<div class="teach-vs-row">'
            + '<div class="teach-vs-cell lbl-col">' + row.feature + '</div>'
            + '<div class="teach-vs-cell a-col">' + row.dc + '</div>'
            + '<div class="teach-vs-cell b-col">' + row.okc + '</div>'
          + '</div>';
        }).join('')
      + '</div>'
    + '</div>';
  }

  // Clinical flow
  if(L.clinicalFlow){
    html += '<div class="teach-flow-block">'
      + '<div class="teach-section-lbl">' + L.clinicalFlow.title + '</div>'
      + '<div class="teach-flow-steps">';
    L.clinicalFlow.steps.forEach(function(step, i){
      const isLast = i === L.clinicalFlow.steps.length - 1;
      html += '<div class="teach-flow-node">'
        + '<div class="teach-flow-q">'
          + '<div class="teach-flow-q-num">' + (i+1) + '</div>'
          + '<div class="teach-flow-q-text">' + step.q + '</div>'
        + '</div>'
        + '<div class="teach-flow-answers">'
          + (step.y ? '<div class="teach-flow-yes"><span class="teach-flow-badge yes">YES →</span><span>' + step.y + '</span></div>' : '')
          + (step.n ? '<div class="teach-flow-no"><span class="teach-flow-badge no">NO →</span><span>' + step.n + '</span></div>' : '')
        + '</div>'
      + '</div>';
      if(!isLast) html += '<div class="teach-flow-connector"></div>';
    });
    html += '</div></div>';
  }

  // Pearls
  if(c.pearls && c.pearls.length){
    html += '<div class="teach-pearls-block">'
      + '<div class="teach-section-lbl">Board pearls — remember these</div>';
    c.pearls.forEach(function(p, i){
      html += '<div class="teach-pearl-item">'
        + '<div class="teach-pearl-num">0' + (i+1) + '</div>'
        + '<div class="teach-pearl-body">'
          + '<div class="teach-pearl-lbl">' + p.lbl + '</div>'
          + '<div class="teach-pearl-txt">' + p.txt + '</div>'
        + '</div>'
      + '</div>';
    });
    html += '</div>';
  }

  // Mnemonic
  if(c.mnem && c.mnem.lines && c.mnem.lines.length){
    html += '<div class="teach-mnem-block">'
      + '<div class="teach-section-lbl">Mnemonic</div>'
      + '<div class="teach-mnem-card">'
        + '<div class="teach-mnem-word">' + c.mnem.word + '</div>'
        + c.mnem.lines.map(function(l){
          return '<div class="teach-mnem-line"><strong>' + l.l + '</strong>' + l.r + '</div>';
        }).join('')
      + '</div>'
    + '</div>';
  }

  // Quiz CTA
  html += '<div class="teach-quiz-cta">'
    + '<div><h4>Ready to test this?</h4><p>Board-style cases — see if the model actually stuck · ~6 min</p></div>'
    + '<button class="quiz-start" onclick="setMode(\'trainer\')">Launch Trainer →</button>'
  + '</div>';

  html += '</div>';

  const panel = rightPanelH(id);
  (targetEl || document.getElementById('pathScreen')).innerHTML = '<div class="path-wrap">' + html + panel + '</div>';
  setTimeout(function(){
    document.querySelectorAll('[data-w]').forEach(function(b){ b.style.width = b.dataset.w; });
  }, 120);
}



/* ════════════ RENDER COMPARE ════════════ */
// ── MODULE 2 RENDER ─────────────────────────────────────────────────────────
const m2CondOrder = ['npc','nla','derm','lymp','thyro','staf'];
const m2CondNames = {
  npc:'Nasopalatine Duct Cyst', nla:'Nasolabial Cyst', derm:'Dermoid/Epidermoid',
  lymp:'Lymphoepithelial Cyst', thyro:'Thyroglossal Duct Cyst', staf:'Stafne Bone Defect'
};

function renderM2(){
  const screenEl = document.getElementById('m2Screen');
  if(!screenEl) return;
  const cond = CONDITIONS[curCondM2];
  if(!cond) return;

  // Mode toggle awareness
  const modeEl = document.getElementById('modeToggle');
  if(modeEl) {
    const btns = modeEl.querySelectorAll('.mt-btn');
    btns.forEach(b => b.classList.toggle('active', b.dataset.mode === curMode));
    modeEl.querySelectorAll('.mt-btn').forEach(b => {
      b.onclick = () => { curMode = b.dataset.mode; renderM2(); };
    });
  }

  if(curMode === 'study'){
    renderStudy(curCondM2, screenEl);
  } else if(curMode === 'compare'){
    screenEl.innerHTML = buildM2CompareHTML();
    // Init accordion interactions
    screenEl.querySelectorAll('.ddx-item').forEach(d => {
      d.querySelector('.ddx-q').onclick = () => d.classList.toggle('open');
    });
  } else if(curMode === 'trainer'){
    // Filter M2 cases and render trainer in m2Screen
    const savedCases = CASES;
    const m2Cases = CASES.filter(c => c.n >= 17 && c.n <= 26);
    renderTrainer(m2Cases, screenEl);
  }
  buildM2SidebarNav();
}

function buildM2SidebarNav(){
  const nav = document.getElementById('sbM2Nav');
  if(!nav) return;
  let h = '';
  m2CondOrder.forEach(id => {
    const n = CONDITIONS[id];
    if(!n) return;
    const active = id === curCondM2 ? ' active-cond' : '';
    h += `<div class="sb-cond${active}" onclick="curCondM2='${id}';renderM2()">${n.title}</div>`;
  });
  nav.innerHTML = h;
}

function buildM2CompareHTML(){
  // Module 2 compare: Non-OG cyst fingerprint comparison table
  let h = `<div class="compare-screen">
    <div class="cmp-header">
      <div class="cmp-eyebrow">Non-Odontogenic Cysts · Quick Compare</div>
      <h2 class="cmp-title">Module 2 — Condition Matrix</h2>
      <p class="cmp-sub">Every Module 2 condition across the same features. Print this, memorize this.</p>
    </div>
    <div class="cmp-table-wrap">
      <table class="cmp-table">
        <thead><tr>
          <th>Feature</th>
          <th>NPDC</th><th>Nasolabial</th><th>Dermoid</th>
          <th>Lymphoepithelial</th><th>Thyroglossal</th><th>Stafne</th>
        </tr></thead>
        <tbody>
          <tr><td class="feat">Location</td><td>Midline anterior maxilla — incisive canal</td><td>Nasal ala base — soft tissue</td><td>Midline floor of mouth</td><td>Floor of mouth OR lateral neck</td><td>Midline neck — any point along duct</td><td>Posterior mandible — lingual cortex</td></tr>
          <tr><td class="feat">Bone Involvement</td><td class="pos">YES — intraosseous</td><td class="neg">NO — soft tissue only</td><td class="pos">No (occasionally shallow pressure)</td><td class="neg">No intraosseous</td><td class="neg">No intraosseous</td><td class="warn">Cortical depression only</td></tr>
          <tr><td class="feat">X-ray finding</td><td class="pos">Heart-shaped RL, midline</td><td class="neg">NONE — normal panoramic</td><td class="neg">None on panoramic</td><td class="neg">None</td><td class="neg">None (neck cyst)</td><td class="warn">RL BELOW IAN canal</td></tr>
          <tr><td class="feat">Pathognomonic Sign</td><td>Nerve/vessel in cyst wall</td><td>Normal X-ray + nasal ala swelling</td><td>Doughy palpation (sebaceous)</td><td>Lymphoid germinal centers in wall</td><td>Moves with tongue protrusion</td><td>BELOW IAN canal, static</td></tr>
          <tr><td class="feat">Decisive Test</td><td>Pulp vitality — centrals must be vital</td><td>Clinical exam + normal X-ray</td><td>MRI or histology (appendages)</td><td>CT/FNA (cystic, squamous + lymphoid)</td><td>Thyroid US before surgery</td><td>MRI (salivary T1 signal)</td></tr>
          <tr><td class="feat">Lining</td><td>Variable — squamous/columnar/cuboidal</td><td>Non-keratinized squamous or respiratory</td><td>Keratinized squamous ± appendages</td><td>Squamous + lymphoid wall</td><td>Respiratory (ciliated columnar)</td><td>Not a cyst — salivary parenchyma</td></tr>
          <tr><td class="feat">Treatment</td><td>Enucleation — palatal approach</td><td>Sublabial excision</td><td>Excision (approach per mylohyoid)</td><td>Excision (intraoral or surgical)</td><td>Sistrunk procedure</td><td>NONE</td></tr>
          <tr><td class="feat">Recurrence</td><td>Low (&lt;11%)</td><td>Low</td><td>Low</td><td>Low</td><td>5% (Sistrunk) / 50% (simple)</td><td>N/A — not pathologic</td></tr>
          <tr><td class="feat">Critical Trap</td><td>Non-vital tooth → RC not NPDC</td><td>Normal X-ray is the diagnosis</td><td>Don't marsupiailze (thick contents)</td><td>FNA first in young adult (lymphoma DDx)</td><td>Confirm separate thyroid pre-op</td><td>Do NOT biopsy — check IAN position</td></tr>
        </tbody>
      </table>
    </div>
  </div>`;
  return h;
}

function renderCompare(){
  document.getElementById('pathScreen').innerHTML=`<div class="compare-wrap">
    <div class="cond-eyebrow" style="margin-bottom:10px;">Pathology · Compare Mode</div>
    <div class="cond-title" style="font-size:32px;margin-bottom:8px;">Side-by-Side</div>
    <p style="font-size:14px;color:var(--tx2);max-width:600px;line-height:1.7;margin-bottom:28px;">The conditions that look alike until the one detail that separates them. Compare by group — pericoronal, apical/lateral, or special types.</p>

    <!-- GROUP NAV -->
    <div class="cmp-group-nav" id="cmpGroupNav">
      <div class="cmp-gn-btn active" onclick="showCmpGroup('pericoronal',this)">Pericoronal Triad</div>
      <div class="cmp-gn-btn" onclick="showCmpGroup('apical',this)">Apical &amp; Lateral</div>
      <div class="cmp-gn-btn" onclick="showCmpGroup('special',this)">Special Types</div>
    </div>

    <!-- PERICORONAL GROUP -->
    <div id="cmp-pericoronal" class="cmp-group">
      <div class="cmp-group-intro">
        <strong>DC · OKC · UA</strong> — the three pericoronal radiolucencies you cannot afford to miss. Every clinician has confused at least one. Here's exactly where they diverge.
      </div>
      <div class="cs-row" style="margin-bottom:16px;">
        <div class="cs-btn c1"><div class="cdot c1"></div>Dentigerous Cyst</div>
        <div class="cs-btn c2"><div class="cdot c2"></div>Odontogenic Keratocyst</div>
        <div class="cs-btn c3"><div class="cdot c3"></div>Unicystic Ameloblastoma</div>
      </div>
      <table class="cmp-table">
        <thead><tr><th class="rh">Category</th><th class="c1">Dentigerous Cyst</th><th class="c2">Odontogenic Keratocyst</th><th class="c3">Unicystic Ameloblastoma</th></tr></thead>
        <tbody>
          <tr><td class="rh">Origin</td><td>Reduced enamel epithelium</td><td>Dental lamina remnants</td><td>Reduced enamel epithelium or DC lining</td></tr>
          <tr class="mrow"><td class="rh">Radiographic</td><td><span class="dhi bl">Unilocular</span>, pericoronal, corticated, smooth</td><td>Uni or multilocular, <span class="dhi re">scalloped borders</span>, silent medullary growth</td><td><span class="dhi am">Radiographically identical to DC</span> — the core danger</td></tr>
          <tr><td class="rh">Pericoronal?</td><td><span class="badge lo">Always</span></td><td><span class="badge md">Sometimes</span></td><td><span class="badge hi">Often</span></td></tr>
          <tr class="mrow"><td class="rh">Expansion</td><td>Expands cortex as it grows</td><td><span class="dhi re">Minimal expansion</span> relative to size — grows along medullary</td><td>Mirrors DC — expansion not a distinguisher</td></tr>
          <tr><td class="rh">Epithelial lining</td><td>Non-keratinized, 2–3 layers, flat interface</td><td><span class="dhi re">Parakeratinized</span>, corrugated surface, palisaded basal, satellite cysts</td><td><span class="dhi gr">Palisading columnar cells</span> + reverse nuclear polarity + stellate reticulum</td></tr>
          <tr class="mrow"><td class="rh">Pathognomonic histo</td><td>None — diagnosis by exclusion</td><td>Parakeratinized corrugated surface + <span class="dhi re">daughter cysts</span></td><td><span class="dhi gr">Palisading columnar cells</span> with reverse polarity at CT interface</td></tr>
          <tr><td class="rh">Syndrome link</td><td>None</td><td><span class="dhi re">Gorlin Syndrome — PTCH1</span> (multiple OKCs + BCCs)</td><td>No established link</td></tr>
          <tr class="mrow"><td class="rh">Recurrence</td><td><span class="badge lo">Very Rare</span></td><td><span class="badge hi">30–50% — High</span></td><td><span class="badge md">15–25%</span></td></tr>
          <tr><td class="rh">Treatment</td><td>Enucleation ± marsupialize</td><td>Enucleation + peripheral ostectomy or Carnoy's</td><td>Luminal: enucleation · Mural: <strong>resection</strong></td></tr>
          <tr class="mrow"><td class="rh">The decisive test</td><td>Non-keratinized thin lining on histo. >3–4mm threshold.</td><td><strong>Parakeratinization + satellite cysts</strong>. Cannot diagnose clinically.</td><td><strong>Cannot exclude without biopsy.</strong> Every pericoronal cyst needs histology.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- APICAL/LATERAL GROUP -->
    <div id="cmp-apical" class="cmp-group" style="display:none;">
      <div class="cmp-group-intro">
        <strong>RC · Residual · LPC · Paradental</strong> — four conditions sorted by where they appear relative to the tooth. Vitality and location are the pivot points.
      </div>
      <div class="cs-row" style="margin-bottom:16px;">
        <div class="cs-btn" style="background:var(--red-dim);border:1px solid rgba(255,94,108,.25);color:var(--red);">Radicular Cyst</div>
        <div class="cs-btn" style="background:var(--amber-dim);border:1px solid rgba(240,165,0,.25);color:var(--amber);">Residual Cyst</div>
        <div class="cs-btn" style="background:var(--green-dim);border:1px solid rgba(61,214,140,.25);color:var(--green);">Lat. Periodontal Cyst</div>
        <div class="cs-btn" style="background:rgba(148,97,255,.12);border:1px solid rgba(148,97,255,.25);color:var(--purp);">Paradental Cyst</div>
      </div>
      <table class="cmp-table">
        <thead>
          <tr>
            <th class="rh">Category</th>
            <th style="color:var(--red);">Radicular Cyst</th>
            <th style="color:var(--amber);">Residual Cyst</th>
            <th style="color:var(--green);">Lat. Periodontal Cyst</th>
            <th style="color:var(--purp);">Paradental Cyst</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="rh">Origin</td><td>Inflammatory — pulpal necrosis</td><td>Radicular cyst left after extraction</td><td>Developmental — dental lamina</td><td>Inflammatory — pericoronitis</td></tr>
          <tr class="mrow"><td class="rh">Tooth vital?</td><td><span class="badge hi">No — always non-vital</span></td><td><span class="badge hi">No tooth present</span></td><td><span class="badge lo">Yes — always vital</span></td><td><span class="badge lo">Yes — vital</span></td></tr>
          <tr><td class="rh">Location</td><td><strong>Apex</strong> of non-vital tooth, continuous with PDL</td><td><strong>Edentulous site</strong> — where the tooth used to be</td><td><strong>Lateral root surface</strong>, premolar–canine region</td><td><strong>Buccal/lateral</strong> to partially erupted crown — NOT pericoronal</td></tr>
          <tr class="mrow"><td class="rh">Radiographic</td><td>Round/oval apical RL, well-defined, corticated ≥10mm</td><td>Identical to RC — edentulous site, round, corticated</td><td>Small (&lt;1cm), oval/teardrop, lateral to root midpoint</td><td>Lateral to crown — does not encircle crown (that would be DC)</td></tr>
          <tr><td class="rh">Histopathology</td><td>Non-keratinized epithelium, neutrophils + plasma cells, <span class="dhi re">cholesterol clefts</span>, <span class="dhi re">Rushton bodies</span></td><td>Identical to RC — reduced inflammation (source removed)</td><td>Non-keratinized, <span class="dhi gr">focal epithelial plaques</span> with glycogen-rich clear cells (PAS+)</td><td>Non-keratinized + <span class="dhi" style="color:var(--purp);">prominent inflammatory infiltrate</span></td></tr>
          <tr class="mrow"><td class="rh">Pathognomonic</td><td>Rushton bodies (eosinophilic curved hyaline deposits)</td><td>None — diagnosis by history + location</td><td><span class="dhi gr">Glycogen-rich epithelial plaques</span> (PAS-positive)</td><td>None — diagnosis by location + pericoronitis history</td></tr>
          <tr><td class="rh">Patient demographics</td><td>Adults 30–60, caries or trauma history</td><td>Adults 50–70, denture patients, edentulous</td><td>Adults 40–80, mandibular premolar area</td><td>Adults 20–40 (3rd molar) · Children 5–15 (BBC — 1st molar)</td></tr>
          <tr class="mrow"><td class="rh">Key DDx pivot</td><td>Non-vital tooth + apical location = RC until proven otherwise</td><td>Edentulous + radiolucency = Residual first. Always biopsy — OKC can look identical.</td><td><strong>EPT is decisive</strong>: vital = LPC, non-vital = lateral RC</td><td>Location is decisive: <strong>lateral to crown ≠ pericoronal</strong>. DC encircles.</td></tr>
          <tr><td class="rh">Boards trap</td><td>RC vs granuloma — radiographically identical. Treat same (RCT). Only histo confirms.</td><td><strong>Residual ≠ Recurrent</strong>. Residual = never removed. Recurrent = came back after treatment.</td><td>Botryoid OC = polycystic LPC variant with <span class="badge hi">Higher recurrence</span></td><td><strong>BBC: do NOT extract</strong> — enucleation alone curative. Tooth erupts normally.</td></tr>
          <tr class="mrow"><td class="rh">Treatment</td><td>Root canal therapy first · Apicoectomy if RCT fails</td><td>Enucleation + curettage</td><td>Enucleation + curettage</td><td>Enucleation ± extraction · BBC: enucleation only</td></tr>
        </tbody>
      </table>
    </div>

    <!-- SPECIAL TYPES GROUP -->
    <div id="cmp-special" class="cmp-group" style="display:none;">
      <div class="cmp-group-intro">
        <strong>COC and its spectrum</strong> — the Calcifying Odontogenic Cyst stands alone. Its histologic findings are pathognomonic and its malignant potential is real. Plus: syndrome traps that show up on every board exam.
      </div>
      <table class="cmp-table">
        <thead>
          <tr>
            <th class="rh">Feature</th>
            <th style="color:var(--purp);">Calcifying OC (COC)</th>
            <th style="color:var(--amber);">Dentinogenic Ghost Cell Tumor</th>
            <th style="color:var(--red);">Ghost Cell Odontogenic Carcinoma</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="rh">Nature</td><td>Cystic — benign</td><td>Solid — benign but locally aggressive</td><td>Malignant — rare</td></tr>
          <tr class="mrow"><td class="rh">Ghost cells</td><td>Present — <span class="dhi" style="color:var(--purp);">pathognomonic for the spectrum</span></td><td>Present, more extensive calcification</td><td>Present + cytologic atypia</td></tr>
          <tr><td class="rh">Radiographic</td><td>Unilocular RL with <span class="dhi" style="color:var(--purp);">irregular RO calcifications</span> (late finding)</td><td>Well-defined mixed RL/RO, more RO component</td><td>Aggressive borders, cortical destruction</td></tr>
          <tr class="mrow"><td class="rh">Recurrence</td><td><span class="badge lo">Low — enucleate</span></td><td><span class="badge md">Moderate — aggressive curettage</span></td><td><span class="badge hi">High — resection required</span></td></tr>
          <tr><td class="rh">Treatment</td><td>Enucleation + curettage</td><td>Peripheral ostectomy or marginal resection</td><td>Wide resection ± radiation</td></tr>
        </tbody>
      </table>

      <!-- Syndrome Name Traps -->
      <div style="margin-top:28px;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--tx3);margin-bottom:14px;display:flex;align-items:center;gap:8px;">Syndrome Name Traps <span style="flex:1;height:1px;background:var(--bdr);display:block;"></span></div>
        <table class="cmp-table">
          <thead>
            <tr>
              <th class="rh">Name</th>
              <th style="color:var(--purp);">Gorlin Cyst</th>
              <th style="color:var(--red);">Gorlin Syndrome</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="rh">What it is</td><td>Calcifying Odontogenic Cyst — a specific histologic entity</td><td>Nevoid Basal Cell Carcinoma Syndrome — a PTCH1 germline mutation</td></tr>
            <tr class="mrow"><td class="rh">Jaw lesion type</td><td>COC — ghost cells, mixed RL/RO, usually single</td><td><strong>Multiple OKCs</strong> — NOT COC. Parakeratinized lining.</td></tr>
            <tr><td class="rh">Associated conditions</td><td>Odontoma, AOT, ameloblastoma occasionally</td><td>Multiple BCCs, calcified falx cerebri, palmar pits, bifid ribs</td></tr>
            <tr class="mrow"><td class="rh">The trap</td><td colspan="2" style="color:var(--amber);font-weight:600;">Same eponym. Completely different diseases. The jaw cysts in Gorlin Syndrome are OKCs — not Gorlin Cysts. This is one of the most tested naming confusions on OMFS and oral path boards.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Quick recall table: all 8 by key differentiator -->
      <div style="margin-top:28px;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--tx3);margin-bottom:14px;display:flex;align-items:center;gap:8px;">Module 1 — One-Line Recall <span style="flex:1;height:1px;background:var(--bdr);display:block;"></span></div>
        <table class="cmp-table">
          <thead><tr><th class="rh">Condition</th><th style="color:var(--blue);">The One Thing</th><th>If You Miss It</th></tr></thead>
          <tbody>
            <tr><td class="rh">DC</td><td>Pericoronal &gt;3–4mm + non-vital excluded</td><td>May miss OKC or UA at same site</td></tr>
            <tr class="mrow"><td class="rh">OKC</td><td>Large + minimal expansion. Parakeratinized + satellite cysts.</td><td>30% recurrence if undertreated</td></tr>
            <tr><td class="rh">UA</td><td>Cannot exclude radiographically. <strong>Always biopsy.</strong></td><td>Mural UA requires resection — not repeat enucleation</td></tr>
            <tr class="mrow"><td class="rh">LPC</td><td>Lateral root + <strong>vital EPT</strong> = LPC. Non-vital = lateral RC.</td><td>Treat wrong cyst (RC needs RCT, LPC doesn't)</td></tr>
            <tr><td class="rh">COC</td><td>Ghost cells (eosinophilic anucleate). Mixed RL/RO.</td><td>Mistake for DC or CEOT</td></tr>
            <tr class="mrow"><td class="rh">RC</td><td>Non-vital tooth + apical RL. Granuloma = same treatment.</td><td>Leaving residual cyst post-extraction</td></tr>
            <tr><td class="rh">Residual</td><td>Edentulous site RL. History of extraction without curettage.</td><td>Missing OKC in edentulous site — biopsy all</td></tr>
            <tr class="mrow"><td class="rh">Paradental</td><td>Lateral to crown (not encircling). BBC: preserve the tooth.</td><td>Extracting a tooth that only needed enucleation</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:24px;padding-bottom:40px;">
      <span class="tb-btn" onclick="setMode('study')">← Back to Study</span>
      <span class="tb-btn primary" onclick="setMode('trainer')">🎯 Test Yourself →</span>
    </div>
  </div>`;
}

function showCmpGroup(id, btn){
  document.querySelectorAll('.cmp-group').forEach(g=>g.style.display='none');
  document.getElementById('cmp-'+id).style.display='block';
  document.querySelectorAll('.cmp-gn-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}



/* ════════════ RENDER TRAINER ════════════ */
function xSvg(type){
// ── Panoramic radiograph simulator ─────────────────────────────
// ViewBox: 480×240 — matches curriculum SVG quality & scale

const W=480, H=240;

const defs = `<defs>
  <filter id="sf1" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="1.2"/></filter>
  <filter id="sf2" x="-30%" y="-30%" width="160%" height="160%"><feGaussianBlur stdDeviation="2.8"/></filter>
  <filter id="sf3" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="5"/></filter>
  <filter id="sf4"><feGaussianBlur stdDeviation="0.5"/></filter>
  <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  <linearGradient id="boneGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%"   stop-color="rgba(200,218,245,.0)"/>
    <stop offset="15%"  stop-color="rgba(185,208,238,.26)"/>
    <stop offset="50%"  stop-color="rgba(175,202,235,.18)"/>
    <stop offset="85%"  stop-color="rgba(170,198,232,.22)"/>
    <stop offset="100%" stop-color="rgba(200,218,245,.0)"/>
  </linearGradient>
  <linearGradient id="maxBoneGrad" x1="0" y1="1" x2="0" y2="0">
    <stop offset="0%"   stop-color="rgba(200,218,245,.0)"/>
    <stop offset="15%"  stop-color="rgba(185,208,238,.22)"/>
    <stop offset="50%"  stop-color="rgba(175,202,235,.16)"/>
    <stop offset="100%" stop-color="rgba(200,218,245,.0)"/>
  </linearGradient>
  <radialGradient id="lesionGrad" cx="48%" cy="44%" r="56%">
    <stop offset="0%"   stop-color="rgba(0,2,10,.99)"/>
    <stop offset="60%"  stop-color="rgba(1,3,12,.97)"/>
    <stop offset="100%" stop-color="rgba(3,8,20,.88)"/>
  </radialGradient>
  <radialGradient id="periGrad" cx="50%" cy="42%" r="52%">
    <stop offset="0%"   stop-color="rgba(0,1,8,.99)"/>
    <stop offset="65%"  stop-color="rgba(1,3,13,.97)"/>
    <stop offset="100%" stop-color="rgba(3,7,18,.85)"/>
  </radialGradient>
  <radialGradient id="blueGrad" cx="50%" cy="44%" r="54%">
    <stop offset="0%"   stop-color="rgba(0,2,12,.99)"/>
    <stop offset="70%"  stop-color="rgba(1,4,16,.97)"/>
    <stop offset="100%" stop-color="rgba(4,10,24,.85)"/>
  </radialGradient>
</defs>`;

const bg = `<rect width="${W}" height="${H}" fill="#010306"/>`;

// ── Mandibular bone ─────────────────────────────────────────────
const mandBody = `
  <path d="M24,82 Q70,72 130,68 Q190,64 260,65 Q320,65 370,70 Q410,74 440,82 Q460,90 462,104 Q462,118 454,130 Q444,144 428,152 Q408,160 382,166 Q350,172 314,175 Q278,178 242,176 Q206,172 174,165 Q142,156 118,144 Q94,130 76,114 Q56,96 40,90 Q28,84 24,82Z"
        fill="url(#boneGrad)"/>
  <path d="M24,82 Q70,72 130,68 Q190,64 260,65 Q320,65 370,70 Q410,74 440,82 Q460,90 462,104 Q462,118 454,130 Q444,144 428,152 Q408,160 382,166 Q350,172 314,175 Q278,178 242,176 Q206,172 174,165 Q142,156 118,144 Q94,130 76,114 Q56,96 40,90 Q28,84 24,82Z"
        fill="none" stroke="rgba(195,218,248,.32)" stroke-width="2"/>`;

const alveolar = `<path d="M28,84 Q90,74 160,70 Q230,66 300,68 Q360,69 420,76 Q446,80 460,88"
      fill="none" stroke="rgba(210,230,252,.38)" stroke-width="2.2" stroke-linecap="round"/>`;

const inferiorCortex = `<path d="M76,148 Q130,162 196,170 Q262,178 330,174 Q390,168 432,154 Q450,146 460,134"
      fill="none" stroke="rgba(195,218,248,.30)" stroke-width="2.8" stroke-linecap="round"/>`;

// ── Maxillary bone ──────────────────────────────────────────────
const maxBone = `
  <path d="M28,155 Q70,148 130,142 Q190,136 250,134 Q310,133 370,138 Q420,143 452,152 Q466,158 468,168 Q466,180 454,188 Q434,196 404,202 Q370,208 330,212 Q290,216 250,217 Q210,218 170,215 Q130,210 100,202 Q72,192 50,178 Q32,166 28,155Z"
        fill="url(#maxBoneGrad)"/>
  <path d="M28,155 Q70,148 130,142 Q190,136 250,134 Q310,133 370,138 Q420,143 452,152 Q466,158 468,168"
        fill="none" stroke="rgba(195,218,248,.28)" stroke-width="1.8"/>
  <path d="M50,178 Q72,192 100,202 Q130,210 170,215 Q210,218 250,217 Q290,216 330,212 Q370,208 404,202 Q434,196 454,188 Q466,180 468,168"
        fill="none" stroke="rgba(195,218,248,.22)" stroke-width="1.8"/>`;

// ── Trabecular bone texture ─────────────────────────────────────
function trabeculae(seed, x1, y1, x2, y2, n) {
  let s = seed >>> 0, out = '';
  function r() { s = (Math.imul(s, 1664525) + 1013904223) >>> 0; return s / 4294967295; }
  for (let i = 0; i < n; i++) {
    const x = x1 + r()*(x2-x1), y = y1 + r()*(y2-y1);
    const len = 8 + r()*22, ang = r()*Math.PI;
    const x2e = x + Math.cos(ang)*len, y2e = y + Math.sin(ang)*len;
    const op = (.08 + r()*.18).toFixed(2);
    out += `<line x1="${x.toFixed(1)}" y1="${y.toFixed(1)}" x2="${x2e.toFixed(1)}" y2="${y2e.toFixed(1)}" stroke="rgba(200,222,248,${op})" stroke-width="${(.6+r()*.8).toFixed(1)}" stroke-linecap="round"/>`;
  }
  return out;
}

// ── Tooth helper ────────────────────────────────────────────────
function tooth(cx, crownY, w, crH, rtH, tilt) {
  const t = tilt || 0;
  return `<g transform="rotate(${t},${cx},${crownY+crH/2})">
    <rect x="${cx-w/2}" y="${crownY}" width="${w}" height="${crH}" rx="2.5" fill="rgba(228,240,254,.44)" stroke="rgba(245,252,255,.2)" stroke-width="0.6" filter="url(#sf4)"/>
    <path d="M${cx-w/2+1.5},${crownY+crH} L${cx-w/2+2},${crownY+crH+rtH} L${cx+w/2-2},${crownY+crH+rtH} L${cx+w/2-1.5},${crownY+crH}Z" fill="rgba(190,215,242,.24)" stroke="rgba(200,222,245,.08)" stroke-width="0.5"/>
    <ellipse cx="${cx}" cy="${crownY+crH+rtH}" rx="${w/2-1.5}" ry="2.5" fill="rgba(168,198,234,.12)"/>
  </g>`;
}

// ── Impacted molar ──────────────────────────────────────────────
function impactedMolar(cx, cy, ang) {
  return `<g transform="rotate(${ang},${cx},${cy})">
    <rect x="${cx-12}" y="${cy-20}" width="24" height="20" rx="4" fill="rgba(215,235,252,.30)" stroke="rgba(230,244,255,.14)" stroke-width="0.6"/>
    <line x1="${cx-6}" y1="${cy}" x2="${cx-6}" y2="${cy+2}" stroke="rgba(220,238,254,.15)" stroke-width="0.5"/>
    <line x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy+2}" stroke="rgba(220,238,254,.15)" stroke-width="0.5"/>
    <line x1="${cx+6}" y1="${cy}" x2="${cx+6}" y2="${cy+2}" stroke="rgba(220,238,254,.15)" stroke-width="0.5"/>
    <path d="M${cx-10},${cy} L${cx-9},${cy+28} L${cx+9},${cy+28} L${cx+10},${cy}Z" fill="rgba(185,210,240,.16)"/>
  </g>`;
}

// ── Cortical border helper ──────────────────────────────────────
function cortBorder(pathD, col, glow) {
  return `<path d="${pathD}" fill="none" stroke="${glow||'rgba(2,6,14,.0)'}" stroke-width="10" filter="url(#sf2)"/>
    <path d="${pathD}" fill="none" stroke="${col}" stroke-width="2.2" stroke-linejoin="round"/>`;
}

// ── HUD labels ──────────────────────────────────────────────────
function hud(left, right) {
  return `<rect x="8" y="8" width="${left.length*5.8+16}" height="18" rx="3" fill="rgba(0,0,0,.7)" stroke="rgba(255,255,255,.12)" stroke-width=".8"/>
    <text x="16" y="20" fill="rgba(240,248,255,.75)" font-size="9" font-family="'IBM Plex Mono',monospace" font-weight="700" letter-spacing="1">${left}</text>
    <rect x="${W-right.length*5.8-24}" y="8" width="${right.length*5.8+16}" height="18" rx="3" fill="rgba(0,0,0,.7)" stroke="rgba(255,255,255,.12)" stroke-width=".8"/>
    <text x="${W-right.length*5.8-16}" y="20" fill="rgba(240,248,255,.6)" font-size="9" font-family="'IBM Plex Mono',monospace">${right}</text>`;
}

// ── Diagnostic label bar ────────────────────────────────────────
function diagBar(text) {
  return `<text x="12" y="${H-10}" fill="rgba(255,94,108,.38)" font-size="9.5" font-family="'IBM Plex Mono',monospace">${text}</text>`;
}

// ══════════════════════════════════════════════════════════════
//  CASE SVGs
// ══════════════════════════════════════════════════════════════

// ── DC — pericoronal lucency around impacted #38 ────────────────
if(type==='dc') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const imp = impactedMolar(320,106,-22);
  const lesion = `
    <ellipse cx="320" cy="118" rx="48" ry="34" fill="url(#periGrad)"/>
    <ellipse cx="320" cy="118" rx="48" ry="34" fill="none" stroke="rgba(74,158,255,.08)" stroke-width="12" filter="url(#sf3)"/>`;
  const rim = cortBorder(
    'M272,118 Q276,84 320,74 Q364,64 368,90 Q372,106 368,128 Q364,150 338,162 Q314,170 292,160 Q272,148 272,118',
    'rgba(74,158,255,.72)','rgba(74,158,255,.16)');
  const lamDura = `<path d="M308,74 Q320,70 332,74" fill="none" stroke="rgba(74,158,255,.4)" stroke-width="1.2" stroke-dasharray="3,2"/>`;
  const annot = `
    <circle cx="320" cy="88" r="5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="320" y1="83" x2="320" y2="56" stroke="rgba(240,165,0,.55)" stroke-width="1"/>
    <line x1="320" y1="56" x2="362" y2="46" stroke="rgba(240,165,0,.55)" stroke-width="1"/>
    <text x="366" y="44" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">follicular space</text>
    <circle cx="294" cy="150" r="5" fill="none" stroke="rgba(74,158,255,.82)" stroke-width="1.8"/>
    <line x1="290" y1="154" x2="260" y2="170" stroke="rgba(74,158,255,.55)" stroke-width="1"/>
    <text x="178" y="182" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">corticated border</text>
    <line x1="338" y1="162" x2="360" y2="178" stroke="rgba(74,158,255,.45)" stroke-width="1"/>
    <text x="364" y="180" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">unilocular</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(11,24,74,462,160,48)}${teeth}${imp}${lesion}${rim}${lamDura}${annot}${hud('PANORAMIC · LEFT POSTERIOR MAND.','23F · Routine Pan')}${diagBar('DC · pericoronal · unilocular · well-corticated · #38 impacted')}</svg>`;
}

// ── OKC — large multilocular, ramus extension ───────────────────
if(type==='okc') {
  const teeth = [52,68,84,100,116,132,148].map(x=>tooth(x,72,12,16,36,0)).join('');
  const imp = impactedMolar(368,108,-18);
  const lesion = `
    <path d="M182,72 Q222,50 272,46 Q322,42 364,60 Q400,76 412,106 Q420,132 410,158 Q398,182 368,192 Q334,202 296,196 Q258,188 228,172 Q198,154 182,128 Q166,102 170,84 Q174,76 182,72Z" fill="url(#lesionGrad)"/>
    <path d="M182,72 Q222,50 272,46 Q322,42 364,60 Q400,76 412,106 Q420,132 410,158 Q398,182 368,192 Q334,202 296,196 Q258,188 228,172 Q198,154 182,128 Q166,102 170,84 Q174,76 182,72Z" fill="none" stroke="rgba(255,94,108,.1)" stroke-width="16" filter="url(#sf3)"/>`;
  const rim = `
    <path d="M182,72 Q222,50 272,46 Q322,42 364,60 Q400,76 412,106 Q420,132 410,158 Q398,182 368,192 Q334,202 296,196 Q258,188 228,172 Q198,154 182,128 Q166,102 170,84 Q174,76 182,72Z" fill="none" stroke="rgba(255,94,108,.66)" stroke-width="2.4"/>`;
  const scallop = `
    <path d="M184,74 Q208,58 232,62 Q256,46 280,50 Q304,42 328,52 Q352,56 366,62" fill="none" stroke="rgba(255,94,108,.35)" stroke-width="1.4"/>`;
  const septa = `
    <path d="M240,60 Q246,120 242,178 Q240,190 238,196" fill="none" stroke="rgba(255,94,108,.26)" stroke-width="1.4" stroke-dasharray="5,4"/>
    <path d="M296,48 Q302,112 300,178 Q298,190 296,196" fill="none" stroke="rgba(255,94,108,.24)" stroke-width="1.4" stroke-dasharray="5,4"/>
    <path d="M170,124 Q230,116 296,118 Q352,118 412,114" fill="none" stroke="rgba(255,94,108,.18)" stroke-width="1.2" stroke-dasharray="4,4"/>`;
  const ramusExt = `
    <path d="M402,62 Q422,46 436,58 Q446,72 440,94" fill="none" stroke="rgba(255,94,108,.34)" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="438" y="42" fill="rgba(255,94,108,.55)" font-size="9.5" font-family="'IBM Plex Mono',monospace">ramus</text>`;
  const annot = `
    <circle cx="274" cy="80" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="274" y1="74" x2="296" y2="50" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="300" y="48" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">septum</text>
    <circle cx="330" cy="52" r="5.5" fill="none" stroke="rgba(255,94,108,.82)" stroke-width="1.8"/>
    <line x1="334" y1="48" x2="356" y2="30" stroke="rgba(255,94,108,.58)" stroke-width="1"/>
    <text x="360" y="28" fill="rgba(255,94,108,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">scalloped</text>
    <line x1="182" y1="128" x2="148" y2="112" stroke="rgba(74,158,255,.65)" stroke-width="1"/>
    <text x="32" y="110" fill="rgba(74,158,255,.75)" font-size="9.5" font-family="'IBM Plex Mono',monospace">min. expansion</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(2,24,74,462,164,52)}${teeth}${imp}${lesion}${rim}${scallop}${septa}${ramusExt}${annot}${hud('PANORAMIC · LEFT MANDIBLE + RAMUS','22M · Referred · Family Hx')}${diagBar('OKC · multilocular · scalloped · ramus extension · min. expansion')}</svg>`;
}

// ── UA — pericoronal, mural thickening ──────────────────────────
if(type==='ua') {
  const teeth = [52,68,84,100,116,132,148,164,180,196].map(x=>tooth(x,72,12,16,36,0)).join('');
  const imp = impactedMolar(310,104,-14);
  const lesion = `
    <path d="M262,72 Q286,56 310,52 Q334,48 358,62 Q378,76 382,100 Q386,124 374,144 Q360,162 336,168 Q310,174 286,164 Q262,152 252,130 Q242,108 248,88 Q252,78 262,72Z" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M262,72 Q286,56 310,52 Q334,48 358,62 Q378,76 382,100 Q386,124 374,144 Q360,162 336,168 Q310,174 286,164 Q262,152 252,130 Q242,108 248,88 Q252,78 262,72',
    'rgba(148,97,255,.72)','rgba(148,97,255,.14)');
  const muralThick = `
    <path d="M262,72 Q286,56 310,52 Q334,48 358,62" fill="none" stroke="rgba(148,97,255,.5)" stroke-width="5" filter="url(#sf1)"/>
    <path d="M262,72 Q286,56 310,52 Q334,48 358,62" fill="none" stroke="rgba(148,97,255,.7)" stroke-width="2.4"/>`;
  const annot = `
    <circle cx="310" cy="68" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="310" y1="62" x2="330" y2="42" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="334" y="40" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">mural nodule</text>
    <line x1="300" y1="52" x2="264" y2="36" stroke="rgba(148,97,255,.65)" stroke-width="1"/>
    <text x="148" y="34" fill="rgba(148,97,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">wall thickening</text>
    <line x1="310" y1="174" x2="310" y2="190" stroke="rgba(74,158,255,.5)" stroke-width="1"/>
    <text x="248" y="202" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">unilocular · pericoronal</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(7,24,74,462,164,46)}${teeth}${imp}${lesion}${rim}${muralThick}${annot}${hud('PANORAMIC · RIGHT POSTERIOR MAND.','31F · Pain · Swelling x 3mo')}${diagBar('UA · pericoronal · unilocular · mural thickening · suspect')}</svg>`;
}

// ── LPC — lateral periodontal, premolar region ──────────────────
if(type==='lpc') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,72,12,16,36,0)).join('');
  const lesion = `
    <ellipse cx="174" cy="122" rx="20" ry="28" fill="url(#blueGrad)"/>`;
  const rim = cortBorder(
    'M154,94 Q162,88 174,86 Q186,88 194,94 Q202,104 202,122 Q202,140 194,150 Q186,158 174,160 Q162,158 154,150 Q146,140 146,122 Q146,104 154,94',
    'rgba(74,158,255,.72)','rgba(74,158,255,.14)');
  const lateralPos = `
    <line x1="162" y1="88" x2="162" y2="72" stroke="rgba(74,158,255,.4)" stroke-width="1" stroke-dasharray="3,2"/>
    <line x1="186" y1="88" x2="186" y2="72" stroke="rgba(74,158,255,.4)" stroke-width="1" stroke-dasharray="3,2"/>`;
  const annot = `
    <circle cx="174" cy="102" r="5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="178" y1="98" x2="212" y2="72" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="216" y="70" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">lateral surface</text>
    <line x1="194" y1="140" x2="224" y2="154" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="228" y="156" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">teardrop shape</text>
    <line x1="154" y1="130" x2="118" y2="144" stroke="rgba(61,214,140,.55)" stroke-width="1"/>
    <text x="30" y="146" fill="rgba(61,214,140,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">vital teeth</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(19,24,74,462,164,44)}${teeth}${lesion}${rim}${lateralPos}${annot}${hud('PERIAPICAL · LOWER LEFT PREMOLARS','58M · Asymptomatic · Routine')}${diagBar('LPC · lateral surface · teardrop · vital teeth · 34/35 region')}</svg>`;
}

// ── COC — anterior mandible, calcifications ─────────────────────
if(type==='coc') {
  const teeth = [108,124,140,156,172,188,204,220,236,252,268,284,300].map(x=>tooth(x,72,12,16,36,0)).join('');
  const lesion = `
    <ellipse cx="230" cy="126" rx="54" ry="38" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M176,126 Q178,88 230,78 Q282,68 284,98 Q288,114 284,148 Q280,168 252,178 Q230,184 208,178 Q184,168 178,148 Q174,138 176,126',
    'rgba(240,165,0,.72)','rgba(240,165,0,.16)');
  // Ghost cell calcifications — bright spots within lesion
  const calcs = `
    <circle cx="218" cy="116" r="4.5" fill="rgba(220,235,252,.38)" filter="url(#sf4)"/>
    <circle cx="238" cy="108" r="3.5" fill="rgba(220,235,252,.32)" filter="url(#sf4)"/>
    <circle cx="248" cy="128" r="5" fill="rgba(220,235,252,.42)" filter="url(#sf4)"/>
    <circle cx="224" cy="138" r="3" fill="rgba(220,235,252,.28)" filter="url(#sf4)"/>
    <circle cx="208" cy="126" r="2.5" fill="rgba(220,235,252,.24)" filter="url(#sf4)"/>
    <circle cx="256" cy="116" r="4" fill="rgba(220,235,252,.34)" filter="url(#sf4)"/>
    <circle cx="242" cy="142" r="3.5" fill="rgba(220,235,252,.30)" filter="url(#sf4)"/>`;
  const annot = `
    <circle cx="248" cy="108" r="6" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="252" y1="103" x2="290" y2="74" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="294" y="72" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">calcifications</text>
    <line x1="284" y1="130" x2="320" y2="128" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="324" y="130" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">corticated rim</text>
    <line x1="230" y1="78" x2="230" y2="56" stroke="rgba(61,214,140,.55)" stroke-width="1"/>
    <text x="174" y="54" fill="rgba(61,214,140,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">anterior region</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(33,24,74,462,164,46)}${teeth}${lesion}${rim}${calcs}${annot}${hud('PERIAPICAL · ANTERIOR MANDIBLE','19F · Swelling · Tx referred')}${diagBar('COC · anterior mand · calcifications · mixed density · ghost cells')}</svg>`;
}

// ── RC — periapical, non-vital tooth ────────────────────────────
if(type==='rc') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228].map((x,i)=>tooth(x,72,12,16,36,0)).join('');
  // Non-vital tooth — slightly different shade
  const nvTooth = `<rect x="153" y="72" width="12" height="16" rx="2.5" fill="rgba(200,218,245,.28)" stroke="rgba(230,244,255,.16)" stroke-width="0.6"/>
    <path d="M155,88 L155.5,124 L164.5,124 L165,88Z" fill="rgba(180,205,238,.18)"/>`;
  const lesion = `
    <ellipse cx="160" cy="134" rx="22" ry="18" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M138,134 Q140,116 160,110 Q180,104 182,122 Q184,134 182,148 Q178,162 160,166 Q142,162 138,148 Q136,140 138,134',
    'rgba(255,94,108,.68)','rgba(255,94,108,.14)');
  const rootLines = `
    <line x1="155" y1="124" x2="155" y2="130" stroke="rgba(200,218,245,.25)" stroke-width="0.8"/>
    <line x1="164" y1="124" x2="164" y2="132" stroke="rgba(200,218,245,.2)" stroke-width="0.8"/>`;
  const annot = `
    <circle cx="160" cy="120" r="5.5" fill="none" stroke="rgba(255,94,108,.82)" stroke-width="1.8"/>
    <line x1="164" y1="116" x2="198" y2="90" stroke="rgba(255,94,108,.6)" stroke-width="1"/>
    <text x="202" y="88" fill="rgba(255,94,108,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">periapical</text>
    <line x1="160" y1="72" x2="130" y2="52" stroke="rgba(255,94,108,.5)" stroke-width="1"/>
    <text x="30" y="50" fill="rgba(255,94,108,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">non-vital</text>
    <line x1="182" y1="144" x2="218" y2="152" stroke="rgba(74,158,255,.55)" stroke-width="1"/>
    <text x="222" y="154" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">sclerotic border</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(47,24,74,462,164,44)}${teeth}${nvTooth}${lesion}${rim}${rootLines}${annot}${hud('PERIAPICAL · LOWER LEFT MOLAR','44M · Pain on palpation')}${diagBar('RC · periapical · non-vital · sclerotic border · carious #36')}</svg>`;
}

// ── RES — residual cyst, edentulous ────────────────────────────
if(type==='res') {
  // Edentulous ridge — no teeth in region
  const teeth = [52,68].map(x=>tooth(x,72,12,16,36,0)).join('') +
                [360,376,392,408,424].map(x=>tooth(x,72,10,14,32,0)).join('');
  const alveolarResid = `<path d="M80,72 Q130,76 180,80 Q230,84 280,82 Q330,80 380,74" fill="none" stroke="rgba(195,218,248,.22)" stroke-width="1.8" stroke-dasharray="5,3"/>`;
  const lesion = `
    <ellipse cx="230" cy="118" rx="62" ry="40" fill="url(#lesionGrad)"/>`;
  const rim = cortBorder(
    'M168,118 Q170,78 230,66 Q290,54 292,90 Q296,108 292,140 Q286,166 252,178 Q230,184 208,178 Q178,166 172,140 Q166,130 168,118',
    'rgba(74,158,255,.7)','rgba(74,158,255,.14)');
  const annot = `
    <circle cx="230" cy="82" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="230" y1="76" x2="260" y2="52" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="264" y="50" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">edentulous site</text>
    <line x1="292" y1="120" x2="330" y2="114" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="334" y="116" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">well-defined</text>
    <line x1="230" y1="182" x2="230" y2="198" stroke="rgba(255,94,108,.5)" stroke-width="1"/>
    <text x="156" y="210" fill="rgba(255,94,108,.65)" font-size="9.5" font-family="'IBM Plex Mono',monospace">residual after extraction</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(23,24,74,462,164,42)}${teeth}${alveolarResid}${lesion}${rim}${annot}${hud('PANORAMIC · ANTERIOR MANDIBLE','67M · Denture discomfort')}${diagBar('Residual cyst · edentulous · post-extraction · unilocular')}</svg>`;
}

// ── PARA — paradental, distal #38 ──────────────────────────────
if(type==='para') {
  const teeth = [52,68,84,100,116,132,148,164,180].map(x=>tooth(x,72,12,16,36,0)).join('');
  const imp = impactedMolar(296,100,-8);
  const lesion = `
    <ellipse cx="326" cy="116" rx="32" ry="26" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M294,116 Q296,90 326,84 Q356,78 358,102 Q360,118 356,136 Q350,154 330,160 Q308,162 298,148 Q290,136 294,116',
    'rgba(255,140,0,.72)','rgba(255,140,0,.14)');
  const distalPos = `
    <path d="M296,100 Q310,92 326,90" fill="none" stroke="rgba(255,140,0,.4)" stroke-width="1.2" stroke-dasharray="3,2"/>`;
  const annot = `
    <circle cx="326" cy="92" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="330" y1="88" x2="366" y2="64" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="370" y="62" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">distal aspect</text>
    <line x1="302" y1="148" x2="272" y2="162" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="160" y="174" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">partially erupted</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(37,24,74,462,164,44)}${teeth}${imp}${lesion}${rim}${distalPos}${annot}${hud('PERIAPICAL · LOWER LEFT #38','22M · Pericoronitis hx')}${diagBar('Paradental cyst · distal #38 · partial eruption · inflamed')}</svg>`;
}

// ── RCLAT — lateral radicular, mid-root ────────────────────────
if(type==='rclat') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const nvTooth2 = `<rect x="117" y="72" width="12" height="16" rx="2.5" fill="rgba(195,215,240,.26)" stroke="rgba(225,240,255,.14)" stroke-width="0.6"/>
    <path d="M119,88 L119.5,128 L128.5,128 L129,88Z" fill="rgba(178,205,235,.16)"/>`;
  const latCanal = `<line x1="123" y1="108" x2="114" y2="108" stroke="rgba(255,94,108,.35)" stroke-width="1.5" stroke-dasharray="2,1.5"/>`;
  const lesion = `<ellipse cx="106" cy="112" rx="18" ry="16" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M88,112 Q90,96 106,92 Q122,88 124,104 Q126,114 122,128 Q118,142 106,146 Q94,142 88,128 Q84,120 88,112',
    'rgba(255,94,108,.68)','rgba(255,94,108,.12)');
  const annot = `
    <circle cx="114" cy="108" r="5" fill="none" stroke="rgba(255,94,108,.82)" stroke-width="1.8"/>
    <line x1="112" y1="104" x2="90" y2="80" stroke="rgba(255,94,108,.6)" stroke-width="1"/>
    <text x="20" y="78" fill="rgba(255,94,108,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">lateral canal</text>
    <line x1="88" y1="122" x2="62" y2="134" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="10" y="146" fill="rgba(240,165,0,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">mid-root</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(53,24,74,462,164,42)}${teeth}${nvTooth2}${latCanal}${lesion}${rim}${annot}${hud('PERIAPICAL · LOWER LEFT PREMOLAR','38F · Asymptomatic')}${diagBar('RC lateral variant · mid-root · lateral canal · non-vital')}</svg>`;
}

// ── BBC — buccal bifurcation ────────────────────────────────────
if(type==='bbc') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const lesion = `<ellipse cx="164" cy="106" rx="22" ry="20" fill="url(#blueGrad)"/>`;
  const rim = cortBorder(
    'M142,106 Q144,86 164,80 Q184,74 186,94 Q188,108 184,122 Q178,138 164,142 Q150,138 144,122 Q140,114 142,106',
    'rgba(74,158,255,.7)','rgba(74,158,255,.14)');
  const buccalPos = `
    <path d="M152,80 Q164,76 176,80" fill="none" stroke="rgba(74,158,255,.4)" stroke-width="1.2"/>`;
  const intact = `
    <path d="M152,106 Q164,100 176,106" fill="none" stroke="rgba(61,214,140,.5)" stroke-width="1.2"/>`;
  const annot = `
    <circle cx="164" cy="86" r="5.5" fill="none" stroke="rgba(74,158,255,.82)" stroke-width="1.8"/>
    <line x1="168" y1="82" x2="200" y2="58" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="204" y="56" fill="rgba(74,158,255,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">buccal bifurcation</text>
    <line x1="164" y1="142" x2="164" y2="158" stroke="rgba(61,214,140,.55)" stroke-width="1"/>
    <text x="94" y="170" fill="rgba(61,214,140,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">intact lamina dura</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(61,24,74,462,164,42)}${teeth}${lesion}${rim}${buccalPos}${intact}${annot}${hud('PERIAPICAL · LOWER LEFT MOLAR','9M · Asymptomatic · Routine')}${diagBar('BBC · buccal furcation · intact lamina dura · vital tooth')}</svg>`;
}

// ── DC ANT — anterior maxillary DC ─────────────────────────────
if(type==='dc_ant') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240].map(x=>tooth(x,142,12,14,32,0)).join('');
  const imp = impactedMolar(200,128,12);
  const lesion = `<ellipse cx="200" cy="114" rx="38" ry="26" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M162,114 Q164,88 200,80 Q236,72 238,100 Q240,114 236,136 Q230,156 200,162 Q170,156 164,136 Q160,126 162,114',
    'rgba(74,158,255,.7)','rgba(74,158,255,.14)');
  const annot = `
    <circle cx="200" cy="90" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="200" y1="84" x2="230" y2="58" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="234" y="56" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">follicular origin</text>
    <text x="140" y="210" fill="rgba(74,158,255,.55)" font-size="9.5" font-family="'IBM Plex Mono',monospace">DC · ant. max · #23 impacted</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(13,24,120,462,220,44)}${maxTeeth}${imp}${lesion}${rim}${annot}${hud('PERIAPICAL · ANTERIOR MAXILLA','15F · Retained canine')}${diagBar('DC · anterior maxilla · impacted canine · unilocular')}</svg>`;
}

// ── OKC UNI — small unilocular OKC ─────────────────────────────
if(type==='okc_uni') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const imp = impactedMolar(260,96,-10);
  const lesion = `<ellipse cx="260" cy="110" rx="38" ry="28" fill="url(#lesionGrad)"/>`;
  const rim = `
    <path d="M222,110 Q224,82 260,72 Q296,62 298,90 Q302,108 296,132 Q290,154 260,160 Q230,156 224,132 Q220,122 222,110Z" fill="none" stroke="rgba(255,94,108,.08)" stroke-width="14" filter="url(#sf3)"/>
    <path d="M222,110 Q224,82 260,72 Q296,62 298,90 Q302,108 296,132 Q290,154 260,160 Q230,156 224,132 Q220,122 222,110Z" fill="none" stroke="rgba(255,94,108,.68)" stroke-width="2.2"/>`;
  const annot = `
    <circle cx="260" cy="80" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="264" y1="76" x2="296" y2="52" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="300" y="50" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">thin cortex</text>
    <line x1="224" y1="118" x2="190" y2="110" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="70" y="112" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">unilocular</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(29,24,74,462,164,46)}${teeth}${imp}${lesion}${rim}${annot}${hud('PANORAMIC · RIGHT POSTERIOR MAND.','19M · Incidental finding')}${diagBar('OKC unilocular · pericoronal · thin cortex · early presentation')}</svg>`;
}

// ── COC ANT — anterior mandible COC ────────────────────────────
if(type==='coc_ant') {
  const teeth = [108,124,140,156,172,188,204,220,236,252].map(x=>tooth(x,72,12,16,36,0)).join('');
  const lesion = `<ellipse cx="196" cy="118" rx="46" ry="36" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M150,118 Q152,82 196,72 Q240,62 242,96 Q244,112 240,144 Q234,168 196,176 Q158,168 152,144 Q148,132 150,118',
    'rgba(240,165,0,.7)','rgba(240,165,0,.14)');
  const calcs2 = `
    <circle cx="186" cy="108" r="4" fill="rgba(220,235,252,.36)" filter="url(#sf4)"/>
    <circle cx="202" cy="100" r="3" fill="rgba(220,235,252,.28)" filter="url(#sf4)"/>
    <circle cx="214" cy="116" r="4.5" fill="rgba(220,235,252,.40)" filter="url(#sf4)"/>
    <circle cx="196" cy="128" r="3.5" fill="rgba(220,235,252,.32)" filter="url(#sf4)"/>
    <circle cx="176" cy="122" r="3" fill="rgba(220,235,252,.26)" filter="url(#sf4)"/>`;
  const annot = `
    <circle cx="214" cy="100" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="218" y1="96" x2="250" y2="68" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="254" y="66" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">calcifications</text>
    <line x1="150" y1="130" x2="112" y2="130" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="20" y="132" fill="rgba(74,158,255,.82)" font-size="10" font-family="'IBM Plex Mono',monospace">cortex intact</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(41,24,74,462,164,44)}${teeth}${lesion}${rim}${calcs2}${annot}${hud('PERIAPICAL · ANTERIOR MANDIBLE','24F · Swelling noted')}${diagBar('COC · anterior mand · ghost cell calc · mixed density')}</svg>`;
}

// ── RC MAX — maxillary periapical ──────────────────────────────
if(type==='rc_max') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240,256,272].map(x=>tooth(x,138,10,14,30,0)).join('');
  const nvMax = `<rect x="149" y="138" width="10" height="14" rx="2" fill="rgba(195,215,240,.24)" stroke="rgba(220,238,255,.12)" stroke-width="0.5"/>
    <path d="M151,152 L151.5,182 L158.5,182 L159,152Z" fill="rgba(175,205,235,.14)"/>`;
  const lesion = `<ellipse cx="155" cy="192" rx="22" ry="16" fill="url(#periGrad)"/>`;
  const rim = cortBorder(
    'M133,192 Q135,176 155,170 Q175,164 177,180 Q179,192 175,206 Q170,220 155,224 Q140,220 134,206 Q131,200 133,192',
    'rgba(255,94,108,.68)','rgba(255,94,108,.12)');
  const sinus = `
    <path d="M80,100 Q130,88 180,86 Q230,84 280,90 Q320,96 340,108" fill="none" stroke="rgba(195,218,248,.16)" stroke-width="1.4" stroke-dasharray="5,4"/>
    <text x="288" y="84" fill="rgba(195,218,248,.3)" font-size="8.5" font-family="'IBM Plex Mono',monospace">sinus floor</text>`;
  const annot = `
    <circle cx="155" cy="180" r="5.5" fill="none" stroke="rgba(255,94,108,.82)" stroke-width="1.8"/>
    <line x1="158" y1="176" x2="192" y2="152" stroke="rgba(255,94,108,.6)" stroke-width="1"/>
    <text x="196" y="150" fill="rgba(255,94,108,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">periapical</text>
    <line x1="135" y1="200" x2="104" y2="210" stroke="rgba(74,158,255,.55)" stroke-width="1"/>
    <text x="8" y="222" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">maxillary anterior</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(71,24,120,462,220,44)}${maxTeeth}${nvMax}${sinus}${lesion}${rim}${annot}${hud('PERIAPICAL · UPPER LEFT CENTRAL','44M · Referred · Trauma hx')}${diagBar('RC · maxillary anterior · periapical · non-vital · trauma hx')}</svg>`;
}


// ── MODULE 2 SVGs — inject into xSvg function ──────────────────────────────
// These are the additional case types referenced by CASES_M2

// NPDC Recognition — anterior maxilla midline radiolucency
if(type==='npdc_rec') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240,256,272].map(x=>tooth(x,138,10,14,30,0)).join('');
  const lesion = `<ellipse cx="200" cy="182" rx="28" ry="22" fill="url(#blueGrad)"/>`;
  const rim = cortBorder('M172,182 Q174,160 200,152 Q226,144 228,168 Q230,180 226,200 Q220,216 200,220 Q180,216 174,200 Q170,190 172,182','rgba(74,158,255,.72)','rgba(74,158,255,.14)');
  const midline = `<line x1="200" y1="140" x2="200" y2="225" stroke="rgba(74,158,255,.2)" stroke-width="1" stroke-dasharray="4,3"/>`;
  const annot = `
    <circle cx="200" cy="160" r="5.5" fill="none" stroke="rgba(240,165,0,.82)" stroke-width="1.8"/>
    <line x1="204" y1="156" x2="240" y2="132" stroke="rgba(240,165,0,.6)" stroke-width="1"/>
    <text x="244" y="130" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">incisive canal</text>
    <text x="122" y="130" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">vital centrals</text>
    <line x1="174" y1="192" x2="140" y2="200" stroke="rgba(74,158,255,.55)" stroke-width="1"/>
    <text x="40" y="202" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">midline position</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(13,24,120,462,220,44)}${maxTeeth}${midline}${lesion}${rim}${annot}${hud('PERIAPICAL · ANTERIOR MAXILLA','47M · Asymptomatic · Routine')}${diagBar('NPDC · midline · incisive canal · vital centrals · 9mm')}</svg>`;
}

// NPDC RC Trap — non-vital central with midline lucency
if(type==='npdc_rc_trap') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240,256,272].map(x=>tooth(x,138,10,14,30,0)).join('');
  const nvCentral = `<rect x="193" y="138" width="10" height="14" rx="2" fill="rgba(190,210,238,.24)" stroke="rgba(215,235,252,.12)" stroke-width="0.5"/>
    <path d="M195,152 L195.5,186 L202.5,186 L203,152Z" fill="rgba(172,202,232,.14)"/>`;
  const lesion = `<ellipse cx="200" cy="196" rx="26" ry="18" fill="url(#periGrad)"/>`;
  const rim = cortBorder('M174,196 Q176,178 200,170 Q224,162 226,180 Q228,196 222,208 Q216,220 200,224 Q184,220 176,208 Q172,204 174,196','rgba(255,94,108,.68)','rgba(255,94,108,.12)');
  const annot = `
    <text x="122" y="130" fill="rgba(255,94,108,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">non-vital left central</text>
    <line x1="195" y1="138" x2="160" y2="128" stroke="rgba(255,94,108,.5)" stroke-width="1"/>
    <line x1="222" y1="192" x2="258" y2="184" stroke="rgba(74,158,255,.6)" stroke-width="1"/>
    <text x="262" y="186" fill="rgba(74,158,255,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">periapical RC</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(17,24,120,462,220,44)}${maxTeeth}${nvCentral}${lesion}${rim}${annot}${hud('PERIAPICAL · ANTERIOR MAXILLA','38F · Post-Trauma')}${diagBar('RC (not NPDC) · non-vital left central · trauma hx · periapical')}</svg>`;
}

// Nasolabial Cyst — soft tissue only, no bone lesion shown (normal X-ray depicted)
if(type==='nla_rec') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240,256,272].map(x=>tooth(x,138,10,14,30,0)).join('');
  // All teeth present, no radiolucency — shows normal bone
  const normalBone = `<text x="120" y="40" fill="rgba(61,214,140,.6)" font-size="10" font-family="'IBM Plex Mono',monospace" font-weight="700">PANORAMIC: WITHIN NORMAL LIMITS</text>`;
  const annot = `
    <rect x="20" y="50" width="200" height="52" rx="6" fill="rgba(0,0,0,.5)" stroke="rgba(61,214,140,.4)" stroke-width="1.2"/>
    <text x="120" y="67" text-anchor="middle" fill="rgba(61,214,140,.88)" font-size="10" font-family="'IBM Plex Mono',monospace" font-weight="700">No bone lesion identified</text>
    <text x="120" y="82" text-anchor="middle" fill="rgba(61,214,140,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">Nasolabial cyst is soft</text>
    <text x="120" y="94" text-anchor="middle" fill="rgba(61,214,140,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">tissue only — no X-ray finding</text>`;
  const softTissueIndicator = `
    <ellipse cx="155" cy="168" rx="20" ry="14" fill="rgba(168,85,247,.15)" stroke="rgba(168,85,247,.5)" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="155" y="196" text-anchor="middle" fill="rgba(168,85,247,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">soft tissue only</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(21,24,120,462,220,44)}${maxTeeth}${annot}${softTissueIndicator}${hud('PANORAMIC · ANTERIOR MAXILLA','44F · Left Nasal Base Swelling')}${diagBar('NASOLABIAL CYST · soft tissue only · normal bone · no radiolucency')}</svg>`;
}

// Nasolabial Trap — RC at lateral incisor + nasal base swelling
if(type==='nla_trap') {
  const maxTeeth = [80,96,112,128,144,160,176,192,208,224,240,256,272].map(x=>tooth(x,138,10,14,30,0)).join('');
  const nvLateral = `<rect x="145" y="138" width="9" height="12" rx="2" fill="rgba(190,210,238,.22)" stroke="rgba(215,235,252,.1)" stroke-width="0.5"/>
    <path d="M147,150 L147.5,182 L153.5,182 L154,150Z" fill="rgba(172,202,232,.12)"/>`;
  const rcLesion = `<ellipse cx="150" cy="192" rx="22" ry="16" fill="url(#periGrad)"/>`;
  const rcRim = cortBorder('M128,192 Q130,176 150,168 Q170,160 172,178 Q174,190 170,204 Q164,218 150,222 Q136,218 128,204 Q124,200 128,192','rgba(255,94,108,.68)','rgba(255,94,108,.12)');
  const annot = `
    <circle cx="150" cy="178" r="5" fill="none" stroke="rgba(255,94,108,.82)" stroke-width="1.8"/>
    <line x1="154" y1="174" x2="190" y2="150" stroke="rgba(255,94,108,.6)" stroke-width="1"/>
    <text x="194" y="148" fill="rgba(255,94,108,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">RC — non-vital lat. incisor</text>
    <rect x="300" y="60" width="140" height="32" rx="4" fill="rgba(0,0,0,.6)" stroke="rgba(168,85,247,.4)" stroke-width="1"/>
    <text x="370" y="74" text-anchor="middle" fill="rgba(168,85,247,.8)" font-size="9" font-family="'IBM Plex Mono',monospace" font-weight="700">+CT: soft tissue nasal</text>
    <text x="370" y="86" text-anchor="middle" fill="rgba(168,85,247,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">ala density (separate)</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${maxBone}${trabeculae(25,24,120,462,220,44)}${maxTeeth}${nvLateral}${rcLesion}${rcRim}${annot}${hud('PERIAPICAL · ANTERIOR MAXILLA','51F · Nasal Pain')}${diagBar('RC lateral incisor + separate nasolabial soft tissue density')}</svg>`;
}

// Dermoid/Epidermoid — floor of mouth, sublingual (submental presentation)
if(type==='derm_rec') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,72,12,16,36,0)).join('');
  const axial = `
    <rect x="20" y="20" width="200" height="130" rx="8" fill="rgba(0,0,0,.6)" stroke="rgba(240,165,0,.35)" stroke-width="1.2"/>
    <text x="120" y="36" text-anchor="middle" fill="rgba(240,165,0,.7)" font-size="8.5" font-family="'IBM Plex Mono',monospace">AXIAL MRI (T1)</text>
    <ellipse cx="120" cy="100" rx="55" ry="38" fill="rgba(0,0,0,.9)" stroke="rgba(200,222,248,.25)" stroke-width="1.5"/>
    <ellipse cx="120" cy="100" rx="45" ry="30" fill="rgba(180,150,80,.45)"/>
    <text x="120" y="102" text-anchor="middle" fill="rgba(240,165,0,.9)" font-size="9" font-family="'IBM Plex Mono',monospace" font-weight="700">sebaceous content</text>
    <text x="120" y="114" text-anchor="middle" fill="rgba(240,165,0,.7)" font-size="8" font-family="'IBM Plex Mono',monospace">T1 hyperintense</text>`;
  const annot = `
    <text x="300" y="50" fill="rgba(240,165,0,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">MRI confirms dermoid contents</text>
    <line x1="240" y1="80" x2="260" y2="70" stroke="rgba(240,165,0,.5)" stroke-width="1"/>
    <text x="260" y="90" fill="rgba(61,214,140,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">midline floor of mouth</text>
    <text x="260" y="105" fill="rgba(61,214,140,.65)" font-size="9" font-family="'IBM Plex Mono',monospace">doughy palpation</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(31,24,74,462,164,42)}${teeth}${axial}${annot}${hud('MRI T1 · FLOOR OF MOUTH','22M · Midline Mass')}${diagBar('Dermoid cyst · midline floor of mouth · T1 hyperintense sebaceous content')}</svg>`;
}

// Dermoid Trap — below mylohyoid, submental
if(type==='derm_trap') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,72,12,16,36,0)).join('');
  const mriPanel = `
    <rect x="20" y="15" width="200" height="130" rx="8" fill="rgba(0,0,0,.65)" stroke="rgba(168,85,247,.35)" stroke-width="1.2"/>
    <text x="120" y="32" text-anchor="middle" fill="rgba(168,85,247,.7)" font-size="8.5" font-family="'IBM Plex Mono',monospace">SAGITTAL MRI</text>
    <path d="M60,100 Q80,80 120,78 Q160,76 180,100 L180,125 Q160,140 120,142 Q80,140 60,125Z" fill="rgba(0,0,0,.9)" stroke="rgba(200,222,248,.2)" stroke-width="1"/>
    <path d="M75,105 Q95,92 120,90 Q145,88 165,105 L165,120 Q145,132 120,134 Q95,132 75,120Z" fill="rgba(160,130,70,.4)"/>
    <line x1="120" y1="95" x2="120" y2="130" stroke="rgba(168,85,247,.5)" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="120" y="74" text-anchor="middle" fill="rgba(168,85,247,.6)" font-size="8" font-family="'IBM Plex Mono',monospace">below mylohyoid</text>`;
  const annot = `
    <text x="260" y="50" fill="rgba(168,85,247,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">Submental dermoid</text>
    <text x="260" y="64" fill="rgba(168,85,247,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">Below mylohyoid → external approach</text>
    <text x="260" y="90" fill="rgba(61,214,140,.72)" font-size="9.5" font-family="'IBM Plex Mono',monospace">Does NOT move with swallowing</text>
    <text x="260" y="104" fill="rgba(61,214,140,.65)" font-size="9" font-family="'IBM Plex Mono',monospace">→ excludes TDC</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(35,24,74,462,164,42)}${teeth}${mriPanel}${annot}${hud('SAGITTAL MRI · SUBMENTAL REGION','28F · Visible Neck Mass')}${diagBar('Dermoid · below mylohyoid · submental · no TDC movement · external approach')}</svg>`;
}

// Thyroglossal Duct Cyst — midline neck, hyoid level
if(type==='thyro_rec') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,52,10,14,30,0)).join('');
  // Schematic midline neck with hyoid and cyst
  const hyoid = `<path d="M174,148 Q196,138 240,134 Q284,138 306,148" fill="none" stroke="rgba(195,218,248,.45)" stroke-width="4" stroke-linecap="round"/>`;
  const hyoidLabel = `<text x="240" y="130" text-anchor="middle" fill="rgba(195,218,248,.5)" font-size="8" font-family="'IBM Plex Mono',monospace">hyoid bone</text>`;
  const tdc = `<ellipse cx="240" cy="158" rx="38" ry="28" fill="url(#blueGrad)"/>`;
  const tdcRim = cortBorder('M202,158 Q204,130 240,120 Q276,110 278,140 Q280,158 274,178 Q266,196 240,200 Q214,196 206,178 Q200,168 202,158','rgba(74,158,255,.7)','rgba(74,158,255,.14)');
  const movementArrow = `
    <line x1="240" y1="118" x2="240" y2="95" stroke="rgba(61,214,140,.8)" stroke-width="2.5" marker-end="url(#arr_up)"/>
    <defs><marker id="arr_up" markerWidth="8" markerHeight="8" refX="4" refY="8" orient="auto"><path d="M0,8 L4,0 L8,8Z" fill="rgba(61,214,140,.8)"/></marker></defs>
    <text x="260" y="100" fill="rgba(61,214,140,.88)" font-size="10" font-family="'IBM Plex Mono',monospace">moves up ↑</text>
    <text x="260" y="113" fill="rgba(61,214,140,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">with tongue protrusion</text>`;
  const tractLine = `<line x1="240" y1="60" x2="240" y2="120" stroke="rgba(74,158,255,.35)" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="280" y="82" fill="rgba(74,158,255,.55)" font-size="9" font-family="'IBM Plex Mono',monospace">duct to foramen cecum</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(43,24,54,462,144,36)}${teeth}${hyoid}${hyoidLabel}${tdc}${tdcRim}${tractLine}${movementArrow}${hud('CLINICAL SCHEMATIC · MIDLINE NECK','9M · Midline Mass')}${diagBar('TDC · midline · hyoid level · moves with tongue protrusion · pathognomonic')}</svg>`;
}

// TDC Trap — ectopic thyroid scenario
if(type==='thyro_trap') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,52,10,14,30,0)).join('');
  const hyoid = `<path d="M174,148 Q196,138 240,134 Q284,138 306,148" fill="none" stroke="rgba(195,218,248,.45)" stroke-width="4" stroke-linecap="round"/>`;
  const tdc = `<ellipse cx="240" cy="158" rx="38" ry="28" fill="url(#periGrad)"/>`;
  const tdcRim = cortBorder('M202,158 Q204,130 240,120 Q276,110 278,140 Q280,158 274,178 Q266,196 240,200 Q214,196 206,178 Q200,168 202,158','rgba(148,97,255,.7)','rgba(148,97,255,.14)');
  const noThyroidBox = `
    <rect x="20" y="20" width="175" height="62" rx="6" fill="rgba(220,38,38,.15)" stroke="rgba(220,38,38,.5)" stroke-width="1.5"/>
    <text x="107" y="36" text-anchor="middle" fill="rgba(220,38,38,.9)" font-size="10" font-family="'IBM Plex Mono',monospace" font-weight="700">⚠ ULTRASOUND</text>
    <text x="107" y="50" text-anchor="middle" fill="rgba(255,94,108,.85)" font-size="9" font-family="'IBM Plex Mono',monospace">No normal thyroid found</text>
    <text x="107" y="64" text-anchor="middle" fill="rgba(255,94,108,.8)" font-size="9" font-family="'IBM Plex Mono',monospace">Thyroid signal: inside TDC</text>`;
  const warningText = `
    <text x="300" y="50" fill="rgba(255,94,108,.88)" font-size="9.5" font-family="'IBM Plex Mono',monospace" font-weight="700">DO NOT EXCISE</text>
    <text x="300" y="64" fill="rgba(255,94,108,.75)" font-size="9" font-family="'IBM Plex Mono',monospace">without endocrinology</text>
    <text x="300" y="78" fill="rgba(255,94,108,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">1% — ectopic thyroid only</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(47,24,54,462,144,36)}${teeth}${hyoid}${tdc}${tdcRim}${noThyroidBox}${warningText}${hud('ULTRASOUND · MIDLINE NECK','14F · Pre-op Sistrunk')}${diagBar('TDC + ectopic thyroid — only thyroid present — DO NOT excise without endocrinology')}</svg>`;
}

// Stafne Bone Defect — below IAN canal
if(type==='staf_rec') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const ianCanal = `<path d="M50,128 Q150,122 260,118 Q360,116 420,120" fill="none" stroke="rgba(255,255,128,.55)" stroke-width="2.5" stroke-linecap="round"/>
    <text x="380" y="112" fill="rgba(255,255,128,.55)" font-size="8.5" font-family="'IBM Plex Mono',monospace">IAN canal</text>`;
  // Stafne is BELOW the IAN line
  const lesion = `<ellipse cx="320" cy="155" rx="40" ry="28" fill="url(#blueGrad)"/>`;
  const rim = cortBorder('M280,155 Q282,127 320,118 Q358,109 360,138 Q362,155 356,172 Q348,188 320,192 Q292,188 284,172 Q278,162 280,155','rgba(74,158,255,.7)','rgba(74,158,255,.14)');
  const belowArrow = `
    <line x1="280" y1="128" x2="280" y2="118" stroke="rgba(255,255,128,.6)" stroke-width="1.5"/>
    <line x1="280" y1="138" x2="280" y2="148" stroke="rgba(255,255,128,.6)" stroke-width="1.5"/>
    <text x="170" y="148" fill="rgba(255,255,128,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">BELOW IAN →</text>`;
  const mriBox = `
    <rect x="380" y="140" width="80" height="36" rx="4" fill="rgba(0,0,0,.6)" stroke="rgba(74,158,255,.4)" stroke-width="1"/>
    <text x="420" y="155" text-anchor="middle" fill="rgba(74,158,255,.82)" font-size="8.5" font-family="'IBM Plex Mono',monospace">MRI: salivary</text>
    <text x="420" y="168" text-anchor="middle" fill="rgba(74,158,255,.7)" font-size="8.5" font-family="'IBM Plex Mono',monospace">T1 signal ✓</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(51,24,74,462,164,44)}${teeth}${ianCanal}${lesion}${rim}${belowArrow}${mriBox}${hud('PANORAMIC · RIGHT POSTERIOR MAND.','58M · Routine Panoramic')}${diagBar('Stafne bone defect · BELOW IAN canal · static · salivary contents · no Tx')}</svg>`;
}

// Stafne Trap — ambiguous IAN position, CT clarifies
if(type==='staf_trap') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212].map(x=>tooth(x,72,12,16,36,0)).join('');
  const ianCanal = `<path d="M50,128 Q150,122 260,118 Q360,116 420,120" fill="none" stroke="rgba(255,255,128,.55)" stroke-width="2.5" stroke-linecap="round"/>
    <text x="380" y="112" fill="rgba(255,255,128,.55)" font-size="8.5" font-family="'IBM Plex Mono',monospace">IAN canal</text>`;
  const lesion = `<ellipse cx="280" cy="125" rx="42" ry="30" fill="url(#lesionGrad)"/>`;
  const rim = cortBorder('M238,125 Q240,95 280,86 Q320,77 322,107 Q324,125 318,144 Q310,162 280,166 Q250,162 242,144 Q236,134 238,125','rgba(240,165,0,.7)','rgba(240,165,0,.14)');
  const ambiguous = `
    <rect x="30" y="20" width="160" height="36" rx="4" fill="rgba(240,165,0,.15)" stroke="rgba(240,165,0,.5)" stroke-width="1.2"/>
    <text x="110" y="34" text-anchor="middle" fill="rgba(240,165,0,.88)" font-size="9" font-family="'IBM Plex Mono',monospace" font-weight="700">IAN relationship</text>
    <text x="110" y="48" text-anchor="middle" fill="rgba(240,165,0,.7)" font-size="8.5" font-family="'IBM Plex Mono',monospace">AMBIGUOUS on panoramic</text>`;
  const ctResult = `
    <rect x="355" y="140" width="105" height="44" rx="4" fill="rgba(0,0,0,.65)" stroke="rgba(74,158,255,.4)" stroke-width="1"/>
    <text x="407" y="155" text-anchor="middle" fill="rgba(74,158,255,.82)" font-size="8.5" font-family="'IBM Plex Mono',monospace" font-weight="700">CT: lingual defect</text>
    <text x="407" y="167" text-anchor="middle" fill="rgba(74,158,255,.72)" font-size="8" font-family="'IBM Plex Mono',monospace">below IAN confirmed</text>
    <text x="407" y="179" text-anchor="middle" fill="rgba(61,214,140,.72)" font-size="8" font-family="'IBM Plex Mono',monospace">Stafne → no biopsy</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(55,24,74,462,164,44)}${teeth}${ianCanal}${lesion}${rim}${ambiguous}${ctResult}${hud('PANORAMIC · LEFT POST. MAND.','52F · Jaw Pain')}${diagBar('Stafne · ambiguous IAN on pano → CT confirms below IAN → no biopsy')}</svg>`;
}

// Lymphoepithelial Cyst — oral type, floor of mouth, yellow nodule
if(type==='lymp_rec') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,72,12,16,36,0)).join('');
  const normalBoneMsg = `
    <rect x="20" y="20" width="200" height="52" rx="6" fill="rgba(0,0,0,.5)" stroke="rgba(61,214,140,.4)" stroke-width="1.2"/>
    <text x="120" y="37" text-anchor="middle" fill="rgba(61,214,140,.88)" font-size="10" font-family="'IBM Plex Mono',monospace" font-weight="700">PANORAMIC: NORMAL</text>
    <text x="120" y="52" text-anchor="middle" fill="rgba(61,214,140,.7)" font-size="9" font-family="'IBM Plex Mono',monospace">No bone lesion — soft tissue</text>
    <text x="120" y="64" text-anchor="middle" fill="rgba(61,214,140,.65)" font-size="9" font-family="'IBM Plex Mono',monospace">cyst is floor of mouth only</text>`;
  const cystDot = `
    <ellipse cx="240" cy="148" rx="18" ry="12" fill="rgba(255,220,100,.25)" stroke="rgba(255,220,100,.7)" stroke-width="1.8" stroke-dasharray="4,3"/>
    <text x="240" y="170" text-anchor="middle" fill="rgba(255,220,100,.82)" font-size="9" font-family="'IBM Plex Mono',monospace">yellow nodule</text>
    <text x="240" y="182" text-anchor="middle" fill="rgba(255,220,100,.65)" font-size="8.5" font-family="'IBM Plex Mono',monospace">floor of mouth / ventral tongue</text>`;
  const histoBox = `
    <rect x="300" y="55" width="155" height="74" rx="5" fill="rgba(0,0,0,.6)" stroke="rgba(168,85,247,.4)" stroke-width="1"/>
    <text x="377" y="71" text-anchor="middle" fill="rgba(168,85,247,.82)" font-size="9" font-family="'IBM Plex Mono',monospace" font-weight="700">HISTOLOGY KEY</text>
    <text x="377" y="85" text-anchor="middle" fill="rgba(195,218,248,.75)" font-size="8.5" font-family="'IBM Plex Mono',monospace">Squamous lining</text>
    <text x="377" y="98" text-anchor="middle" fill="rgba(168,85,247,.8)" font-size="8.5" font-family="'IBM Plex Mono',monospace" font-weight="700">Lymphoid follicles in wall</text>
    <text x="377" y="111" text-anchor="middle" fill="rgba(61,214,140,.7)" font-size="8" font-family="'IBM Plex Mono',monospace">= pathognomonic</text>
    <text x="377" y="124" text-anchor="middle" fill="rgba(195,218,248,.6)" font-size="8" font-family="'IBM Plex Mono',monospace">No skin appendages</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(59,24,74,462,164,42)}${teeth}${normalBoneMsg}${cystDot}${histoBox}${hud('CLINICAL · FLOOR OF MOUTH','34M · Incidental Yellow Nodule')}${diagBar('Lymphoepithelial cyst · soft tissue · floor of mouth · normal X-ray · lymphoid wall')}</svg>`;
}

// Lymphoepithelial Trap — cervical type vs. metastatic neck node (young adult)
if(type==='lymp_trap') {
  const teeth = [52,68,84,100,116,132,148,164,180,196,212,228,244].map(x=>tooth(x,52,10,14,30,0)).join('');
  // Neck schematic - lateral cyst
  const neckmass = `<ellipse cx="340" cy="148" rx="48" ry="36" fill="url(#blueGrad)"/>`;
  const neckmassRim = cortBorder('M292,148 Q294,112 340,100 Q386,88 388,124 Q390,148 382,172 Q372,196 340,202 Q308,196 298,172 Q290,158 292,148','rgba(74,158,255,.68)','rgba(74,158,255,.14)');
  const scmLabel = `
    <path d="M280,80 Q290,100 300,130 Q310,160 315,190" fill="none" stroke="rgba(195,218,248,.3)" stroke-width="3" stroke-linecap="round"/>
    <text x="260" y="76" fill="rgba(195,218,248,.45)" font-size="8.5" font-family="'IBM Plex Mono',monospace">SCM</text>`;
  const fnaBox = `
    <rect x="20" y="20" width="175" height="68" rx="5" fill="rgba(0,0,0,.6)" stroke="rgba(240,165,0,.45)" stroke-width="1.2"/>
    <text x="107" y="36" text-anchor="middle" fill="rgba(240,165,0,.88)" font-size="9.5" font-family="'IBM Plex Mono',monospace" font-weight="700">FNA FIRST</text>
    <text x="107" y="50" text-anchor="middle" fill="rgba(195,218,248,.75)" font-size="8.5" font-family="'IBM Plex Mono',monospace">Cystic squamous cells</text>
    <text x="107" y="63" text-anchor="middle" fill="rgba(168,85,247,.8)" font-size="8.5" font-family="'IBM Plex Mono',monospace">+ lymphoid background</text>
    <text x="107" y="76" text-anchor="middle" fill="rgba(61,214,140,.72)" font-size="8" font-family="'IBM Plex Mono',monospace">→ benign LEC confirmed</text>`;
  const trapLabel = `
    <text x="340" y="84" text-anchor="middle" fill="rgba(255,94,108,.88)" font-size="9.5" font-family="'IBM Plex Mono',monospace" font-weight="700">DDx: SCC met? Lymphoma?</text>
    <text x="340" y="97" text-anchor="middle" fill="rgba(255,94,108,.7)" font-size="8.5" font-family="'IBM Plex Mono',monospace">Young adult lateral neck mass</text>
    <text x="340" y="110" text-anchor="middle" fill="rgba(255,94,108,.65)" font-size="8" font-family="'IBM Plex Mono',monospace">→ FNA before excision</text>`;
  return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(63,24,54,462,144,36)}${teeth}${scmLabel}${neckmass}${neckmassRim}${fnaBox}${trapLabel}${hud('CLINICAL · LATERAL NECK','26M · Soft Lateral Neck Mass')}${diagBar('LEC cervical · lateral neck · FNA first · exclude SCC met + lymphoma before excision')}</svg>`;
}

// ── Fallback ────────────────────────────────────────────────────
return `<svg class="xray-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${defs}${bg}${mandBody}${alveolar}${inferiorCortex}${trabeculae(0,24,74,462,164,42)}</svg>`;
}



// Case metadata: type + condition label
const CASE_META = {
  1:  {type:'recognition', cond:'Dentigerous Cyst',        label:'DC'},
  2:  {type:'recognition', cond:'Odontogenic Keratocyst',  label:'OKC'},
  3:  {type:'trap',        cond:'Unicystic Ameloblastoma', label:'UA'},
  4:  {type:'trap',        cond:'Dentigerous Cyst',        label:'DC'},
  5:  {type:'trap',        cond:'OKC',                     label:'OKC'},
  6:  {type:'trap',        cond:'OKC Recurrence',          label:'OKC'},
  7:  {type:'recognition', cond:'Unicystic Ameloblastoma', label:'UA'},
  8:  {type:'recognition', cond:'Lateral Periodontal Cyst',label:'LPC'},
  9:  {type:'trap',        cond:'LPC vs. Lat. Radicular',  label:'LPC'},
  10: {type:'recognition', cond:'Calcifying OC',           label:'COC'},
  11: {type:'trap',        cond:'Gorlin Cyst vs. Gorlin Syndrome', label:'COC'},
  12: {type:'recognition', cond:'Radicular Cyst',          label:'RC'},
  13: {type:'recognition', cond:'Residual Cyst',           label:'RC'},
  14: {type:'recognition', cond:'Paradental Cyst',         label:'Para'},
  15: {type:'trap',        cond:'Paradental vs. DC',       label:'Para'},
  16: {type:'pediatric',   cond:'Buccal Bifurcation Cyst', label:'BBC'},
};


// ══════════════════════════════════════════════════════════════════════════
//  MODULE 2 — NON-ODONTOGENIC CYSTS
//  6 conditions · Full parity with Module 1
//  npc = Nasopalatine Duct, nla = Nasolabial, derm = Dermoid/Epidermoid,
//  lymp = Lymphoepithelial, thyro = Thyroglossal, staf = Stafne Bone Defect
// ══════════════════════════════════════════════════════════════════════════

CONDITIONS['npc'] = {
  id:'npc', ey:'Pathology · Non-Odontogenic Cysts · 1 of 6',
  title:'Nasopalatine Duct Cyst', aka:'Incisive Canal Cyst · NPDC',
  tags:[{l:'Most Common Non-OG Cyst',c:'blue'},{l:'Midline Maxilla',c:'slate'},{l:'Boards High-Yield',c:'amber'}],
  summary:'The <strong>most common non-odontogenic cyst</strong> of the oral cavity, arising from remnants of the nasopalatine duct in the incisive canal. Located in the <strong>midline anterior maxilla</strong>. Classic imaging: <strong>heart-shaped radiolucency</strong> between the maxillary central incisors — with both adjacent teeth vital. Cannot be diagnosed from imaging alone when small; must exceed 6mm or show growth to warrant biopsy over observation.',
  fp:[{k:'Aggressiveness',v:15,t:'lo',l:'Low'},{k:'Recurrence',v:18,t:'lo',l:'Low'},{k:'Commonality',v:85,t:'hi',l:'Most Common Non-OG'},{k:'Boards Freq.',v:90,t:'hi',l:'Very High'},{k:'Tx Complexity',v:20,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Clinical Presentation',sub:'Demographics · Location · Symptoms',cards:[
      {lbl:'👤 Demographics',items:['Peak: <em>40–60 years</em>','<strong>Male > Female</strong> (2:1)','All races, no ethnic predilection','Rare in children — development completes by adolescence']},
      {lbl:'📍 Location',items:['<strong>Midline anterior maxilla</strong> — incisive canal','Between maxillary central incisors','Extends posteriorly along incisive canal','May have intraoral component (incisive papilla swelling)']},
      {lbl:'🔍 Symptoms',items:['<strong>Usually asymptomatic</strong> — incidental find','Anterior palatal swelling if large','Characteristic <em>salty taste</em> if draining','Pressure or fullness if large','Nasal symptoms — rare, very large cysts']},
    ]},
    {n:'02',title:'Radiographic Presentation',sub:'Panoramic · Periapical · The Critical Threshold',cards:[
      {lbl:'🔲 Features',items:['<strong>Heart-shaped (inverted)</strong> radiolucency — classic','Located between central incisors at midline','Well-defined, corticated borders','Incisive canal widened if large','Adjacent teeth vital — essential DDx point']},
      {lbl:'📏 Size Interpretation',items:['<em>< 6mm</em> — may be normal incisive fossa, observe','<em>≥ 6mm</em> — significant; NPDC likely','Growth on serial imaging → biopsy regardless of size','Corticated sclerotic border = slow chronic growth','CBCT shows posterior canal extension']},
    ],hls:[
      {cls:'amber',lbl:'⚡ The 6mm Rule',txt:'Incisive fossa diameter normally up to <strong>6mm</strong>. Below this with vital teeth and no growth = observe. Above 6mm or enlarging = NPDC until biopsied. This single measurement drives the biopsy vs. watch decision.'},
      {cls:'red',lbl:'⚠️ Heart Shape Is NOT Specific',txt:'The "heart shape" is caused by the anterior nasal spine superimposing on the radiolucency — it is a <strong>projection artifact</strong>, not a true lesion shape. Not every NPDC is heart-shaped. Rely on location and vitality, not shape alone.'},
    ]},
    {n:'03',title:'Histopathology',sub:'Epithelial Lining · Variants · Pitfalls',cards:[
      {lbl:'🧫 Lining — Variable',items:['<strong>No single consistent epithelium</strong>','Stratified squamous, pseudostratified columnar, cuboidal — all possible','Mixed lining in one cyst is common','Reflects dual origin from duct remnants']},
      {lbl:'🧱 Wall Contents',items:['Mucous glands in wall — characteristic','<em>Neurovascular bundle</em> — nasopalatine nerve/vessels in wall','Cartilage remnants — occasionally','Inflammatory infiltrate if secondary infection']},
    ],hls:[{cls:'green',lbl:'🔑 Pathognomonic Finding',txt:'<strong>Neurovascular bundle in the cyst wall</strong> = NPDC. No other jaw cyst has nerve and vessel elements in the fibrous wall as a routine finding. This is the histologic tell when the lining is ambiguous.',full:true}]},
    {n:'04',title:'Differential Diagnosis',sub:'Click to exclude',ddx:[
      {name:'Periapical Granuloma/Cyst',key:'RC: non-vital tooth, located at apex — NPDC: vital teeth, midline, NOT apical. Always EPT both centrals.'},
      {name:'Lateral Incisor Agenesis Space',key:'Developmental — no cystic lining, no corticated border. Absent tooth on examination confirms.'},
      {name:'Median Palatine Cyst',key:'Truly rare — located further posteriorly. No true distinction from posterior NPDC by imaging alone.'},
      {name:'Adenomatoid Odontogenic Tumor',key:'AOT: pericoronal, anterior maxilla often with canine, duct-like structures histologically — not midline incisive canal.'},
      {name:'Globulomaxillary Cyst',key:'Previously described between lateral incisor and canine — now recognized as a positional description, not a distinct entity. Usually OKC or LPC in that location.'},
    ]},
    {n:'05',title:'Management',sub:'Surgery · Prognosis · Follow-Up',cards:[
      {lbl:'🔪 Surgical',items:['<strong>Enucleation via palatal approach</strong>','Preserve nasopalatine nerve if possible','Large cysts: may require tooth extraction if root displacement is severe','Marsupialization for very large cysts — rare']},
      {lbl:'📋 Prognosis',items:['<strong>Recurrence: low (< 11%)</strong>','Most recurrences from incomplete removal','Annual radiographic follow-up × 2 years','Malignant transformation: not documented']},
    ]},
  ],
  pearls:[
    {s:'dark',lbl:'Pearl #1 — Vitality is the decisive test',txt:'Both adjacent central incisors must respond to pulp testing before calling NPDC. A <strong>non-vital central = periapical cyst</strong> until proven otherwise. The entire diagnosis pivots on this one test.'},
    {s:'amber',lbl:'Pearl #2 — 6mm threshold',txt:'<strong>Under 6mm + vital teeth + no growth = observe.</strong> You don\'t biopsy every incisive fossa finding. Over 6mm, growing, or symptomatic — biopsy. This threshold prevents unnecessary surgery and missed diagnoses equally.'},
    {s:'blue',lbl:'Pearl #3 — Neurovascular bundle',txt:'On histology, a <strong>nasopalatine nerve or vessel in the cyst wall</strong> is pathognomonic. No other odontogenic or non-odontogenic jaw cyst contains this structure as a normal finding.'},
  ],
  mnem:{word:'N · P · D · C',lines:[
    {l:'N',r:'asopalatine duct remnants — developmental, not inflammatory'},
    {l:'P',r:'apilla/palatal midline — always in the incisive canal'},
    {l:'D',r:'iameter threshold — >6mm or growing = biopsy'},
    {l:'C',r:'entral incisors vital — if non-vital, think radicular cyst first'},
  ]},
  syns:[
    {cls:'blue',ico:'🔵',title:'Incisive Papilla Cyst — Extraosseous Variant',txt:'When the NPDC extends into the soft tissue of the incisive papilla, it presents as a <strong>bluish dome-shaped palatal swelling</strong> — the extraosseous or incisive papilla cyst. Same histology, no intraosseous component. Treated by simple surgical excision.'},
  ],
  next:[{id:'nla',ico:'🟣',title:'Nasolabial Cyst',sub:'Soft tissue only — no bone involvement'},{id:'derm',ico:'🟡',title:'Dermoid/Epidermoid Cyst',sub:'Keratinized lining — floor of mouth classic'}],
};

CONDITIONS['nla'] = {
  id:'nla', ey:'Pathology · Non-Odontogenic Cysts · 2 of 6',
  title:'Nasolabial Cyst', aka:'Nasoalveolar Cyst · Klestadt Cyst',
  tags:[{l:'Soft Tissue Only',c:'green'},{l:'No Bone Involvement',c:'blue'},{l:'Nasal Ala Location',c:'slate'}],
  summary:'A rare <strong>fissural cyst of the soft tissue</strong> — unique among jaw cysts because it causes <strong>no intraosseous radiolucency</strong>. Arises from entrapped epithelium at the junction of the nasal process during embryogenesis. Located at the base of the nasal ala, lifting the nasolabial fold and causing nasal floor elevation. Diagnosed clinically and confirmed histologically after excision. Boards key: <strong>no radiographic finding</strong>.',
  fp:[{k:'Aggressiveness',v:12,t:'lo',l:'Very Low'},{k:'Recurrence',v:12,t:'lo',l:'Low'},{k:'Commonality',v:20,t:'lo',l:'Rare'},{k:'Boards Freq.',v:60,t:'md',l:'Moderate'},{k:'Tx Complexity',v:18,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Clinical Presentation',sub:'Demographics · Location · How It Presents',cards:[
      {lbl:'👤 Demographics',items:['Peak: <em>4th–5th decade</em>','<strong>Female > Male</strong> (3:1)','More common in African Americans','Rare overall — < 0.7% of jaw cysts','Bilateral in ~10% of cases']},
      {lbl:'📍 Location',items:['Base of the <strong>nasal ala</strong> — nasolabial fold','Elevates nasal floor on clinical exam','Lateral to midline — not median','Vestibular fullness at lateral incisor–canine region']},
      {lbl:'🔍 Symptoms',items:['<strong>Fullness or fluctuant swelling</strong> at nasal base','Obliteration of the nasolabial fold','Nasal obstruction if large','Rarely painful unless infected','Swelling is soft, fluctuant, transilluminates']},
    ]},
    {n:'02',title:'Radiographic',sub:'The Critical Point — No Bone Lesion',cards:[
      {lbl:'📡 Imaging',items:['<strong>No intraosseous radiolucency</strong> — strictly soft tissue','Panoramic: normal','Periapical: normal','CT/MRI: soft tissue mass at nasal ala','May cause shallow pressure cupping of the underlying bone on CT']},
    ],hls:[{cls:'red',lbl:'🚨 The Boards Trap',txt:'<strong>Nasolabial cyst has no radiographic finding on panoramic or periapical.</strong> A clinical swelling at the nasal base with a completely normal X-ray = nasolabial cyst until proven otherwise. If you order imaging expecting to find a radiolucency, you will miss it.',full:true}]},
    {n:'03',title:'Histopathology',sub:'Lining · Wall',cards:[
      {lbl:'🔬 Microscopic',items:['<strong>Non-keratinized stratified squamous epithelium</strong>','Pseudostratified ciliated columnar (respiratory) epithelium — common','Mucous goblet cells in lining — characteristic','Fibrous wall, minimal inflammation unless infected','No odontogenic epithelium — confirms non-odontogenic']},
    ]},
    {n:'04',title:'DDx',sub:'What it mimics',ddx:[
      {name:'Periapical Granuloma/Cyst',key:'RC: bony lucency at apex of non-vital tooth — nasolabial: normal X-ray, vital teeth, soft tissue only'},
      {name:'Nasopalatine Duct Cyst',key:'NPDC: intraosseous, midline incisive canal — nasolabial: soft tissue, lateral, no bone involvement'},
      {name:'Mucocele (Vestibular)',key:'Mucocele: salivary gland origin, burst easily, more superficial — nasolabial: deeper, fissural, firmer'},
      {name:'Facial Space Abscess',key:'Abscess: hot, tender, erythema, systemic signs — nasolabial cyst: cold, non-tender, chronic course'},
    ]},
    {n:'05',title:'Management',sub:'Treatment · Prognosis',cards:[
      {lbl:'🔪 Treatment',items:['<strong>Surgical excision — sublabial approach</strong>','Complete excision = cure','Large cysts: marsupialization then excision','No adjunct therapy needed']},
      {lbl:'📋 Prognosis',items:['Excellent — recurrence rare with complete removal','No malignant transformation documented','Clinical follow-up only — no radiographic surveillance needed']},
    ]},
  ],
  pearls:[
    {s:'red',lbl:'Pearl #1 — Normal X-ray is the clue',txt:'<strong>Nasolabial cyst is a soft tissue diagnosis with a normal radiograph.</strong> When a patient has a swelling at the nasal base and a normal panoramic, the imaging result isn\'t a failure — it\'s the diagnosis. Soft tissue cysts don\'t show on bone films.'},
    {s:'blue',lbl:'Pearl #2 — Respiratory lining is distinctive',txt:'The presence of <strong>pseudostratified ciliated columnar epithelium (respiratory type)</strong> in a jaw/facial cyst points directly to nasolabial origin — confirming its embryologic fissural origin from the alar-maxillary junction.'},
    {s:'amber',lbl:'Pearl #3 — It\'s lateral, not midline',txt:'Students confuse this with NPDC. <strong>Nasolabial = lateral (nasal ala). NPDC = midline (incisive canal).</strong> The anatomic distinction prevents misdiagnosis — NPDC is intraosseous; nasolabial is purely soft tissue.'},
  ],
  mnem:{word:'N · L · A',lines:[
    {l:'N',r:'o bone involvement — normal X-ray is characteristic'},
    {l:'L',r:'ateral position — nasal ala, not midline incisive canal'},
    {l:'A',r:'la elevates — nasolabial fold obliteration is the clinical sign'},
  ]},
  syns:[],
  next:[{id:'npc',ico:'💙',title:'Nasopalatine Duct Cyst',sub:'Intraosseous, midline — the contrast'},{id:'derm',ico:'🟡',title:'Dermoid/Epidermoid Cyst',sub:'Keratinized lining, floor of mouth'}],
};

CONDITIONS['derm'] = {
  id:'derm', ey:'Pathology · Non-Odontogenic Cysts · 3 of 6',
  title:'Dermoid / Epidermoid Cyst', aka:'Dermoid Cyst · Epidermoid Cyst',
  tags:[{l:'Keratinized Lining',c:'amber'},{l:'Floor of Mouth',c:'blue'},{l:'Doughy Mass',c:'slate'}],
  summary:'Developmental cysts of the floor of mouth arising from <strong>entrapped epithelium during embryogenesis</strong>. Two histologic variants with different contents: <strong>Epidermoid</strong> (squamous lining only, keratin debris), and <strong>Dermoid</strong> (squamous lining + skin appendages — hair follicles, sebaceous glands, sweat glands). Both present as a midline floor-of-mouth mass. Classic dermoid: <strong>"doughy"</strong> on palpation from sebaceous content. Teratoid is the third, rarest variant.',
  fp:[{k:'Aggressiveness',v:12,t:'lo',l:'Very Low'},{k:'Recurrence',v:14,t:'lo',l:'Low'},{k:'Commonality',v:22,t:'lo',l:'Uncommon'},{k:'Boards Freq.',v:68,t:'hi',l:'High'},{k:'Tx Complexity',v:28,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Clinical Presentation',sub:'Demographics · Location · Palpation',cards:[
      {lbl:'👤 Demographics',items:['Young adults — teens to 30s most common','No strong sex predilection','May be present since birth — slow-growing','Congenital or acquired via trauma']},
      {lbl:'📍 Location',items:['<strong>Midline floor of mouth</strong>','Sublingual (above mylohyoid) or submental (below)','Sublingual: pushes tongue up, intraoral swelling','Submental: visible neck mass below chin']},
      {lbl:'🔍 Symptoms',items:['<strong>Slow-growing, painless midline mass</strong>','Sublingual: difficulty eating, speaking if large','Submental: cosmetic neck swelling','<em>Doughy or "putty-like"</em> palpation — sebaceous content','Transillumination: negative (thick contents)']},
    ]},
    {n:'02',title:'Three Variants',sub:'Epidermoid · Dermoid · Teratoid',cards:[
      {lbl:'📋 Epidermoid',items:['Keratinized squamous epithelium only','No skin appendages in wall','Contents: white keratin debris ("cottage cheese")','Most common variant','Boards: squamous + keratin only = epidermoid']},
      {lbl:'💛 Dermoid (True)',items:['Keratinized squamous epithelium + <strong>skin appendages</strong>','Hair follicles, sebaceous glands, sweat glands in wall','Contents: sebaceous/keratinous material + hair','<em>"Doughy"</em> or greasy on palpation','Boards: appendages in wall = dermoid']},
      {lbl:'🔬 Teratoid (Rare)',items:['All three germ layers represented','Ectodermal + mesodermal + endodermal elements','Contains muscle, bone, or respiratory mucosa','Extremely rare — surgical curiosity','Boards: tri-laminar = teratoid']},
    ],hls:[{cls:'amber',lbl:'🔑 The Defining Feature',txt:'<strong>Skin appendages (hair follicles, sebaceous glands) in the cyst wall = true Dermoid.</strong> Epidermoid has keratinized lining only — no appendages. Teratoid has all three germ layers. The wall contents make the diagnosis, not the lining alone.',full:true}]},
    {n:'03',title:'Histopathology',sub:'Lining · Wall · Contents',cards:[
      {lbl:'🔬 Epidermoid',items:['Stratified squamous epithelium — <strong>keratinized</strong>','No skin appendages','Lumen: laminated keratin debris','PAS negative — no glycogen','Fibrous wall — thin, no inflammation typically']},
      {lbl:'🔬 Dermoid',items:['Stratified squamous epithelium — keratinized','<strong>Skin appendages in wall: sebaceous glands, hair follicles</strong>','Lumen: sebaceous material + keratin + hair shafts','Wall often shows foreign body reaction to keratin']},
    ]},
    {n:'04',title:'DDx',sub:'What it mimics',ddx:[
      {name:'Ranula (Simple)',key:'Ranula: salivary origin (sublingual gland duct obstruction), bluish, transilluminates, rapidly enlarging — dermoid: doughy, slow-growing, no blue tinge'},
      {name:'Thyroglossal Duct Cyst',key:'TDC: midline neck, moves with swallowing or tongue protrusion, embryonic thyroid tract — dermoid/epidermoid: floor of mouth, no movement with swallowing'},
      {name:'Lymphoepithelial Cyst',key:'LEC: soft, fluctuant, lateral floor of mouth or tonsillar/parotid — dermoid: midline, doughy, keratinized lining without lymphoid tissue'},
      {name:'Ludwig\'s Angina',key:'Ludwig\'s: acute, board-like floor, febrile, rapidly expanding — dermoid: chronic, soft, afebrile, slow growth'},
    ]},
    {n:'05',title:'Management',sub:'Treatment · Prognosis',cards:[
      {lbl:'🔪 Treatment',items:['<strong>Surgical excision — intraoral or extraoral</strong>','Sublingual: intraoral approach','Submental: external approach','Complete removal including capsule','Marsupialization not recommended — contents are thick, won\'t drain']},
      {lbl:'📋 Prognosis',items:['Excellent — recurrence rare','Malignant transformation: not documented for epidermoid/dermoid','Teratoid: extremely rare malignant transformation documented','Follow-up: clinical exam only']},
    ]},
  ],
  pearls:[
    {s:'amber',lbl:'Pearl #1 — Skin appendages make the diagnosis',txt:'<strong>Hair follicles or sebaceous glands in the cyst wall = true Dermoid Cyst.</strong> Epidermoid has keratinized squamous lining only — no appendages. The difference is in the wall, not the epithelium. Both present identically clinically.'},
    {s:'blue',lbl:'Pearl #2 — Doughy palpation is the clinical tell',txt:'The sebaceous content of a dermoid gives it a characteristic <strong>"doughy" or putty-like"</strong> palpation quality — it indents and holds the indentation briefly. Ranulas feel fluctuant and spring back. Dermoids don\'t.'},
    {s:'dark',lbl:'Pearl #3 — Submental vs. sublingual',txt:'<strong>If above the mylohyoid → sublingual (intraoral swelling).</strong> If below the mylohyoid → submental (neck swelling). This anatomic relationship determines the surgical approach and how the patient presents clinically.'},
  ],
  mnem:{word:'D · E · R · M',lines:[
    {l:'D',r:'oughy palpation — sebaceous content is the clinical tip-off'},
    {l:'E',r:'pidermoid = squamous lining only (no appendages) — simpler variant'},
    {l:'R',r:'emoval = excision — marsupialization won\'t work, contents too thick'},
    {l:'M',r:'ylohyoid muscle — above it = sublingual, below = submental'},
  ]},
  syns:[{cls:'amber',ico:'🟡',title:'Teratoid Cyst — The Third Variant',txt:'The rarest form. Contains elements from all three embryonic germ layers. May contain respiratory mucosa, muscle, or even bone within the cyst wall. Extremely uncommon. Same surgical approach — complete excision. Documented (very rare) potential for malignant transformation distinguishes it from the other two variants.'}],
  next:[{id:'lymp',ico:'🟤',title:'Lymphoepithelial Cyst',sub:'Lateral — lymphoid follicles in wall'},{id:'thyro',ico:'💚',title:'Thyroglossal Duct Cyst',sub:'Neck midline — moves with swallowing'}],
};

CONDITIONS['lymp'] = {
  id:'lymp', ey:'Pathology · Non-Odontogenic Cysts · 4 of 6',
  title:'Lymphoepithelial Cyst', aka:'Oral Lymphoepithelial Cyst · Branchial Cleft Cyst (cervical)',
  tags:[{l:'Lymphoid Tissue in Wall',c:'purp'},{l:'Floor of Mouth',c:'blue'},{l:'Lateral Neck Variant',c:'slate'}],
  summary:'Cysts with a <strong>stratified squamous epithelial lining surrounded by lymphoid tissue</strong>. Two distinct anatomic forms: <strong>Oral</strong> (floor of mouth, ventral tongue, soft palate — small, yellow, asymptomatic) and <strong>Cervical</strong> (lateral neck from branchial cleft remnants — pulsatile mass, associated with SCM). The lymphoid tissue in the wall is the histologic signature. Cervical type is boards-critical for neck mass DDx in young adults.',
  fp:[{k:'Aggressiveness',v:10,t:'lo',l:'None'},{k:'Recurrence',v:14,t:'lo',l:'Low'},{k:'Commonality',v:30,t:'lo',l:'Uncommon'},{k:'Boards Freq.',v:62,t:'md',l:'Moderate'},{k:'Tx Complexity',v:22,t:'lo',l:'Low'}],
  sections:[
    {n:'01',title:'Two Forms — One Entity',sub:'Oral · Cervical (Branchial)',cards:[
      {lbl:'💛 Oral Type',items:['Small (< 1cm), yellow-white submucosal nodule','Floor of mouth, ventral tongue, soft palate','Asymptomatic — incidental finding','Multiple lesions in same patient common','Often in HIV/immunosuppressed patients (parotid type)']},
      {lbl:'🔵 Cervical Type (Branchial Cleft Cyst)',items:['<strong>Lateral neck mass</strong> — anterior border of SCM','Second branchial cleft most common origin','Young adults 20–40 — slow-growing lateral neck mass','May have a fistula opening at skin','Fluctuant, soft, transilluminates']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'Oral · Cervical',cards:[
      {lbl:'🦷 Oral LEC',items:['Soft, smooth, yellow-white nodule','Often < 0.5cm','Asymptomatic — found on routine exam','Floor of mouth and soft palate most common','Can be HIV-associated (parotid location more common in HIV)']},
      {lbl:'🔵 Cervical LEC',items:['Lateral neck mass — anterior to SCM','Soft, mobile, fluctuant','Slow-growing — months to years','May enlarge with upper respiratory infections','Rarely: fistula with skin opening (2nd branchial fistula)']},
    ]},
    {n:'03',title:'Histopathology',sub:'Lining · Lymphoid Follicles · The Defining Feature',cards:[
      {lbl:'🔬 Microscopic',items:['<strong>Stratified squamous epithelium</strong> lining','Wall: <strong>lymphoid tissue with germinal centers</strong> — pathognomonic','Keratinous debris may fill lumen','Cholesterol clefts from old debris — occasional','No salivary tissue (unlike Warthin tumor)']},
    ],hls:[{cls:'purp',lbl:'🔑 The Wall Defines It',txt:'<strong>Lymphoid follicles with germinal centers in the cyst wall</strong> = Lymphoepithelial Cyst. No other oral or cervical cyst has organized lymphoid tissue as a defining wall feature. This distinguishes it from dermoid (skin appendages) and Warthin tumor (salivary parenchyma + lymphoid stroma).',full:true}]},
    {n:'04',title:'DDx',sub:'What it mimics',ddx:[
      {name:'Warthin Tumor (Parotid)',key:'Warthin: parotid, bilateral in 10%, oncocytic bilayered epithelium + lymphoid stroma — LEC: oral mucosa or lateral neck, not parotid parenchyma'},
      {name:'Dermoid/Epidermoid',key:'Dermoid: midline floor of mouth, keratinized, doughy — LEC: lateral location, lymphoid wall, no skin appendages'},
      {name:'Thyroglossal Duct Cyst',key:'TDC: midline neck, moves with swallowing, thyroid tissue — LEC: lateral neck, no movement, no thyroid tissue'},
      {name:'Lymphoma (Cervical)',key:'Lymphoma: firm, rubbery, painless lateral neck nodes, B symptoms — cervical LEC: soft/fluctuant, cystic on imaging, chronic course'},
    ]},
    {n:'05',title:'Management',sub:'Treatment · Prognosis',cards:[
      {lbl:'🔪 Treatment',items:['<strong>Oral LEC: simple excision if symptomatic</strong>','Often left untreated if asymptomatic and small','Cervical LEC: formal surgical excision','Complete removal including capsule — prevents recurrence','No adjunct therapy needed']},
      {lbl:'📋 Prognosis',items:['Excellent for both types','Recurrence: low with complete excision','No malignant transformation documented','Cervical: fistula repair if present at time of excision']},
    ]},
  ],
  pearls:[
    {s:'purp',lbl:'Pearl #1 — Lymphoid follicles are pathognomonic',txt:'<strong>Germinal centers in the cyst wall</strong> = Lymphoepithelial Cyst. This is the one finding that separates LEC from every other cyst in the head and neck. Nothing else has organized lymphoid tissue as a defining wall component — not dermoid, not NPDC, not ranula.'},
    {s:'blue',lbl:'Pearl #2 — Cervical LEC in young adults = branchial cleft',txt:'A <strong>lateral neck mass in a young adult (20-40), soft, fluctuant, anterior to the SCM</strong> = branchial cleft cyst (cervical LEC) until proven otherwise. This is a classic boards setup. The DDx is lymphoma — which is firm, not fluctuant, and CT-confirmed cystic.'},
    {s:'amber',lbl:'Pearl #3 — HIV and parotid LEC',txt:'In HIV-positive patients, <strong>bilateral parotid cystic masses = HIV-associated lymphoepithelial lesion</strong>. This is a distinct but related entity. Multiple parotid cysts in an HIV patient are a clinical marker of immunosuppression. Not common boards content but clinically important.'},
  ],
  mnem:{word:'L · E · C',lines:[
    {l:'L',r:'ymphoid follicles in the wall — the defining histologic feature'},
    {l:'E',r:'pithelium is squamous — but wall lymphoid tissue is the tell'},
    {l:'C',r:'ervical type = branchial cleft — lateral to SCM in young adults'},
  ]},
  syns:[{cls:'blue',ico:'🔵',title:'Cervical Lymphoepithelial Cyst — Branchial Cleft',txt:'The cervical variant arises from entrapped epithelium in cervical lymph nodes from branchial cleft remnants. Most common at the angle of the jaw or anterior SCM border. Second branchial cleft is the most common origin. Complete surgical excision with identification of the tract (if fistula is present) is the treatment. Recurrence is low.'}],
  next:[{id:'thyro',ico:'💚',title:'Thyroglossal Duct Cyst',sub:'Midline neck — moves with swallowing'},{id:'staf',ico:'⚫',title:'Stafne Bone Defect',sub:'Not a cyst — the most important pseudo-cyst'}],
};

CONDITIONS['thyro'] = {
  id:'thyro', ey:'Pathology · Non-Odontogenic Cysts · 5 of 6',
  title:'Thyroglossal Duct Cyst', aka:'Thyroglossal Cyst · TDC',
  tags:[{l:'Most Common Neck Cyst',c:'blue'},{l:'Midline Neck',c:'green'},{l:'Moves with Swallowing',c:'amber'}],
  summary:'The <strong>most common congenital neck mass</strong>, arising from persistence of the thyroglossal duct — the embryonic tract from the foramen cecum at the tongue base to the thyroid gland. Located in the <strong>midline neck</strong> at any point along this tract. Pathognomonic clinical sign: <strong>mass moves superiorly with tongue protrusion or swallowing</strong>. Treatment: Sistrunk procedure (tract + central hyoid bone resection) — not simple enucleation.',
  fp:[{k:'Aggressiveness',v:14,t:'lo',l:'Low'},{k:'Recurrence',v:30,t:'md',l:'High Without Sistrunk'},{k:'Commonality',v:72,t:'hi',l:'Most Common Neck Cyst'},{k:'Boards Freq.',v:88,t:'hi',l:'Very High'},{k:'Tx Complexity',v:55,t:'md',l:'Moderate'}],
  sections:[
    {n:'01',title:'Embryology & Anatomy',sub:'Why It Forms · Tract Path',cards:[
      {lbl:'📋 Embryologic Origin',items:['Thyroid descends from foramen cecum (tongue base) to final position','Tract normally involutes completely by week 10','Persistence = duct with secretory potential → cyst formation','Duct passes through or near the hyoid bone — critical for treatment']},
      {lbl:'📍 Location Along Tract',items:['<strong>Subhyoid (infrahyoid): 65%</strong> — most common','Thyrohyoid: ~20%','Suprahyoid: ~15%','Intralingual/foramen cecum: rare','Anywhere from tongue base to thyroid — midline throughout']},
    ]},
    {n:'02',title:'Clinical Presentation',sub:'The Pathognomonic Sign · Demographics',cards:[
      {lbl:'🏥 Clinical Findings',items:['<strong>Midline neck mass</strong> — most common presentation','Peak: children and young adults','<em>Moves superiorly with tongue protrusion</em> — pathognomonic','Moves superiorly with swallowing','Soft, smooth, cystic — transilluminates','Occasionally infected — then tender, erythematous, warm']},
      {lbl:'⚠️ Red Flags',items:['<strong>Infection</strong> — most common complication; increases recurrence if operated infected','Fistula — to skin if ruptured or incised','Ectopic thyroid tissue in TDC — may be patient\'s only thyroid','Malignant transformation: rare (papillary thyroid carcinoma)']},
    ]},
    {n:'03',title:'Imaging & Diagnosis',sub:'CT · Ultrasound · Thyroid Scan',cards:[
      {lbl:'📡 Imaging Approach',items:['<strong>Ultrasound first</strong> — confirms cystic nature, no radiation','CT: if infected or to delineate tract','<em>Always perform thyroid scan/ultrasound first</em>','Confirm normal thyroid exists before surgery — critical','Technetium scan: confirms separate functioning thyroid']},
      {lbl:'⚠️ The Critical Pre-Op Check',items:['Up to 1% of TDCs contain the patient\'s <strong>only functioning thyroid tissue</strong>','Removing it = permanent hypothyroidism','Pre-op thyroid ultrasound or scan is mandatory','If no separate thyroid identified → do NOT excise without endocrinology input']},
    ],hls:[{cls:'red',lbl:'🚨 Most Important Pre-Op Step',txt:'<strong>Always confirm presence of a separate, normal thyroid gland before TDC excision.</strong> Approximately 1% of TDCs contain the only thyroid tissue the patient has. Removing it without knowing = surgical hypothyroidism requiring lifelong T4 replacement. This is a never-event that is entirely preventable.',full:true}]},
    {n:'04',title:'Histopathology',sub:'Lining · Contents · Thyroid Tissue',cards:[
      {lbl:'🔬 Microscopic',items:['<strong>Pseudostratified ciliated columnar (respiratory) epithelium</strong>','Squamous epithelium if close to skin/infected','Thyroid follicles in wall — characteristic and confirmatory','Mucous glands in lining','Inflammatory change if previously infected']},
    ]},
    {n:'05',title:'DDx',sub:'Click to exclude',ddx:[
      {name:'Lymphoepithelial Cyst (Cervical)',key:'LEC: lateral neck (anterior to SCM), fluctuant — TDC: midline, moves with tongue protrusion, thyroid follicles in wall'},
      {name:'Dermoid Cyst (Submental)',key:'Dermoid: midline but floor of mouth, doughy, skin appendages in wall — TDC: neck level, moves with swallowing, respiratory lining'},
      {name:'Ectopic Thyroid',key:'Ectopic thyroid: solid on imaging, no cystic component, functions as active thyroid — TDC is cystic with potential thyroid inclusion'},
      {name:'Ludwig\'s Angina / Neck Abscess',key:'Abscess: acute, febrile, bilateral, airway compromise — TDC infected: midline, preceded by cyst history, slower progression'},
    ]},
    {n:'06',title:'Management',sub:'The Sistrunk Procedure',cards:[
      {lbl:'🔪 Sistrunk Procedure',items:['<strong>Cyst + entire tract + central hyoid bone segment</strong>','Tract followed to foramen cecum','Core of tongue tissue taken above hyoid — removes all duct remnants','NOT simple enucleation — recurrence rate 50% with simple excision vs 5% with Sistrunk']},
      {lbl:'📋 Why Central Hyoid?',items:['The duct passes through the body of the hyoid','Leaving hyoid remnant = leaving duct epithelium = recurrence source','Central 1cm of hyoid is resected with tract','Hyoid function preserved — bilateral wings remain']},
    ],hls:[{cls:'amber',lbl:'⚡ Sistrunk vs. Simple Excision',txt:'Simple enucleation = <strong>50% recurrence rate</strong>. Sistrunk procedure = <strong>5% recurrence rate</strong>. The hyoid bone passes through the duct — any surgery that doesn\'t remove the central hyoid leaves viable epithelium behind. This is not an advanced concept; it\'s the fundamental surgical principle for TDC.'}]},
  ],
  pearls:[
    {s:'dark',lbl:'Pearl #1 — Moving mass is pathognomonic',txt:'<strong>A midline neck mass that moves superiorly with tongue protrusion or swallowing</strong> = TDC until proven otherwise. No other neck mass has this clinical behavior because no other neck structure is attached to the base of the tongue via a remnant tract.'},
    {s:'red',lbl:'Pearl #2 — Check the thyroid first',txt:'<strong>Before any TDC surgery, confirm a separate functioning thyroid gland.</strong> 1% of TDCs are the patient\'s only thyroid. Imaging/scan before surgery is not optional — it\'s the standard of care.'},
    {s:'amber',lbl:'Pearl #3 — Sistrunk, not enucleation',txt:'The <strong>Sistrunk procedure</strong> removes the cyst, entire tract, and central hyoid body segment. Without resecting the central hyoid, the recurrence rate is 50% because the duct passes through the hyoid. No other soft tissue cyst in the head and neck has a bone in its treatment protocol.'},
  ],
  mnem:{word:'T · Y · D · C',lines:[
    {l:'T',r:'hyroglossal — tract from foramen cecum to thyroid'},
    {l:'Y',r:'our only thyroid? — confirm separate gland before surgery'},
    {l:'D',r:'escends with swallowing/tongue protrusion — pathognomonic sign'},
    {l:'C',r:'entral hyoid resection — Sistrunk procedure reduces recurrence to 5%'},
  ]},
  syns:[{cls:'red',ico:'🔴',title:'Ectopic Thyroid in TDC — Surgical Trap',txt:'In approximately 1% of TDC cases, the thyroid tissue found in the wall is the <strong>patient\'s only functioning thyroid gland</strong>. Excising the cyst destroys it, causing permanent hypothyroidism. Technetium-99m scan or thyroid ultrasound before surgery identifies the separately descended thyroid — or its absence. This complication is entirely preventable.'}],
  next:[{id:'staf',ico:'⚫',title:'Stafne Bone Defect',sub:'Not a cyst at all — static, incidental, never biopsy'},{id:'npc',ico:'💙',title:'Nasopalatine Duct Cyst',sub:'Most common non-OG cyst — intraosseous midline'}],
};

CONDITIONS['staf'] = {
  id:'staf', ey:'Pathology · Non-Odontogenic Cysts · 6 of 6',
  title:'Stafne Bone Defect', aka:'Stafne Bone Cavity · Static Bone Cyst · Latent Bone Cyst',
  tags:[{l:'Not a True Cyst',c:'red'},{l:'Static Lesion',c:'green'},{l:'Below IAN Canal',c:'amber'}],
  summary:'<strong>Not a true cyst</strong> — a developmental depression (concavity) in the lingual cortex of the mandible filled with normal submandibular salivary gland tissue. Appears radiographically as a <strong>well-defined, oval radiolucency below the inferior alveolar nerve canal</strong> in the posterior mandible. Boards gold standard: <strong>below the IAN + static on serial imaging = no biopsy needed</strong>. The most important pseudo-cyst to recognize because it should never be biopsied.',
  fp:[{k:'Aggressiveness',v:0,t:'lo',l:'None — Not Pathologic'},{k:'Recurrence',v:0,t:'lo',l:'N/A'},{k:'Commonality',v:38,t:'md',l:'Not Rare'},{k:'Boards Freq.',v:80,t:'hi',l:'High'},{k:'Tx Complexity',v:0,t:'lo',l:'None'}],
  sections:[
    {n:'01',title:'What It Is & Why It Matters',sub:'Pathogenesis · Clinical Significance',cards:[
      {lbl:'📋 Pathogenesis',items:['Developmental: submandibular gland tissue herniates into a depression in lingual mandibular cortex','Depression forms in response to gland pressure','Contents: normal salivary gland parenchyma — not cyst fluid','<strong>NOT a pathologic process</strong>','Confirmed by MRI/CT: salivary signal inside the "defect"']},
      {lbl:'⚠️ Why This Matters',items:['<strong>Can be mistaken for aggressive lesion on panoramic</strong>','Unnecessary biopsy or surgery if misidentified','Biopsy impossible without cortical breach — contents are gland tissue','Recognition saves the patient from an invasive procedure','Boards: recognizing what NOT to biopsy is as important as diagnosis']},
    ]},
    {n:'02',title:'Radiographic Features',sub:'Location · Morphology · The Definitive Sign',cards:[
      {lbl:'📡 Key Features',items:['Well-defined, <strong>oval-to-round radiolucency</strong>','Located in <strong>posterior mandible BELOW the inferior alveolar canal</strong>','Corticated, sclerotic border','Usually 1–3cm in size','<strong>Static on serial imaging</strong> — does not change over years']},
      {lbl:'🔍 Anatomic Location Precisely',items:['Below the IAN canal — this is the single most important feature','Between the mandibular angle and second molar region','On the lingual cortex (not visible from buccal approach)','MRI/CT: shows salivary gland signal filling the defect','CT: no bone loss — cortical depression only']},
    ],hls:[
      {cls:'red',lbl:'⚡ The Single Defining Feature',txt:'<strong>Radiolucency BELOW the inferior alveolar nerve canal</strong> = Stafne Bone Defect until proven otherwise. Every other significant jaw cyst and tumor is ABOVE the IAN canal. This anatomic position is the most reliable diagnostic sign available on panoramic.'},
      {cls:'green',lbl:'✅ Static Is the Proof',txt:'If you are unsure — take a repeat panoramic in 6–12 months. <strong>A Stafne defect does not change.</strong> Stable lesion on serial imaging is the functional diagnostic confirmation. No other jaw pathology is this reliably static.'},
    ]},
    {n:'03',title:'Imaging Confirmation',sub:'MRI · CT · The Definitive Study',cards:[
      {lbl:'🖥️ MRI',items:['<strong>MRI with fat suppression</strong> is diagnostic','Salivary gland tissue = hyperintense on T1','Confirms normal salivary signal inside defect','No enhancement pattern of pathology','Avoids biopsy entirely when positive']},
      {lbl:'🖥️ CT',items:['CBCT: shows cortical depression without periosteal reaction','No internal calcification or septation','Confirms proximity to IAN canal','Used for surgical planning if other diagnosis is being ruled out']},
    ]},
    {n:'04',title:'DDx',sub:'What it mimics',ddx:[
      {name:'Ameloblastoma',key:'Amelo: ABOVE IAN canal, cortical expansion, soap-bubble, aggressive — Stafne: below IAN, static, no expansion'},
      {name:'OKC in Posterior Mandible',key:'OKC: above IAN, scalloped, parakeratinized lining on biopsy — Stafne: below IAN, static, salivary contents'},
      {name:'Residual Cyst',key:'Residual: above IAN, edentulous site, prior extraction history — Stafne: below IAN, no prior pathology, static'},
      {name:'Central Vascular Lesion',key:'Hemangioma: may pulsate, sunray speculations, catastrophic if biopsied blindly — Stafne: no pulsation, salivary signal on MRI'},
    ]},
    {n:'05',title:'Management',sub:'The Correct Answer Is Do Nothing',cards:[
      {lbl:'✅ Treatment',items:['<strong>No treatment required</strong>','Imaging confirmation if clinical uncertainty','Periodic radiographic observation acceptable','MRI to confirm salivary contents if atypical','Never biopsy without MRI/CT confirmation — contents are gland tissue, no cystic lining to sample']},
      {lbl:'📋 Prognosis',items:['No growth — lesion is static for life','No clinical consequence in vast majority','No malignant potential','Patient education: reassure, document, no follow-up required','Rare: symptomatic cases if gland enlarges secondary to obstruction']},
    ]},
  ],
  pearls:[
    {s:'red',lbl:'Pearl #1 — Below the IAN is the whole answer',txt:'<strong>Every important jaw cyst and tumor is ABOVE the inferior alveolar canal.</strong> A radiolucency below it = Stafne Bone Defect. This single anatomic fact is the entire diagnosis. The moment you see a posterior mandible radiolucency below the IAN canal, stop looking for pathology.'},
    {s:'green',lbl:'Pearl #2 — Static on serial imaging',txt:'If you are uncertain, the functional test is time. <strong>Take a panoramic in 6 months. If it hasn\'t changed — it\'s Stafne.</strong> Every true jaw pathology (cysts, tumors) grows. A Stafne defect has been static since it formed in childhood.'},
    {s:'amber',lbl:'Pearl #3 — MRI is definitive',txt:'<strong>MRI shows salivary gland tissue filling the defect — T1 hyperintense signal = fat-containing salivary parenchyma.</strong> This eliminates every other lesion from the differential. When in doubt: MRI before biopsy. The MRI result prevents an unnecessary operation.'},
  ],
  mnem:{word:'S · T · A · F · N · E',lines:[
    {l:'S',r:'alivary gland fills the defect — not a cyst, not pathology'},
    {l:'T',r:'he IAN canal — below it = Stafne (every cyst is above it)'},
    {l:'A',r:'symptomatic and incidental — never causes problems'},
    {l:'F',r:'ind it, identify it, leave it alone — no biopsy needed'},
    {l:'N',r:'ot a true cyst — a developmental cortical depression'},
    {l:'E',r:'ncourage the patient — static for life, no consequence'},
  ]},
  syns:[{cls:'green',ico:'✅',title:'Anterior Variant — Sublingual Gland',txt:'A rare anterior Stafne defect exists in the anterior mandible below the canines, filled by sublingual gland tissue. Same principle — below the IAN, static, salivary contents on MRI. Extremely uncommon. Important only to know it can be bilateral or in an atypical anterior location and still behave identically to the posterior variant.'}],
  next:[{id:'npc',ico:'💙',title:'Nasopalatine Duct Cyst',sub:'Most common non-OG cyst — revisit the contrast'},{id:'lymp',ico:'🟤',title:'Lymphoepithelial Cyst',sub:'Lateral neck and floor of mouth'}],
};

// ── MODULE 2 LESSONS ──────────────────────────────────────────────────────────

const lessons_m2 = {

  npc: {
    whyHard: "Most students confuse NPDC with a radicular cyst on panoramic — both are anterior maxillary radiolucencies. The entire diagnosis hinges on ONE test you have to remember to do: pulp vitality on the adjacent centrals.",
    coreIdea: "A cyst that grew from embryonic duct remnants trapped in the incisive canal. The duct was supposed to disappear — when it doesn't, it slowly fills with fluid. The canal in the midline anterior maxilla is the only place this can happen.",
    theNumber: "**6mm** — the diameter threshold for the incisive fossa. Under 6mm with vital teeth = observe. Over 6mm or growing = NPDC until biopsied. One number, one test, whole diagnosis.",
    visualNote: "Picture a dark oval between the roots of the two upper front teeth — sitting in the midline, not at the apex of either tooth. Both teeth are alive. The darkness is fluid in a cyst sitting inside the incisive canal, which runs through the anterior hard palate.",
    svgLabel: "NPDC — midline anterior maxilla, incisive canal",
    chain: [
      {step: "Where does it come from?", answer: "The nasopalatine duct connects the oral cavity to the nasal cavity in embryonic life. It normally obliterates completely before birth. When epithelial remnants persist, they can form a cyst within the incisive canal — the bony channel that runs through the anterior hard palate at the midline."},
      {step: "What does it look like on imaging?", answer: "A well-defined, often heart-shaped radiolucency in the midline anterior maxilla, between the roots of the central incisors. The 'heart shape' comes from the superimposition of the anterior nasal spine — it's a projection artifact, not a true shape."},
      {step: "The 6mm rule", answer: "The normal incisive fossa can be up to 6mm in diameter. Any radiolucency in this location under 6mm with vital adjacent teeth and no growth is probably normal anatomy. Over 6mm, or showing growth on serial imaging, is pathological. Biopsy at that threshold."},
      {step: "The one decisive test", answer: "Pulp vitality testing of both central incisors. NPDC is always associated with vital teeth — the cyst is developmental, not inflammatory. If either central incisor is non-vital, you're looking at a radicular cyst, not NPDC."},
      {step: "Histology: no single answer", answer: "NPDC can be lined by squamous, cuboidal, pseudostratified columnar, or mixed epithelium. The variable lining reflects the dual-origin nature of the duct. The diagnostic tell on histology is a nasopalatine nerve or vessel in the fibrous wall — no other cyst has this."},
    ],
    traps: [
      {label: "The vitality trap", icon: "⚡", scenario: "Midline anterior maxilla radiolucency. You diagnose NPDC clinically. You plan enucleation.", consequence: "The maxillary central incisor is non-vital from prior trauma. It's a radicular cyst. You planned the wrong surgery — the tooth needs RCT alongside or before enucleation.", fix: "Always EPT the adjacent central incisors before diagnosing NPDC. Non-vital = radicular cyst. Period."},
    ],
    contrast: {versus: "Radicular Cyst", vsId: "rc", intro: "Same location on the X-ray. Completely different origin and treatment. Vitality testing is the only separator.",
      rows: [
        {feature: "Adjacent tooth", dc: "VITAL — responds to cold", okc: "NON-VITAL — no pulp response"},
        {feature: "Location precisely", dc: "MIDLINE between roots — incisive canal", okc: "AT THE APEX of non-vital tooth"},
        {feature: "Origin", dc: "Developmental — nasopalatine duct remnant", okc: "Inflammatory — Rests of Malassez, pulp necrosis"},
        {feature: "Treatment", dc: "Enucleation — palatal approach", okc: "RCT first; enucleation if RCT fails"},
        {feature: "Pathognomonic histology", dc: "Nerve/vessel in cyst wall", okc: "Rushton bodies, cholesterol clefts"},
      ]
    },
    clinicalFlow: {title: "Anterior maxillary midline radiolucency",
      steps: [
        {q: "Radiolucency between maxillary central incisors — midline?", y: "Test pulp vitality both centrals", n: "Off midline → different lesion"},
        {q: "Both centrals vital (cold EPT+)?", y: "NPDC likely — measure size", n: "Non-vital → radicular cyst → RCT first"},
        {q: "Lesion ≥6mm or growing on serial imaging?", y: "Biopsy confirmed → enucleation via palatal approach", n: "Observe; repeat panoramic in 12 months"},
      ]
    }
  },

  nla: {
    whyHard: "It has no X-ray finding. Students who only look for radiolucencies on a panoramic will always miss it. The diagnosis is entirely clinical.",
    coreIdea: "A soft tissue cyst at the base of the nose. It elevates the nasal ala, obliterates the nasolabial fold, and shows nothing on panoramic because it's not in bone.",
    theNumber: "**0** — as in zero radiographic finding. The panoramic is normal. That's not a miss; it's the diagnosis.",
    visualNote: "Picture a smooth, fluctuant swelling that lifts one side of the nose — the nasolabial fold on that side is flattened. The lip and nasal base look asymmetric. The panoramic you ordered comes back completely normal. That normal X-ray is the clinical clue.",
    svgLabel: "Nasolabial Cyst — soft tissue, nasal base",
    chain: [
      {step: "Origin and location", answer: "Forms at the fusion line of the nasal and maxillary processes during facial development. Epithelial remnants get trapped at the nasal ala. Slow fluid accumulation forms the cyst — entirely in soft tissue, never in bone."},
      {step: "What it feels like to the patient", answer: "A gradually enlarging fullness at the nasal base — usually on one side. The nasolabial fold on that side is obliterated. Nasal breathing may be partially obstructed if large. It's soft and fluctuant."},
      {step: "Why the X-ray is normal", answer: "There's no bone involvement. Panoramic and periapical X-rays image bone. A purely soft tissue cyst leaves no bony shadow. Students who expect a radiolucency will read the imaging as 'normal' and miss the diagnosis."},
      {step: "What histology shows", answer: "Non-keratinized squamous or pseudostratified ciliated (respiratory) columnar epithelium. The respiratory-type lining confirms its nasal origin. No odontogenic epithelium, no skin appendages, no lymphoid tissue."},
    ],
    traps: [
      {label: "The normal X-ray trap", icon: "📷", scenario: "Patient presents with unilateral nasal base swelling. You order a panoramic to look for a jaw lesion. It comes back normal. You reassure the patient.", consequence: "The nasolabial cyst was missed. The 'normal' X-ray isn't a negative finding — it's part of the diagnosis. A soft tissue cyst won't show on bone films.", fix: "When clinical exam shows a nasal base soft tissue swelling with a normal panoramic — think nasolabial cyst first. MRI or CT confirms the soft tissue mass."},
    ],
    contrast: {versus: "NPDC", vsId: "npc", intro: "Both affect the anterior maxillary region. One is intraosseous; one is purely soft tissue. Location and imaging separate them immediately.",
      rows: [
        {feature: "Location", dc: "Soft tissue — nasal ala base (lateral)", okc: "Intraosseous — midline incisive canal"},
        {feature: "Radiographic finding", dc: "NONE — normal panoramic", okc: "Heart-shaped midline radiolucency"},
        {feature: "Adjacent teeth", dc: "Not involved", okc: "Between central incisors — vital"},
        {feature: "Lining", dc: "Non-keratinized squamous or respiratory", okc: "Variable — squamous, columnar, cuboidal"},
        {feature: "Treatment", dc: "Sublabial soft tissue excision", okc: "Palatal enucleation"},
      ]
    },
    clinicalFlow: {title: "Nasal base soft tissue swelling",
      steps: [
        {q: "Soft, fluctuant swelling at nasal ala/nasolabial fold?", y: "Order panoramic to rule out bony lesion", n: "Different presentation"},
        {q: "Panoramic normal (no radiolucency)?", y: "Nasolabial cyst most likely — confirm with MRI/CT", n: "Bony lesion present → different diagnosis"},
        {q: "MRI/CT: soft tissue cystic mass at nasal ala, no bone involvement?", y: "Nasolabial cyst confirmed → sublabial excision", n: "Consider other soft tissue lesion"},
      ]
    }
  },

  derm: {
    whyHard: "Students mix up the three variants (epidermoid, dermoid, teratoid) and can't remember which one has what in the wall. It's simpler than it looks: skin appendages = dermoid. Nothing extra = epidermoid.",
    coreIdea: "A developmental cyst in the floor of the mouth. The lining is keratinized squamous epithelium. What distinguishes the variants is what's in the WALL, not the lining: epidermoid has wall only, dermoid adds skin appendages, teratoid adds all three germ layers.",
    theNumber: "**2 key tests**: (1) Is it above or below the mylohyoid? → determines surgical approach. (2) Does histology show skin appendages in the wall? → dermoid vs. epidermoid.",
    visualNote: "Picture a doughy, midline mass in the floor of the mouth. Push on it — it indents and holds the indentation like putty. That's the sebaceous content of a dermoid. A ranula feels like a water balloon and springs back. This palpation quality is the clinical tell.",
    svgLabel: "Dermoid/Epidermoid — floor of mouth, above/below mylohyoid",
    chain: [
      {step: "How it forms", answer: "Epithelium gets trapped at embryonic fusion lines during midface development. In the floor of the mouth, this happens at the midline where the mandibular and hyoid arches fuse. Slow accumulation of keratin and sebaceous material inflates the cyst."},
      {step: "The two locations", answer: "If above the mylohyoid muscle → sublingual: pushes tongue up, creates a submental swelling in the floor of mouth that's visible intraorally. If below the mylohyoid → submental: creates a visible neck swelling below the chin. Location determines surgical approach."},
      {step: "The three variants", answer: "Epidermoid = keratinized squamous lining, keratin debris only. Dermoid = same lining + skin appendages (hair follicles, sebaceous glands) in the wall. Teratoid = all three germ layers. The wall contents make the diagnosis."},
      {step: "The clinical tell", answer: "Doughy or putty-like palpation = dermoid (sebaceous content). Fluctuant = epidermoid or ranula. Doughy quality doesn't spring back on release — sebaceous material flows slowly. This is the palpation finding that points to dermoid before histology."},
    ],
    traps: [
      {label: "Dermoid vs. ranula", icon: "💧", scenario: "Floor of mouth swelling — you diagnose ranula, plan marsupialization.", consequence: "Ranula is salivary, thin-walled, marsupialization works. Dermoid has thick keratin/sebaceous contents — marsupialization does nothing. Wrong surgery.", fix: "Dermoid: doughy, doesn't transilluminate, doesn't decompress well. Ranula: bluish tinge, transilluminates, thin-walled. If unsure — MRI first."},
    ],
    contrast: null,
    clinicalFlow: {title: "Floor of mouth midline mass",
      steps: [
        {q: "Midline floor of mouth mass — soft, slow-growing?", y: "Palpate: doughy (dermoid) or fluctuant (ranula/epidermoid)?", n: "Firm — consider other diagnosis"},
        {q: "Above or below mylohyoid?", y: "Above → sublingual: intraoral excision", n: "Below → submental: external approach"},
        {q: "Histology: skin appendages in wall?", y: "True Dermoid Cyst", n: "Epidermoid (no appendages) or Teratoid (all 3 germ layers)"},
      ]
    }
  },

  lymp: {
    whyHard: "Two forms, same name, different location, different DDx. Students need to separate oral LEC (tiny, yellow, floor of mouth) from cervical LEC (lateral neck mass, branchial cleft, different DDx entirely).",
    coreIdea: "A squamous-lined cyst with lymphoid follicles in the wall. The lymphoid tissue is what makes it unique — no other jaw or neck cyst has germinal centers in its wall. Two forms: oral (small, incidental, floor of mouth) and cervical (lateral neck, branchial cleft origin, important DDx).",
    theNumber: "**1 histologic feature**: germinal centers in the wall = LEC. Everything else follows from that.",
    visualNote: "Picture a small yellow-white dome in the floor of the mouth — looks like a lymph node trapped under mucosa. Under the microscope: a squamous-lined cyst, but the wall is filled with lymphoid tissue with active germinal centers. That combination is LEC.",
    svgLabel: "Lymphoepithelial Cyst — oral and cervical forms",
    chain: [
      {step: "Oral form — where and why", answer: "Epithelial rests get trapped within intraoral lymphoid tissue during development. The oral floor, ventral tongue, and soft palate have lymphoid aggregates — when epithelium gets enclosed, LEC forms. Small, yellow, discovered incidentally."},
      {step: "Cervical form — branchial cleft", answer: "The cervical LEC (branchial cleft cyst) forms from entrapped epithelium within cervical lymph nodes from branchial cleft development. Second branchial cleft is most common. Presents as a soft, lateral neck mass anterior to the SCM in young adults."},
      {step: "The histologic signature", answer: "Stratified squamous lining with lymphoid follicles (germinal centers) in the cyst wall. This is pathognomonic. Warthin tumor has a similar lymphoid stroma but also contains oncocytic bilayered epithelium and salivary gland parenchyma — not squamous lining alone."},
      {step: "The cervical LEC boards scenario", answer: "Young adult with a soft, fluctuant, lateral neck mass anterior to the SCM that's been slowly growing for months. A CT shows a cystic mass. The two diagnoses to rule in or out: cervical LEC vs. lymphoma. LEC: cystic on imaging, long history, soft. Lymphoma: solid, firm, B symptoms."},
    ],
    traps: [
      {label: "Lymphoma vs. cervical LEC", icon: "🔴", scenario: "Young adult, lateral neck mass. You assume LEC, plan surgical excision.", consequence: "If it's lymphoma and you excise it without biopsy/workup, you've done the wrong operation. Lymphoma requires staging, not excision.", fix: "CT and FNA before excision of any lateral neck mass in a young adult. Lymphoma: solid, firm, FNA shows lymphoid cells. LEC: cystic on CT, FNA shows squamous cells and keratinous debris."},
    ],
    contrast: {versus: "Warthin Tumor", vsId: "lymp", intro: "Both have lymphoid stroma. The distinction is in the epithelium and location.",
      rows: [
        {feature: "Location", dc: "Oral LEC: floor of mouth, tongue, soft palate. Cervical: lateral neck", okc: "Parotid gland — tail of parotid most common"},
        {feature: "Epithelium", dc: "Stratified squamous lining", okc: "Oncocytic bilayered epithelium — papillary projections into lumen"},
        {feature: "Lymphoid stroma", dc: "Present — germinal centers in wall", okc: "Present — identical wall feature"},
        {feature: "Salivary parenchyma", dc: "Absent", okc: "Present — salivary gland tissue in wall"},
        {feature: "Bilateral", dc: "10% oral; 5% cervical", okc: "10% bilateral (classic Warthin feature)"},
      ]
    },
    clinicalFlow: {title: "Lateral neck mass DDx",
      steps: [
        {q: "Soft, fluctuant lateral neck mass anterior to SCM in young adult?", y: "CT to confirm cystic nature", n: "Firm/solid → lymphoma workup, FNA"},
        {q: "CT: cystic mass, no solid component?", y: "LEC (branchial cleft cyst) most likely — plan excision", n: "Solid component → FNA for cells first"},
        {q: "FNA: squamous cells and keratinous debris?", y: "LEC confirmed — surgical excision with tract", n: "Lymphoid cells → hematology/oncology before surgery"},
      ]
    }
  },

  thyro: {
    whyHard: "Students know 'moves with swallowing' and stop there. The clinical trap — and the most consequential fact — is that 1% of TDCs contain the patient's only thyroid. That's the fact that gets patients hurt.",
    coreIdea: "A midline neck cyst from persistence of the thyroglossal duct — the embryonic thyroid migration path. The duct runs through the hyoid bone. Treatment must remove the central hyoid with the cyst (Sistrunk procedure) or recurrence is 50%.",
    theNumber: "**5% vs 50%** — recurrence rate with Sistrunk vs. simple excision. The central hyoid segment is the non-negotiable part of treatment.",
    visualNote: "Picture a midline neck mass that visibly rises as the patient sticks out their tongue. The mass is attached by a residual duct to the tongue base — it moves because the tongue pulls it. No other neck mass does this.",
    svgLabel: "Thyroglossal Duct Cyst — midline neck tract",
    chain: [
      {step: "Embryologic origin", answer: "The thyroid gland descends from the foramen cecum (tongue base) to its final position in the lower neck. The tract normally involutes completely. When it doesn't — a cyst forms at any point along the path. Most commonly at or below the hyoid bone."},
      {step: "The pathognomonic sign", answer: "The mass moves superiorly when the patient protrudes the tongue or swallows. This happens because the tract is still attached to the tongue base. The tongue pulls the tract — and any cyst on it — upward. No other neck mass does this."},
      {step: "Why Sistrunk — the hyoid problem", answer: "The thyroglossal duct passes through the body of the hyoid bone. Any surgery that doesn't remove the central segment of the hyoid body leaves viable duct epithelium in the hyoid. That epithelium will reform a cyst. Simple excision = 50% recurrence. Sistrunk = 5%."},
      {step: "The critical pre-op check", answer: "About 1% of TDCs contain ectopic thyroid tissue that is the patient's ONLY functioning thyroid. Removing the cyst destroys it. Thyroid ultrasound or scan must confirm a normally descended thyroid before any surgery."},
      {step: "Histology", answer: "Pseudostratified ciliated columnar (respiratory) epithelium is the classic lining. May be squamous if infected or near the skin. Thyroid follicles in the wall are characteristic and confirmatory of TDC."},
    ],
    traps: [
      {label: "Ectopic thyroid trap", icon: "🦋", scenario: "Young patient, midline neck cyst, obvious TDC. You schedule Sistrunk procedure without pre-op imaging.", consequence: "TDC contains patient's only thyroid tissue. You remove it. Patient develops permanent hypothyroidism, lifelong T4 replacement.", fix: "Pre-op thyroid ultrasound or Tc-99m scan before every TDC surgery. Confirm a separate, normal thyroid gland. This is standard of care — not optional."},
      {label: "Simple excision trap", icon: "✂️", scenario: "TDC confirmed. You remove the cyst cleanly. Surgery looks successful.", consequence: "You left the central hyoid body. Duct epithelium remains in the hyoid — 50% chance of recurrence within 2 years.", fix: "Sistrunk procedure always. Central hyoid segment + the cystic tract to the foramen cecum. Never simple enucleation for TDC."},
    ],
    contrast: {versus: "Dermoid (Submental)", vsId: "derm", intro: "Both are midline neck/floor of mouth masses. The movement test and histology separate them.",
      rows: [
        {feature: "Movement with swallowing", dc: "YES — rises superiorly", okc: "NO — fixed"},
        {feature: "Location", dc: "Midline neck — subhyoid (65%)", okc: "Submental or floor of mouth — above/below mylohyoid"},
        {feature: "Lining", dc: "Respiratory (ciliated columnar) or squamous", okc: "Keratinized squamous + skin appendages"},
        {feature: "Thyroid tissue in wall", dc: "Present — characteristic", okc: "Never"},
        {feature: "Treatment", dc: "Sistrunk procedure (central hyoid resection required)", okc: "Excision — no bone resection"},
      ]
    },
    clinicalFlow: {title: "Midline neck mass workup",
      steps: [
        {q: "Midline neck mass — rises with tongue protrusion or swallowing?", y: "TDC confirmed clinically", n: "Fixed midline mass → consider dermoid, ectopic thyroid"},
        {q: "Pre-op: thyroid ultrasound confirms separately descended thyroid?", y: "Proceed to Sistrunk procedure", n: "No thyroid found → endocrinology consult; confirm ectopic before surgery"},
        {q: "Sistrunk procedure: cyst + tract + central hyoid body removed?", y: "5% recurrence rate", n: "Simple excision only → 50% recurrence rate"},
      ]
    }
  },

  staf: {
    whyHard: "It looks exactly like a threatening jaw lesion on a panoramic, and the correct management is to do nothing. Students are trained to act on radiolucencies. Stafne teaches you when NOT to act — which is the hardest lesson in oral pathology.",
    coreIdea: "Not a cyst. A developmental pit in the lingual cortex of the mandible where normal salivary gland tissue sits. It's below the inferior alveolar nerve canal — an anatomic position that no true pathology occupies. Static. Asymptomatic. Never needs treatment.",
    theNumber: "**1 anatomic rule**: every significant jaw cyst and tumor is ABOVE the inferior alveolar canal. A radiolucency BELOW it = Stafne until proven otherwise.",
    visualNote: "Picture a panoramic of the posterior mandible. There's a round, corticated radiolucency — looks exactly like a residual cyst or ameloblastoma. But then you check its position relative to the inferior alveolar nerve canal. It's below. That one anatomic detail changes everything.",
    svgLabel: "Stafne Bone Defect — below IAN canal",
    chain: [
      {step: "What is it really?", answer: "A developmental depression (concavity) in the lingual cortex of the posterior mandible. The submandibular salivary gland herniates into this depression, filling it with normal salivary parenchyma. There's no cyst lining, no fluid, no pathology — just normal salivary tissue in a bone pocket."},
      {step: "Why it looks threatening on X-ray", answer: "A corticated, oval radiolucency in the posterior mandible — same appearance as an OKC, residual cyst, or early ameloblastoma. The key is its position: below the inferior alveolar nerve canal. No true jaw pathology is routinely found below the IAN."},
      {step: "The one anatomic rule", answer: "Every significant jaw cyst (OKC, residual cyst, ameloblastoma, DC) is above the inferior alveolar nerve canal. Stafne defects are below it. This single anatomic position is the whole diagnosis on panoramic."},
      {step: "How to confirm", answer: "MRI: T1-weighted signal inside the defect shows fat-containing salivary parenchyma — diagnostic. CT: cortical depression on lingual surface, no periosteal reaction. Serial panoramics: no change. Any one of these three confirms Stafne."},
      {step: "Treatment", answer: "None required. The defect is static for the patient's entire life. Document it, educate the patient, and move on. Biopsy is inappropriate — there's no cyst lining to sample, only normal salivary gland tissue."},
    ],
    traps: [
      {label: "The biopsy trap", icon: "🩺", scenario: "Posterior mandible radiolucency. Looks worrisome. You plan biopsy to confirm.", consequence: "It's below the IAN canal — a Stafne defect. Biopsy of normal salivary gland tissue confirms nothing useful and risks IAN injury. You've put the patient through surgery they didn't need.", fix: "Before any posterior mandible biopsy: check the position relative to the IAN canal. Below it = get MRI first. Salivary signal on MRI = Stafne = no biopsy."},
    ],
    contrast: {versus: "Residual Cyst", vsId: "res", intro: "Both are well-defined posterior mandible radiolucencies. Position relative to the IAN canal separates them immediately.",
      rows: [
        {feature: "Position vs. IAN", dc: "BELOW the IAN canal — definitive sign", okc: "ABOVE the IAN canal"},
        {feature: "Contents", dc: "Normal salivary gland tissue", okc: "Cystic fluid with epithelial lining"},
        {feature: "Growth", dc: "Static — never changes", okc: "Slowly grows over months/years"},
        {feature: "Prior extraction history", dc: "None required", okc: "Yes — tooth extracted at that site"},
        {feature: "Treatment", dc: "None", okc: "Enucleation + curettage"},
      ]
    },
    clinicalFlow: {title: "Posterior mandible radiolucency",
      steps: [
        {q: "Well-defined posterior mandible radiolucency — check position vs. IAN canal", y: "Below IAN canal", n: "Above IAN canal → standard cyst DDx (RC, residual, OKC)"},
        {q: "Static on serial imaging (6-12 month comparison)?", y: "Stafne confirmed — no treatment", n: "Growing → biopsy regardless of position"},
        {q: "Confirm with MRI if uncertain", y: "Salivary T1 signal in defect → Stafne → close case", n: "Cystic signal → reconsider diagnosis → biopsy"},
      ]
    }
  }

};

// Merge Module 2 lessons into the global lessons object
Object.assign(lessons, lessons_m2);

// ── MODULE 2 CASES ────────────────────────────────────────────────────────────

// Cases 17-28 (2 per condition)
const CASES_M2 = [

  // ── CASE 17: NPDC RECOGNITION ──────────────────────────────────────────────
  {n:17,badge:'Periapical · Anterior Maxilla',badge2:'47M · Asymptomatic',svg:'npdc_rec',
   vig:'A <strong>47-year-old male</strong> presents for a routine dental check. Periapical radiograph of the maxillary anterior region shows a <strong>well-defined, oval radiolucency in the midline anterior maxilla</strong> between the central incisors, measuring approximately <strong>9mm</strong>. Borders are smooth and corticated. Both central incisors respond normally to cold EPT. The patient reports no pain, swelling, or drainage.',
   finds:[{t:'Midline radiolucency 9mm',c:'radio'},{t:'Corticated borders',c:'radio'},{t:'Between central incisors',c:'radio'},{t:'Vital centrals (EPT+)',c:'clinical'},{t:'Asymptomatic',c:'clinical'}],
   ans:'Nasopalatine Duct Cyst',opts:['Periapical Granuloma','Nasopalatine Duct Cyst','Radicular Cyst','Globulomaxillary Cyst'],
   correct:'Midline anterior maxillary radiolucency >6mm with vital adjacent teeth = Nasopalatine Duct Cyst. The 9mm size exceeds the normal incisive fossa threshold (6mm). Vital EPT on both centrals excludes radicular cyst. Location in the incisive canal midline is pathognomonic.',
   wrong:'Radicular cyst requires a non-vital tooth — both centrals are vital. Periapical granuloma is at the apex of a non-vital tooth. Globulomaxillary cyst is an outdated term — most lesions described in that position are OKC or LPC, not a distinct entity.',
   reasoning:[{k:'Midline position',v:'match',t:'✓ NPDC lives in the incisive canal — always midline'},{k:'>6mm (9mm)',v:'match',t:'✓ Exceeds normal incisive fossa — biopsy threshold met'},{k:'Both centrals vital',v:'match',t:'✓ Excludes radicular cyst (requires non-vital tooth)'},{k:'Corticated borders',v:'match',t:'✓ Slow-growing developmental cyst — chronic'},{k:'Asymptomatic',v:'match',t:'✓ Classic NPDC presentation'},{k:'Why not RC?',v:'err',t:'RC requires non-vital tooth — EPT+ centrals exclude it'},{k:'Treatment',v:'match',t:'Enucleation via palatal approach'}]},

  // ── CASE 18: NPDC TRAP — NPDC vs. Radicular Cyst ──────────────────────────
  {n:18,badge:'Periapical · Anterior Maxilla',badge2:'38F · Post-Trauma',svg:'npdc_rc_trap',
   vig:'A <strong>38-year-old female</strong> presents with a midline anterior maxillary radiolucency measuring 8mm on periapical radiograph — oval, well-defined, corticated. She has a history of facial trauma 6 years ago involving the maxillary front teeth. The <strong>left central incisor does not respond to cold EPT</strong>. The right central responds normally.',
   finds:[{t:'Midline radiolucency 8mm',c:'radio'},{t:'Corticated borders',c:'radio'},{t:'Left central: no EPT response',c:'clinical'},{t:'Right central: EPT positive',c:'clinical'},{t:'Trauma history 6 years',c:'clinical'}],
   ans:'Radicular Cyst',opts:['Nasopalatine Duct Cyst','Radicular Cyst','Nasolabial Cyst','Median Palatine Cyst'],
   correct:'Left central incisor is non-vital (no EPT response) following trauma 6 years ago. A midline radiolucency associated with a non-vital tooth = radicular cyst until proven otherwise — even if the location superficially resembles NPDC. The non-vital tooth pivots the entire diagnosis.',
   wrong:'NPDC requires vital adjacent teeth — the non-vital left central excludes it as the primary diagnosis. The 8mm size and midline position are consistent with both entities, but vitality testing is the decisive separator.',
   reasoning:[{k:'Left central non-vital (EPT-)',v:'err',t:'Non-vital tooth = radicular cyst, not NPDC'},{k:'Trauma history × 6 years',v:'match',t:'✓ Classic mechanism for pulpal necrosis → radicular cyst'},{k:'Midline position',v:'warn',t:'Can be either NPDC or radicular — vitality decides'},{k:'8mm size',v:'warn',t:'Exceeds NPDC threshold but does not change the DDx pivot'},{k:'Why not NPDC?',v:'err',t:'NPDC requires vital teeth — non-vital left central excludes it'},{k:'Treatment',v:'match',t:'RCT left central first; enucleation if cyst persists'}]},

  // ── CASE 19: NASOLABIAL CYST RECOGNITION ───────────────────────────────────
  {n:19,badge:'Clinical Exam · Nasal Base',badge2:'44F · Left Nasal Fullness',svg:'nla_rec',
   vig:'A <strong>44-year-old female</strong> presents with a 4-month history of left nasal fullness and obliteration of the left nasolabial fold. Clinical exam reveals a <strong>soft, fluctuant swelling at the base of the left nasal ala</strong>. She has no pain or drainage. Panoramic and periapical radiographs of the maxillary anterior region are <strong>completely normal</strong>. Adjacent teeth are vital.',
   finds:[{t:'Normal panoramic + periapical',c:'radio'},{t:'Soft fluctuant swelling',c:'clinical'},{t:'Left nasal ala base',c:'clinical'},{t:'Nasolabial fold obliterated',c:'clinical'},{t:'Vital adjacent teeth',c:'clinical'}],
   ans:'Nasolabial Cyst',opts:['Nasopalatine Duct Cyst','Nasolabial Cyst','Periapical Abscess','Mucocele'],
   correct:'Soft tissue swelling at nasal ala base + obliterated nasolabial fold + completely normal radiographs = Nasolabial Cyst. The key diagnostic point: nasolabial cyst is purely a soft tissue lesion — it has NO intraosseous component and NO radiographic finding. The normal X-ray is part of the diagnosis, not a failure.',
   wrong:'NPDC shows an intraosseous radiolucency — this patient has a normal X-ray. Periapical abscess requires a non-vital tooth and typically shows a periapical bony change. Mucocele is a salivary gland lesion — typically intraoral, not at the nasal base.',
   reasoning:[{k:'Normal radiograph',v:'match',t:'✓ Nasolabial cyst is purely soft tissue — no bone lesion'},{k:'Nasal ala location',c:'match',t:'✓ Pathognomonic position for nasolabial cyst'},{k:'Nasolabial fold obliteration',v:'match',t:'✓ Classic clinical sign — fold lifted by cyst'},{k:'Soft, fluctuant',v:'match',t:'✓ Cystic consistency confirms non-solid nature'},{k:'Why not NPDC?',v:'err',t:'NPDC is intraosseous — would show midline radiolucency'},{k:'Treatment',v:'match',t:'Sublabial surgical excision — excellent prognosis'}]},

  // ── CASE 20: NASOLABIAL CYST TRAP — Nasolabial vs. RC ─────────────────────
  {n:20,badge:'Clinical + Periapical · Left Maxilla',badge2:'51F · Left Nasal Base Pain',svg:'nla_trap',
   vig:'A <strong>51-year-old female</strong> presents with left nasal base pain and swelling for 3 weeks. She reports the area was previously asymptomatic until recently. Periapical X-ray ordered by the referring dentist shows a <strong>periapical radiolucency at the apex of the maxillary left lateral incisor</strong>, with a separate, subtle soft tissue density at the nasal ala noted on CT. The lateral incisor does not respond to cold EPT.',
   finds:[{t:'Periapical radiolucency — lateral incisor',c:'radio'},{t:'Non-vital lateral incisor (EPT-)',c:'clinical'},{t:'Soft tissue nasal ala density (CT)',c:'radio'},{t:'Acute pain 3 weeks',c:'clinical'}],
   ans:'Radicular Cyst',opts:['Nasolabial Cyst','Radicular Cyst','Both (concurrent lesions)','NPDC'],
   correct:'The non-vital lateral incisor with a periapical radiolucency is a radicular cyst. The soft tissue finding on CT represents secondary inflammation or a concurrent (incidental) nasolabial cyst — but the primary diagnosis is the periapical lesion driven by the non-vital tooth. Treat the tooth first. The CT soft tissue finding may be resolved or evaluated separately.',
   wrong:'Nasolabial cyst is strictly soft tissue with no bone lesion — the periapical radiolucency here is clearly associated with a non-vital tooth. Both lesions can coexist, but the clinical urgency and primary pathology is the radicular cyst driving the acute pain.',
   reasoning:[{k:'Periapical radiolucency',v:'match',t:'✓ At apex of non-vital lateral incisor = radicular cyst'},{k:'Non-vital lateral incisor',v:'match',t:'✓ Required for radicular cyst diagnosis'},{k:'Soft tissue CT finding',v:'warn',t:'May be concurrent nasolabial cyst — evaluate separately'},{k:'Acute pain',v:'match',t:'✓ Infected radicular cyst or periapical abscess'},{k:'Treatment',v:'match',t:'RCT lateral incisor first; re-evaluate soft tissue finding after'},{k:'Lesson',v:'warn',t:'Concurrent lesions exist — treat the primary pathology first'}]},

  // ── CASE 21: DERMOID/EPIDERMOID RECOGNITION ────────────────────────────────
  {n:21,badge:'Clinical · Floor of Mouth',badge2:'22M · Midline Floor Mass',svg:'derm_rec',
   vig:'A <strong>22-year-old male</strong> presents with a 6-month history of a slowly enlarging midline floor-of-mouth mass. Clinical exam reveals a <strong>soft, "doughy" midline submental swelling</strong> below the chin, and a corresponding intraoral elevation of the floor of mouth pushing the tongue upward. Transillumination is negative. The patient has no pain, fever, or lymphadenopathy.',
   finds:[{t:'Midline submental swelling',c:'clinical'},{t:'"Doughy" palpation quality',c:'clinical'},{t:'Intraoral floor elevation',c:'clinical'},{t:'Negative transillumination',c:'clinical'},{t:'Slow-growing, 6 months',c:'clinical'}],
   ans:'Dermoid/Epidermoid Cyst',opts:['Ranula','Dermoid/Epidermoid Cyst','Thyroglossal Duct Cyst','Ludwig\'s Angina'],
   correct:'Midline floor-of-mouth mass with doughy palpation quality, negative transillumination, and slow growth = Dermoid/Epidermoid Cyst. The "doughy" consistency is the clinical tell — sebaceous content doesn\'t spring back. Ranula is fluctuant with a bluish tinge and transilluminates. Ludwig\'s is acute and board-like, not chronic and soft.',
   wrong:'Ranula has a characteristic bluish tinge, fluctuant spring-back on palpation, and transilluminates. TDC is a midline neck mass that moves with tongue protrusion — not a submental floor mass. Ludwig\'s angina is an acute bilateral infection — not a 6-month slow-growing mass.',
   reasoning:[{k:'"Doughy" palpation',v:'match',t:'✓ Sebaceous content = dermoid cyst — doesn\'t spring back'},{k:'Midline floor of mouth',v:'match',t:'✓ Classic dermoid/epidermoid location'},{k:'Negative transillumination',v:'match',t:'✓ Thick contents don\'t transmit light (unlike ranula)'},{k:'Slow-growing, 6 months',v:'match',t:'✓ Developmental cyst — always slow'},{k:'Why not ranula?',v:'err',t:'Ranula: bluish, thin-walled, springs back, transilluminates'},{k:'Treatment',v:'match',t:'Excision — sublingual or submental approach based on mylohyoid position'}]},

  // ── CASE 22: DERMOID TRAP — Below vs. Above Mylohyoid ─────────────────────
  {n:22,badge:'Clinical · Floor of Mouth + Neck',badge2:'28F · Visible Neck Mass',svg:'derm_trap',
   vig:'A <strong>28-year-old female</strong> presents with a visible neck mass below the chin that has been present for 2 years and is slowly growing. Intraorally, no floor-of-mouth swelling is noted. Externally: a soft, midline, <strong>doughy submental mass</strong> is palpable, approximately 3.5cm. It does not move with tongue protrusion or swallowing. MRI confirms a midline cystic mass below the mylohyoid muscle with internal debris signal.',
   finds:[{t:'Submental doughy mass 3.5cm',c:'clinical'},{t:'Below mylohyoid (MRI)',c:'radio'},{t:'No intraoral component',c:'clinical'},{t:'Does NOT move with swallowing',c:'clinical'},{t:'Internal debris signal (MRI)',c:'radio'}],
   ans:'Dermoid/Epidermoid Cyst',opts:['Thyroglossal Duct Cyst','Dermoid/Epidermoid Cyst','Lymphoepithelial Cyst','Submental Abscess'],
   correct:'Midline doughy submental mass below the mylohyoid on MRI, with internal debris (keratinous/sebaceous), that does NOT move with swallowing = Dermoid cyst. Below the mylohyoid = submental presentation. TDC is attached to the tongue base and moves with swallowing — this does not.',
   wrong:'TDC moves superiorly with tongue protrusion — this mass is fixed. Cervical LEC is lateral, not midline. Submental abscess is acute, febrile, painful, board-like — not a 2-year slow-growing doughy mass.',
   reasoning:[{k:'Below mylohyoid on MRI',v:'match',t:'✓ Submental dermoid — external approach required'},{k:'Does not move with swallowing',v:'match',t:'✓ Not attached to tongue base — excludes TDC'},{k:'Midline position',v:'match',t:'✓ Dermoid is always midline (embryonic fusion line)'},{k:'Internal debris on MRI',v:'match',t:'✓ Keratinous/sebaceous content = dermoid'},{k:'Why not TDC?',v:'err',t:'TDC moves with swallowing — dermoid is fixed'},{k:'Treatment',v:'match',t:'External submental excision — complete capsule removal'}]},

  // ── CASE 23: THYROGLOSSAL DUCT CYST RECOGNITION ────────────────────────────
  {n:23,badge:'Clinical · Midline Neck',badge2:'9M · Growing Neck Mass',svg:'thyro_rec',
   vig:'A <strong>9-year-old male</strong> is referred by his pediatrician for evaluation of a midline neck mass that has been present for 8 months and is growing. Exam reveals a <strong>3cm, soft, fluctuant midline mass</strong> at the level of the hyoid bone. The mass <strong>moves superiorly when the patient sticks out his tongue</strong>. There is no tenderness or erythema. Thyroid ultrasound is not yet performed.',
   finds:[{t:'Midline neck mass 3cm',c:'clinical'},{t:'Hyoid level',c:'clinical'},{t:'Moves with tongue protrusion',c:'clinical'},{t:'Soft, fluctuant',c:'clinical'},{t:'Child patient (9yo)',c:'clinical'},{t:'No thyroid ultrasound yet',c:'clinical'}],
   ans:'Thyroglossal Duct Cyst',opts:['Lymphoepithelial Cyst','Thyroglossal Duct Cyst','Dermoid Cyst','Cervical Lymphadenopathy'],
   correct:'Midline neck mass at hyoid level that moves superiorly with tongue protrusion = TDC. This is pathognomonic. No other neck mass has this movement. In a child, TDC is the most common congenital neck mass. Critical next step before surgery: thyroid ultrasound to confirm a separately descended thyroid gland.',
   wrong:'LEC (branchial cleft) is lateral, not midline. Dermoid does not move with tongue protrusion. Cervical lymphadenopathy is a node — multiple, firm, tender, reactive — not a midline fluctuant cystic mass.',
   reasoning:[{k:'Moves with tongue protrusion',v:'match',t:'✓ Pathognomonic for TDC — no other neck mass does this'},{k:'Midline position',v:'match',t:'✓ TDC is always midline (from foramen cecum to thyroid)'},{k:'Hyoid level',v:'match',t:'✓ Most common TDC location (subhyoid 65%)'},{k:'Child patient',v:'match',t:'✓ Most common congenital neck mass in children'},{k:'⚠️ No thyroid ultrasound done',v:'warn',t:'CRITICAL pre-op step — must confirm separate thyroid before Sistrunk'},{k:'Treatment',v:'match',t:'Sistrunk procedure after thyroid confirmation — cyst + tract + central hyoid'}]},

  // ── CASE 24: TDC TRAP — Pre-op Thyroid Verification ──────────────────────
  {n:24,badge:'Clinical + Imaging · Midline Neck',badge2:'14F · Midline Neck Cyst',svg:'thyro_trap',
   vig:'A <strong>14-year-old female</strong> is scheduled for Sistrunk procedure for a confirmed TDC. Pre-op workup: surgeon orders thyroid ultrasound. <strong>Ultrasound shows no separately descended thyroid gland in the normal anatomic position.</strong> The radiologist notes the cystic mass itself contains tissue with thyroid signal. The surgeon reassesses.',
   finds:[{t:'TDC confirmed on imaging',c:'radio'},{t:'No separate thyroid on ultrasound',c:'radio'},{t:'Thyroid signal inside cyst',c:'radio'},{t:'14-year-old female',c:'clinical'},{t:'Sistrunk planned',c:'clinical'}],
   ans:'Thyroglossal Duct Cyst',opts:['Proceed with Sistrunk as planned','Thyroglossal Duct Cyst','Cancel surgery — observe only','Dermoid Cyst'],
   correct:'The diagnosis is still TDC — but this is the 1% scenario where the TDC contains the patient\'s only thyroid tissue. The correct answer is NOT to proceed with Sistrunk as planned. Endocrinology consult and thyroid function testing are required first. Any plan to remove the cyst must account for the ectopic thyroid — or the patient will be permanently hypothyroid.',
   wrong:'Proceeding with Sistrunk without addressing the ectopic thyroid = permanent hypothyroidism. This is a never-event. The absence of a separately descended thyroid changes the surgical plan entirely — not the diagnosis, but the management.',
   reasoning:[{k:'TDC diagnosis confirmed',v:'match',t:'✓ Still TDC — diagnosis unchanged'},{k:'No separate thyroid found',v:'err',t:'⚠️ TDC contains only thyroid tissue — do NOT excise without endocrinology'},{k:'Thyroid signal inside cyst',v:'err',t:'Ectopic thyroid in TDC — 1% scenario, but real'},{k:'Next step',v:'match',t:'Endocrinology consult + TSH/T4 labs before any surgery'},{k:'Surgical options',v:'match',t:'Thyroid preservation in situ, partial excision, or suppression — specialist decision'},{k:'The lesson',v:'warn',t:'Thyroid ultrasound pre-op is MANDATORY — this scenario is why'}]},

  // ── CASE 25: STAFNE RECOGNITION ────────────────────────────────────────────
  {n:25,badge:'Panoramic · Right Posterior Mandible',badge2:'58M · Routine Panoramic',svg:'staf_rec',
   vig:'A <strong>58-year-old male</strong> presents for a routine dental evaluation. A panoramic radiograph reveals a <strong>well-defined, oval radiolucency</strong> in the right posterior mandible between the second and third molar regions. The lesion measures approximately 2.4cm, has smooth corticated borders, and is located <strong>clearly below the inferior alveolar nerve canal</strong>. The patient is asymptomatic. Adjacent teeth are vital. He has no history of jaw pathology, jaw surgery, or trauma.',
   finds:[{t:'Well-defined oval RL 2.4cm',c:'radio'},{t:'BELOW IAN canal',c:'radio'},{t:'Corticated, smooth borders',c:'radio'},{t:'Vital adjacent teeth',c:'clinical'},{t:'Asymptomatic',c:'clinical'},{t:'No prior pathology',c:'clinical'}],
   ans:'Stafne Bone Defect',opts:['Residual Cyst','Stafne Bone Defect','Odontogenic Keratocyst','Central Giant Cell Granuloma'],
   correct:'Well-defined radiolucency BELOW the inferior alveolar nerve canal = Stafne Bone Defect until proven otherwise. This single anatomic position separates it from every true jaw pathology. No treatment needed. Confirm with MRI (salivary signal) if uncertain, or serial panoramic (static). No biopsy required.',
   wrong:'Residual cyst, OKC, and CGCG are all ABOVE the IAN canal. The critical distinguishing factor here is the anatomic position of the lesion. Below the IAN is Stafne until the MRI proves otherwise.',
   reasoning:[{k:'Below IAN canal',v:'match',t:'✓ The single defining anatomic rule — no true pathology is below the IAN'},{k:'Corticated borders',v:'match',t:'✓ Slow-forming, non-aggressive — developmental'},{k:'2.4cm',v:'warn',t:'Size is typical for Stafne — doesn\'t change the diagnosis'},{k:'Asymptomatic, incidental',v:'match',t:'✓ Classic Stafne presentation'},{k:'Why not OKC?',v:'err',t:'OKC is ABOVE the IAN canal — always'},{k:'Confirmation',v:'match',t:'MRI: salivary T1 signal confirms; serial panoramic: static confirms'},{k:'Treatment',v:'match',t:'None required — document, educate patient, close case'}]},

  // ── CASE 26: STAFNE TRAP — Stafne vs. Ameloblastoma ──────────────────────
  {n:26,badge:'Panoramic · Left Posterior Mandible',badge2:'52F · Jaw Pain',svg:'staf_trap',
   vig:'A <strong>52-year-old female</strong> presents with vague left jaw discomfort. Panoramic shows a <strong>3.2cm, well-defined radiolucency</strong> in the left posterior mandible. The referring dentist noted it looks suspicious for ameloblastoma. Review of the panoramic with careful attention to the IAN canal shows the lesion is <strong>located at the inferior border of the IAN canal</strong> — it is ambiguous whether the lesion is above or below the nerve. CT is ordered.',
   finds:[{t:'Well-defined RL 3.2cm',c:'radio'},{t:'Left posterior mandible',c:'radio'},{t:'Ambiguous IAN relationship (panoramic)',c:'radio'},{t:'CT ordered',c:'clinical'},{t:'Vague jaw discomfort',c:'clinical'}],
   ans:'Stafne Bone Defect',opts:['Ameloblastoma','Stafne Bone Defect','OKC','Residual Cyst'],
   correct:'CT confirms the lesion is on the lingual cortex, below the IAN canal, with salivary gland signal filling the defect on MRI — confirming Stafne Bone Defect. The vague discomfort was unrelated (unilateral temporomandibular pain on further workup). This case illustrates that when panoramic is ambiguous, CT/MRI resolves the IAN position question definitively before any biopsy is considered.',
   wrong:'Ameloblastoma would show cortical expansion, possible multilocularity, and CBCT would show it expanding above the IAN canal with cortical thinning — this CT showed a cortical depression on the lingual surface below the IAN with salivary contents.',
   reasoning:[{k:'CT: lingual cortical depression',v:'match',t:'✓ Confirms Stafne architecture — no periosteal reaction'},{k:'Below IAN on CT',v:'match',t:'✓ Resolves the panoramic ambiguity — confirms Stafne'},{k:'MRI: salivary signal',v:'match',t:'✓ Pathognomonic — closes the case'},{k:'No cortical expansion',v:'match',t:'✓ Ameloblastoma expands cortex — Stafne does not'},{k:'Vague pain was unrelated',v:'warn',t:'Stafne is always asymptomatic — pain was TMJ on further workup'},{k:'Lesson',v:'match',t:'When panoramic is ambiguous for IAN position → CT before biopsy'}]},

  // ── CASE 27: LYMPHOEPITHELIAL CYST RECOGNITION ─────────────────────────────
  {n:27,badge:'Clinical · Floor of Mouth',badge2:'34M · Incidental Yellow Nodule',svg:'lymp_rec',
   vig:'A <strong>34-year-old male</strong> presents for a new patient exam. During intraoral inspection, you find a <strong>small, yellowish, submucosal nodule</strong> on the floor of the mouth, approximately <strong>8mm</strong> in diameter. It is soft, non-tender, non-fluctuant, and has been present for "at least a year." The patient is otherwise healthy. Panoramic radiograph is <strong>within normal limits</strong>. The nodule does not trans-illuminate brightly.',
   finds:[{t:'Yellow submucosal nodule',c:'clinical'},{t:'Floor of mouth, 8mm',c:'clinical'},{t:'Soft, non-tender',c:'clinical'},{t:'Stable ≥1 year',c:'clinical'},{t:'Normal panoramic',c:'radio'},{t:'No bone involvement',c:'radio'}],
   ans:'Lymphoepithelial Cyst',opts:['Mucocele','Lymphoepithelial Cyst','Dermoid Cyst','Lipoma'],
   correct:'Small, yellowish, submucosal, stable floor-of-mouth nodule with a normal panoramic radiograph = oral lymphoepithelial cyst. The yellow color comes from keratin debris accumulating in the cyst lumen behind the lymphoid wall. Mucocele would be translucent blue and fluctuant. Dermoid would be midline and larger. Lipoma would be softer and paler.',
   wrong:'Mucocele is the most common mistake — but mucocele is translucent blue, fluctuant, and typically on the lower lip. LEC is yellow-white, floor of mouth or ventral tongue, and histology shows lymphoid follicles in the wall — that\'s the pathognomonic feature.',
   reasoning:[{k:'Yellow color',v:'match',t:'✓ Keratin in cyst lumen — LEC hallmark'},{k:'Floor of mouth location',v:'match',t:'✓ Classic LEC oral site: floor of mouth, ventral tongue, soft palate'},{k:'Normal X-ray',v:'match',t:'✓ Soft tissue only — no bone involvement'},{k:'Stable ≥1 year',v:'match',t:'✓ LEC grows slowly — months to years history typical'},{k:'Why not Mucocele?',v:'warn',t:'Mucocele = translucent blue, fluctuant, lower lip — not yellow, floor of mouth'},{k:'Why not Dermoid?',v:'warn',t:'Dermoid = midline, doughy, larger — LEC is lateral and smaller'},{k:'Histology confirms',v:'match',t:'Lymphoid follicles with germinal centers in wall = pathognomonic LEC'}]},

  // ── CASE 28: LYMPHOEPITHELIAL TRAP — CERVICAL LEC vs. NECK NODE ────────────
  {n:28,badge:'Clinical · Lateral Neck',badge2:'26M · Growing Lateral Neck Mass',svg:'lymp_trap',
   vig:'A <strong>26-year-old male</strong> presents referred by his PCP for a <strong>2.8cm, soft, fluctuant, lateral neck mass</strong> at the anterior border of the sternocleidomastoid muscle. It has grown slowly over 4 months. He has no fever, no night sweats, no weight loss. No smoking, no alcohol. Oral exam is unremarkable. PCP note reads: <strong>"rule out metastatic SCC vs. lymphoma."</strong> CT neck shows a cystic mass, no solid components.',
   finds:[{t:'Lateral neck mass 2.8cm',c:'clinical'},{t:'Anterior SCM border',c:'clinical'},{t:'Soft, fluctuant, cystic on CT',c:'clinical'},{t:'4-month slow growth',c:'clinical'},{t:'No systemic symptoms',c:'clinical'},{t:'Normal oral exam',c:'clinical'}],
   ans:'Lymphoepithelial Cyst',opts:['Metastatic SCC (cystic)','Lymphoepithelial Cyst','Branchial Cleft Cyst','Reactive Lymph Node'],
   correct:'A 26-year-old with no smoking/alcohol history, no oral lesion, purely cystic lateral neck mass, and no systemic symptoms = cervical lymphoepithelial cyst (branchial cleft origin). FNA showing cystic squamous cells in a lymphoid background confirms benign LEC. Metastatic cystic SCC occurs in older patients with risk factors and a primary oral/oropharyngeal lesion. The critical step here is FNA before excision.',
   wrong:'Metastatic cystic SCC is the critical trap — HPV-associated oropharyngeal SCC can present as a cystic lateral neck mass in a young adult. The correct workup is FNA first, then tonsillectomy/panendoscopy if atypical cells are found. Never excise a lateral neck cyst in an adult without FNA — you may violate surgical planes around an occult primary.',
   reasoning:[{k:'Age 26, no risk factors',v:'match',t:'✓ Favors benign LEC — SCC met requires tobacco/alcohol or HPV exposure'},{k:'Purely cystic on CT',v:'match',t:'✓ Benign cysts are purely cystic — mets often have solid nodules'},{k:'Anterior SCM border',v:'match',t:'✓ Classic branchial/LEC position — posterior triangle suggests lymphoma'},{k:'No systemic symptoms',v:'match',t:'✓ No B-symptoms → argues against lymphoma'},{k:'Normal oral exam',v:'match',t:'✓ No primary lesion found — further supports benign'},{k:'Critical step',v:'warn',t:'FNA FIRST — cystic squamous + lymphoid = LEC; atypical squamous = workup for SCC primary'},{k:'Never excise first',v:'err',t:'Excising without FNA risks violating surgical planes if SCC met — catastrophic'}]},

];

// Merge Module 2 cases into main CASES array
CASES.push(...CASES_M2);

// Merge Module 2 CASE_META
Object.assign(CASE_META, {
  17: {type:'recognition', cond:'Nasopalatine Duct Cyst',      label:'NPDC'},
  18: {type:'trap',        cond:'NPDC vs. Radicular Cyst',     label:'NPDC'},
  19: {type:'recognition', cond:'Nasolabial Cyst',             label:'NLA'},
  20: {type:'trap',        cond:'Nasolabial vs. Radicular',    label:'NLA'},
  21: {type:'recognition', cond:'Dermoid/Epidermoid Cyst',     label:'Derm'},
  22: {type:'trap',        cond:'Dermoid — Below Mylohyoid',   label:'Derm'},
  23: {type:'recognition', cond:'Thyroglossal Duct Cyst',      label:'TDC'},
  24: {type:'trap',        cond:'TDC — Ectopic Thyroid',       label:'TDC'},
  25: {type:'recognition', cond:'Stafne Bone Defect',          label:'Staf'},
  26: {type:'trap',        cond:'Stafne vs. Ameloblastoma',    label:'Staf'},
  27: {type:'recognition', cond:'Lymphoepithelial Cyst',       label:'LEC'},
  28: {type:'trap',        cond:'LEC — Cervical vs. SCC Met',  label:'LEC'},
});

// Track per-case results for results screen
let trResults = [];
let trConf = [];  // 'lo'|'md'|'hi' per case

function saveProgress(){
  try {
    localStorage.setItem('chri_tr', JSON.stringify({
      tr, trResults, trConf, ts: Date.now()
    }));
  } catch(e){}
}

function loadProgress(){
  try {
    const raw = localStorage.getItem('chri_tr');
    if(!raw) return;
    const d = JSON.parse(raw);
    // Only restore if same session day (within 24h)
    if(d.ts && Date.now() - d.ts < 86400000){
      if(d.tr) tr = d.tr;
      if(Array.isArray(d.trResults)) trResults = d.trResults;
      if(Array.isArray(d.trConf)) trConf = d.trConf;
    }
  } catch(e){}
}

function renderTrainer(caseOverride, wrapOverride){
  const wrap = wrapOverride || document.getElementById('pathScreen');
  const activeCases = caseOverride || CASES;
  if(tr.done){ _renderResults(wrap); return; }
  const tc = activeCases[tr.case];
  const meta = CASE_META[tc.n] || {type:'recognition', cond:'Unknown', label:'?'};
  const prog = (tr.case / activeCases.length * 100).toFixed(0);

  const dots = CASES.map((c,i)=>{
    let cls = 't-dot';
    if(i < tr.case)      cls += trResults[i] ? ' done-correct' : ' done-wrong';
    else if(i===tr.case) cls += ' current';
    return `<div class="${cls}" title="Case ${c.n}"></div>`;
  }).join('');

  const typeLabel = {trap:'⚠ DDx Trap', pediatric:'Pediatric Case', recognition:'Recognition'}[meta.type] || 'Recognition';
  const typeCls = meta.type || 'recognition';

  wrap.innerHTML = `
  <div class="trainer-screen">
    <div class="trainer-inner">

      <div class="t-eyebrow">Pathology · Diagnosis Trainer</div>
      <div class="t-title">Commit Before the Reveal</div>
      <div class="t-sub">Read the case. Lock in your diagnosis. See exactly where your reasoning holds — or breaks.</div>

      <div class="t-prog-wrap">
        <div class="t-prog">
          <div class="t-prog-lbl">Case ${tc.n} of ${CASES.length}</div>
          <div class="t-prog-track"><div class="t-prog-fill" id="tProgFill" style="width:0"></div></div>
          <div class="t-score" id="tScore">${tr.correct} correct</div>
        </div>
        <div class="t-dots">${dots}</div>
      </div>

      <div class="case-type-strip">
        <span class="case-type-badge ${typeCls}">${typeLabel}</span>
        <span class="case-cond-tag">· ${meta.cond}</span>
      </div>

      <div class="case-card">
        <div class="xray-panel">
          <div class="xray-badge">${tc.badge}</div>
          <div class="xray-badge2">${tc.badge2}</div>
          ${xSvg(tc.svg)}
        </div>
        <div class="case-body">
          <div class="case-lbl">Clinical Vignette — Case ${tc.n}</div>
          <div class="case-vig">${tc.vig}</div>

          <div class="finds-hdr">Key Findings</div>
          <div class="finds-row">
            ${tc.finds.map(f=>`<div class="find ${f.c}"><div class="fd"></div>${f.t}</div>`).join('')}
          </div>

          <div class="conf-section">
            <div class="conf-lbl-row"><span class="conf-label-txt">Your confidence before answering</span></div>
            <div class="conf-row">
              <span class="conf-btn" onclick="setConf(this,'lo')">🤔 Not sure</span>
              <span class="conf-btn" onclick="setConf(this,'md')">🙂 Fairly sure</span>
              <span class="conf-btn" onclick="setConf(this,'hi')">✓ Very sure</span>
            </div>
          </div>

          <div class="ans-section-lbl">Select your diagnosis</div>
          <div class="ans-grid" id="ansGrid">
            ${tc.opts.map(o=>`<div class="ans-opt" onclick="pickAns(this,'${o.replace(/'/g,"\\'")}','${tc.ans.replace(/'/g,"\\'")}');return false;">${o}</div>`).join('')}
          </div>

          <div class="reveal-sec" id="revealSec">
            <div class="result-banner" id="resBanner">
              <div class="rb-ico" id="rbIco"></div>
              <div style="flex:1">
                <div class="rb-title" id="rbTitle"></div>
                <div class="rb-body" id="rbBody"></div>
              </div>
            </div>
            <div class="reasoning">
              <div class="reason-hdr">Clinical Reasoning</div>
              <div id="rRows"></div>
            </div>
            <div class="study-nudge" onclick="showCond('${tc.svg}','study')">
              <div class="study-nudge-ico">📖</div>
              <div class="study-nudge-txt">Review the full <strong>${meta.cond}</strong> lesson — diagrams, logic chain, traps</div>
              <div class="study-nudge-arrow">→</div>
            </div>
          </div>

          <div class="t-btns" id="tBtns" style="display:none;">
            <button class="t-btn ghost" onclick="setMode('study')">← Study Notes</button>
            <button class="t-btn primary" id="nextBtn" onclick="nextCase()">Next Case →</button>
          </div>
        </div>
      </div>

    </div>
  </div>`;

  requestAnimationFrame(()=>{
    const fill = document.getElementById('tProgFill');
    if(fill) setTimeout(()=>{ fill.style.width = prog+'%'; }, 60);
  });
}

function _renderResults(wrap){
  const pct = Math.round(tr.correct / CASES.length * 100);
  const grade = pct===100?'Perfect run.':pct>=80?'Strong performance.':pct>=60?'Solid foundation — review your misses.':'Keep studying — the reasoning breakdowns show exactly where to focus.';

  const condMap = {};
  CASES.forEach((c,i)=>{
    const lbl=(CASE_META[c.n]||{}).label||'?';
    if(!condMap[lbl]) condMap[lbl]={correct:0,total:0,id:(CASE_META[c.n]||{}).cond};
    condMap[lbl].total++;
    if(trResults[i]) condMap[lbl].correct++;
  });

  const condRows = Object.entries(condMap).map(([lbl,d])=>{
    const cls = d.correct===d.total?'all-correct':d.correct===0?'all-wrong':'some-wrong';
    const ico = d.correct===d.total?'✓':d.correct===0?'✗':'~';
    return `<div class="rb-cond-row">
      <div class="rb-cond-name">${d.id||lbl}</div>
      <div class="rb-cond-score ${cls}">${ico} ${d.correct}/${d.total}</div>
    </div>`;
  }).join('');

  const missed = CASES.filter((_,i)=>!trResults[i]);
  const missedConds = [...new Set(missed.map(c=>(CASE_META[c.n]||{}).cond))];
  const trapsMissed = missed.filter(c=>(CASE_META[c.n]||{}).type==='trap').length;

  let insight = '';
  if(pct===100){
    insight='You identified every condition correctly and navigated every trap. Your diagnostic reasoning is precise.';
  } else if(trapsMissed>0 && trapsMissed===missed.length){
    insight=`Perfect on recognition — only the traps caught you. That\'s a specific pattern: when presentations are ambiguous, your confidence outruns your DDx precision. Focus on <strong>${missedConds.slice(0,2).join(' and ')}</strong>.`;
  } else if(missedConds.length>0){
    insight=`Weak spots this session: <strong>${missedConds.slice(0,3).join(', ')}</strong>. Open each condition\'s study page and read the trap cards — that\'s where the reasoning broke down.`;
  } else {
    insight='Strong session. Keep building on this pattern.';
  }

  const scoreColor = pct===100?'var(--green)':pct>=80?'var(--blue)':pct>=60?'var(--amber)':'var(--red)';

  wrap.innerHTML=`
  <div class="trainer-screen">
    <div class="trainer-inner">
      <div class="results-screen">
        <div class="t-eyebrow">Trainer Complete</div>
        <div class="tc-score" style="color:${scoreColor}">${tr.correct}<span style="font-size:36px;color:var(--tx3)">/${CASES.length}</span></div>
        <div class="tc-pct">${pct}% accuracy</div>
        <div class="tc-lbl">${grade}</div>

        <div class="score-bd">
          <div class="sbi"><div class="sbi-num" style="color:var(--green)">${tr.correct}</div><div class="sbi-lbl">Correct</div></div>
          <div class="sbi"><div class="sbi-num" style="color:var(--red)">${CASES.length-tr.correct}</div><div class="sbi-lbl">Missed</div></div>
          <div class="sbi"><div class="sbi-num" style="color:${scoreColor}">${pct}%</div><div class="sbi-lbl">Accuracy</div></div>
        </div>

        <div class="results-breakdown">
          <div class="rb-section-hdr">By Condition</div>
          ${condRows}
        </div>

        <div class="insight-card">
          <div class="insight-card-hdr">⚡ Session Insight</div>
          <div class="insight-card-txt">${insight}</div>
        </div>

        <div class="results-btns">
          <button class="t-btn ghost" onclick="resetTrainer()">↺ Retry All Cases</button>
          <button class="t-btn ghost" onclick="setMode('study')">Study Notes →</button>
          <button class="t-btn primary" onclick="goScreen('progress',document.getElementById('sbProgress'))">View Progress →</button>
        </div>
      </div>
    </div>
  </div>`;
}

function pickAns(el, chosen, correct){
  if(tr.answered) return;
  tr.answered = true;
  const tc = CASES[tr.case];
  const ok = chosen === correct;
  if(ok) tr.correct++;
  trResults[tr.case] = ok;

  document.querySelectorAll('.ans-opt').forEach(o=>{
    o.onclick = null;
    const t = o.textContent.trim();
    if(t === chosen) o.classList.add(ok ? 'correct' : 'wrong');
    if(t === correct && !ok) o.classList.add('reveal');
  });

  const b = document.getElementById('resBanner');
  b.className = `result-banner ${ok ? 'correct' : 'wrong'}`;
  document.getElementById('rbIco').textContent = ok ? '✅' : '❌';
  document.getElementById('rbTitle').textContent = ok ? `Correct — ${correct}` : `Not quite — ${correct}`;
  document.getElementById('rbBody').textContent = ok ? tc.correct : tc.wrong;

  const rIcos = {match:'✓',warn:'⚠',err:'✗'};
  document.getElementById('rRows').innerHTML = tc.reasoning.map(r=>`
    <div class="r-row">
      <div class="r-ico" style="color:${r.v==='match'?'var(--green)':r.v==='warn'?'var(--amber)':'var(--red)'}">${rIcos[r.v]||'·'}</div>
      <div class="r-key">${r.k}</div>
      <div class="r-val ${r.v}">${r.t}</div>
    </div>`).join('');

  document.getElementById('revealSec').classList.add('show');
  document.getElementById('tScore').textContent = `${tr.correct} correct`;

  const btns = document.getElementById('tBtns');
  btns.style.display = 'flex';

  const isLast = tr.case === CASES.length - 1;
  if(isLast){
    const nb = document.getElementById('nextBtn');
    nb.textContent = 'See Results →';
    nb.onclick = ()=>{ tr.done=true; renderTrainer(); };
  }

  // Update current dot to correct/wrong
  const dots = document.querySelectorAll('.t-dot');
  if(dots[tr.case]) dots[tr.case].className = `t-dot ${ok ? 'done-correct' : 'done-wrong'}`;
  saveProgress();
}

function nextCase(){
  tr.case++;
  tr.answered = false;
  renderTrainer();
}

function resetTrainer(){
  tr = {case:0, correct:0, answered:false, done:false};
  trResults = [];
  trConf = [];
  try{ localStorage.removeItem('chri_tr'); }catch(e){}
  renderTrainer();
}

function setConf(el, l){
  document.querySelectorAll('.conf-btn').forEach(b=>b.classList.remove('sel','lo','md','hi'));
  el.classList.add('sel', l);
  if(typeof trConf !== 'undefined') trConf[tr.case] = l;
  saveProgress();
}



/* ════════════ RENDER DASHBOARD ════════════ */
function renderDashboard(){
  const R = ROLES[curRole];
  const caseCount = CASES.length;
  const condCount = Object.keys(CONDITIONS).length;
  // Live trainer stats
  const answeredCount = trResults.length;
  const correctCount = trResults.filter(Boolean).length;
  const liveAcc = answeredCount > 0 ? Math.round(correctCount/answeredCount*100)+'%' : '--';
  const liveAccSub = answeredCount > 0 ? correctCount+'/'+answeredCount+' cases · this session' : 'No cases completed yet';
  const liveCases = answeredCount > 0 ? answeredCount+'/'+caseCount : '0/'+caseCount;

  // 2 weeks of streak data — Mon to today (Sunday)
  // Week 1: Mon Apr 7 – Sun Apr 13
  // Week 2: Mon Apr 14 – Sun Apr 20 (today = Sun Apr 20)
  const week1 = [
    {d:'M',s:'done'},{d:'T',s:'done'},{d:'W',s:'done'},
    {d:'T',s:'done'},{d:'F',s:'done'},{d:'S',s:'missed'},{d:'S',s:'done'}
  ];
  const week2 = [
    {d:'M',s:'done'},{d:'T',s:'done'},{d:'W',s:'done'},
    {d:'T',s:'done'},{d:'F',s:'done'},{d:'S',s:'done'},{d:'S',s:'today'}
  ];

  const condList = [
    {id:'dc',  n:'01', name:'Dentigerous Cyst',        cases:2},
    {id:'okc', n:'02', name:'OKC / KCOT',              cases:3},
    {id:'ua',  n:'03', name:'Unicystic Ameloblastoma',  cases:2},
    {id:'lpc', n:'04', name:'Lateral Periodontal Cyst', cases:2},
    {id:'coc', n:'05', name:'Calcifying OC',            cases:2},
    {id:'rc',  n:'06', name:'Radicular Cyst',           cases:2},
    {id:'res', n:'07', name:'Residual Cyst',            cases:1},
    {id:'para',n:'08', name:'Paradental / BBC',         cases:3},
  ];

  const streakCell = (day) =>
    `<div class="sg-cell ${day.s}">${day.d}</div>`;

  document.getElementById('dashContent').innerHTML = `

    <div class="dash-main-col">
    <!-- ── HERO CARD: Name + Streak + XP ── -->
    <div class="dash-hero">
      <div class="dh-main">
        <div class="dh-greeting">Good evening</div>
        <div class="dh-name">${R.name.split(' ')[0]}<span>.</span></div>

        <!-- Streak calendar -->
        <div class="streak-cal-wrap">
          <div class="streak-cal-header">
            <div class="streak-flame">🔥</div>
            <div>
              <div class="streak-count">${curRole==='student'?'14':'21'}-day streak</div>
            </div>
            <div class="streak-best">Best: ${curRole==='student'?'22':'34'} days</div>
          </div>
          <div class="sg-row-label">Last week</div>
          <div class="streak-grid">
            ${week1.map(streakCell).join('')}
          </div>
          <div class="sg-row-label">This week</div>
          <div class="streak-grid">
            ${week2.map(streakCell).join('')}
          </div>
        </div>

        <!-- Stat pills -->
        <div class="dh-stats-row">
          <div class="dh-stat-pill">
            <div class="dh-stat-val green">87%</div>
            <div class="dh-stat-lbl">Quiz accuracy</div>
          </div>
          <div class="dh-stat-pill">
            <div class="dh-stat-val blue">${caseCount}</div>
            <div class="dh-stat-lbl">Cases done</div>
          </div>
          <div class="dh-stat-pill">
            <div class="dh-stat-val amber">+120</div>
            <div class="dh-stat-lbl">XP today</div>
          </div>
        </div>
      </div>

      <!-- XP panel -->
      <div class="dh-xp">
        <div class="dh-level-ring">
          <div class="dh-lvl-num">7</div>
          <div class="dh-lvl-lbl">Level</div>
        </div>
        <div class="dh-xp-info">
          <div class="dh-xp-pts">2,840 / 3,200 XP</div>
          <div class="dh-xp-track">
            <div class="dh-xp-fill" style="width:0" data-w="88%"></div>
          </div>
          <div class="dh-xp-next">360 XP to Level 8<br>Oral Pathologist rank</div>
        </div>
      </div>
    </div>

    <!-- ── MIDDLE: Mission + Stats ── -->
    <div class="dash-mid">
      <div class="mission-card">
        <div class="mc-header">
          <div class="mc-label">Today's Mission</div>
          <div class="mc-xp-pill">+80 XP</div>
        </div>
        <div class="mc-body">
          <div class="mc-condition">Calcifying Odontogenic Cyst</div>
          <div class="mc-sub">Gorlin Cyst · Ghost Cell Spectrum</div>
          <div class="mc-tasks">
            <div class="mc-task done">Read COC module</div>
            <div class="mc-task">Complete 2 trainer cases</div>
            <div class="mc-task">Post to Exchange</div>
          </div>
          <div class="mc-actions">
            <button class="mc-btn-primary" onclick="showCond('coc','study')">Continue COC →</button>
            <button class="mc-btn-secondary" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">Quick Quiz</button>
          </div>
        </div>
      </div>

      <div class="dash-stats">
        <div class="dash-stat-card">
          <div class="dsc-label">Quiz Accuracy</div>
          <div class="dsc-value green">${liveAcc}</div>
          <div class="dsc-sub">${liveAccSub}</div>
        </div>
        <div class="dash-stat-card">
          <div class="dsc-label">Cases Completed</div>
          <div class="dsc-value blue">${liveCases}</div>
          <div class="dsc-sub">Across ${condCount} conditions</div>
        </div>
      </div>
    </div>

    <!-- ── MODULE PROGRESS ── -->
    <div class="module-section">
      <div class="mod-sec-header">
        <div class="mod-sec-title">Module 1 — Odontogenic Cysts</div>
        <div class="mod-sec-badge">Complete ✓</div>
      </div>
      <div class="mod-progress-bar">
        <div class="mod-progress-fill" style="width:0" data-w="100%"></div>
      </div>
      <div class="cond-list" id="condListRows"></div>
    </div>

    <!-- ── BOTTOM: Trainer card only (pearls moved to right col) ── -->
    <div class="trainer-card" style="margin-top:16px">
      <div class="tc-label">Diagnosis Trainer</div>
      <div class="tc-stats">
        <div>
          <div class="tc-stat-val">${caseCount}</div>
          <div class="tc-stat-lbl">Cases</div>
        </div>
        <div>
          <div class="tc-stat-val" style="color:var(--green)">${condCount}</div>
          <div class="tc-stat-lbl">Conditions</div>
        </div>
        <div>
          <div class="tc-stat-val" style="color:var(--purp)">4</div>
          <div class="tc-stat-lbl">Exchange</div>
        </div>
      </div>
      <div class="tc-desc">Recognition drills, DDx traps, radiograph interpretation. Every case has a clinical narrative and attending commentary.</div>
      <div class="tc-btn" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">
        🎯 Launch Trainer →
      </div>
    </div>

    </div><!-- end dash-main-col -->

    <!-- ── RIGHT COLUMN: Pearl of the Day sidebar ── -->
    <div class="dash-pearl-col">
      ${pearlSidebarH()}
    </div>

  `;

  // Populate condition list with rich data
  renderCondList();

  // Animate fills
  setTimeout(()=>{
    document.querySelectorAll('[data-w]').forEach(el => {
      el.style.width = el.dataset.w;
    });
  }, 120);
}

function pearlSidebarH(){
  // Rotate daily — one pearl per day of year
  const allPearls = [
    { cond:'Dentigerous Cyst', color:'blue', icon:'🦷',
      headline:'4mm is the only number that matters',
      body:'Under 4mm = normal follicle, observe. Over 4mm = Dentigerous Cyst until histology proves otherwise. The entire clinical decision lives in that one measurement.',
      trap:'The xray cannot tell you if it\'s DC, OKC, or UA. All three look identical. 4mm tells you to biopsy — pathology tells you what it is.',
      tag:'Boards Threshold' },
    { cond:'OKC / KCOT', color:'amber', icon:'⚠️',
      headline:'Daughter cysts = the recurrence engine',
      body:'OKC recurs because daughter cysts and odontogenic rests survive simple enucleation. Carnoy\'s solution or peripheral ostectomy targets exactly this. Skip it and you\'re planning a re-operation.',
      trap:'Gorlin Syndrome: any young patient with bilateral or multiple OKCs needs PTCH1 workup, derm referral, and head CT. Missing this is a career-defining error.',
      tag:'High Recurrence' },
    { cond:'Unicystic Ameloblastoma', color:'red', icon:'🔬',
      headline:'Cannot be excluded by imaging — ever',
      body:'UA is the trap hiding inside every pericoronal lucency in a patient under 30. Radiographically indistinguishable from DC. The only safe rule: biopsy any pericoronal lesion before committing to a surgical plan.',
      trap:'Luminal UA → enucleation works. Mural UA → resection required. You cannot know the subtype without histology. Treat DC and miss mural UA = recurrence + re-resection.',
      tag:'Biopsy First' },
    { cond:'Lateral Periodontal Cyst', color:'green', icon:'🧪',
      headline:'Vital pulp test splits the entire DDx',
      body:'LPC sits lateral to vital tooth roots — premolar/canine zone, lower jaw. One EPT: vital = LPC. Non-vital = lateral radicular cyst. That single test collapses the differential.',
      trap:'Botryoid variant = polycystic/multilocular LPC. Higher recurrence. Don\'t treat it like a simple LPC.',
      tag:'One Test DDx' },
    { cond:'Calcifying Odontogenic Cyst', color:'purp', icon:'👻',
      headline:'Ghost cells are pathognomonic — full stop',
      body:'No other jaw lesion has ghost cell calcifications. If you see them on histology, the diagnosis is made. Everything else is secondary.',
      trap:'Gorlin CYST ≠ Gorlin SYNDROME. COC = Gorlin Cyst (one lesion). Gorlin Syndrome = PTCH1 mutation, multiple OKCs + BCCs. Different conditions, dangerously similar names.',
      tag:'Pathognomonic' },
    { cond:'Radicular Cyst', color:'blue', icon:'🦷',
      headline:'RC vs granuloma — same treatment, always',
      body:'You cannot distinguish RC from periapical granuloma on imaging. They are clinically identical. The correct move: RCT first. Histology follows. Do not let the DDx change your initial plan.',
      trap:'Rushton bodies in the epithelium = RC confirmed on histology. Eosinophilic curved hyaline structures — memorize the look, you will see them on boards.',
      tag:'Most Common Jaw Cyst' },
    { cond:'Residual Cyst', color:'slate', icon:'📋',
      headline:'Residual ≠ recurrent — different problem, different cause',
      body:'Residual cyst persists because the original cyst was incompletely removed at extraction. Recurrent cyst comes back after adequate treatment. Same histology, completely different clinical story.',
      trap:'Prevention: socket curettage at time of extraction. If you leave inflamed tissue behind, the cyst persists. If it grows and you miss it, it can displace a future implant site.',
      tag:'Prevention' },
    { cond:'Paradental Cyst', color:'green', icon:'🦷',
      headline:'Lateral crown position separates it from DC',
      body:'DC is pericoronal — attaches at the CEJ, surrounds the crown. Paradental is buccal or distal-lateral, driven by pericoronitis inflammation. Same tooth, different anatomy, different diagnosis.',
      trap:'Buccal Bifurcation Cyst (BBC) = pediatric paradental variant at mandibular first molar. Tooth is vital, eruption is intact. Extraction often unnecessary — enucleation preserves the tooth.',
      tag:'Pericoronitis Driven' },
    { cond:'Nasopalatine Duct Cyst', color:'blue', icon:'💙',
      headline:'6mm — the biopsy threshold for NPDC',
      body:'Incisive canal up to 6mm = normal anatomy. Above 6mm or enlarging with vital centrals = NPDC until biopsied. Both centrals must be vital — non-vital central flips the DDx to RC.',
      trap:'Heart-shaped radiolucency is classic but not diagnostic. The vital pulp test on both central incisors is the decisive step. Skip it and you risk extracting a normal tooth.',
      tag:'Most Common Non-OG Cyst' },
    { cond:'Nasolabial Cyst', color:'green', icon:'🫧',
      headline:'Normal X-ray IS the diagnosis',
      body:'Nasolabial cyst is soft tissue only. No bone involvement, no radiographic finding. A normal panoramic + nasal ala swelling = nasolabial cyst until proven otherwise.',
      trap:'The trap: ordering a biopsy for a "normal" panoramic. Normal IS the finding. The diagnosis is made clinically — nasal base swelling, soft, fluctuant, normal bone on imaging.',
      tag:'Soft Tissue Only' },
    { cond:'Dermoid / Epidermoid', color:'amber', icon:'🟡',
      headline:'Doughy palpation = sebaceous content = dermoid',
      body:'Floor of mouth midline mass with doughy consistency = dermoid cyst. The sebaceous content is what makes it feel like a stress ball. Epidermoid is the same location but firmer — keratin only.',
      trap:'Mylohyoid position determines approach. Above = intraoral excision. Below = submental external approach. Miss this and you plan the wrong surgery.',
      tag:'Approach Anatomy' },
    { cond:'Lymphoepithelial Cyst', color:'purp', icon:'🟤',
      headline:'Lymphoid follicles in the wall = pathognomonic',
      body:'Oral LEC: small, yellow, floor of mouth or ventral tongue. Normal X-ray. Wall has lymphoid germinal centers — no other cyst has this. Cervical LEC: lateral neck, FNA before any excision.',
      trap:'Lateral neck LEC in a young adult: FNA first, always. Excising without FNA risks violating surgical planes around an occult SCC primary. That mistake is career-ending.',
      tag:'FNA First' },
    { cond:'Thyroglossal Duct Cyst', color:'green', icon:'💚',
      headline:'Moves with tongue protrusion — pathognomonic',
      body:'Midline neck mass that moves superiorly when the patient protrudes their tongue = TDC until proven otherwise. The duct remnant connects to the foramen cecum — tongue movement pulls it up.',
      trap:'Pre-op thyroid ultrasound is mandatory. 1% of patients have no other thyroid tissue — the TDC is their only thyroid. Sistrunk without US = risk of permanent hypothyroidism.',
      tag:'Sistrunk Procedure' },
    { cond:'Stafne Bone Defect', color:'slate', icon:'🦴',
      headline:'Below the IAN canal — the entire diagnosis',
      body:'Stafne is a lingual cortical depression from submandibular salivary gland pressure. Not a true cyst. Pathognomonic location: BELOW the inferior alveolar nerve canal. Static on serial imaging.',
      trap:'Never biopsy a Stafne on panoramic alone. If IAN position is ambiguous → CT first. MRI confirms salivary T1 signal. Biopsy risks the IAN for a non-pathologic finding.',
      tag:'Do Not Biopsy' },
  ];

  // Pick today's pearl — rotate by day of year
  const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(),0,0)) / 86400000);
  const p = allPearls[dayOfYear % allPearls.length];
  const next = allPearls[(dayOfYear + 1) % allPearls.length];

  const colorMap = {blue:'var(--blue)', amber:'var(--amber)', red:'var(--red)', green:'var(--green)', purp:'var(--purp)', slate:'var(--tx3)'};
  const dimMap   = {blue:'var(--blue-dim)', amber:'var(--amber-dim)', red:'var(--red-dim)', green:'var(--green-dim)', purp:'rgba(148,97,255,.08)', slate:'var(--bg2)'};

  return `
    <div class="pearl-sidebar-card">
      <div class="psb-eyebrow">
        <span class="psb-dot" style="background:${colorMap[p.color]}"></span>
        Pearl of the Day
      </div>
      <div class="psb-cond" style="color:${colorMap[p.color]}">${p.icon} ${p.cond}</div>
      <div class="psb-tag" style="background:${dimMap[p.color]};color:${colorMap[p.color]}">${p.tag}</div>
      <div class="psb-headline">${p.headline}</div>
      <div class="psb-body">${p.body}</div>
      <div class="psb-trap-label">⚠ The Trap</div>
      <div class="psb-trap">${p.trap}</div>
      <button class="psb-btn" onclick="showCond('${allPearls.findIndex(x=>x.cond===p.cond)>=0 ? Object.keys(CONDITIONS)[allPearls.findIndex(x=>x.cond===p.cond)] : 'dc'}','study')">
        Study ${p.cond} →
      </button>
    </div>

    <div class="pearl-sidebar-next">
      <div class="psn-label">Tomorrow's Pearl</div>
      <div class="psn-cond">${next.icon} ${next.cond}</div>
      <div class="psn-preview">${next.headline}</div>
    </div>

    <div class="pearl-sidebar-streak">
      <div class="psb-eyebrow"><span class="psb-dot" style="background:var(--amber)"></span>Module Progress</div>
      <div class="pss-row">
        <div class="pss-label">Module 1</div>
        <div class="pss-track"><div class="pss-fill" style="width:0;background:var(--green)" data-w="100%"></div></div>
        <div class="pss-pct green">100%</div>
      </div>
      <div class="pss-row">
        <div class="pss-label">Module 2</div>
        <div class="pss-track"><div class="pss-fill" style="width:0;background:var(--blue)" data-w="65%"></div></div>
        <div class="pss-pct blue">65%</div>
      </div>
      <div class="pss-row" style="opacity:.45">
        <div class="pss-label">Module 3</div>
        <div class="pss-track"><div class="pss-fill" style="width:0;background:var(--tx4)" data-w="0%"></div></div>
        <div class="pss-pct" style="color:var(--tx4)">Q3</div>
      </div>
    </div>
  `;
}

function renderCondList(){
  var condData = [
    {id:"dc",   n:"01", name:"Dentigerous Cyst",          aka:"Follicular Cyst",     cases:2},
    {id:"okc",  n:"02", name:"OKC / KCOT",                aka:"Keratocystic OT",     cases:3},
    {id:"ua",   n:"03", name:"Unicystic Ameloblastoma",   aka:"",                    cases:2},
    {id:"lpc",  n:"04", name:"Lateral Periodontal Cyst",  aka:"Botryoid OC",         cases:2},
    {id:"coc",  n:"05", name:"Calcifying Odontogenic Cyst",aka:"Gorlin Cyst",        cases:2},
    {id:"rc",   n:"06", name:"Radicular Cyst",            aka:"Periapical Cyst",     cases:2},
    {id:"res",  n:"07", name:"Residual Cyst",             aka:"",                    cases:1},
    {id:"para", n:"08", name:"Paradental Cyst",           aka:"Buccal Bifurcation",  cases:3},
  ];
  var hallmarks = {
    "dc":   "Pericoronal radiolucency \u003E\u20044mm — most common developmental cyst",
    "okc":  "Daughter cysts in wall — scalloped margins, 25–60% recurrence rate",
    "ua":   "Radiographically indistinguishable from DC — biopsy always required",
    "lpc":  "Lateral to vital tooth roots — teardrop shape, rare, vital pulp",
    "coc":  "Ghost cell calcifications on histology — Gorlin Syndrome association",
    "rc":   "Periapical, non-vital tooth — most common jaw cyst overall",
    "res":  "Persists post-extraction — histologically identical to radicular",
    "para": "Buccal to partially erupted mandibular molars — pericoronitis link",
  };
  var el = document.getElementById("condListRows");
  if(!el) return;
  el.innerHTML = condData.map(function(c){
    var cd = CONDITIONS[c.id];
    if(!cd) return "";
    var boards = cd.fp.find(function(f){return f.k==="Boards Freq.";})||{v:50,l:"Moderate",t:"md"};
    var recur  = cd.fp.find(function(f){return f.k==="Recurrence";})||{v:20,l:"Low",t:"lo"};
    var agg    = cd.fp.find(function(f){return f.k==="Aggressiveness";})||{v:20,l:"Low",t:"lo"};
    var bv = boards.v;
    var tier = bv>=90 ? ["Boards Essential","amber"]
             : bv>=70 ? ["High-Yield","blue"]
             : bv>=50 ? ["Moderate","neutral"]
             :          ["Low-Yield","neutral"];
    var ac = agg.t==="hi" ? "red" : agg.t==="md" ? "amber" : "green";
    var aka = c.aka ? "<span class=\"cond-row-aka\">" + c.aka + "</span>" : "";
    return "<div class=\"cond-row\" onclick=\"showCond('" + c.id + "','study')\">"
      + "<div class=\"cond-row-num\">" + c.n + "</div>"
      + "<div class=\"cond-row-main\">"
        + "<div class=\"cond-row-name-wrap\"><span class=\"cond-row-name\">" + c.name + "</span>" + aka + "</div>"
        + "<div class=\"cond-row-hallmark\">" + (hallmarks[c.id]||"") + "</div>"
        + "<div class=\"cond-row-tags\">"
          + "<span class=\"cond-tag t-" + tier[1] + "\">" + tier[0] + "</span>"
          + "<span class=\"cond-tag t-" + ac + "\">Agg: " + agg.l + "</span>"
          + "<span class=\"cond-tag t-neutral\">Recur: " + recur.l + "</span>"
        + "</div>"
      + "</div>"
      + "<div class=\"cond-row-right\">"
        + "<div class=\"cond-boards-wrap\">"
          + "<div class=\"cond-boards-label\">Boards</div>"
          + "<div class=\"cond-boards-track\"><div class=\"cond-boards-fill t-" + ac + "\" style=\"width:" + bv + "%\"></div></div>"
          + "<div class=\"cond-boards-pct\">" + bv + "%</div>"
        + "</div>"
        + "<div class=\"cond-row-cases\">" + c.cases + " case" + (c.cases!==1?"s":"") + "</div>"
        + "<div class=\"cond-row-check\">\u2713</div>"
      + "</div>"
      + "</div>";
  }).join("");
}



/* ════════════ EXCHANGE ENGINE ════════════ */
/* ════════════════════════════════════════════
   CHRI EXCHANGE — THREAD LOGIC
════════════════════════════════════════════ */

// ── STATE ──

// ══════════════════════════════════════════════
// CLINICAL EXCHANGE
// ══════════════════════════════════════════════

// ── Thread data ──
const THREAD_DATA = {
  1: {
    title: "OKC in 19-year-old — large multilocular lesion extending to ramus. Family history of skin lesions. What's your Gorlin workup sequence before surgery?",
    type: 'Imaging · Pathology', tags:['Pathology','Imaging'],
    poster: {av:'MS', role:'resident', name:'Dr. Marcus S.', cred:'OMFS-2 Resident · University Medical Center'},
    verified: 'Verified Resident',
    stats: {replies:14, views:112, time:'2h ago'},
    imaging: 'okc',
    facts: [
      {k:'Patient',    v:'<strong>19M</strong>, otherwise healthy'},
      {k:'Found',      v:'Incidental — routine panoramic'},
      {k:'Location',   v:'<strong>Left posterior mandible</strong>, extending to ramus'},
      {k:'Symptoms',   v:'<em>Asymptomatic</em>. No swelling.'},
      {k:'Imaging',    v:'<strong>Multilocular</strong>, scalloped borders, corticated margins'},
      {k:'Family hx',  v:'Father: <em>"history of skin lesions"</em> — unspecified'},
    ],
    narrative: 'Routine panoramic for wisdom tooth evaluation reveals a <strong>large, multilocular radiolucency</strong> in the left posterior mandible and ramus. Despite radiographic size, <strong>surprisingly minimal buccal expansion</strong>. Adjacent teeth test vital. Patient asymptomatic.',
    diffs: ['Dentigerous Cyst','Odontogenic Keratocyst','Conventional Ameloblastoma','Unicystic Ameloblastoma','Central Giant Cell Granuloma','Ameloblastic Fibroma'],
    correct: 'Odontogenic Keratocyst',
    expert: {
      av:'AT', name:'Dr. Amara T., DMD, MD', cred:'OMFS Attending · Board Certified · 14 yrs practice',
      votes: 41,
      body: `This presentation is <strong>OKC until proven otherwise</strong>, and the father's skin lesion history should trigger your Gorlin evaluation immediately — before surgical planning, not after.<br><br>The radiographic pattern is classic: <em>multilocular, scalloped, extending along the medullary space with disproportionately minimal cortical expansion</em>. That last detail is what separates OKC from ameloblastoma in this age group. Ameloblastoma tends to expand through cortex. OKC sneaks.`,
      points: [
        'Incisional biopsy first — confirm OKC histologically. Do not plan definitive surgery without tissue.',
        '<strong>Dermatology referral</strong> — the father\'s skin lesions may be BCCs. PTCH1 genetic testing if confirmed.',
        'Head CT — calcified falx cerebri (~80% of Gorlin patients). Fastest non-invasive confirmatory sign.',
        'Full skeletal survey — bifid ribs, vertebral anomalies. Spine X-ray adds minimal burden.',
        '<strong>Neurology consult</strong> if any neurological symptoms or medulloblastoma family history.',
      ],
      footer: `If Gorlin is confirmed, these patients will have multiple jaw lesions over their lifetime. You're starting a decades-long surveillance relationship. <strong>Enucleation + peripheral ostectomy with Carnoy's solution</strong> for this one. 6-month panoramic follow-up, indefinitely.`,
    },
    replies: 'REPLIES',
    hindsights: 'HINDSIGHTS1',
  },
  2: {
    title: "Pericoronal lucency — DC vs UA on CBCT. Any reliable differentiating signs?",
    type: 'Pathology', tags:['Pathology'],
    poster: {av:'RK', role:'attending', name:'Dr. R. Kim, MD', cred:'OMFS Attending · Stanford'},
    verified: 'Verified Attending',
    stats: {replies:9, views:67, time:'5h ago'},
    imaging: 'ua',
    facts: [
      {k:'Patient',    v:'<strong>24F</strong>'},
      {k:'Location',   v:'<strong>Right posterior mandible</strong>, pericoronal'},
      {k:'Lesion',     v:'Well-defined, unilocular, pericoronal around impacted #32'},
      {k:'Symptoms',   v:'<em>Asymptomatic</em>'},
      {k:'Size',       v:'3.2cm — larger than expected for DC'},
      {k:'Question',   v:'Any CBCT features that reliably distinguish UA from DC?'},
    ],
    narrative: 'Trying to build a consistent CBCT read protocol for pericoronal lesions. I know we can\'t definitively distinguish DC from UA radiographically — but are there subtle signs that shift your index of suspicion before biopsy?',
    diffs: ['Dentigerous Cyst','Unicystic Ameloblastoma','Odontogenic Keratocyst','Lateral Periodontal Cyst','Follicular Hyperplasia'],
    correct: 'Unicystic Ameloblastoma',
    expert: {
      av:'AT', name:'Dr. A. Takahashi, MD', cred:'Oral & Maxillofacial Pathology · UCSF',
      votes: 18,
      body: `Honest answer: <strong>no CBCT feature reliably distinguishes DC from UA.</strong> The palisading columnar cells that define UA require histologic evaluation — you simply cannot see them on imaging.<br><br>What CBCT <em>can</em> do is increase your index of suspicion: root resorption in a young patient, lining thickening >3mm, or any nodularity on the internal surface should trigger urgent biopsy rather than presumptive enucleation.`,
      points: [
        'Age <25 with pericoronal lesion → UA on differential regardless of appearance.',
        'Lesion "too quiet" for size — no expansion, no symptoms at >2.5cm.',
        'History of prior enucleation at same site (recurrence = classic UA tell).',
        'Request step-sectioning from pathologist. Single H&E slide is insufficient for pericoronal cyst in patient under 25.',
      ],
      footer: `Change your language with the patient: <em>"we're treating this as a cyst, but we need the pathology before we can confirm that."</em>`,
    },
    replies: 'REPLIES2',
    hindsights: 'HINDSIGHTS2',
  },
  3: {
    title: "Marsupialization not working at 6 months — when do you abandon and enucleate?",
    type: 'Surgical Planning', tags:['Surgical'],
    poster: {av:'PJ', role:'resident', name:'Dr. P. Johnson', cred:'OMFS-3 Resident · Mass General'},
    verified: 'Verified Resident',
    stats: {replies:22, views:189, time:'1d ago'},
    imaging: 'dc',
    facts: [
      {k:'Patient',    v:'<strong>28M</strong>'},
      {k:'Diagnosis',  v:'DC confirmed on initial histo'},
      {k:'Treatment',  v:'Marsupialization x6 months'},
      {k:'Status',     v:'<strong>Not shrinking</strong> as expected'},
      {k:'Concern',    v:'Could this be UA on re-biopsy?'},
      {k:'Question',   v:'When do you abandon marsup and enucleate?'},
    ],
    narrative: '6-month marsupialization case, DC confirmed on histo. Not shrinking as expected. Considering re-biopsy before proceeding to formal enucleation. Has anyone had a marsupialization case come back as UA on re-biopsy?',
    diffs: ['Continue marsupialization','Re-biopsy first','Enucleate now','CBCT reassessment','Refer to Oral Path'],
    correct: 'Re-biopsy first',
    expert: {
      av:'MO', name:'Dr. M. Okonkwo, MD', cred:'OMFS Program Director · Columbia',
      votes: 29,
      body: `<strong>Re-biopsy before enucleating.</strong> Always. This is not optional when a DC isn't following expected marsupialization kinetics.<br><br>Expected DC behavior: 20-30% volume reduction by 3 months, measurable wall thickening, progressive tooth eruption if pericoronal. Flat or negative response at 6 months is a red flag that the original diagnosis may be incomplete.`,
      points: [
        'Get new CBCT — compare wall thickness, any new loculations, cortical changes.',
        'Biopsy from the thickest area. If the original biopsy was from one wall, sample a different section.',
        'UA mural variant can be missed on limited biopsy — step-sectioning essential.',
        'Do not schedule the OR until you have updated tissue. OR time is not an argument for skipping re-biopsy.',
      ],
      footer: `The conversation with the patient is straightforward: <em>"We're taking another small sample to make sure we have the right diagnosis before the larger procedure."</em> No downside. Huge upside.`,
    },
    replies: 'REPLIES3',
    hindsights: 'HINDSIGHTS3',
  },
  4: {
    title: "Carnoy's solution contraindications — IAN proximity threshold in practice?",
    type: 'Boards Prep', tags:['Boards'],
    poster: {av:'LW', role:'attending', name:'Dr. L. Wang', cred:'Oral & Maxillofacial Pathology'},
    verified: 'Verified Attending',
    stats: {replies:6, views:44, time:'2d ago'},
    imaging: 'rc',
    facts: [
      {k:'Context',    v:'OKC enucleation, posterior mandible'},
      {k:'Concern',    v:'IAN proximity — Carnoy\'s contraindication'},
      {k:'Distance',   v:'~5mm estimated on CBCT between lesion and IAN'},
      {k:'Question',   v:'What\'s the practical threshold most attendings use?'},
    ],
    narrative: 'I know Carnoy\'s is contraindicated near the IAN without nerve protection, but what\'s the practical threshold most attendings use? Is 5mm enough of a buffer? Looking for practical guidance beyond the textbook.',
    diffs: ["Apply Carnoy's universally","Apply Carnoy's with nerve protection","Avoid Carnoy's entirely","Use peripheral ostectomy instead","Case-by-case based on CBCT"],
    correct: "Apply Carnoy's with nerve protection",
    expert: {
      av:'FS', name:'Dr. F. Sullivan, MD', cred:'OMFS Attending · Duke · OKC Recurrence Research',
      votes: 14,
      body: `There is no universal distance threshold — this is a judgment call based on CBCT anatomy, not a formula. <strong>My protocol: if the IAN is within 5mm of the planned application zone, I protect it.</strong><br><br>Protection technique: rubber dam strip or Telfa over the visualized nerve prior to application. Do not rely on distance alone — bone anatomy varies and CBCT underestimates proximity in cancellous bone.`,
      points: [
        'Always visualize the IAN before applying. If you can\'t see the nerve, don\'t apply.',
        'Rubber dam strip is the standard. Some use Telfa. Both work.',
        'Apply Carnoy\'s for 3 minutes max. Set a timer.',
        'The evidence base for Carnoy\'s reducing recurrence comes from studies with nerve protection protocols. Use both together.',
      ],
      footer: `Permanent IAN deficits from Carnoy's are documented in the literature. They're avoidable with protection. The question isn't <em>whether</em> to protect — it's how comfortable you are with the visualization.`,
    },
    replies: 'REPLIES4',
    hindsights: 'HINDSIGHTS4',
  },
};

// ── Reply data ──
const REPLIES = [
  {av:'RK',role:'attending',name:'Dr. R. Kim, MD',cred:'OMFS Attending · Stanford',tag:'dx',tagLabel:'Dx Reasoning',
   body:`<strong>Agree completely with Dr. T.</strong> The size-to-expansion discrepancy is the tell that residents miss most often. Ameloblastoma at this age would have ballooned the buccal cortex. OKC sneaks. This patient probably has a lesion that's been growing for 2–3 years silently. <br><br>The family skin lesion history is the critical piece — don't let that slide. I've had two Gorlin patients who were diagnosed initially as "isolated OKC" and it wasn't until the second or third jaw cyst that someone thought to ask about skin history.`,
   time:'1h ago',helpful:'12 attendings',promoted:true},
  {av:'PJ',role:'resident',name:'Dr. P. Johnson',cred:'OMFS-3 Resident · Mass General',tag:'sx',tagLabel:'Surgical Approach',
   body:`Question for the attendings: for the Carnoy's application specifically — given the ramus extension here and the likely proximity to the IAN, would you protect the nerve or just avoid the distal extent of the cavity?<br><br>I've seen both approaches. Our program director protects universally with a rubber dam strip, others don't bother if the nerve is clearly visible.`,
   time:'45m ago',helpful:'3 attendings',promoted:false},
  {av:'LW',role:'attending',name:'Dr. L. Wang',cred:'Oral & Maxillofacial Pathology',tag:'path',tagLabel:'Pathology',
   body:`From the pathology side: when you send this biopsy, <strong>specifically request Carnoy's-fixed sections if possible</strong> — it better preserves the parakeratinized lining, which can be tricky to evaluate in formalin. The corrugated surface and palisaded basal layer are your diagnostic features. If the pathologist sees satellite cysts in the submitted wall — that's essentially confirmatory for OKC.<br><br>Also request Ki-67 staining if there's any clinical suspicion of aggressive behavior.`,
   time:'38m ago',helpful:'8 attendings',promoted:true},
  {av:'MS',role:'resident',name:'Dr. Marcus S.',cred:'OMFS-2 Resident (Case Author)',tag:'seen',tagLabel:"I've Seen This",
   body:`Thanks everyone — this is exactly what I needed. Following up: I reached out to dermatology today. Father has 3 BCCs diagnosed over the past 6 years, all on the face. Dermatologist is already suspicious of Gorlin but no formal workup was done. We're proceeding with incisional biopsy this week and coordinating with neuro for head CT. Will update the thread.`,
   time:'22m ago',helpful:'',promoted:false},
  {av:'JT',role:'student',name:'Jordan T.',cred:'MS-III · NYU',tag:'dx',tagLabel:'Dx Reasoning',
   body:`Before I committed my differential I thought DC because it looked similar to what we studied last week. The multilocular pattern and the fact that the expansion was minimal relative to the lesion size — I wouldn't have caught that without reading these replies. Saving this thread to review before boards.`,
   time:'15m ago',helpful:'',promoted:false},
];

const HINDSIGHTS1 = [
  {t:'I would have biopsied before scheduling formal enucleation. I assumed DC, got the OR time, and got the UA pathology the day before the case.'},
  {t:'I would have specifically ordered step-sectioning on every pericoronal cyst under 30 — our lab default is 3 levels and it is not enough.'},
  {t:'I would have told the patient upfront that biopsy results could change the surgical plan significantly, rather than acting like enucleation was already decided.'},
  {t:'I would have included "cannot exclude UA" in my attending note. It sounds like hedge language but it changes what you do next.'},
];

const REPLIES2 = [
  {av:'AT',role:'attending',name:'Dr. A. Takahashi, MD',cred:'Oral & Maxillofacial Pathology · UCSF',tag:'path',tagLabel:'Pathology',
   body:`Honest answer: <strong>no CBCT feature reliably distinguishes DC from UA.</strong> I know that's not what you want to hear, but it's the clinical reality. The palisading columnar cells with reverse nuclear polarity that define UA — you simply cannot see those on any imaging modality. They live at the epithelial-connective tissue interface and require histologic evaluation.<br><br>What CBCT <em>can</em> do is increase your index of suspicion: root resorption in a young patient, thickening of the cyst lining &gt;3mm on CBCT, or any nodularity on the internal surface of the cyst wall should trigger urgent biopsy rather than presumptive enucleation.`,
   time:'4h ago',helpful:'18 attendings',promoted:true},
  {av:'BN',role:'attending',name:'Dr. B. Nguyen',cred:'OMFS Program Director · Penn',tag:'sx',tagLabel:'Surgical Approach',
   body:`I teach residents that <strong>the clinical presentation can never exclude UA</strong> — only histology can. But there are patterns that shift my pre-op suspicion:<br><br>1. Patient age &lt;25 with pericoronal lesion → UA on my differential regardless of appearance<br>2. Lesion "too quiet" for its size — no expansion, no symptoms at &gt;2.5cm<br>3. History of prior enucleation at the same site (recurrence is the classic UA tell)<br><br>If any of these are present, I change my language with the patient: "we're treating this as a cyst, but we need the pathology before we can confirm that."`,
   time:'3h ago',helpful:'11 attendings',promoted:true},
  {av:'CL',role:'resident',name:'Dr. C. Lee',cred:'OMFS-3 · Johns Hopkins',tag:'dx',tagLabel:'Dx Reasoning',
   body:`Question for the group: what's your protocol when the incisional biopsy comes back as "dentigerous cyst" but the clinical picture still feels off? I had a case where our attending pushed for re-biopsy of a different wall section and found the UA pattern. The initial biopsy missed it.<br><br>Is there a standard depth or location for incisional biopsy of pericoronal cysts that gives the best yield for UA?`,
   time:'2h ago',helpful:'5 attendings',promoted:false},
  {av:'AT',role:'attending',name:'Dr. A. Takahashi, MD',cred:'Oral & Maxillofacial Pathology · UCSF',tag:'path',tagLabel:'Pathology',
   body:`@Dr. Lee — great question. UA is notoriously focal. The palisading columnar epithelium may only occupy a small section of the cyst wall. Standard incisional biopsy from one area misses it regularly.<br><br><strong>My recommendation:</strong> biopsy from the thickest or most nodular area on CBCT. If the cyst appears uniform, biopsy from the anterior-inferior wall (where mural ameloblastoma nests tend to concentrate). Submit multiple fragments and specifically request step-sectioning from the pathologist. A single H&amp;E slide is insufficient for a pericoronal cyst in a patient under 25.`,
   time:'1h ago',helpful:'9 attendings',promoted:true},
  {av:'SJ',role:'student',name:'Sam J.',cred:'MS-II · UCSF',tag:'dx',tagLabel:'Dx Reasoning',
   body:`This thread is exactly why I committed "DC" before reading and then felt wrong after. The UA section in the study notes said "cannot be excluded radiographically" but I don't think I really understood what that meant practically until reading these replies. I've been treating it as a rule-out you note in your chart — but it sounds like it should actually change your biopsy technique.`,
   time:'30m ago',helpful:'',promoted:false},
];

const HINDSIGHTS2 = [
  {t:'I would have biopsied before scheduling formal enucleation. I assumed DC, got the OR time, and got the UA pathology the day before the case.'},
  {t:'I would have specifically ordered step-sectioning on every pericoronal cyst under 30 — our lab default is 3 levels and it is not enough.'},
  {t:'I would have told the patient upfront that biopsy results could change the surgical plan significantly, rather than acting like enucleation was already decided.'},
  {t:'I would have included "cannot exclude UA" in my attending note. It sounds like hedge language but it changes what you do next.'},
];

const REPLIES3 = [
  {av:'MO',role:'attending',name:'Dr. M. Okonkwo, MD',cred:'OMFS Attending · Mayo Clinic',tag:'sx',tagLabel:'Surgical Approach',
   body:`<strong>Yes — I have had exactly this case.</strong> Marsupialization at 4 months, decompression stent in place, minimal radiographic response. Re-biopsy of a different section of the cyst wall showed mural UA. The first biopsy was "dentigerous cyst" — classic sampling error.<br><br>My rule now: any pericoronal cyst that does not show 20–30% volume reduction by 3–4 months of marsupialization gets re-biopsied from a different wall section before any further surgical planning. Do not assume the histology is settled from a single incisional biopsy.`,
   time:'6h ago',helpful:'21 attendings',promoted:true},
  {av:'YC',role:'attending',name:'Dr. Y. Chen',cred:'OMFS · Cleveland Clinic',tag:'dx',tagLabel:'Dx Reasoning',
   body:`Important distinction to make here: <strong>lack of response to marsupialization is not always UA.</strong> OKC also responds poorly to marsupialization in some locations — particularly ramus lesions. Before you call this a UA, make sure your histology is showing what actually matters: parakeratinization + corrugated surface = OKC. Palisading columnar cells at the interface = UA.<br><br>These look different. They also change your surgical plan differently. OKC: enucleate + Carnoy's. UA: depends on mural vs luminal subtype — luminal can often still be enucleated, mural requires resection.`,
   time:'5h ago',helpful:'14 attendings',promoted:true},
  {av:'RP',role:'resident',name:'Dr. R. Patel',cred:'OMFS-2 Resident · Case Author',tag:'seen',tagLabel:"I've Seen This",
   body:`Update: we proceeded with re-biopsy at the 6-month mark. Pathology came back as UA — mural subtype. The attending has now scheduled a marginal resection. I'm presenting this case at our M&M next week.<br><br>The most sobering part is that the patient had her surgery bumped twice because we were trying to give the marsupialization more time. She lost almost a year on the assumption that the first biopsy settled the diagnosis. I don't think I'll ever trust a single pericoronal cyst biopsy the same way again.`,
   time:'2h ago',helpful:'7 attendings',promoted:false},
  {av:'MO',role:'attending',name:'Dr. M. Okonkwo, MD',cred:'OMFS Attending · Mayo Clinic',tag:'sx',tagLabel:'Surgical Approach',
   body:`@Dr. Patel — thank you for the update. Mural UA is the worst-case scenario on that differential for exactly this reason. The treatment gap between luminal and mural subtypes is enormous: enucleation vs. marginal resection with adequate margins.<br><br>One thing to flag for your M&M: the timing pressure was real. Marsupialization stents are uncomfortable, patients get impatient, and attendings feel pressure to commit to a plan. That's exactly the environment where UA gets missed. Build the re-biopsy threshold into your program's formal protocol — not as a case-by-case judgment call.`,
   time:'45m ago',helpful:'16 attendings',promoted:true},
  {av:'HK',role:'student',name:'Hannah K.',cred:'MS-III · Harvard',tag:'dx',tagLabel:'Dx Reasoning',
   body:`The UA subtype section in the study notes clicked for me reading this thread. I knew luminal/intraluminal/mural existed as categories but I didn't understand why mural changes treatment so dramatically. It's because the mural nests extend into the fibrous wall — they're not contained by the cyst lining. So enucleation leaves them behind.`,
   time:'20m ago',helpful:'',promoted:false},
];

const HINDSIGHTS3 = [
  {t:'I would have re-biopsied at 3 months, not 6. The lack of decompression response was the signal and I waited too long.'},
  {t:'I would have specifically requested step-sectioning and explicitly asked the pathologist to evaluate for UA features on the initial biopsy.'},
  {t:'I would have staged the conversation with the patient differently — framing the plan as conditional on biopsy results, not as settled.'},
  {t:'I would have escalated to my attending sooner when I had a clinical gut feeling something was off at month 4.'},
];

const REPLIES4 = [
  {av:'FS',role:'attending',name:'Dr. F. Sullivan, MD',cred:'OMFS Attending · UCSF',tag:'sx',tagLabel:'Surgical Approach',
   body:`The published contraindication threshold is &lt;5mm from the IAN. In practice, <strong>most programs I've trained in use visible nerve as the cutoff</strong> — if you can see the IAN in the surgical field, protect it before applying Carnoy's.<br><br>A rubber dam strip or petroleum-impregnated gauze placed over the exposed nerve provides adequate protection. The issue is neurotoxicity from direct contact — Carnoy's is 60% ethanol + 30% chloroform + fixatives. Even brief exposure to nerve tissue causes irreversible histologic damage. The IAN is not a structure you want to "see how it goes" with.`,
   time:'8h ago',helpful:'26 attendings',promoted:true},
  {av:'DK',role:'attending',name:'Dr. D. Kim',cred:'OMFS · Brigham and Women\'s',tag:'sx',tagLabel:'Surgical Approach',
   body:`I'd push back slightly on the "visible nerve as cutoff" framing. <strong>5mm on preoperative CBCT is the threshold I use</strong> — not intraoperative visualization — because by the time you've decompressed the cavity enough to visualize the IAN, you've already committed to a field where Carnoy's application is risky.<br><br>My protocol: if CBCT shows IAN within 5mm of the cyst wall, I plan from the start to skip Carnoy's in that quadrant entirely and rely on peripheral ostectomy alone in the IAN zone. The recurrence risk from skipping one zone of Carnoy's is substantially lower than the risk of permanent paresthesia from IAN injury.`,
   time:'7h ago',helpful:'19 attendings',promoted:true},
  {av:'NB',role:'resident',name:'Dr. N. Brooks',cred:'OMFS-4 Resident · Case Author',tag:'seen',tagLabel:"I've Seen This",
   body:`This is super helpful. To clarify my case: the IAN is visible on CBCT at approximately 3mm from the inferior cyst wall in the distal third of the cavity. Our attending is leaning toward protecting with rubber dam in that zone and applying Carnoy's everywhere else. That matches what @Dr. Sullivan described.<br><br>Follow-up: for the peripheral ostectomy in the IAN zone — what burr do you use and what depth? I've seen 1mm and 1.5mm cited in the literature for standard ostectomy.`,
   time:'5h ago',helpful:'4 attendings',promoted:false},
  {av:'FS',role:'attending',name:'Dr. F. Sullivan, MD',cred:'OMFS Attending · UCSF',tag:'sx',tagLabel:'Surgical Approach',
   body:`@Dr. Brooks — standard peripheral ostectomy depth for OKC is 1–2mm depending on the bone quality and cyst wall thickness. I use a round carbide burr on an electric handpiece, light pressure, copious irrigation. <br><br>The goal is mechanical removal of the surface epithelial islands and satellite daughter cysts that Carnoy's would otherwise chemically ablate. In the IAN zone, 1mm is conservative enough to protect the nerve while still addressing the superficial layer where most satellite cysts reside.<br><br>Document your decision-making in the operative note: "Carnoy's withheld from the distal 1cm of the inferior cavity due to IAN proximity (&lt;5mm on CBCT); peripheral ostectomy performed to 1mm depth in this zone." That note protects you if there's recurrence at that site later.`,
   time:'3h ago',helpful:'13 attendings',promoted:true},
  {av:'EM',role:'student',name:'Elena M.',cred:'MS-II · Columbia',tag:'dx',tagLabel:'Dx Reasoning',
   body:`Before I read the replies I honestly had no idea Carnoy's had IAN contraindications. I knew it was an adjunct for OKC recurrence reduction but I was picturing it like a rinse. The nerve protection detail is going in my notes permanently.`,
   time:'1h ago',helpful:'',promoted:false},
];

const HINDSIGHTS4 = [
  {t:'I would have reviewed the CBCT IAN distance preoperatively and written my Carnoy\'s plan in the consent note, not figured it out in the OR.'},
  {t:'I would have asked specifically about IAN proximity during the preop planning meeting rather than assuming my attending had a protocol.'},
  {t:'I would have documented the decision to omit Carnoy\'s from a zone and the rationale explicitly in the operative report.'},
  {t:'I would have read the original Stoelinga paper on peripheral ostectomy before my first OKC case instead of relying on verbal hand-off from a senior.'},
];


// ── State ──
let exCommitted = false;
let exSelectedDiff = null;
let exCurThread = 1;
let exFilter = 'All';

const exCondMap = {1:'okc', 2:'ua', 3:'okc', 4:'okc'};

// ── Navigation ──
function renderExchange(){
  const el = document.getElementById('exchangeContent');
  if(!el) return;

  const filterDefs = ['All','Pathology','Imaging','Surgical','Boards'];
  const filterHtml = filterDefs.map(f=>
    `<div class="ex-filter${exFilter===f?' active':''}" onclick="exFilter='${f}';renderExchange()">${f}</div>`
  ).join('');

  const allEntries = Object.entries(THREAD_DATA);
  const filtered = exFilter === 'All'
    ? allEntries
    : allEntries.filter(([n,td]) => td.tags && td.tags.includes(exFilter));

  const caseRows = filtered.map(([n, td])=>`
    <div class="ex-case-row" onclick="renderThread(${n})">
      <div class="ex-row-top">
        <div class="ex-row-type">${td.type}</div>
        <div class="ex-row-tag expert">Expert Reply</div>
      </div>
      <div class="ex-row-title">${td.title}</div>
      <div class="ex-row-footer">
        <div class="ex-row-poster">
          <div class="ex-row-av ${td.poster.role}">${td.poster.av}</div>
          <span>${td.poster.name}</span>
        </div>
        <span>💬 ${td.stats.replies}</span>
        <span>👁 ${td.stats.views}</span>
        <span>${td.stats.time}</span>
      </div>
    </div>`).join('');

  el.innerHTML = `
    <div class="ex-index">
      <div class="ex-index-wrap">
        <div class="ex-eyebrow">Community · Clinical Exchange</div>
        <div class="ex-index-title">Case Discussions</div>
        <div class="ex-index-sub">Real cases. Verified clinicians. Commit your diagnosis before reading a single reply.</div>
        <div class="ex-filters">${filterHtml}</div>
        <div class="ex-case-list">
          ${filtered.length > 0 ? caseRows : '<div style="color:var(--tx3);font-size:14px;padding:20px 0">No cases match this filter.</div>'}
        </div>
      </div>
    </div>`;
}

function renderThread(n){
  exCurThread = n;
  exCommitted = false;
  exSelectedDiff = null;

  const td = THREAD_DATA[n];
  document.getElementById('topTitle').textContent = td.type + ' · Case ' + n;
  document.getElementById('topCta').textContent = '← All Cases';
  document.getElementById('topCta').onclick = ()=>{ renderExchange(); document.getElementById('topTitle').textContent='Clinical Exchange'; document.getElementById('topCta').textContent='Open Pathology →'; document.getElementById('topCta').onclick=()=>goScreen('pathology',document.getElementById('sbPath')); };

  const svg = xSvg(td.imaging);
  const facts = td.facts.map(f=>`
    <div class="ex-fact">
      <div class="ex-fact-key">${f.k}</div>
      <div class="ex-fact-val">${f.v}</div>
    </div>`).join('');
  const diffs = td.diffs.map(d=>`
    <div class="ex-diff-opt" onclick="exPickDiff(this,'${d.replace(/'/g,"\\'")}')">
      ${d}
    </div>`).join('');

  document.getElementById('exchangeContent').innerHTML = `
    <div class="ex-thread-layout">

      <div class="ex-case-panel">
        <div class="ex-cp-inner">
          <button class="ex-back-btn" onclick="renderExchange();document.getElementById('topTitle').textContent='Clinical Exchange';document.getElementById('topCta').textContent='Open Pathology →';document.getElementById('topCta').onclick=()=>goScreen('pathology',document.getElementById('sbPath'));">← All Cases</button>
          <div class="ex-cp-tag">${td.type} · Case ${n} of 4</div>
          <div class="ex-cp-title">${td.title}</div>
          <div class="ex-cp-poster">
            <div class="ex-cp-av ${td.poster.role}">${td.poster.av}</div>
            <div>
              <div class="ex-cp-name">${td.poster.name}</div>
              <div class="ex-cp-cred">${td.poster.cred}</div>
            </div>
            <div class="ex-cp-verified">${td.verified}</div>
          </div>
          <div class="ex-imaging">
            <div class="ex-img-bar">
              <div class="ex-img-tab active">Pan</div>
              <div class="ex-img-tab">Axial</div>
              <div class="ex-img-tab">Coronal</div>
            </div>
            <div class="ex-img-view">${svg}</div>
          </div>
          <div class="ex-facts">${facts}</div>
          <div class="ex-gate">
            <div class="ex-gate-lbl">What's your read? — commit to unlock the discussion</div>
            <div class="ex-diff-opts">${diffs}</div>
            <button class="ex-commit-btn" id="exCommitBtn" onclick="exCommit()" disabled>
              Select a diagnosis first
            </button>
          </div>
        </div>
      </div>

      <div class="ex-disc-panel" id="exDiscPanel">
        <div class="ex-disc-inner" id="exDiscInner">
          <div class="ex-disc-locked">
            <div class="ex-disc-lock-icon">🔒</div>
            <div class="ex-disc-lock-txt">Select your diagnosis and commit to unlock the discussion</div>
          </div>
        </div>
      </div>

    </div>`;
}

function exPickDiff(el, val){
  if(exCommitted) return;
  document.querySelectorAll('.ex-diff-opt').forEach(o=>o.classList.remove('pending'));
  el.classList.add('pending');
  exSelectedDiff = val;
  const btn = document.getElementById('exCommitBtn');
  if(btn){ btn.disabled = false; btn.textContent = 'Commit: "' + val + '" →'; }
}

function exCommit(){
  if(!exSelectedDiff || exCommitted) return;
  exCommitted = true;
  const td = THREAD_DATA[exCurThread];
  const ok = exSelectedDiff === td.correct;

  document.querySelectorAll('.ex-diff-opt').forEach(o=>{
    const t = o.textContent.trim();
    o.classList.remove('pending');
    o.style.pointerEvents = 'none';
    if(t === exSelectedDiff) o.classList.add(ok ? 'correct' : 'wrong');
    if(!ok && t === td.correct) o.classList.add('correct');
  });

  const btn = document.getElementById('exCommitBtn');
  if(btn){
    btn.textContent = ok ? '✓ Correct' : 'Answer: ' + td.correct;
    btn.disabled = true;
    btn.style.background = ok ? 'var(--green)' : 'var(--amber)';
  }

  setTimeout(()=>{
    const replies = td.replies==='REPLIES'?REPLIES:td.replies==='REPLIES2'?REPLIES2:td.replies==='REPLIES3'?REPLIES3:REPLIES4;
    const hindsights = td.hindsights==='HINDSIGHTS1'?HINDSIGHTS1:td.hindsights==='HINDSIGHTS2'?HINDSIGHTS2:td.hindsights==='HINDSIGHTS3'?HINDSIGHTS3:HINDSIGHTS4;
    const ex = td.expert;

    const replyHtml = replies.map(r=>`
      <div class="ex-reply">
        <div class="ex-reply-hdr">
          <div class="ex-reply-av ${r.role}">${r.av}</div>
          <div class="ex-reply-meta">
            <div class="ex-reply-name">${r.name} <span class="ex-reply-rtag ${r.tag}">${r.tagLabel}</span></div>
            <div class="ex-reply-cred">${r.cred}</div>
            <div class="ex-reply-time">${r.time}</div>
          </div>
        </div>
        <div class="ex-reply-body">${r.body}</div>
        <div class="ex-reply-actions">
          <button class="ex-vote-btn" onclick="this.classList.toggle('voted')">${r.helpful?'👍 '+r.helpful:'👍 Helpful'}</button>
        </div>
      </div>`).join('');

    document.getElementById('exDiscInner').innerHTML = `
      <div class="ex-disc-result ${ok?'correct':'wrong'}">
        ${ok ? '✓ Correct — '+td.correct : 'Correct answer: '+td.correct}
      </div>
      <div class="ex-expert">
        <div class="ex-expert-badge">★ Expert Answer · ${ex.votes} attendings</div>
        <div class="ex-expert-poster">
          <div class="ex-expert-av">${ex.av}</div>
          <div>
            <div class="ex-expert-name">${ex.name}</div>
            <div class="ex-expert-cred">${ex.cred}</div>
          </div>
        </div>
        <div class="ex-expert-body">${ex.body}</div>
        ${ex.points?`<div class="ex-expert-points">${ex.points.map((p,i)=>`<div class="ex-expert-pt"><div class="ex-expert-pt-num">${i+1}.</div><div>${p}</div></div>`).join('')}</div>`:''}
        ${ex.footer?`<div class="ex-expert-body" style="margin-top:12px">${ex.footer}</div>`:''}
        <div class="ex-expert-footer">
          <button class="ex-helpful-btn" onclick="this.classList.toggle('voted')">👍 Helpful</button>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--tx4);">${ex.votes} attendings found this helpful</span>
          <div class="ex-module-link" onclick="showCond(exCondMap[exCurThread]||'okc','study')">Study Module →</div>
        </div>
      </div>
      <div class="ex-disc-section-lbl">${replies.length} replies</div>
      <div class="ex-replies">${replyHtml}</div>
      <div class="ex-hind-section">
        <div class="ex-hind-lbl">What I would have done differently</div>
        <div class="ex-hind-list" id="exHindList">${hindsights.map(h=>`<div class="ex-hind-item">${h}</div>`).join('')}</div>
        <div class="ex-hind-input-row">
          <input id="exHindInput" placeholder="Add your own reflection..." type="text"/>
          <button class="ex-hind-add" onclick="exAddHint()">Add</button>
        </div>
      </div>`;
  }, 280);
}

function exAddHint(){
  const input = document.getElementById('exHindInput');
  const val = input.value.trim();
  if(!val) return;
  const list = document.getElementById('exHindList');
  if(!list) return;
  const item = document.createElement('div');
  item.className = 'ex-hind-item';
  item.textContent = val;
  list.appendChild(item);
  input.value = '';
}

function renderProgress(){
  const el = document.getElementById('progressContent');
  if(!el) return;

  const total = CASES.length;
  const answered = trResults.filter(x => x !== undefined).length;
  const correct  = trResults.filter(Boolean).length;
  const pct = answered > 0 ? Math.round(correct/answered*100) : 0;
  const scoreColor = pct>=80?'var(--green)':pct>=60?'var(--amber)':'var(--red)';

  // Per-condition breakdown
  const condBreak = {};
  CASES.forEach((c, i) => {
    const meta = CASE_META[c.n] || {cond:'Unknown'};
    if(!condBreak[meta.cond]) condBreak[meta.cond] = {total:0, correct:0, conf:[]};
    condBreak[meta.cond].total++;
    if(trResults[i] === true)  condBreak[meta.cond].correct++;
    if(trResults[i] !== undefined && trConf[i]) condBreak[meta.cond].conf.push(trConf[i]);
  });

  const condRows = Object.entries(condBreak).map(([cond, d])=>{
    const cpct = d.total > 0 ? Math.round(d.correct/d.total*100) : 0;
    const cc = cpct===100?'var(--green)':cpct>=50?'var(--amber)':'var(--red)';
    const avgConf = d.conf.length ? (d.conf.filter(x=>x==='hi').length/d.conf.length*100).toFixed(0)+'% hi-conf' : '';
    return `<div class="prog-cond-row">
      <div class="prog-cond-name">${cond}</div>
      <div class="prog-cond-bar-wrap">
        <div class="prog-cond-track"><div class="prog-cond-fill" style="width:${cpct}%;background:${cc}"></div></div>
      </div>
      <div class="prog-cond-pct" style="color:${cc}">${d.correct}/${d.total}</div>
      ${avgConf ? `<div class="prog-cond-conf">${avgConf}</div>` : ''}
    </div>`;
  }).join('');

  // Confidence breakdown
  const confCounts = {lo:0, md:0, hi:0};
  trConf.forEach(c => { if(c) confCounts[c]++; });
  const confTotal = confCounts.lo + confCounts.md + confCounts.hi;

  el.innerHTML = `<div class="prog-wrap">
    <div class="ex-eyebrow">Personal · Session Summary</div>
    <div class="ex-index-title" style="margin-bottom:4px">My Progress</div>
    <div class="ex-index-sub" style="margin-bottom:32px">Results from your current session. Progress saves automatically.</div>

    ${answered === 0 ? `
      <div class="prog-empty">
        <div style="font-size:40px;margin-bottom:12px">📋</div>
        <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--tx);margin-bottom:8px">No cases attempted yet</div>
        <div style="font-size:13px;color:var(--tx3);margin-bottom:20px">Head to the trainer to start building your diagnostic skills.</div>
        <button class="ex-commit-btn" style="max-width:220px" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">Start Trainer →</button>
      </div>` : `

    <div class="prog-score-row">
      <div class="prog-big-score" style="color:${scoreColor}">${pct}<span>%</span></div>
      <div class="prog-score-detail">
        <div class="prog-score-line">${correct} correct out of ${answered} cases answered</div>
        <div class="prog-score-line" style="color:var(--tx3)">${total - answered} cases remaining in this module</div>
        ${answered===total?`<div class="prog-score-line" style="color:var(--green);font-weight:600">✓ Module complete</div>`:''}
      </div>
    </div>

    <div class="prog-section-lbl">By Condition</div>
    <div class="prog-cond-list">${condRows}</div>

    ${confTotal > 0 ? `
    <div class="prog-section-lbl">Confidence Profile</div>
    <div class="prog-conf-row">
      <div class="prog-conf-item lo">
        <div class="prog-conf-num">${confCounts.lo}</div>
        <div class="prog-conf-lbl">Low confidence</div>
        <div class="prog-conf-bar"><div style="width:${confTotal?Math.round(confCounts.lo/confTotal*100):0}%;background:var(--red);height:100%;border-radius:99px"></div></div>
      </div>
      <div class="prog-conf-item md">
        <div class="prog-conf-num">${confCounts.md}</div>
        <div class="prog-conf-lbl">Medium</div>
        <div class="prog-conf-bar"><div style="width:${confTotal?Math.round(confCounts.md/confTotal*100):0}%;background:var(--amber);height:100%;border-radius:99px"></div></div>
      </div>
      <div class="prog-conf-item hi">
        <div class="prog-conf-num">${confCounts.hi}</div>
        <div class="prog-conf-lbl">High confidence</div>
        <div class="prog-conf-bar"><div style="width:${confTotal?Math.round(confCounts.hi/confTotal*100):0}%;background:var(--green);height:100%;border-radius:99px"></div></div>
      </div>
    </div>` : ''}

    <div class="prog-actions">
      ${answered < total ? `<button class="t-btn primary" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">Continue Trainer →</button>` : ''}
      <button class="t-btn ghost" onclick="resetTrainer();goScreen('pathology',document.getElementById('sbPath'));setMode('trainer')">↺ Retry All Cases</button>
      <button class="t-btn ghost" onclick="goScreen('pathology',document.getElementById('sbPath'));setMode('study')">Study Notes →</button>
    </div>`}
  </div>`;

  // Animate progress bars
  requestAnimationFrame(()=>{
    setTimeout(()=>{
      document.querySelectorAll('.prog-cond-fill[data-w]').forEach(b=>{ b.style.width=b.dataset.w; });
    }, 80);
  });
}

function goLectures(){
  curScreen='lectures';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const sl=document.getElementById('screen-lectures');if(sl)sl.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('active'));
  const sb=document.getElementById('sbLectures');if(sb)sb.classList.add('active');
  document.getElementById('topTitle').textContent='CE Lectures';
  document.getElementById('modeToggle').style.display='none';
  document.getElementById('topCta').textContent='Open Pathology →';
  document.getElementById('topCta').onclick=()=>goScreen('pathology',document.getElementById('sbPath'));
  const sbm=document.getElementById('sbM1');if(sbm)sbm.style.display='none';
  renderLectures();
}

const LECTURES = [
  {id:1, status:'available', progress:100, eyebrow:'Radiology · Core Series',
   title:"Reading the Posterior Mandible: OKC, DC, and What You'll Miss",
   speaker:'Dr. A. Takahashi', speakerFull:'Dr. Akiko Takahashi, DDS, PhD',
   cred:'Oral Pathology · UCSF', credFull:'Professor of Oral & Maxillofacial Pathology, UCSF School of Dentistry. Board examiner for oral pathology since 2014.',
   duration:'54 min', credits:1.0, thumb:'🦷', thumbBg:'rgba(74,158,255,.08)',
   tags:['Radiology','Boards Prep'], accentColor:'var(--blue)',
   desc:"The posterior mandible is where residents make their biggest diagnostic errors. This lecture walks through the radiographic decision tree for OKC, dentigerous cyst, ameloblastoma, and the lesions that mimic each — with real cases at every step.",
   objectives:[
     'Recognize the size-to-expansion discrepancy that separates OKC from ameloblastoma',
     'Apply the pericoronal space threshold (3–4mm) systematically across patient age groups',
     'Identify the 3 CBCT features that should trigger urgent biopsy over observation',
     'Build a differential for posterior mandibular radiolucency in under 60 seconds',
   ],
   chapters:[
     {t:'Introduction & Case Overview', ts:'0:00', done:true},
     {t:'Anatomy of the Posterior Mandible', ts:'4:12', done:true},
     {t:'Dentigerous Cyst: Criteria & Variants', ts:'11:40', done:true},
     {t:'OKC: The Sneaky Lesion', ts:'22:05', done:true},
     {t:'Ameloblastoma: When to Worry', ts:'33:18', done:true},
     {t:'Live Case: 22M Incidental Finding', ts:'44:30', done:true},
     {t:'Board-Style Summary & Quiz', ts:'51:00', done:true},
   ],
   transcript:`The posterior mandible accounts for a disproportionate share of missed diagnoses in dental practice — not because the lesions are subtle, but because clinicians conflate radiographic appearance with diagnosis before asking the critical question: what is the biology here?

Let me start with a case. This is a 22-year-old male referred after a routine panoramic. The referring dentist noted "possible dentigerous cyst versus normal follicular space." The lesion is 11mm. Pericoronal. Corticated borders. Unilocular.

If your answer is dentigerous cyst, you're in good company — and you're probably wrong.`,
  },
  {id:2, status:'available', progress:60, eyebrow:'Surgical Decision-Making',
   title:'Enucleation vs Resection: When to Escalate and How to Justify It',
   speaker:'Dr. B. Nguyen', speakerFull:'Dr. Brian Nguyen, MD, DDS',
   cred:'OMFS Program Director · Penn', credFull:'Program Director, Oral & Maxillofacial Surgery at University of Pennsylvania. Specialty interest in jaw reconstruction and oncologic surgery.',
   duration:'68 min', credits:1.0, thumb:'🔪', thumbBg:'rgba(255,94,108,.07)',
   tags:['Surgery'], accentColor:'var(--red)',
   desc:"The decision to enucleate versus resect is one of the highest-stakes calls in OMFS. This lecture gives you a practical framework based on lesion biology, recurrence risk, patient factors, and how to document your reasoning when a colleague would have chosen differently.",
   objectives:[
     'Apply the WHO recurrence risk hierarchy to guide initial surgical planning',
     'Recognize the 5 clinical signs that convert an enucleation case to a resection',
     'Structure a defensible surgical plan for a borderline OKC in a young patient',
     'Counsel patients on recurrence probability with data, not estimates',
   ],
   chapters:[
     {t:'The Surgical Decision Framework', ts:'0:00', done:true},
     {t:'Enucleation: Technique & Adjuncts', ts:'8:30', done:true},
     {t:'Carnoy\'s Solution: Evidence & Limits', ts:'19:45', done:true},
     {t:'Marsupialization: When and Why', ts:'28:10', done:true},
     {t:'Resection Indications', ts:'38:00', done:false},
     {t:'Case: Recurrent OKC in 34F', ts:'50:20', done:false},
     {t:'Documentation & Justification', ts:'62:00', done:false},
   ],
   transcript:`I want to start by challenging a framework I see used too often: "aggressive vs conservative." These words carry moral weight they shouldn't. Resection isn't aggressive — it's appropriate when the biology demands it. Enucleation isn't conservative — it's precise when the margins are sound.

The question is never about how much you're willing to do. It's about what the lesion will do if you do less.

Let me walk you through the decision tree I use in every case...`,
  },
  {id:3, status:'available', progress:0, eyebrow:'Pathology · Case Conference',
   title:'Grand Rounds: 5 Cases That Changed How I Practice',
   speaker:'Dr. C. Reyes', speakerFull:'Dr. Carmen Reyes, DDS, MS',
   cred:'Oral & Maxillofacial Path · Mayo', credFull:'Senior Consultant in Oral Pathology at Mayo Clinic. Author of over 40 peer-reviewed publications in odontogenic cyst biology.',
   duration:'72 min', credits:1.0, thumb:'🔬', thumbBg:'rgba(61,214,140,.07)',
   tags:['Pathology','Grand Rounds'], accentColor:'var(--green)',
   desc:"Five real cases presented in grand rounds format — each one containing a diagnostic error, a near-miss, or a lesson that changed clinical approach. No slides edited for clarity. This is how pathology actually gets done.",
   objectives:[
     'Analyze diagnostic reasoning failures across 5 high-complexity cases',
     'Identify the anchoring biases that produce systematic misdiagnosis',
     'Apply histologic criteria to cases where imaging was misleading',
     'Develop a personal error-prevention checklist from case analysis',
   ],
   chapters:[
     {t:'Case 1: The DC That Wasn\'t', ts:'0:00', done:false},
     {t:'Case 2: A Gorlin Patient Missed for 4 Years', ts:'14:20', done:false},
     {t:'Case 3: Calcifying Cyst vs COC vs Ghost Cell Tumor', ts:'27:55', done:false},
     {t:'Case 4: Residual Cyst in an Edentulous Jaw', ts:'44:10', done:false},
     {t:'Case 5: LPC Diagnosed as Periodontal Disease', ts:'58:30', done:false},
     {t:'Discussion & Q&A', ts:'67:00', done:false},
   ],
   transcript:`Grand rounds only works if we're honest. So let me start by telling you about a case I got wrong.

The patient was a 41-year-old female, referred for evaluation of a "periapical lesion" at the lower left lateral incisor. Vitality tests were equivocal. The lesion was 6mm. Well-defined. Corticated.

I called it a lateral periodontal cyst. I was wrong. And the error cost her a year.

Here's what I missed — and what I changed in my practice because of it...`,
  },
  {id:4, status:'available', progress:0, eyebrow:'Boards Review · High-Yield',
   title:'Odontogenic Cysts: Everything You Need for Boards in 45 Minutes',
   speaker:'Dr. M. Park', speakerFull:'Dr. Michael Park, DDS',
   cred:'OMFS Boards Examiner', credFull:'Oral & Maxillofacial Surgery boards examiner. Developed the oral pathology question bank used by three major dental school programs.',
   duration:'45 min', credits:0.75, thumb:'📋', thumbBg:'rgba(240,165,0,.07)',
   tags:['Boards Prep','Pathology'], accentColor:'var(--amber)',
   desc:"Exactly what boards tests, how it tests it, and the fastest path to getting it right. No filler. Built from 8 years of writing and reviewing board questions across NBDE, OMFS, and oral pathology specialty exams.",
   objectives:[
     'Master the 12 highest-frequency odontogenic cyst board questions',
     'Learn the 4 classic image-based traps and how to avoid them',
     'Distinguish treatment protocols that boards tests vs clinical reality',
     'Build a 60-second classification framework for exam day',
   ],
   chapters:[
     {t:'What Boards Actually Tests', ts:'0:00', done:false},
     {t:'Classification: The Right Framework', ts:'3:45', done:false},
     {t:'OKC vs DC: The #1 Board Trap', ts:'10:20', done:false},
     {t:'Calcifying Cyst: Ghost Cell Mnemonics', ts:'18:30', done:false},
     {t:'Treatment Protocols You Must Know', ts:'27:00', done:false},
     {t:'12-Question Rapid Review', ts:'36:15', done:false},
   ],
   transcript:`Every year I see the same mistakes on board exams. Not because the concepts are hard — the concepts in oral pathology are genuinely learnable — but because most candidates have memorized facts without building the decision logic that connects them.

The question won't say "what is an OKC." The question will show you a panoramic, give you a 28-year-old with no symptoms, and ask you to choose between four entities that all look the same on film.

Here's how I want you to approach it...`,
  },
  {id:5, status:'soon', progress:0, eyebrow:'Radiology · Advanced',
   title:'CBCT Interpretation: Beyond the Basics for Odontogenic Lesions',
   speaker:'Dr. S. Watanabe', speakerFull:'Dr. Soshi Watanabe, DDS, MS',
   cred:'Oral Radiology · Harvard', credFull:'Associate Professor of Oral Radiology, Harvard School of Dental Medicine. Researcher in 3D imaging biomarkers for cyst recurrence prediction.',
   duration:'61 min', credits:1.0, thumb:'🖥️', thumbBg:'rgba(148,97,255,.07)',
   tags:['Radiology'], accentColor:'var(--purp)', launch:'Q2 2026',
   desc:"CBCT changed what we can see — but only if you know what to look for. This lecture focuses on the features that change management: cortical perforation, root resorption patterns, IAN proximity, and the 3mm wall-thickness threshold.",
   objectives:[
     'Interpret CBCT axial, coronal, and sagittal cuts for cyst extent',
     'Identify cortical perforation and classify its surgical implications',
     'Measure IAN proximity and apply safe-margin thresholds',
     'Recognize the wall-thickening pattern that changes DC to UA suspicion',
   ],
   chapters:[], transcript:'',
  },
  {id:6, status:'soon', progress:0, eyebrow:'Genetics · Emerging Topics',
   title:'Gorlin Syndrome to PTCH1: The Molecular Basis of OKC Recurrence',
   speaker:'Dr. A. Takahashi', speakerFull:'Dr. Akiko Takahashi, DDS, PhD',
   cred:'Oral Pathology · UCSF', credFull:'Professor of Oral & Maxillofacial Pathology, UCSF. NIH-funded research on PTCH1 pathway inhibition in OKC recurrence.',
   duration:'82 min', credits:1.5, thumb:'🧬', thumbBg:'rgba(37,99,235,.06)',
   tags:['Pathology'], accentColor:'var(--blue)', launch:'Q2 2026',
   desc:"Why does OKC recur at rates that other cysts don't? The answer is in the biology — PTCH1 mutations, satellite cysts, and epithelial remnants. This lecture bridges the molecular science to clinical decision-making.",
   objectives:[
     'Explain the PTCH1/Hedgehog pathway and its role in OKC growth',
     'Describe how satellite cysts drive recurrence after enucleation',
     'Connect Gorlin Syndrome genetics to surgical planning decisions',
     'Interpret emerging evidence on vismodegib for recurrent OKC',
   ],
   chapters:[], transcript:'',
  },
];
let lecFilter = 'All';

function renderLectures(){
  const earned = LECTURES.filter(l=>l.status==='available'&&l.progress===100).reduce((a,l)=>a+l.credits,0);
  const pct = Math.round(earned/20*100);
  const avail = LECTURES.filter(l=>l.status==='available');
  const soon  = LECTURES.filter(l=>l.status==='soon');
  const filtered = lecFilter==='All'?avail:avail.filter(l=>l.tags&&l.tags.some(t=>t.toLowerCase().includes(lecFilter.toLowerCase())));

  const filters = ['All','Boards Prep','Radiology','Surgery','Pathology','Grand Rounds'].map(f=>
    `<div class="lec-filter${lecFilter===f?' active':''}" onclick="lecFilter='${f}';renderLectures()">${f}</div>`
  ).join('');

  const makeRow = (l, locked) => `
    <div class="lec-row${locked?' locked':''}" onclick="${locked?`lecComingSoon()`:`renderLectureDetail(${l.id})`}">
      <div class="lec-row-icon" style="background:${l.thumbBg}">${l.thumb}</div>
      <div class="lec-row-body">
        <div class="lec-row-eyebrow">${l.eyebrow||''}</div>
        <div class="lec-row-title">${l.title}</div>
        <div class="lec-row-meta"><span>${l.speaker}</span><span>·</span><span>${l.cred.split('·')[0].trim()}</span></div>
        ${l.progress>0&&l.progress<100?`<div class="lec-row-progress"><div class="lec-row-progress-fill" style="width:${l.progress}%"></div></div>`:''}
      </div>
      <div class="lec-row-right">
        <div class="lec-row-credits">${l.credits} CME</div>
        <div class="lec-row-duration">${l.duration}</div>
        ${l.progress===100?'<div class="lec-row-done">✓ Done</div>':''}
        ${locked?`<div class="lec-row-soon">🔒 ${l.launch||'Soon'}</div>`:''}
      </div>
    </div>`;

  document.getElementById('lecturesContent').innerHTML = `
    <div class="lec-wrap">
      <div class="lec-header">
        <div class="ex-eyebrow">Community · Continuing Education</div>
        <div class="lec-header-title">CE Lectures</div>
        <div class="lec-header-sub">Expert-led sessions in oral pathology, radiology, and surgical decision-making. CME credits tracked automatically.</div>
      </div>
      <div class="lec-credit-bar">
        <div class="lec-credit-nums">${earned.toFixed(1)}<span> / 20 CME</span></div>
        <div class="lec-credit-track-wrap">
          <div class="lec-credit-lbl">Annual CE Progress</div>
          <div class="lec-credit-track"><div class="lec-credit-fill" id="lecCreditFill" style="width:0"></div></div>
        </div>
      </div>
      <div class="lec-filters">${filters}</div>
      ${filtered.length>0?`
        <div class="lec-section-lbl">Available — ${filtered.length} lecture${filtered.length!==1?'s':''}</div>
        <div class="lec-list">${filtered.map(l=>makeRow(l,false)).join('')}</div>
      `:'<div style="color:var(--tx3);font-size:14px;padding:20px 0">No lectures match this filter.</div>'}
      ${soon.length>0?`
        <div class="lec-section-lbl">Coming Soon</div>
        <div class="lec-list">${soon.map(l=>makeRow(l,true)).join('')}</div>
      `:''}
    </div>`;

  requestAnimationFrame(()=>{
    const fill = document.getElementById('lecCreditFill');
    if(fill) setTimeout(()=>{ fill.style.width=pct+'%'; }, 80);
  });
}

function lecComingSoon(){
  const el = document.getElementById('lecturesContent');
  el.innerHTML = `<div class="lec-wrap"><div style="padding:80px 0;text-align:center;color:var(--tx3)">
    <div style="font-size:48px;margin-bottom:16px">🔒</div>
    <div style="font-family:'Fraunces',serif;font-size:24px;font-weight:700;color:var(--tx);margin-bottom:8px">Coming Q2 2026</div>
    <div style="font-size:14px;margin-bottom:24px">This lecture is in production. We'll notify you when it drops.</div>
    <button class="lec-back-btn" onclick="goLectures()">← Back to Lectures</button>
  </div></div>`;
}

function renderLectureDetail(id){
  const l = LECTURES.find(x=>x.id===id);
  if(!l) return;

  document.getElementById('topTitle').textContent = l.eyebrow;
  document.getElementById('topCta').textContent = '← Lectures';
  document.getElementById('topCta').onclick = goLectures;

  const doneCount = l.chapters.filter(c=>c.done).length;
  const pct = l.chapters.length ? Math.round(doneCount/l.chapters.length*100) : l.progress;

  const chapterRows = l.chapters.map((c,i)=>`
    <div class="lec-chapter ${c.done?'done':''}">
      <div class="lec-chapter-num">${i+1}</div>
      <div class="lec-chapter-body">
        <div class="lec-chapter-title">${c.t}</div>
        <div class="lec-chapter-ts">${c.ts}</div>
      </div>
      <div class="lec-chapter-status">${c.done?'✓':''}</div>
    </div>`).join('');

  const objRows = l.objectives.map(o=>`
    <div class="lec-obj-row">
      <div class="lec-obj-dot"></div>
      <div class="lec-obj-text">${o}</div>
    </div>`).join('');

  document.getElementById('lecturesContent').innerHTML = `
    <div class="lec-detail-wrap">

      <!-- Header -->
      <div class="lec-detail-header">
        <div class="lec-detail-icon" style="background:${l.thumbBg}">${l.thumb}</div>
        <div class="lec-detail-meta">
          <div class="lec-detail-eyebrow">${l.eyebrow}</div>
          <h1 class="lec-detail-title">${l.title}</h1>
          <div class="lec-detail-stats">
            <span>${l.duration}</span>
            <span>·</span>
            <span>${l.credits} CME credit${l.credits!==1?'s':''}</span>
            ${l.tags.map(t=>`<span class="lec-detail-tag">${t}</span>`).join('')}
          </div>
        </div>
      </div>

      <!-- Video player placeholder -->
      <div class="lec-player">
        <div class="lec-player-inner" onclick="this.classList.toggle('playing')">
          <div class="lec-player-overlay" id="lecPlayerOverlay">
            <div class="lec-play-btn">▶</div>
            <div class="lec-player-label">Preview — Full access coming Q2 2026</div>
          </div>
          <div class="lec-waveform">
            ${Array.from({length:60},(_,i)=>`<div class="lec-wf-bar ${i<Math.round(pct/100*60)?'played':''}" style="height:${18+Math.sin(i*0.7)*12+Math.random()*8}px"></div>`).join('')}
          </div>
        </div>
        <div class="lec-player-controls">
          <div class="lec-player-prog-wrap">
            <div class="lec-player-prog-track">
              <div class="lec-player-prog-fill" style="width:${pct}%"></div>
            </div>
            <span class="lec-player-time">${pct>0?Math.round(parseInt(l.duration)*pct/100)+' min':'0:00'} / ${l.duration}</span>
          </div>
        </div>
      </div>

      <!-- Two-column body -->
      <div class="lec-detail-body">

        <!-- Left: content -->
        <div class="lec-detail-left">

          <!-- Speaker -->
          <div class="lec-speaker-card">
            <div class="lec-speaker-av">${l.speaker.split(' ').map(w=>w[0]).join('').slice(0,2)}</div>
            <div>
              <div class="lec-speaker-name">${l.speakerFull}</div>
              <div class="lec-speaker-cred">${l.credFull}</div>
            </div>
          </div>

          <!-- Description -->
          <div class="lec-detail-section-lbl">About this lecture</div>
          <div class="lec-detail-desc">${l.desc}</div>

          <!-- Learning objectives -->
          <div class="lec-detail-section-lbl">What you'll learn</div>
          <div class="lec-objectives">${objRows}</div>

          <!-- Transcript preview -->
          ${l.transcript ? `
          <div class="lec-detail-section-lbl">Transcript preview</div>
          <div class="lec-transcript">
            <div class="lec-transcript-text">${l.transcript}</div>
            <div class="lec-transcript-fade">
              <span style="font-size:12px;color:var(--tx4)">Full transcript available after completing lecture</span>
            </div>
          </div>` : ''}
        </div>

        <!-- Right: chapters + CME -->
        <div class="lec-detail-right">

          <!-- CME card -->
          <div class="lec-cme-card">
            <div class="lec-cme-top">
              <div class="lec-cme-credits">${l.credits}</div>
              <div>
                <div class="lec-cme-lbl">CME Credits</div>
                <div class="lec-cme-sub">Awarded on completion</div>
              </div>
            </div>
            ${pct>0?`
            <div class="lec-cme-prog-lbl">Your progress — ${pct}%</div>
            <div class="lec-cme-prog-track"><div class="lec-cme-prog-fill" style="width:${pct}%"></div></div>
            `:''}
            <button class="lec-start-btn" style="border-color:${l.accentColor};color:${l.accentColor}">
              ${pct===100?'✓ Completed — Review':'▶ '+(pct>0?'Continue':'Start Lecture')}
            </button>
          </div>

          <!-- Chapters -->
          ${l.chapters.length>0?`
          <div class="lec-chapters-card">
            <div class="lec-chapters-hdr">
              <span>Chapters</span>
              <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--tx4)">${doneCount}/${l.chapters.length} done</span>
            </div>
            <div class="lec-chapters-list">${chapterRows}</div>
          </div>`:''}

        </div>
      </div>
    </div>`;
}



function renderCurriculum(){
  const modules = [
    {
      n:'01', id:'pathology', icon:'🔬', status:'live',
      name:'Odontogenic Cysts',
      sub:'The most boards-tested jaw lesions — 8 conditions, fully interactive',
      count:'8 conditions · 16 cases',
      tag:'Live now',
      conditions:['Dentigerous Cyst','OKC / KCOT','Unicystic Ameloblastoma',
        'Lateral Periodontal Cyst','Calcifying OC','Radicular Cyst',
        'Residual Cyst','Paradental Cyst'],
      cta:'Continue studying →'
    },
    {
      n:'02', id:'m2', icon:'🫙', status:'live',
      name:'Non-Odontogenic Cysts',
      sub:'The cysts that don\'t come from teeth — include the most important pseudo-cyst in dentistry',
      count:'6 conditions · 10 cases',
      tag:'Live now',
      conditions:['Nasopalatine Duct Cyst','Nasolabial Cyst','Dermoid/Epidermoid',
        'Lymphoepithelial Cyst','Thyroglossal Duct Cyst','Stafne Bone Defect'],
      cta:'Start Module 2 →'
    },
    {
      n:'03', id:'m3', icon:'🧬', status:'soon',
      name:'Odontogenic Tumors',
      sub:'High recurrence, surgical decision-making, malignant variants — the neoplastic side',
      count:'6 conditions',
      tag:'Q3 2026',
      conditions:['Ameloblastoma','CEOT (Pindborg)','Adenomatoid OT',
        'Odontoma','Ameloblastic Fibroma','Odontogenic Myxoma']
    },
    {
      n:'04', id:'m4', icon:'🦴', status:'soon',
      name:'Bone Pathology',
      sub:'Radiopaque and mixed lesions that separate residents from attendings',
      count:'6 conditions',
      tag:'Q3 2026',
      conditions:['Fibrous Dysplasia','CGCG','Periapical COD',
        'Florid COD','Paget Disease','Osteosarcoma']
    },
    {
      n:'05', id:'m5', icon:'🫀', status:'soon',
      name:'Soft Tissue Lesions',
      sub:'Bread-and-butter soft tissue diagnoses every clinician sees weekly',
      count:'6 conditions',
      tag:'Q4 2026',
      conditions:['Mucocele','Ranula','Pyogenic Granuloma',
        'Peripheral Giant Cell Granuloma','Fibroma','Epulis Fissuratum']
    },
    {
      n:'06', id:'m6', icon:'💧', status:'soon',
      name:'Salivary Gland Pathology',
      sub:'Histologic grading that changes surgical and oncologic plans',
      count:'6 conditions',
      tag:'2027',
      conditions:['Pleomorphic Adenoma','Mucoepidermoid Carcinoma',
        'Adenoid Cystic Carcinoma','Warthin Tumor','Sialadenitis','Sjögren Syndrome']
    }
  ];

  let html = '<div class="curr-screen">'
    + '<div class="curr-header">'
      + '<div class="curr-eyebrow">ChRi Health · Full Curriculum</div>'
      + '<h1 class="curr-title">Oral Pathology Mastery</h1>'
      + '<p class="curr-sub">Six modules. Every high-yield condition. Built for the way clinicians actually think.</p>'
    + '</div>'
    + '<div class="curr-progress-bar-wrap">'
      + '<div class="curr-progress-lbl"><span>Module 1 complete</span><span>1 of 6 modules live</span></div>'
      + '<div class="curr-progress-track"><div class="curr-progress-fill" style="width:0" data-w="16.7%"></div></div>'
    + '</div>'
    + '<div class="curr-modules">';

  modules.forEach(function(mod, i){
    const isLive = mod.status === 'live';
    html += '<div class="curr-mod ' + (isLive ? 'live' : 'locked') + '" '
      + (isLive ? 'onclick="goScreen(\'' + mod.id + '\',document.getElementById(\'sbM' + mod.n + '\'))"' 
                : 'onclick="goComingSoon(\'' + mod.name + '\',\'' + mod.id + '\')"') + '>'
      + '<div class="curr-mod-left">'
        + '<div class="curr-mod-num">' + mod.n + '</div>'
        + '<div class="curr-mod-icon">' + mod.icon + '</div>'
      + '</div>'
      + '<div class="curr-mod-body">'
        + '<div class="curr-mod-top">'
          + '<div>'
            + '<div class="curr-mod-name">' + mod.name + '</div>'
            + '<div class="curr-mod-sub">' + mod.sub + '</div>'
          + '</div>'
          + '<div class="curr-mod-tag ' + (isLive ? 'tag-live' : 'tag-soon') + '">' + mod.tag + '</div>'
        + '</div>'
        + '<div class="curr-mod-conditions">'
          + mod.conditions.map(function(c){
              return '<span class="curr-cond-pill' + (isLive ? ' pill-live' : '') + '">' + c + '</span>';
            }).join('')
        + '</div>'
        + '<div class="curr-mod-footer">'
          + '<span class="curr-mod-count">' + mod.count + '</span>'
          + (isLive
            ? '<span class="curr-mod-cta">' + mod.cta + ' <span class="curr-cta-arr">→</span></span>'
            : '<span class="curr-mod-notify" onclick="event.stopPropagation();this.textContent=\'✓ Noted\';this.style.color=\'var(--green)\'">🔔 Notify me</span>')
        + '</div>'
      + '</div>'
    + '</div>';
  });

  html += '</div></div>';
  document.getElementById('curriculumContent').innerHTML = html;
  setTimeout(function(){
    document.querySelectorAll('[data-w]').forEach(function(b){ b.style.width = b.dataset.w; });
  }, 120);
}

function goComingSoon(name, moduleKey){
  curScreen='comingsoon';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-comingsoon').classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('active'));
  document.getElementById('topTitle').textContent = name;
  document.getElementById('modeToggle').style.display='none';
  document.getElementById('topCta').textContent='Open Pathology →';
  document.getElementById('topCta').onclick=()=>goScreen('pathology',document.getElementById('sbPath'));

  const mod = COMING_MODULES[moduleKey] || {name, icon:'🔒', tag:'Coming Soon', desc:'This module is in development.', conditions:[]};
  document.getElementById('comingSoonContent').innerHTML = `
    <div class="cs-screen">
      <div class="cs-hero">
        <div class="cs-lock-icon">${mod.icon}</div>
        <div class="cs-hero-text">
          <div class="cs-module-tag">${mod.tag}</div>
          <div class="cs-title">${mod.name}</div>
          <div class="cs-sub">${mod.desc}</div>
        </div>
      </div>
      <div class="cs-body">
        <div>
          <div class="cs-col-label">Conditions in this module</div>
          <div class="cs-conditions">
            ${mod.conditions.map(c=>`<div class="cs-cond-pill">${c}</div>`).join('')}
          </div>
        </div>
        <div>
          <div class="cs-col-label">What's included</div>
          <div class="cs-conditions">
            ${['8-section deep-dive per condition','Radiograph galleries','Compare mode (3-group)','Trainer cases with explanations','Mnemonics + pearl cards'].map(c=>`<div class="cs-cond-pill">${c}</div>`).join('')}
          </div>
        </div>
      </div>
      <div class="cs-notify" onclick="this.innerHTML='✓ You\'re on the list — we\'ll email you when this drops';this.style.background='var(--green-dim)';this.style.color='var(--green)';this.style.borderColor='rgba(61,214,140,.25)';this.style.cursor='default'">
        🔔 Notify me when this module drops
      </div>
      <div class="cs-roadmap">
        <div class="cs-roadmap-hdr">Full Curriculum Roadmap</div>
        ${CURRICULUM_ROADMAP.map(r=>`
          <div class="cs-roadmap-row" ${r.status==='done'?`onclick="goScreen('pathology',document.getElementById('sbPath'))" style="cursor:pointer"`:''}>
            <div class="cs-roadmap-num">${r.n}</div>
            <div style="flex:1">
              <div class="cs-roadmap-name">${r.name}</div>
            </div>
            <div class="cs-roadmap-count">${r.count}</div>
            <div class="cs-roadmap-status ${r.status}">${r.status==='done'?'✓ Live now':r.label}</div>
          </div>`).join('')}
      </div>
      <div style="margin-top:24px;">
        <span class="tb-btn" onclick="goScreen('pathology',document.getElementById('sbPath'))" style="display:inline-flex;align-items:center;gap:8px;">← Back to Odontogenic Cysts</span>
      </div>
    </div>`;
}

function goScreen(id, sbEl){
  curScreen = id;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById('screen-' + id);
  if(target) target.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  if(sbEl) sbEl.classList.add('active');

  const mt = document.getElementById('modeToggle');
  const topCta = document.getElementById('topCta');
  const sbM1 = document.getElementById('sbM1');

  // Reset topbar defaults
  if(mt) mt.style.display = 'none';
  if(sbM1) sbM1.style.display = 'none';
  topCta.textContent = 'Open Pathology →';
  topCta.onclick = () => goScreen('pathology', document.getElementById('sbPath'));

  if(id === 'dashboard'){
    document.getElementById('topTitle').textContent = 'Dashboard';
    document.getElementById('sbDash').classList.add('active');
    topCta.textContent = 'Start Quiz →';
    topCta.onclick = () => goScreen('pathology', document.getElementById('sbPath'));
    renderDashboard();
  }
  else if(id === 'pathology'){
    document.getElementById('topTitle').textContent = 'Odontogenic Cysts';
    document.getElementById('sbPath').classList.add('active');
    if(mt) mt.style.display = 'flex';
    if(sbM1) sbM1.style.display = 'block';
    topCta.textContent = 'Start Quiz →';
    topCta.onclick = () => setMode('trainer');
    renderStudy(curCond);
  }
  else if(id === 'm2'){
    document.getElementById('topTitle').textContent = 'Non-Odontogenic Cysts';
    const sbM2el = document.getElementById('sbM2');
    if(sbM2el) sbM2el.classList.add('active');
    const sbM2nav = document.getElementById('sbM2Nav');
    if(sbM2nav) sbM2nav.style.display = 'block';
    if(mt) mt.style.display = 'flex';
    topCta.textContent = 'Start Quiz →';
    topCta.onclick = () => { curModuleId = 'm2'; setMode('trainer'); renderM2(); };
    curModuleId = 'm2';
    if(!curCondM2) curCondM2 = 'npc';
    renderM2();
  }
  else if(id === 'curriculum'){
    document.getElementById('topTitle').textContent = 'Curriculum';
    const el = document.getElementById('sbCurriculum');
    if(el) el.classList.add('active');
    renderCurriculum();
  }
  else if(id === 'exchange'){
    document.getElementById('topTitle').textContent = 'Clinical Exchange';
    document.getElementById('sbExchange').classList.add('active');
    renderExchange();
  }
  else if(id === 'progress'){
    document.getElementById('topTitle').textContent = 'My Progress';
    document.getElementById('sbProgress').classList.add('active');
    renderProgress();
  }
}

function setSbModule(mod){
  // Show/hide sub-nav for pathology
  const m1 = document.getElementById('sbM1');
  if(m1) m1.style.display = (mod==='m1') ? 'block' : 'none';
}

function updateSbSubActive(condId){
  document.querySelectorAll('.sb-sub').forEach(s=>s.classList.remove('active'));
  const map={dc:'sbDC',okc:'sbOKC',ua:'sbUA',lpc:'sbLPC',coc:'sbCOC',rc:'sbRC',res:'sbRES',para:'sbPARA'};
  const el=document.getElementById(map[condId]);
  if(el)el.classList.add('active');
}

function showCond(id,modeOrEl){
  curCond=id;
  const targetMode=(typeof modeOrEl==='string')?modeOrEl:'study';
  if(curScreen!=='pathology'){
    goScreen('pathology',document.getElementById('sbPath'));
    if(targetMode!=='study')setTimeout(()=>setMode(targetMode),50);
  } else {
    setMode(targetMode);
  }
  updateSbSubActive(id);
  // scroll study content to top
  const ps=document.getElementById('screen-pathology');
  if(ps) ps.scrollTop=0;
}

function setMode(mode){
  curMode=mode;
  document.querySelectorAll('.mt-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById(`m${mode.charAt(0).toUpperCase()+mode.slice(1)}`);
  if(btn)btn.classList.add('active');
  if(mode==='study')renderStudy(curCond);
  else if(mode==='compare')renderCompare();
  else if(mode==='trainer'){if(tr.done)resetTrainer();else renderTrainer();}
  const ps=document.getElementById('screen-pathology');
  if(ps) ps.scrollTop=0;
}

function setRole(role, el){
  curRole=role;
  document.querySelectorAll('.rs-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const R=ROLES[role];
  document.getElementById('sbUserName').textContent=R.name;
  document.getElementById('sbUserRole').textContent=R.role;
  if(curScreen==='dashboard')renderDashboard();
  if(curScreen==='exchange'){ renderExchange(); }
}


// ── COVER / LOGIN FLOW ────────────────────────────────────────
function showLogin(){
  const cover = document.getElementById('coverScreen');
  cover.classList.add('exit');
  setTimeout(()=>{
    cover.style.display='none';
    cover.classList.remove('exit');
    const login = document.getElementById('loginScreen');
    login.style.display='flex';
    requestAnimationFrame(()=>login.style.opacity='1');
  }, 480);
}

function showCover(){
  const login = document.getElementById('loginScreen');
  login.classList.add('exit');
  setTimeout(()=>{
    login.style.display='none';
    login.classList.remove('exit');
    const cover = document.getElementById('coverScreen');
    cover.style.display='flex';
    requestAnimationFrame(()=>cover.style.opacity='1');
  }, 480);
}

function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const role  = document.getElementById('loginRole').value;
  const year  = document.getElementById('loginYear').value;

  // Extract display name from email (before @ or dot)
  let displayName = 'You';
  if(email){
    const local = email.split('@')[0];
    const parts = local.split(/[._-]/);
    displayName = parts.map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
    if(displayName.length > 18) displayName = displayName.split(' ')[0];
  }
  _enterApp(displayName, role, year);
}

function doLoginAlt(){
  const email = document.getElementById('loginEmailAlt').value.trim();
  const role  = document.getElementById('loginRoleAlt').value;
  const year  = document.getElementById('loginYearAlt').value;
  let name = 'You';
  if(email){
    const parts = email.split('@')[0].split(/[._-]/);
    name = parts.map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
    if(name.length>18) name=name.split(' ')[0];
  }
  _enterApp(name, role, year);
}

function enterAsGuest(){
  _enterApp('Guest', 'student', 'MS-II');
}

function _enterApp(name, role, year){
  try { loadProgress(); } catch(e){}

  // Update sidebar identity
  try {
    const nameEl = document.getElementById('sbUserName');
    const roleEl = document.getElementById('sbUserRole');
    if(nameEl) nameEl.textContent = name;
    if(roleEl) roleEl.textContent = year + ' · ' + (role==='student'?'Student':role==='resident'?'Resident':'Attending');
    setRole(role, document.querySelector('.rs-btn'));
  } catch(e){}

  // Hide cover/login immediately, show app
  const cover = document.getElementById('coverScreen');
  const login = document.getElementById('loginScreen');
  const app   = document.querySelector('.app');

  if(cover) { cover.classList.add('exit'); setTimeout(()=>{ cover.style.display='none'; }, 450); }
  if(login) { login.classList.add('exit'); setTimeout(()=>{ login.style.display='none'; }, 450); }
  if(app)   { app.style.opacity='1'; }
}

// ── App is visible immediately — cover sits on top via z-index:999 ──────────


/* ════════════════════════════════════════════════
   KEYBOARD NAVIGATION
════════════════════════════════════════════════ */
document.addEventListener('keydown', function(e){
  const tag = document.activeElement.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA') return;

  // ── Trainer keyboard shortcuts ──
  if(curScreen === 'pathology' && curMode === 'trainer' && !tr.done){
    // 1-4: pick answer
    if(e.key >= '1' && e.key <= '4'){
      if(tr.answered) return;
      const opts = document.querySelectorAll('.ans-opt');
      const idx = parseInt(e.key) - 1;
      if(opts[idx]) opts[idx].click();
      e.preventDefault(); return;
    }
    // Enter / Space: commit (go to next after answering)
    if((e.key === 'Enter' || e.key === ' ') && tr.answered){
      const nextBtn = document.querySelector('.t-next-btn, .t-btn.primary');
      if(nextBtn){ nextBtn.click(); e.preventDefault(); return; }
    }
  }

  // ── Exchange keyboard shortcuts ──
  if(curScreen === 'exchange'){
    // 1-4: pick diagnosis in thread view
    if(e.key >= '1' && e.key <= '4'){
      if(!exSelectedDiff || !exCommitted){
        const opts = document.querySelectorAll('.ex-diff-opt');
        const idx = parseInt(e.key) - 1;
        if(opts[idx] && !exCommitted){ opts[idx].click(); e.preventDefault(); return; }
      }
    }
    // Enter: commit
    if(e.key === 'Enter' && exSelectedDiff && !exCommitted){
      exCommit(); e.preventDefault(); return;
    }
    // Escape: back to index
    if(e.key === 'Escape'){
      const cta = document.getElementById('topCta');
      if(cta && cta.textContent.includes('← Cases')){ cta.click(); e.preventDefault(); }
    }
  }

  // ── Global ──
  // Escape on lecture detail: back to list
  if(curScreen === 'lectures' && e.key === 'Escape'){
    goLectures(); e.preventDefault();
  }
});

/* Keyboard hint tooltip on trainer */
(function(){
  const hint = document.createElement('div');
  hint.id = 'kbHint';
  hint.innerHTML = '⌨ <span>1–4</span> pick · <span>Enter</span> next';
  hint.style.cssText = 'position:fixed;bottom:14px;right:14px;font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--tx4);background:var(--bg1);border:1px solid var(--bdr);padding:5px 10px;border-radius:8px;opacity:0;transition:opacity .3s;pointer-events:none;z-index:200;letter-spacing:.06em;';
  document.body.appendChild(hint);

  let hintTimer;
  document.addEventListener('keydown', function(){
    if(curScreen !== 'pathology' || curMode !== 'trainer') return;
    hint.style.opacity = '1';
    clearTimeout(hintTimer);
    hintTimer = setTimeout(()=>{ hint.style.opacity='0'; }, 2200);
  });
})();


/* ════════════════════════════════════════════════
   MOBILE NAV
════════════════════════════════════════════════ */
function toggleMobNav(){
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('mobOverlay');
  if(!sb || !ov) return;
  const isOpen = sb.classList.contains('mob-open');
  if(isOpen){ closeMobNav(); } else { openMobNav(); }
}
function openMobNav(){
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('mobOverlay');
  if(!sb || !ov) return;
  sb.classList.add('mob-open');
  ov.style.display = 'block';
  requestAnimationFrame(()=>{ ov.classList.add('open'); });
  document.body.style.overflow = 'hidden';
}
function closeMobNav(){
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('mobOverlay');
  if(!sb || !ov) return;
  sb.classList.remove('mob-open');
  ov.classList.remove('open');
  setTimeout(()=>{ ov.style.display = 'none'; }, 240);
  document.body.style.overflow = '';
}

// Auto-close sidebar when a nav item is tapped on mobile
(function(){
  document.addEventListener('click', function(e){
    const sb = document.querySelector('.sidebar');
    if(!sb || !sb.classList.contains('mob-open')) return;
    if(e.target.closest('.sb-item, .sb-cond, .sb-module-link, .sb-section-link')) {
      setTimeout(closeMobNav, 120);
    }
  });
})();

// ── INIT ──
document.getElementById("topMono").textContent=new Date().toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
renderDashboard();
// XP fills animated on init via renderDashboard data-w attrs
</script>
</body>
</html>
